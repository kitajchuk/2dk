(()=>{var xt=window.getComputedStyle(document.documentElement),x=s=>xt.getPropertyValue(s),L={verbs:{RUN:"run",PUSH:"push",PULL:"pull",GRAB:"grab",LIFT:"lift",WALK:"walk",FACE:"face",JUMP:"jump",FALL:"fall",THROW:"throw",SMASH:"smash",ATTACK:"attack"},map:{types:{WORLD:"world",INDOOR:"indoor"}},tiles:{HOLES:"holes",GRASS:"grass",WATER:"water",LEDGE:"ledge",STAIRS:"stairs",SWITCH:"switch"},keys:{A:"KeyX",B:"KeyZ",UP:"ArrowUp",DOWN:"ArrowDown",LEFT:"ArrowLeft",RIGHT:"ArrowRight",START:"Enter",SELECT:"Space",UPLEFT:"ArrowUpLeft",UPRIGHT:"ArrowUpRight",DOWNLEFT:"ArrowDownLeft",DOWNRIGHT:"ArrowDownRight"},plugins:{TOPVIEW:"topview"},events:{DOOR:"door",WARP:"warp",DIALOGUE:"dialogue",BOUNDARY:"boundary",CUTSCENE:"cutscene"},broadcast:{PAUSED:"paused",RESUMED:"resumed",MAPEVENT:"mapevent"},npc:{WALK:"walk",ROAM:"roam",FLOAT:"float",WANDER:"wander"},facing:{UP:"up",DOWN:"down",LEFT:"left",RIGHT:"right"},opposites:{y:"x",x:"y",up:"down",down:"up",left:"right",right:"left"},dialogue:{types:{TEXT:"text",PROMPT:"prompt"},verbs:{TALK:"talk",READ:"read"}},colors:{red:x("--red"),grey:x("--grey"),blue:x("--blue"),teal:x("--teal"),pink:x("--pink"),black:x("--black"),green:x("--green"),white:x("--white"),purple:x("--purple"),yellow:x("--yellow"),greyDark:x("--grey-dark"),blueDark:x("--blue-dark"),charcoal:x("--charcoal"),charcoal2:x("--charcoal2")}},C=[L.facing.UP,L.facing.DOWN,L.facing.LEFT,L.facing.RIGHT],h=L;var I={dev(){return/^file:|^http:\/\/(localhost|127\.0\.0\.1)/.test(window.location.href)},log(...s){I.dev()&&console.log.apply(console,s)},func(s){return typeof s=="function"},def(s){return s!==void 0},error(...s){I.dev()&&console.error.apply(console,s)},merge(s,t,i){return s=structuredClone(s),t=structuredClone(t),Object.keys(t).forEach(e=>{(!s[e]||i)&&(s[e]=t[e])}),s},contains(s,t){let i=!1;return t.x+t.width<=s.x+s.width&&t.x>=s.x&&t.y+t.height<=s.y+s.height&&t.y>=s.y&&(i=!0),i},collide(s,t){let i=!1;return s.x<t.x+t.width&&s.x+s.width>t.x&&s.y<t.y+t.height&&s.height+s.y>t.y&&(i={x:Math.max(0,s.x-t.x),y:Math.max(0,s.y-t.y),width:Math.min(t.width,s.x-t.x+s.width)-Math.max(0,s.x-t.x),height:Math.min(t.height,s.y-t.y+s.height)-Math.max(0,s.y-t.y)}),i},drawTileCel(s,t,i,e,a,o,n,d){s.drawImage(t,a,o,i,i,n*e,d*e,e,e)},drawMapTile(s,t,i,e,a,o,n){if(Array.isArray(i))for(let d=0,l=i.length;d<l;d++)this.drawTileCel(s,t,e,a,i[d][0],i[d][1],o,n);else s.clearRect(o*a,n*a,a,a)},drawMapTiles(s,t,i,e,a){for(let o=i.length;o--;){let n=i[o];for(let d=n.length;d--;){let l=n[d];this.drawMapTile(s,t,l,e,a,d,o)}}},getSurroundingTileCoords(s){return{topLeft:{x:s[0]-1,y:s[1]-1},top:{x:s[0],y:s[1]-1},topRight:{x:s[0]+1,y:s[1]-1},left:{x:s[0]-1,y:s[1]},right:{x:s[0]+1,y:s[1]},bottomLeft:{x:s[0]-1,y:s[1]+1},bottom:{x:s[0],y:s[1]+1},bottomRight:{x:s[0]+1,y:s[1]+1}}},random(s,t){return s+Math.floor(Math.random()*t)},limit(s,t,i){return s<t?t:s>i?i:s},goToZero(s){return s?s-s/Math.abs(s):0},getDistance(s,t){return Math.sqrt(Math.pow(t.x-s.x,2)+Math.pow(t.y-s.y,2))}},r=I;var O=class{constructor(){this.handlers={},this.animate=null,this.started=!1,this.cycle=null}go(t){if(this.started)return this;this.started=!0,this.animate=i=>{this.cycle=window.requestAnimationFrame(this.animate),r.func(t)&&t(i)},this.cycle=window.requestAnimationFrame(this.animate)}stop(){window.cancelAnimationFrame(this.cycle),this.animate=null,this.started=!1,this.cycle=null}on(t,i){t.split(" ").forEach(a=>{r.func(i)&&(this.handlers[a]||(this.handlers[a]=[]),this.handlers[a].push(i))})}off(t,i){if(!this.handlers[t])return this;if(i){for(let e=this.handlers[t].length;e--;)if(this.handlers[t][e]===i){this.handlers[t].splice(e,1);break}}else delete this.handlers[t]}emit(t,...i){if(!this.handlers[t])return this;this.handlers[t].forEach(e=>{e.apply(this,i)})}},H=O;var R=[],vt=8,st=50,bt=[h.keys.UPLEFT,h.keys.UPRIGHT,h.keys.DOWNLEFT,h.keys.DOWNRIGHT],ht=[h.keys.UP,h.keys.DOWN,h.keys.LEFT,h.keys.RIGHT],c={a:{key:h.keys.A,elem:null,timer:null,touched:!1,hold:0,text:"A",gamepad:[0]},b:{key:h.keys.B,elem:null,timer:null,touched:!1,hold:0,text:"B",gamepad:[1]},start:{key:h.keys.START,elem:null,timer:null,touched:!1,hold:0,text:"Start",menu:!0,gamepad:[9]},select:{key:h.keys.SELECT,elem:null,hold:0,timer:null,touched:!1,text:"Select",menu:!0,gamepad:[8]},"up-left":{key:h.keys.UPLEFT,elem:null,timer:null,touched:!1,dpad:["left","up"]},up:{key:h.keys.UP,elem:null,timer:null,touched:!1,dpad:["up"],axes:[0,-1]},"up-right":{key:h.keys.UPRIGHT,elem:null,timer:null,touched:!1,dpad:["right","up"]},left:{key:h.keys.LEFT,elem:null,timer:null,touched:!1,dpad:["left"],axes:[-1,0]},neutral:{elem:null,dpad:[]},right:{key:h.keys.RIGHT,elem:null,timer:null,touched:!1,dpad:["right"],axes:[1,0]},"down-left":{key:h.keys.DOWNLEFT,elem:null,timer:null,touched:!1,dpad:["left","down"]},down:{key:h.keys.DOWN,elem:null,timer:null,touched:!1,dpad:["down"],axes:[0,1]},"down-right":{key:h.keys.DOWNRIGHT,elem:null,timer:null,touched:!1,dpad:["right","down"]}},z=class extends H{constructor(t){super(),this.player=t,this.build(),this.bind()}clear(){setTimeout(()=>{this.clearTouches(),this.cancelTouches()},300)}bind(){this.element.addEventListener("touchstart",this.onTouchStart.bind(this),!1),this.element.addEventListener("touchmove",this.onTouchMove.bind(this),!1),this.element.addEventListener("touchend",this.onTouchEnd.bind(this),!1),document.addEventListener("keyup",this.onKeyUp.bind(this),!1),document.addEventListener("keydown",this.onKeyDown.bind(this),!1),window.addEventListener("gamepadconnected",this.onGamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this.onGamepadDisconnected.bind(this))}build(){this.element=document.createElement("div"),this.dpad=document.createElement("div"),this.btns=document.createElement("div"),this.element.className="_2dk__gamepad",this.dpad.className="_2dk__gamepad__dpad",this.btns.className="_2dk__gamepad__btns",this.element.appendChild(this.dpad),this.element.appendChild(this.btns),this.diagonaldpad=this.player.data.diagonaldpad,this.availableControls=Object.keys(c),this.functionalControls=Object.keys(c).reduce((t,i)=>(i==="neutral"||!this.diagonaldpad&&bt.includes(c[i].key)||t.push(i),t),[]),this.availableControls.forEach(t=>{let i=this.functionalControls.some(e=>e===t);c[t].btn=t.split("-"),c[t].elem=document.createElement("div"),c[t].elem.className=`_2dk__gamepad__${t}`,c[t].key&&(c[t].elem.dataset.key=c[t].key),i||(c[t].elem.dataset.off="true"),c[t].text&&(c[t].elem.innerHTML=`<span>${c[t].text}</span>`),c[t].dpad?this.dpad.appendChild(c[t].elem):this.btns.appendChild(c[t].elem)}),this.player.element.appendChild(this.element),this.player.device||(this.element.style.display="none")}canReceiveInput(t){let i=ht.includes(t),e=R.some(n=>ht.includes(n)),a=this.diagonaldpad||!i?!0:!e,o=!R.includes(t);return a&&o}pushInput(t){R.push(t)}removeInput(t){R.includes(t)&&R.splice(R.indexOf(t),1)}checkDpad(){let t=[];return this.functionalControls.forEach(i=>{c[i].touched&&c[i].dpad&&t.push(c[i])}),t.sort(i=>i.key===h.keys.UP||i.key===h.keys.DOWN?1:-1)}getControl(t){let i=null;return this.availableControls.forEach(e=>{c[e].key===t&&(i=c[e])}),i}getGamepad(t){let i=null;return this.availableControls.forEach(e=>{c[e].gamepad&&c[e].gamepad.indexOf(t)!==-1&&(i=c[e])}),i}getAxes(t,i){let e=null;return this.availableControls.forEach(a=>{c[a].axes&&c[a].axes[t]===i&&(e=c[a])}),e}getTouched(t,i){for(let e=0;e<t.length;e++)if(document.elementFromPoint(t[e].pageX,t[e].pageY).dataset.key===i.key)return i;return null}onTouchStart(t){t.preventDefault();for(let i=0;i<t.touches.length;i++){let e=document.elementFromPoint(t.touches[i].pageX,t.touches[i].pageY);if(e.dataset.key){let a=this.getControl(e.dataset.key);this.startTouch(a)}}return!1}onTouchMove(t){t.preventDefault();for(let i=0;i<t.touches.length;i++){let e=document.elementFromPoint(t.touches[i].pageX,t.touches[i].pageY);if(e.dataset.key){let a=this.getControl(e.dataset.key);a&&this.startTouch(a)}this.functionalControls.forEach(a=>{c[a].touched&&(this.getTouched(t.touches,c[a])||this.cancelTouch(c[a]))})}return!1}onTouchEnd(t){return t.preventDefault(),t.touches.length?this.availableControls.forEach(i=>{c[i].touched&&(this.getTouched(t.touches,c[i])||this.cancelTouch(c[i]))}):(this.clearTouches(),this.cancelTouches()),!1}onKeyDown(t){if(this.canReceiveInput(t.code)){this.pushInput(t.code);let i=this.getControl(t.code);i&&this.startTouch(i)}}onKeyUp(t){if(!this.canReceiveInput(t.code)){this.removeInput(t.code);let i=this.getControl(t.code);i&&this.cancelTouch(i)}}handleGamepadAxes(t){let i={x:this.getAxes(0,t.axes[0]),y:this.getAxes(1,t.axes[1])};i.x&&this.canReceiveInput(i.x.key)?(this.pushInput(i.x.key),this.startTouch(i.x)):i.x||(this.canReceiveInput(h.keys.LEFT)||(this.removeInput(h.keys.LEFT),this.cancelTouch(c.left)),this.canReceiveInput(h.keys.RIGHT)||(this.removeInput(h.keys.RIGHT),this.cancelTouch(c.right))),i.y&&this.canReceiveInput(i.y.key)?(this.pushInput(i.y.key),this.startTouch(i.y)):i.y||(this.canReceiveInput(h.keys.UP)||(this.removeInput(h.keys.UP),this.cancelTouch(c.up)),this.canReceiveInput(h.keys.DOWN)||(this.removeInput(h.keys.DOWN),this.cancelTouch(c.down)))}handleGamepadButtons(t){for(let i=t.buttons.length;i--;){let e=this.getGamepad(i);e&&this.canReceiveInput(e.key)&&t.buttons[i].pressed?(this.pushInput(e.key),this.startTouch(e)):e&&!this.canReceiveInput(e.key)&&!t.buttons[i].pressed&&(this.removeInput(e.key),this.cancelTouch(e))}}onGamepadConnected(){let t=navigator.getGamepads()[0];this.stop(),this.go(()=>{t=navigator.getGamepads()[0],this.handleGamepadAxes(t),this.handleGamepadButtons(t)}),r.log(`GamePad Connected: ${t.id}`,t)}onGamepadDisconnected(){this.stop()}clearTouches(){this.availableControls.forEach(t=>{c[t].elem.classList.remove("is-active")})}cancelTouches(){this.availableControls.forEach(t=>{c[t].touched&&this.cancelTouch(c[t])})}cancelTouch(t){t.timer&&(clearInterval(t.timer),t.timer=null),t.elem.classList.remove("is-active"),t.touched=!1,this.handleTouchEnd(t)}startTouch(t){t.timer||(t.elem.classList.add("is-active"),t.touched=!0,this.handleTouchStart(t),Object.prototype.hasOwnProperty.call(t,"hold")&&!t.menu&&(t.timer=setInterval(()=>{this.handleTouchStart(t)},vt)))}handleTouchStart(t){if(t.touched&&t.menu&&t.hold>0){t.hold++;return}Object.prototype.hasOwnProperty.call(t,"hold")?(t.hold++,t.hold>st?this.emit(`${t.btn[0]}-holdpress`):this.emit(`${t.btn[0]}-press`)):t.dpad?t.dpad.forEach((i,e)=>{this.emit(`${t.btn[e]}-press`,i)}):this.emit(`${t.btn[0]}-press`,null)}handleTouchEnd(t){Object.prototype.hasOwnProperty.call(t,"hold")?(t.hold>st?this.emit(`${t.btn[0]}-holdrelease`):this.emit(`${t.btn[0]}-release`),t.hold=0):t.dpad?t.dpad.forEach((i,e)=>{this.emit(`${t.btn[e]}-release`,i)}):this.emit(`${t.btn[0]}-release`,null)}},at=z;var m={},F=class{static cash(t,i){return i&&(m[t]=i),t?m[t]:m}load(t){let i=t.split("/").pop().split(".").pop();if(i==="png")return this.loadImage(t);if(i==="mp3")return this.loadAudio(t);if(i==="json")return this.loadJson(t)}loadImage(t){return new Promise((i,e)=>{if(m[t])return i(m[t]);let a=new Image;a.onload=()=>{m[t]=a,i(m[t])},a.onerror=()=>{e()},a.src=t})}loadAudio(t){return new Promise(i=>{if(m[t])return i(m[t]);let e=new Audio;e.addEventListener("loadedmetadata",()=>{m[t]=!0,e=null,i(m[t])},!1),e.muted=!0,e.volume=0,e.src=t,e.load()})}loadJson(t){return new Promise(i=>{if(m[t])return i(m[t]);fetch(t).then(e=>{e.json().then(a=>{m[t]=a,i(m[t])})})})}},v=F;var N=class{constructor(t){this.gamebox=t,this.data=null,this.ready=!1,this.pressed=!1,this.active=!1,this.isResolve=!1,this.resolve=null,this.reject=null,this.timeout=null,this.debounce=750,this.duration=250,this.build()}build(){this.element=document.createElement("div"),this.element.className="_2dk__dialogue"}write(t){this.element.innerHTML=`<div class="_2dk__dialogue__text">${t}</div>`}clear(){this.element.innerHTML=""}auto(t){this.active||(this.timeout&&clearTimeout(this.timeout),this.data=structuredClone(t),this.element.classList.add("is-texting"),this.write(this.data.text.shift()),this.timeout=setTimeout(()=>{this.teardown()},this.debounce*3))}play(t){if(!this.active)return this.active=!0,new Promise((i,e)=>{this.data=structuredClone(t),this.isResolve=!0,this.resolve=i,this.reject=e,this.element.classList.add("is-texting"),this.write(this.data.text.shift()),this.timeout=setTimeout(()=>{this.ready=!0},this.debounce)})}check(t,i){if(!(!this.active||!this.ready||this.active&&this.pressed))switch(this.pressed=!0,this.data.type){case h.dialogue.types.TEXT:this.handleText();break;case h.dialogue.types.PROMPT:this.handlePrompt(t,i);break}}handleText(){this.data.text.length?(this.write(this.data.text.shift()),this.timeout=setTimeout(()=>{this.pressed=!1},this.debounce)):(this.isResolve?this.resolve():this.reject(),this.teardown())}handlePrompt(t,i){if(this.data.text.length){let e=[`<div>${this.data.text.shift()}</div>`];this.data.text.length||(e.push(`<span class="a">A: ${this.data.yes.label}</span>`),e.push("<span>,&nbsp;</span>"),e.push(`<span class="b">B: ${this.data.no.label}</span>`)),this.write(e.join("")),this.timeout=setTimeout(()=>{this.pressed=!1},this.debounce)}else t?(this.isResolve=!0,this.data.type=h.dialogue.types.TEXT,this.data.text=this.data.yes.text,this.timeout=setTimeout(()=>{this.pressed=!1,this.check(!0,!1)},this.duration)):i&&(this.isResolve=!1,this.data.type=h.dialogue.types.TEXT,this.data.text=this.data.no.text,this.timeout=setTimeout(()=>{this.pressed=!1,this.check(!1,!0)},this.duration))}teardown(){this.element.classList.remove("is-texting"),this.data=null,this.ready=!1,this.pressed=!1,this.isResolve=!1,this.resolve=null,this.reject=null,this.timeout=setTimeout(()=>{this.clear(),this.active=!1,this.timeout=null},this.duration)}},ot=N;var U=class{constructor(t,i){this.data=t,this.map=i,this.gamebox=this.map.gamebox,this.scale=this.data.scale||1,this.width=this.data.width/this.scale,this.height=this.data.height/this.scale,this.dir=this.data.dir||this.data.spawn.dir||"down",this.verb=this.data.verb||h.verbs.FACE,this.image=v.cash(this.data.image),this.speed=1,this.frame=0,this.opacity=t.opacity||1,this.position={x:this.data.spawn&&this.data.spawn.x||0,y:this.data.spawn&&this.data.spawn.y||0,z:this.data.spawn&&this.data.spawn.z||0},this.physics={vx:this.data.vx||0,vy:this.data.vy||0,vz:this.data.vz||0,maxv:this.data.maxv||4,controlmaxv:this.data.controlmaxv||4,maxvstatic:this.data.maxv||4,controlmaxvstatic:this.data.controlmaxv||4},this.offset={x:this.gamebox.offset.x+this.position.x,y:this.gamebox.offset.y+this.position.y},this.idle={x:!0,y:!0},this.data.hitbox=this.data.hitbox||{x:0,y:0,width:this.data.width,height:this.data.height},this.hitbox={x:this.position.x+this.data.hitbox.x/this.scale,y:this.position.y+this.data.hitbox.y/this.scale,width:this.data.hitbox.width/this.scale,height:this.data.hitbox.height/this.scale},this.footbox={x:this.hitbox.x,y:this.hitbox.y+this.hitbox.height/2,width:this.hitbox.width,height:this.hitbox.height/2},this.layer=this.data.layer||"background",this.spritecel=this.getCel(),this.previousElapsed=null,this.resetElapsed=!1,this.frameStopped=!1}destroy(){}can(t){return!!this.data.verbs[t]}is(t){return this.verb===t}visible(){return r.collide(this.gamebox.camera,{x:this.position.x,y:this.position.y,width:this.width,height:this.height})}isHero(){return this===this.gamebox.hero}isCompanion(){return this===this.gamebox.companion}isLifted(){return r.def(this.hero)}isIdle(){return this.idle.x&&this.idle.y}isJumping(){return this.position.z<0}blit(t){this.visible()&&(this.previousElapsed===null&&(this.previousElapsed=t),this.applyFrame(t))}update(){this.visible()&&this.updateStack()}updateStack(){this.handleVelocity(),this.handleGravity(),this.applyPosition(),this.applyHitbox(),this.applyOffset(),this.applyGravity()}render(){this.visible()&&(r.func(this.renderBefore)&&this.renderBefore(),!this.isHero()&&!this.isCompanion()&&(this.data.type===h.npc.FLOAT?this.layer="foreground":this.hitbox.width*this.hitbox.height!==this.width*this.height&&(this.hitbox.y>this.gamebox.hero.hitbox.y?this.layer="foreground":this.layer="background")),this.data.shadow&&!this.is(h.verbs.FALL)&&this.gamebox.layers[this.layer].onCanvas.context.drawImage(this.image,Math.abs(this.data.shadow.offsetX),Math.abs(this.data.shadow.offsetY),this.data.width,this.data.height,this.offset.x,this.offset.y,this.width,this.height),this.opacity&&(this.gamebox.layers[this.layer].onCanvas.context.globalAlpha=this.opacity),this.gamebox.layers[this.layer].onCanvas.context.drawImage(this.image,this.spritecel[0],this.spritecel[1],this.data.width,this.height,this.offset.x,this.offset.y+this.position.z,this.width,this.height),r.func(this.renderAfter)&&this.renderAfter(),this.gamebox.player.query.get("debug")&&this.renderDebug())}renderDebug(){this.gamebox.layers.foreground.onCanvas.context.globalAlpha=.25,this.gamebox.layers.foreground.onCanvas.context.fillStyle=h.colors.white,this.gamebox.layers.foreground.onCanvas.context.fillRect(this.offset.x,this.offset.y,this.width,this.height),this.gamebox.layers.foreground.onCanvas.context.globalAlpha=.5,this.gamebox.layers.foreground.onCanvas.context.fillStyle=h.colors.red,this.gamebox.layers.foreground.onCanvas.context.fillRect(this.offset.x+this.data.hitbox.x/this.scale,this.offset.y+this.data.hitbox.y/this.scale,this.hitbox.width,this.hitbox.height),this.gamebox.layers.foreground.onCanvas.context.fillStyle=h.colors.green,this.gamebox.layers.foreground.onCanvas.context.fillRect(this.offset.x+this.data.hitbox.x/this.scale,this.offset.y+this.data.hitbox.y/this.scale+this.hitbox.height/2,this.footbox.width,this.footbox.height),this.gamebox.layers.foreground.onCanvas.context.globalAlpha=1}cycle(t,i){this.dir=i,this.verb=t}face(t){this.cycle(h.verbs.FACE,t)}handleVelocity(){this.idle.x&&(this.physics.vx=r.goToZero(this.physics.vx)),this.idle.y&&(this.physics.vy=r.goToZero(this.physics.vy))}handleGravity(){this.physics.vz++}applyPosition(){this.isLifted()&&!this.throwing?(this.position.x=this.hero.position.x+this.hero.width/2-this.width/2,this.position.y=this.hero.position.y-this.height+42):this.isLifted()||(this.position=this.getNextPoi())}applyHitbox(){this.hitbox.x=this.position.x+this.data.hitbox.x/this.scale,this.hitbox.y=this.position.y+this.data.hitbox.y/this.scale,this.footbox.x=this.hitbox.x,this.footbox.y=this.hitbox.y+this.hitbox.height/2}applyOffset(){this.offset={x:this.gamebox.offset.x+this.position.x,y:this.gamebox.offset.y+this.position.y}}applyGravity(){this.position.z=this.getNextZ(),this.position.z>0&&(this.position.z=0)}applyFrame(t){if(!this.frameStopped){if(this.frame=0,this.resetElapsed&&(this.resetElapsed=!1,this.previousElapsed=t),this.data.verbs[this.verb][this.dir].stepsX)if(this.is(h.verbs.LIFT)&&this.isIdle())r.log("static lift...");else{let i=t-this.previousElapsed;this.frame=Math.min(Math.floor(i/this.data.verbs[this.verb].dur*this.data.verbs[this.verb][this.dir].stepsX),this.data.verbs[this.verb][this.dir].stepsX-1),i>=this.data.verbs[this.verb].dur&&(this.previousElapsed=t,this.data.verbs[this.verb].stop?this.frameStopped=!0:this.frame=0)}this.spritecel=this.getCel()}}getCel(){return[Math.abs(this.data.verbs[this.verb][this.dir].offsetX)+this.data.width*this.frame,Math.abs(this.data.verbs[this.verb][this.dir].offsetY)]}getDur(t){return this.data.verbs[t].dur||0}getNextX(){return this.position.x+r.limit(this.physics.vx,-this.physics.maxv,this.physics.maxv)}getNextY(){return this.position.y+r.limit(this.physics.vy,-this.physics.maxv,this.physics.maxv)}getNextZ(){return this.position.z+r.limit(this.physics.vz,-this.physics.maxv,this.physics.maxv)}getNextPoi(){return{x:this.getNextX(),y:this.getNextY(),z:this.getNextZ()}}getNextPoiByDir(t,i){return i&&t==="left"&&(i=-this.physics.controlmaxv),i&&t==="right"&&(i=this.physics.controlmaxv),i&&t==="up"&&(i=-this.physics.controlmaxv),i&&t==="down"&&(i=this.physics.controlmaxv),i||(i=0),{x:t==="left"||t==="right"?this.getNextX()+i:this.position.x,y:t==="up"||t==="down"?this.getNextY()+i:this.position.y,z:this.position.z}}getHitbox(t){return{x:t.x+this.data.hitbox.x/this.scale,y:t.y+this.data.hitbox.y/this.scale,width:this.hitbox.width,height:this.hitbox.height}}getFootbox(t){return{x:t.x+this.data.hitbox.x/this.scale,y:t.y+(this.data.hitbox.y/this.scale+this.hitbox.height/2),width:this.footbox.width,height:this.footbox.height}}},T=U;var B=class extends T{constructor(t,i){super(t,i),this.states=structuredClone(this.data.states),this.dialogue=null,this.attacked=!1,this.controls={},this.counter=this.data.ai?60:0,this.dirX=null,this.dirY=null,this.stepsX=0,this.stepsY=0,this.data.stats&&(this.stats=structuredClone(this.data.stats)),this.shift()}destroy(){}shift(){this.states.length&&(this.state=this.states.shift(),this.dir=this.state.dir,this.verb=this.state.verb)}payload(){this.data.payload.dialogue&&!this.dialogue&&(this.dialogue=this.gamebox.dialogue.play(this.data.payload.dialogue),this.dialogue.then(()=>{this.resetDialogue(),this.handleAI()}).catch(()=>{this.resetDialogue()}))}resetDialogue(){this.dialogue=null,this.dir=this.state.dir,this.verb=this.state.verb}update(){this.visible()&&(this.gamebox.handleControls(this.controls,this),this.handleAI(),this.updateStack())}applyPosition(){let t=this.getNextPoi(),i={map:this.gamebox.checkMap(t,this),npc:this.gamebox.checkNPC(t,this),hero:this.gamebox.checkHero(t,this),tiles:this.gamebox.checkTiles(t,this)},e=i.map||i.npc||i.hero||this.gamebox.canHeroTileStop(t,null,i);if(i.hero&&this.data.ai===h.npc.ROAM){switch(this.dir){case"left":this.gamebox.hero.physics.vx=-1;break;case"right":this.gamebox.hero.physics.vx=1;break;case"up":this.gamebox.hero.physics.vy=-1;break;case"down":this.gamebox.hero.physics.vy=1;break}return}if(e){this.data.ai===h.npc.ROAM&&(this.counter=0),this.handleAI();return}this.position=t}handleAI(){if(this.data.ai&&!this.attacked)switch(this.data.ai){case h.npc.ROAM:this.handleRoam();break;case h.npc.WANDER:this.handleWander();break}}handleRoam(){if(this.counter)this.counter--;else{this.counter=r.random(60,120);let t=this.dir,i=C[r.random(0,C.length)];if(t===i){this.counter=0,this.handleRoam();return}this.dir=i}C.forEach(t=>{t===this.dir?this.controls[t]=!0:this.controls[t]=!1})}handleWander(){if(this.counter)this.counter--;else{let t=this.dirX,i=this.dirY,e=["left","right"][r.random(0,2)],a=["down","up"][r.random(0,2)];if(t===e&&i===a){this.handleWander();return}this.counter=r.random(60,120),this.stepsX=r.random(30,60),this.stepsY=r.random(30,60),this.dirX=e,this.dirY=a}this.stepsX?(this.stepsX--,this.controls[this.dirX]=!0,this.controls[h.opposites[this.dirX]]=!1,this.data.verbs[this.verb][this.dirX]&&(this.dir=this.dirX)):(this.controls.left=!1,this.controls.right=!1),this.stepsY?(this.stepsY--,this.controls[this.dirY]=!0,this.controls[h.opposites[this.dirY]]=!1,this.data.verbs[this.verb][this.dirY]&&(this.dir=this.dirY)):(this.controls.up=!1,this.controls.down=!1),!this.stepsX&&!this.stepsY?(this.verb=h.verbs.FACE,this.controls={}):(this.data.bounce&&this.position.z===0&&(this.physics.vz=-6),this.can(h.verbs.WALK)&&(this.verb=h.verbs.WALK))}canInteract(t){return this.state.action&&this.state.action.dir&&t===this.state.action.dir}doInteract(){this.data.payload&&this.payload(),this.state.action.sound&&this.gamebox.player.gameaudio.hitSound(this.state.action.sound),this.state.action.verb&&this.data.verbs[this.state.action.verb]&&(this.verb=this.state.action.verb,this.dir=this.state.dir),this.state.action.shift&&this.shift()}},rt=B;var X=class extends T{constructor(t,i){super(t,i),this.paused=!1}blit(t){this.visible()&&(this.paused||(this.previousElapsed===null&&(this.previousElapsed=t),this.data.type===h.npc.FLOAT&&this.position.y--,this.applyFrame(t)))}getCel(){return[Math.abs(this.data.offsetX)+this.data.width*this.frame,Math.abs(this.data.offsetY)]}applyFrame(t){if(this.frame=0,this.data.stepsX){let i=t-this.previousElapsed;this.frame=Math.floor(i/this.data.dur*this.data.stepsX),i>=this.data.dur&&(this.data.kill?this.map.killObj("fx",this):(this.previousElapsed=t,this.frame=this.data.stepsX-1,this.data.type===h.npc.FLOAT&&(this.position.y=this.data.spawn.y)))}this.spritecel=this.getCel()}},A=X;var W=class{constructor(t){this.data=t,this.build()}build(){this.canvas=document.createElement("canvas"),this.canvas.className="_2dk__layer",this.canvas.dataset.layer=this.data.id,this.context=this.canvas.getContext("2d"),this.update(this.data.width,this.data.height)}update(t,i){this.data.width=t,this.data.height=i,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${i}px`,this.canvas.width=t,this.canvas.height=i}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}destroy(){this.clear(),this.canvas.width=0,this.canvas.height=0,this.context=null,this.canvas=null}},P=W;var j=class{constructor(t,i){this.data=t,this.map=i,this.gamebox=this.map.gamebox,this.frame=0,this.pushed=[],this.spliced=[],this.previousElapsed=null}destroy(){}blit(t){if(this.previousElapsed===null&&(this.previousElapsed=t),this.frame=0,this.data.stepsX){let i=t-this.previousElapsed;this.frame=Math.min(Math.floor(i/this.data.dur*this.data.stepsX),this.data.stepsX-1),i>=this.data.dur&&(this.previousElapsed=t,this.frame=0)}}getTile(){return[this.data.offsetX+this.frame*this.map.data.tilesize,this.data.offsetY]}canInteract(t=null){return t?this.data.actions.find(i=>i.verb===t):this.data.actions}canAttack(){return this.data.actions&&this.data.actions.find(t=>t.verb===h.verbs.ATTACK)}attack(t){this.splice(t),this.map.gamebox.smokeObject({position:{x:t[0]*this.map.data.tilesize,y:t[1]*this.map.data.tilesize},width:this.map.data.tilesize,height:this.map.data.tilesize})}splice(t){if(!this.isSpliced(t)){for(let i=this.pushed.length;i--;)if(this.pushed[i][0]===t[0]&&this.pushed[i][1]===t[1])return this.spliced.push(this.pushed[i]),this.pushed.splice(i,1),!0}}push(t){this.isPushed(t)||this.pushed.push(t)}isPushed(t){return this.pushed.find(i=>i[0]===t[0]&&i[1]===t[1])}isSpliced(t){return this.spliced.find(i=>i[0]===t[0]&&i[1]===t[1])}},nt=j;var _=class{constructor(t,i){this.data=t,this.gamebox=i,this.camera=this.gamebox.camera,this.width=this.data.width,this.height=this.data.height,this.image=v.cash(t.image),this.layers={background:null,foreground:null},this.activeTiles=[],this.fx=[],this.npcs=[],this.offset={x:0,y:0},this.build()}destroy(){Object.keys(this.layers).forEach(t=>{this.layers[t].offCanvas.destroy()}),this.layers=null,this.activeTiles.forEach(t=>{t.destroy()}),this.activeTiles=null,this.npcs.forEach(t=>{t.destroy()}),this.npcs=null,this.fx.forEach(t=>{t.destroy()}),this.fx=null,this.image=null}build(){Object.keys(this.layers).forEach(t=>{this.addLayer(t)}),this.data.fx.forEach(t=>{this.fx.push(new A(this.gamebox.player.getMergedData(t,"fx",!0),this))}),this.data.npcs.forEach(t=>{this.npcs.push(new rt(this.gamebox.player.getMergedData(t,"npcs"),this))}),this.data.tiles.forEach(t=>{this.activeTiles.push(new nt(t,this))})}addLayer(t){let i=this.gamebox.camera.width+this.data.tilesize*2,e=this.gamebox.camera.height+this.data.tilesize*2;this.layers[t]={},this.layers[t].offCanvas=new P({id:t,width:i,height:e}),this.layers[t].offCanvas.canvas.width=`${i*this.gamebox.camera.resolution}`,this.layers[t].offCanvas.canvas.height=`${e*this.gamebox.camera.resolution}`}blit(t){this.activeTiles.forEach(i=>{i.blit(t)}),this.npcs.forEach(i=>{i.blit(t)}),this.fx.forEach(i=>{i.blit(t)})}update(t){this.offset=t,this.npcs.forEach(i=>{i.update()}),this.fx.forEach(i=>{i.update()})}render(t){this.clear(),this.camera=t,this.renderBox=this.getRenderbox(t);let i=this.npcs.filter(a=>a.data.type!==h.npc.FLOAT&&a.layer==="background"),e=this.npcs.filter(a=>a.data.type===h.npc.FLOAT||a.layer==="foreground");this.renderTextures("background"),i.forEach(a=>{a.render()}),this.renderTextures("foreground"),e.forEach(a=>{a.render()}),this.fx.forEach(a=>{a.render()}),this.gamebox.player.query.get("debug")&&this.renderDebug()}renderDebug(){this.gamebox.getVisibleColliders().forEach(i=>{this.gamebox.layers.foreground.onCanvas.context.globalAlpha=.5,this.gamebox.layers.foreground.onCanvas.context.fillStyle=h.colors.red,this.gamebox.layers.foreground.onCanvas.context.fillRect(this.offset.x+i[0]*this.data.collider,this.offset.y+i[1]*this.data.collider,this.data.collider,this.data.collider)}),this.gamebox.layers.foreground.onCanvas.context.globalAlpha=1}renderTextures(t){r.drawMapTiles(this.layers[t].offCanvas.context,this.image,this.renderBox.textures[t],this.data.tilesize,this.data.tilesize),this.gamebox.layers[t].onCanvas.context.drawImage(this.layers[t].offCanvas.canvas,0,0,this.layers[t].offCanvas.canvas.width,this.layers[t].offCanvas.canvas.height,this.renderBox.bleed.x,this.renderBox.bleed.y,this.layers[t].offCanvas.canvas.width,this.layers[t].offCanvas.canvas.height)}clear(){Object.keys(this.layers).forEach(t=>{this.layers[t].offCanvas.clear()})}getRenderbox(t){let i={x:Math.floor(t.x/this.data.tilesize)-1,y:Math.floor(t.y/this.data.tilesize)-1,width:t.width+this.data.tilesize*2,height:t.height+this.data.tilesize*2,bleed:{},textures:{}};return i.bleed=this.getBleed(i,t),i.textures=this.getTextures(i,t),i}getBleed(t,i){return{x:-(i.x-t.x*this.data.tilesize),y:-(i.y-t.y*this.data.tilesize)}}getTextures(t){let i=t.height/this.data.tilesize,e=t.width/this.data.tilesize,a={};return Object.keys(this.data.textures).forEach(o=>{let n=0;for(a[o]=[];n<i;){a[o][n]=[];let d=t.y+n;if(this.data.textures[o][d]){let l=0;for(;l<e;){let p=t.x+l;if(this.data.textures[o][d][p]){let f=structuredClone(this.data.textures[o][d][p]),u=this.getActiveTile(o,[p,d],f);this.checkShiftableForeground(o,d,p)?a.background[n][l]=a.background[n][l].concat(f):a[o][n][l]=f,u&&a[o][n][l].push(u)}else a[o][n][l]=0;l++}}n++}}),a}checkShiftableForeground(t,i,e){if(t!=="foreground")return!1;if(i*this.data.tilesize<this.gamebox.hero.position.y){let o=i+1;return this.data.textures[t][o][e]?o*this.data.tilesize<this.gamebox.hero.position.y:!0}return!1}spliceActiveTile(t,i){this.getActiveTiles(t).splice(i)}getActiveTiles(t){return this.activeTiles.find(i=>i.data.group===t)}getActiveTile(t,i,e){let a=this.data.tiles.filter(o=>o.layer===t);for(let o=a.length;o--;){let n=a[o],d=e[e.length-1],l=this.getActiveTiles(n.group),p=n.stepsX,f=l.isPushed(i),u=l.isSpliced(i);if(l.pushed.length)for(let g=l.pushed.length;g--;){let b=l.pushed[g];if(b[0]===i[0]&&b[1]===i[1]&&p)return l.getTile()}if(n.offsetX===d[0]&&n.offsetY===d[1]){if(!f&&!u)return l.push(i),!0;if(u)return e.pop(),e}}}addNPC(t){this.npcs.push(t)}addFX(t){this.fx.push(t)}killObj(t,i){this[t].splice(this[t].indexOf(i),1),i.destroy(),i=null}},M=_;var G=class extends T{constructor(t,i){super(t,i),this.layer="heroground"}visible(){return!0}resetMaxV(){this.gamebox.running?(this.physics.maxv=this.physics.controlmaxvstatic*1.75,this.physics.controlmaxv=this.physics.controlmaxvstatic*1.75):(this.physics.maxv=this.physics.maxvstatic,this.physics.controlmaxv=this.physics.controlmaxvstatic)}hasWeapon(){return this.data.weapon&&this.data.weapon[this.dir]&&this.data.weapon[this.dir].length}update(){this.gamebox.handleControls(this.gamebox.player.controls,this),this.handleVelocity(),this.handleGravity(),this.applyGravity()}renderAfter(){this.is(h.verbs.ATTACK)&&this.hasWeapon()&&(this.gamebox.layers[this.layer].onCanvas.context.drawImage(this.image,Math.abs(this.data.weapon[this.dir][this.frame].offsetX),Math.abs(this.data.weapon[this.dir][this.frame].offsetY),this.data.weapon[this.dir][this.frame].width,this.data.weapon[this.dir][this.frame].height,this.offset.x+this.data.weapon[this.dir][this.frame].positionX,this.offset.y+this.data.weapon[this.dir][this.frame].positionY,this.data.weapon[this.dir][this.frame].width/this.scale,this.data.weapon[this.dir][this.frame].height/this.scale),this.frame>0&&this.gamebox.handleHeroAttackFrame()),this.gamebox.player.query.get("debug")&&this.renderAfterDebug()}renderAfterDebug(){if(this.gamebox.attacking&&this.hasWeapon()){let t=this.getWeaponbox("offset");this.gamebox.layers.foreground.onCanvas.context.globalAlpha=.5,this.gamebox.layers.foreground.onCanvas.context.fillStyle=h.colors.teal,this.gamebox.layers.foreground.onCanvas.context.fillRect(t.x,t.y,t.width,t.height),this.gamebox.layers.foreground.onCanvas.context.globalAlpha=1}}applyPosition(t,i){this.dir=i,this.position.x=t.x,this.position.y=t.y,this.applyHitbox()}applyOffset(){let t={x:Math.abs(this.map.offset.x),y:Math.abs(this.map.offset.y)};this.offset={x:this.gamebox.camera.width/2-this.width/2,y:this.gamebox.camera.height/2-this.height/2},t.x<=0&&(this.offset.x=this.position.x),t.x>=this.map.width-this.gamebox.camera.width&&(this.offset.x=this.position.x+this.map.offset.x),t.y<=0&&(this.offset.y=this.position.y),t.y>=this.map.height-this.gamebox.camera.height&&(this.offset.y=this.position.y+this.map.offset.y)}applyCycle(){this.is(h.verbs.LIFT)?this.cycle(h.verbs.LIFT,this.dir):this.gamebox.jumping?this.cycle(h.verbs.JUMP,this.dir):this.gamebox.attacking?this.cycle(h.verbs.ATTACK,this.dir):this.gamebox.running?this.cycle(h.verbs.RUN,this.dir):this.idle.x&&this.idle.y?this.face(this.dir):this.cycle(h.verbs.WALK,this.dir)}getWeaponbox(t="position"){return{x:this[t].x+this.data.weapon[this.dir][this.frame].positionX,y:this[t].y+this.data.weapon[this.dir][this.frame].positionY,width:this.data.weapon[this.dir][this.frame].width,height:this.data.weapon[this.dir][this.frame].height}}},lt=G;var Y=class{constructor(t,i=0,e=0,a=30,o=1.5,n=.1){this.player=t,this.position={x:i,y:e},this.poi={x:i,y:e},this.velocity={x:0,y:0},this.mass=n,this.stiffness=a,this.damping=o,this.errorMargin=.001,this.isResting=!1,this.sprite=null,this.previousElapsed=null,this.player.on(h.broadcast.PAUSED,()=>{this.previousElapsed=null})}bind(t){this.sprite=t}blit(t){if(this.previousElapsed===null&&(this.previousElapsed=t),Math.abs(this.position.x-this.poi.x)<this.errorMargin&&Math.abs(this.position.y-this.poi.y)<this.errorMargin){this.previousElapsed=t,this.isResting=!0;return}let e=(t-this.previousElapsed)/1e3;this.previousElapsed=t,this.isResting=!1;let a=-this.stiffness*(this.position.x-this.poi.x),o=-this.damping*this.velocity.x,n=(a+o)/this.mass,d=-this.stiffness*(this.position.y-this.poi.y),l=-this.damping*this.velocity.y,p=(d+l)/this.mass;this.velocity.x+=n*e,this.velocity.y+=p*e,this.position.x+=this.velocity.x*e,this.position.y+=this.velocity.y*e,this.sprite&&(this.sprite.position.x=this.position.x,this.sprite.position.y=this.position.y)}},D=Y;var $=class extends T{constructor(t,i){super(t,i.map),this.layer=this.data.type===h.npc.FLOAT?"foreground":"heroground",this.hero=i,this.spring=new D(this.gamebox.player,this.position.x,this.position.y,10),this.spring.bind(this)}visible(){return!0}destroy(){}blit(t){this.visible()&&(this.previousElapsed===null&&(this.previousElapsed=t),this.data.type===h.npc.WALK&&this.blitWalk(),this.data.type===h.npc.FLOAT&&this.blitFloat(),this.spring.blit(t),this.applyFrame(t))}blitFloat(){this.position.z=-(this.map.data.tilesize*2),this.hero.position.x+this.hero.width/2>this.position.x+this.width/2?this.dir="right":this.dir="left"}blitWalk(){let t=r.getDistance(this.position,this.spring.poi);(!this.hero.idle.x||!this.hero.idle.y||this.hero.idle.x&&this.hero.idle.y&&t>this.map.data.tilesize/2)&&this.data.bounce&&this.position.z===0&&(this.physics.vz=-8),Math.ceil(this.hero.position.x)>Math.floor(this.position.x)?this.dir="right":this.dir="left"}applyPosition(){this.data.type===h.npc.WALK&&this.applyWalkPosition(),this.data.type===h.npc.FLOAT&&this.applyFloatPosition()}applyFloatPosition(){let t={},i={x:this.hero.position.x+this.hero.width/2,y:this.hero.position.y+this.hero.height/2},e={x:this.position.x+this.width/2,y:this.position.y+this.height/2};this.hero.dir==="right"&&i.x>e.x&&(t.x=i.x-this.width,t.y=i.y),this.hero.dir==="left"&&i.x<e.x&&(t.x=i.x,t.y=i.y),this.hero.dir==="up"&&i.y<e.y&&(t.x=i.x-this.width/2,t.y=i.y+this.height),this.hero.dir==="down"&&i.y>e.y&&(t.x=i.x-this.width/2,t.y=i.y),t.x&&t.y&&(this.spring.poi=t)}applyWalkPosition(){let t={};this.hero.dir==="right"&&this.hero.position.x>this.position.x&&(t.x=this.hero.position.x-this.width/2,t.y=this.hero.footbox.y-(this.height-this.hero.footbox.height)),this.hero.dir==="left"&&this.hero.position.x<this.position.x&&(t.x=this.hero.position.x+this.hero.width-this.width/2,t.y=this.hero.footbox.y-(this.height-this.hero.footbox.height)),this.hero.dir==="up"&&this.hero.position.y<this.position.y&&(t.x=this.hero.position.x+this.hero.width/2-this.width/2,t.y=this.hero.position.y+this.hero.height-this.height/2),this.hero.dir==="down"&&this.hero.position.y>this.position.y&&(t.x=this.hero.position.x+this.hero.width/2-this.width/2,t.y=this.hero.position.y-this.height/2),t.x&&t.y&&(this.spring.poi=t)}},S=$;var wt=[h.verbs.GRAB,h.verbs.LIFT],kt=[h.verbs.LIFT,h.verbs.PULL,h.verbs.PUSH,h.verbs.FALL,h.verbs.ATTACK],Tt=[h.tiles.STAIRS,h.tiles.WATER,h.tiles.GRASS,h.tiles.HOLES],At=[h.tiles.STAIRS,h.tiles.GRASS],V=class{constructor(t,i,e,a,o){this.x=t,this.y=i,this.width=e,this.height=a,this.resolution=o}},K=class{constructor(t){this.player=t,this.step=1,this.offset={x:0,y:0},this.camera=new V(0,0,this.player.width*this.player.resolution,this.player.height*this.player.resolution,this.player.resolution),this.layers={background:null,heroground:null,foreground:null};let i=v.cash(this.player.heroData.map),e=this.player.heroData;this.map=new M(i,this),e.spawn=i.spawn[e.spawn],this.hero=new lt(e,this.map),Object.keys(e.sounds).forEach(a=>{this.player.gameaudio.addSound({id:a,src:e.sounds[a],channel:"sfx"})}),e.companion&&(e.companion=this.player.getMergedData(e.companion,"npcs"),e.companion.spawn={x:this.hero.position.x,y:this.hero.position.y},this.companion=new S(e.companion,this.hero)),this.dialogue=new ot(this),this.currentMusic=null,this.build(),this.initMap()}clear(){Object.keys(this.layers).forEach(t=>{this.layers[t].onCanvas.clear()})}build(){this.element=document.createElement("div"),this.element.className="_2dk__gamebox",Object.keys(this.layers).forEach(t=>{this.addLayer(t)}),this.player.screen.appendChild(this.element),this.player.screen.appendChild(this.dialogue.element)}pause(t){t?(this.hero.face(this.hero.dir),this.player.gameaudio.stopSound(this.currentMusic)):this.player.gameaudio.playSound(this.currentMusic)}addLayer(t){this.layers[t]={},this.layers[t].onCanvas=new P({id:t,width:this.camera.width,height:this.camera.height}),this.layers[t].onCanvas.canvas.width=`${this.camera.width*this.camera.resolution}`,this.layers[t].onCanvas.canvas.height=`${this.camera.height*this.camera.resolution}`,this.element.appendChild(this.layers[t].onCanvas.canvas)}initMap(){this.update(this.hero.position),this.hero.applyOffset(),this.player.gameaudio.addSound({id:this.map.data.id,src:this.map.data.sound,channel:"bgm"}),this.currentMusic=this.map.data.id,this.dialogue.auto({text:[this.map.data.name]})}blit(){}update(){}pressD(){}releaseD(){}pressA(){}holdA(){}releaseA(){}releaseHoldA(){}pressB(){}holdB(){}releaseB(){}releaseHoldB(){}smokeObject(t){let i=this.player.getMergedData({id:"smoke",kill:!0,spawn:{x:t.position.x+t.width/2-this.map.data.tilesize/2,y:t.position.y+t.height/2-this.map.data.tilesize/2}},"fx");this.map.addFX(new A(i,this.map)),this.map.addFX(new A(r.merge(i,{spawn:{x:origin.x-this.map.data.tilesize/4,y:origin.y-this.map.data.tilesize/4},vx:-8,vy:-8}),this.map)),this.map.addFX(new A(r.merge(i,{spawn:{x:origin.x+this.map.data.tilesize/4,y:origin.y-this.map.data.tilesize/4},vx:8,vy:-8}),this.map)),this.map.addFX(new A(r.merge(i,{spawn:{x:origin.x-this.map.data.tilesize/4,y:origin.y+this.map.data.tilesize/4},vx:-8,vy:8}),this.map)),this.map.addFX(new A(r.merge(i,{spawn:{x:origin.x+this.map.data.tilesize/4,y:origin.y+this.map.data.tilesize/4},vx:8,vy:8}),this.map))}getVisibleColliders(){let t=[],i=this.map.renderBox?{x:this.camera.x-this.map.data.tilesize,y:this.camera.y-this.map.data.tilesize,width:this.map.renderBox.width,height:this.map.renderBox.height}:this.camera;for(let e=this.map.data.collision.length;e--;)r.collide(i,{width:this.map.data.collider,height:this.map.data.collider,x:this.map.data.collision[e][0]*this.map.data.collider,y:this.map.data.collision[e][1]*this.map.data.collider})&&t.push(this.map.data.collision[e]);return t}getVisibleEvents(){let t=[];for(let i=this.map.data.events.length;i--;)r.collide(this.camera,{width:this.map.data.tilesize,height:this.map.data.tilesize,x:this.map.data.events[i].coords[0]*this.map.data.tilesize,y:this.map.data.events[i].coords[1]*this.map.data.tilesize})&&t.push(this.map.data.events[i]);return t}getVisibleNPCs(){let t=[];for(let i=this.map.npcs.length;i--;)r.collide(this.camera,{x:this.map.npcs[i].position.x,y:this.map.npcs[i].position.y,width:this.map.npcs[i].width,height:this.map.npcs[i].height})&&t.push(this.map.npcs[i]);return t}getVisibleActiveTiles(){let t=[];for(let i=this.map.activeTiles.length;i--;)for(let e=this.map.activeTiles[i].pushed.length;e--;)r.collide(this.camera,{width:this.map.data.tilesize,height:this.map.data.tilesize,x:this.map.activeTiles[i].pushed[e][0]*this.map.data.tilesize,y:this.map.activeTiles[i].pushed[e][1]*this.map.data.tilesize})&&t.indexOf(this.map.activeTiles[i])===-1&&t.push(this.map.activeTiles[i]);return t}checkCamera(t,i){let e=!1;return(t.x<=this.camera.x||t.x>=this.camera.x+this.camera.width-i.width)&&(e=!0),(t.y<=this.camera.y||t.y>=this.camera.y+this.camera.height-i.height)&&(e=!0),e}checkHero(t,i){let e=!1,a=r.collide(i.getHitbox(t),this.hero.hitbox);return a&&(e=a),e}checkMap(t,i){let e=i.getHitbox(t),a=this.getVisibleColliders();for(let o=a.length;o--;){let n={width:this.map.data.collider,height:this.map.data.collider,x:a[o][0]*this.map.data.collider,y:a[o][1]*this.map.data.collider,layer:"foreground"};if(r.collide(e,n))return!0}return!1}checkEvents(t,i){let e=this.getVisibleEvents();for(let a=e.length;a--;){let o={width:this.map.data.tilesize,height:this.map.data.tilesize,x:e[a].coords[0]*this.map.data.tilesize,y:e[a].coords[1]*this.map.data.tilesize},n=e[a].dir,d=e[a].type===h.events.BOUNDARY,l=d?{...i.position,width:i.width,height:i.height}:i.hitbox,p=r.collide(l,o),f=p.width*p.height/(o.width*o.height)*100,u=n?i.dir===n:!0,g=d?f>=50:f>=20;if(p&&g&&u)return Object.assign(e[a],{collides:p,amount:f})}return!1}checkNPC(t,i){let e=this.getVisibleNPCs(),a=i;r.func(i.getHitbox)&&(a=i.getHitbox(t));for(let o=e.length;o--;)if(!e[o].hero&&e[o]!==i&&r.collide(a,e[o].hitbox))return e[o];return!1}checkTiles(t,i){let e={action:[],attack:[],passive:[]};return this.getVisibleActiveTiles().forEach(o=>{let n=i;r.func(i.getFootbox)&&r.func(i.getHitbox)&&(n=Tt.indexOf(o.data.group)!==-1?i.getFootbox(t):i.getHitbox(t)),o.pushed.forEach(d=>{let l={width:this.map.data.tilesize,height:this.map.data.tilesize,x:d[0]*this.map.data.tilesize,y:d[1]*this.map.data.tilesize},p=r.collide(n,l);if(p){let f=p.width*p.height/(this.map.data.tilesize*this.map.data.tilesize)*100,u={jump:!!(o.data.actions&&o.canInteract(h.verbs.JUMP)),fall:!!(o.data.actions&&o.canInteract(h.verbs.FALL)),stop:!!(o.data.actions&&o.data.actions.find(g=>wt.indexOf(g.verb)!==-1)),group:o.data.group,coord:d,action:!!(o.data.actions&&o.data.actions.find(g=>kt.indexOf(g.verb)!==-1)),attack:!!(o.data.actions&&o.canAttack()),camera:At.indexOf(o.data.group)!==-1,amount:f,tilebox:l,collides:p,instance:o};u.action&&e.action.push(u),u.attack&&e.attack.push(u),(!u.action&&!u.attack||u.attack&&u.camera)&&e.passive.push(u)}})}),e.action.length||e.attack.length||e.passive.length?e:!1}},dt=K;var Et={linear(s){return s},swing(s){return(1-Math.cos(s*Math.PI))/2},easeInQuad(s){return s*s},easeOutQuad(s){return s*(2-s)},easeInOutQuad(s){return s<.5?2*s*s:-1+(4-2*s)*s},easeInCubic(s){return s*s*s},easeOutCubic(s){return--s*s*s+1},easeInOutCubic(s){return s<.5?4*s*s*s:(s-1)*(2*s-2)*(2*s-2)+1},easeInQuart(s){return s*s*s*s},easeOutQuart(s){return 1- --s*s*s*s},easeInOutQuart(s){return s<.5?8*s*s*s*s:1-8*--s*s*s*s},easeInQuint(s){return s*s*s*s*s},easeOutQuint(s){return 1+--s*s*s*s*s},easeInOutQuint(s){return s<.5?16*s*s*s*s*s:1+16*--s*s*s*s*s}},J=class extends H{constructor(){super(),this.sprite=null}bind(t){this.sprite=t}tween(t){let i=null,e=t.to.x-t.from.x,a=t.to.y-t.from.y;r.func(t.ease)||(t.ease=Et.linear),this.stop(),this.go(o=>{i===null&&(i=o);let n=o-i,d=e*t.ease(n/t.duration)+t.from.x,l=a*t.ease(n/t.duration)+t.from.y,p={x:d,y:l};this.sprite?(this.sprite.position.x=p.x,this.sprite.position.y=p.y,this.sprite.applyOffset()):r.func(t.update)&&t.update(p),n>=t.duration&&(this.stop(),t.complete(p))})}};var q=J;var Q=class extends dt{constructor(t){super(t),this.interact={npc:null,tile:null,fall:null,mask:null,push:0},this.parkour=null,this.attacking=!1,this.running=!1,this.jumping=!1,this.falling=!1,this.locked=!1,this.dropin=!1,this.keyTimer=null}blit(t){this.clear(),this.hero.blit(t),this.interact.mask&&this.interact.mask.blit(t),this.companion&&this.companion.blit(t),this.map.blit(t),this.interact.tile&&this.interact.tile.sprite&&this.interact.tile.spring&&this.handleThrowing(t),this.interact.npc&&this.interact.npc.sprite&&this.interact.npc.spring&&this.handleAttackNCP(t),this.dropin&&this.hero.position.z===0&&(this.dropin=!1),this.update(),this.hero.update(),this.interact.mask&&this.interact.mask.update(),this.companion&&this.companion.update(),this.map.update(this.offset),this.companion&&this.companion.data.type!==h.npc.FLOAT&&this.companion.hitbox.y<this.hero.hitbox.y&&this.companion.render(),this.hero.render(),this.interact.mask&&this.interact.mask.render(),this.companion&&this.companion.data.type!==h.npc.FLOAT&&this.companion.hitbox.y>this.hero.hitbox.y&&this.companion.render(),this.map.render(this.camera),this.companion&&this.companion.data.type===h.npc.FLOAT&&this.companion.render()}update(){let t=this.hero.position.x-(this.camera.width/2-this.hero.width/2),i=this.hero.position.y-(this.camera.height/2-this.hero.height/2),e={};t>=0&&t<=this.map.width-this.camera.width?e.x=-t:t>=this.map.width-this.camera.width?e.x=-(this.map.width-this.camera.width):e.x=0,i>=0&&i<=this.map.height-this.camera.height?e.y=-i:i>=this.map.height-this.camera.height?e.y=-(this.map.height-this.camera.height):e.y=0,this.offset=e,this.camera.x=Math.abs(e.x),this.camera.y=Math.abs(e.y)}pressD(t){if(this.dropin)return;let i=this.hero.getNextPoiByDir(t);this.handleHero(i,t)}releaseD(){this.locked||this.jumping||this.falling||this.attacking||this.dropin||(this.running&&(this.running=!1,this.hero.resetMaxV()),this.interact.push&&(this.interact.push=0),this.interact.tile?this.hero.cycle(this.hero.verb,this.hero.dir):this.hero.face(this.hero.dir))}pressA(){if(this.locked||this.jumping||this.falling||this.attacking||this.dropin||this.dialogue.active)return;let t=this.hero.getNextPoiByDir(this.hero.dir,1),i={npc:this.checkNPC(t,this.hero),tiles:this.checkTiles(t,this.hero)};i.npc?this.handleHeroNPCAction(t,this.hero.dir,i.npc):i.tiles&&i.tiles.action.length&&i.tiles.action[0].action&&i.tiles.action[0].instance.canInteract(h.verbs.LIFT)&&this.hero.can(h.verbs.LIFT)&&this.hero.can(h.verbs.GRAB)&&!this.interact.tile?(this.interact.tile=i.tiles.action[0],this.hero.cycle(h.verbs.GRAB,this.hero.dir)):!this.hero.is(h.verbs.LIFT)&&!this.hero.is(h.verbs.GRAB)&&this.handleHeroJump(t,this.hero.dir)}holdA(){r.log("A Hold"),this.jumping||this.falling||this.attacking||this.dropin}releaseA(){this.jumping||this.falling||this.attacking||this.dropin||(this.dialogue.check(!0,!1),this.handleReleaseA())}releaseHoldA(){r.log("A Hold Release"),!(this.jumping||this.falling||this.attacking||this.dropin)&&this.handleReleaseA()}handleReleaseA(){this.jumping||this.attacking||this.dropin||this.running||(this.hero.is(h.verbs.GRAB)&&this.hero.face(this.hero.dir),this.hero.is(h.verbs.LIFT)?this.interact.tile.throw?this.handleHeroThrow():this.interact.tile.throw=!0:this.interact.tile=null)}pressB(){if(!(this.attacking||this.dropin||this.dialogue.active)&&!this.jumping&&!this.hero.is(h.verbs.LIFT))switch(this.player.data.bButton){case h.verbs.RUN:this.handleHeroRun();break;case h.verbs.ATTACK:this.handleHeroAttack();break}}holdB(){r.log("B Hold"),!(this.jumping||this.falling||this.attacking||this.dropin)&&this.player.data.bButton===h.verbs.RUN&&this.handleHeroRun()}releaseB(){this.jumping||this.falling||this.dropin||(this.running&&(this.running=!1,this.hero.resetMaxV()),this.attacking&&(this.attacking=!1),this.dialogue.check(!1,!0))}releaseHoldB(){r.log("B Hold Release"),!(this.jumping||this.falling||this.dropin)&&(this.running&&(this.running=!1,this.hero.resetMaxV()),this.attacking&&(this.attacking=!1))}canHeroMoveWhileJumping(t,i,e){return!e.map&&!e.npc&&!e.camera&&!(e.tiles&&e.tiles.action.length&&e.tiles.action.find(a=>a.stop))}canHeroResetMaxV(){return this.hero.physics.maxv!==this.hero.physics.controlmaxv&&!this.hero.is(h.verbs.LIFT)}canHeroEventDoor(t,i,e){return e.event.type===h.events.DOOR}canHeroEventBoundary(t,i,e){return e.event.type===h.events.BOUNDARY&&e.camera}canHeroEventDialogue(t,i,e){return e.event.type===h.events.DIALOGUE&&e.event.payload}canHeroTileStop(t,i,e){return e.tiles&&e.tiles.action.length&&e.tiles.action.find(a=>a.stop)}canHeroTileFall(t,i,e){return e.tiles&&e.tiles.action.length&&e.tiles.action.find(a=>a.fall&&r.contains(a.tilebox,this.hero.footbox))}canHeroLift(t,i){return i===h.opposites[this.hero.dir]}canHeroTileJump(t,i,e){let a=e.tiles&&e.tiles.passive.length;if(this.hero.is(h.verbs.LIFT)||!a)return!1;let o=e.tiles.passive.filter(d=>d.jump);if(!o.length)return!1;let n=o[0];return o.length>1?o.every(d=>d.instance.canInteract(h.verbs.JUMP).dir===i):(n.collides.width>n.tilebox.width/2||n.collides.height>n.tilebox.height/2)&&n.instance.canInteract(h.verbs.JUMP).dir===i}applyHero(t,i){this.hero.applyPosition(t,i),this.hero.applyOffset(),this.hero.applyCycle()}applyHeroMask(){if(this.interact.mask){let t=this.hero.position.x+(this.hero.width-this.interact.mask.width)/2,i=this.hero.position.y+(this.hero.height-this.interact.mask.height);this.interact.mask.position.x=t,this.interact.mask.position.y=i,this.hero.isIdle()&&this.interact.mask.frame===this.interact.mask.data.stepsX-1?this.interact.mask.paused=!0:this.interact.mask.paused=!1}}handleResetHeroDirs(){C.forEach(t=>{this.player.controls[t]=!1})}handleCriticalReset(){this.keyTimer&&(clearTimeout(this.keyTimer),this.keyTimer=null),this.handleResetHeroDirs(),this.hero.face(this.hero.dir),this.parkour=!1,this.jumping=!1,this.falling=!1,this.attacking=!1,this.running=!1,this.hero.resetMaxV()}handleHero(t,i){if((this.locked||this.jumping||this.falling||this.parkour||this.dropin)&&(this.interact.push=0),this.locked||this.falling||this.parkour||this.attacking)return;let e={map:this.checkMap(t,this.hero),npc:this.checkNPC(t,this.hero),tiles:this.checkTiles(t,this.hero),event:this.checkEvents(t,this.hero),camera:this.checkCamera(t,this.hero)};if(this.jumping){this.canHeroMoveWhileJumping(t,i,e)&&this.applyHero(t,i);return}if(e.event)if(this.canHeroEventBoundary(t,i,e)){this.handleHeroEventBoundary(t,i,e.event);return}else if(this.canHeroEventDoor(t,i,e)){this.handleHeroEventDoor(t,i,e.event);return}else this.canHeroEventDialogue(t,i,e)&&this.handleHeroEventDialogue(t,i,e.event);if(e.npc){this.handleHeroPush(t,i);return}if(e.map){this.handleHeroPush(t,i);return}if(e.camera){this.handleHeroCamera(t,i);return}if(this.hero.is(h.verbs.GRAB)){this.canHeroLift(t,i,e)&&this.handleHeroLift(t,i);return}if(e.tiles){if(this.canHeroTileJump(t,i,e))this.handleHeroTileJump(t,i,e.tiles.passive.filter(a=>a.jump));else if(this.canHeroTileStop(t,i,e)){this.handleHeroPush(t,i,e.tiles.action[0]);return}else if(this.canHeroTileFall(t,i,e)){this.handleHeroFall(t,i,e.tiles);return}this.handleHeroTiles(t,i,e.tiles)}else this.canHeroResetMaxV(t,i,e)&&this.hero.resetMaxV();(!e.tiles||!e.tiles.passive.length)&&(this.interact.mask=null),this.applyHero(t,i),this.interact.mask&&this.applyHeroMask()}handleHeroJump(){this.hero.can(h.verbs.JUMP)&&(this.interact.mask=null,this.hero.resetMaxV(),this.jumping=!0,this.hero.cycle(h.verbs.JUMP,this.hero.dir),this.hero.physics.vz=-(this.map.data.tilesize/4),this.player.gameaudio.hitSound(h.verbs.JUMP),this.keyTimer=setTimeout(()=>{this.jumping=!1,this.hero.face(this.hero.dir)},this.hero.getDur(h.verbs.JUMP)))}handleHeroTileJump(t,i,e){this.handleResetHeroDirs();let a=i==="left"||i==="right"?0:1,o=i==="left"||i==="up"?-1:1,n=e[0],d=this.map.data.textures[n.instance.data.layer],l=[...n.coord];l[a]+=o;let p=d[l[1]][l[0]],f=p[p.length-1],u=f,g=n.instance.data.elevation||1;if(!n.instance.data.elevation)for(;u[0]===f[0]&&u[1]===f[1];){l[a]+=o;let k=d[l[1]][l[0]];u=k[k.length-1],g++}let b,y=[n.tilebox.x,n.tilebox.y];y[a]=y[a]+o*(this.map.data.tilesize*g);let w=this.getVisibleEvents().find(k=>k.coords[0]*this.map.data.tilesize===y[0]&&k.coords[1]*this.map.data.tilesize===y[1]),E=w&&w.type===h.events.DOOR;switch(i){case"left":b={x:y[0],y:E?y[1]-(this.hero.height-this.map.data.tilesize)/2:this.hero.position.y};break;case"right":b={x:y[0]-(this.hero.width-this.map.data.tilesize),y:E?y[1]-(this.hero.height-this.map.data.tilesize)/2:this.hero.position.y};break;case"up":b={x:E?y[0]-(this.hero.width-this.map.data.tilesize)/2:this.hero.position.x,y:y[1]};break;case"down":b={x:E?y[0]-(this.hero.width-this.map.data.tilesize)/2:this.hero.position.x,y:y[1]-(this.hero.height-this.map.data.tilesize)};break}this.jumping=!0,this.hero.cycle(h.verbs.JUMP,i),this.hero.physics.vz=-(this.map.data.tilesize/2.6667),this.player.gameaudio.hitSound("parkour"),this.parkour={},this.parkour.tween=new q,this.parkour.tween.bind(this.hero),this.parkour.tween.tween({to:b,from:{x:this.hero.position.x,y:this.hero.position.y},duration:this.hero.getDur(h.verbs.JUMP),complete:()=>{if(E)w.verb&&this.hero.can(w.verb)?(this.hero.cycle(w.verb,i),setTimeout(()=>{this.dropin=!0,this.hero.frameStopped=!1,this.jumping=!1,this.parkour=null,this.handleCriticalReset(),this.handleHeroEventDoor(t,i,w)},this.hero.getDur(w.verb))):(this.jumping=!1,this.parkour=null,this.handleCriticalReset(),this.handleHeroEventDoor(t,i,w));else{this.jumping=!1,this.parkour=null,this.hero.face(i);let k=this.player.gamepad.checkDpad();k.length&&k.forEach(gt=>{gt.dpad.forEach(yt=>{this.player.controls[yt]=!0})})}}})}handleHeroPush(t,i){if(this.interact.push++,!this.hero.is(h.verbs.LIFT)&&this.interact.push>this.map.data.tilesize){if(!this.hero.can(h.verbs.PUSH))return;this.hero.cycle(h.verbs.PUSH,i)}else this.hero.is(h.verbs.LIFT)||this.hero.cycle(h.verbs.WALK,i)}handleHeroCamera(t,i){this.hero.cycle(this.hero.verb,i)}handleHeroEventDoor(t,i,e){this.changeMap(e),this.player.stop()}handleHeroEventBoundary(t,i,e){this.changeMap(e),this.player.stop()}handleHeroEventDialogue(t,i,e){this.dialogue.auto({text:e.payload.dialogue.text}),e.sound&&(this.player.gameaudio.stopSound(this.currentMusic),this.currentMusic=e.sound.split("/").pop().split(".")[0],this.player.gameaudio.addSound({id:this.currentMusic,src:e.sound,channel:"sfx"}),this.player.gameaudio.playSound(this.currentMusic))}handleHeroLift(t,i){this.locked=!0,this.hero.cycle(h.verbs.PULL,i),setTimeout(()=>{let a=this.map.getActiveTiles(this.interact.tile.group).getTile();this.player.gameaudio.hitSound(h.verbs.LIFT),this.map.spliceActiveTile(this.interact.tile.group,this.interact.tile.coord),this.interact.tile.sprite=new T({type:h.npc.FLOAT,layer:"foreground",width:this.map.data.tilesize,height:this.map.data.tilesize,spawn:{x:this.interact.tile.coord[0]*this.map.data.tilesize,y:this.interact.tile.coord[1]*this.map.data.tilesize},image:this.map.data.image,hitbox:{x:0,y:0,width:this.map.data.tilesize,height:this.map.data.tilesize},verbs:{face:{down:{offsetX:a[0],offsetY:a[1]}}}},this.map),this.interact.tile.sprite.hero=this.hero,this.map.addNPC(this.interact.tile.sprite),this.hero.cycle(h.verbs.LIFT,this.hero.dir),this.hero.physics.maxv=this.hero.physics.controlmaxv/2,this.locked=!1},this.hero.getDur(h.verbs.LIFT))}handleHeroThrow(){this.hero.face(this.hero.dir),this.player.gameaudio.hitSound(h.verbs.THROW),this.hero.physics.maxv=this.hero.physics.controlmaxv,this.handleThrow(this.interact.tile.sprite)}handleHeroRun(){this.player.gamepad.checkDpad().length&&(this.running||!this.hero.is(h.verbs.WALK)&&!this.hero.can(h.verbs.RUN)||(this.running=!0,this.hero.cycle(h.verbs.RUN,this.hero.dir),this.hero.physics.maxv=this.hero.physics.controlmaxvstatic*1.75,this.hero.physics.controlmaxv=this.hero.physics.controlmaxvstatic*1.75))}handleHeroAttack(){this.attacking||this.hero.can(h.verbs.ATTACK)&&(this.attacking=!0,this.hero.resetElapsed=!0,this.hero.cycle(h.verbs.ATTACK,this.hero.dir),this.player.gameaudio.hitSound(h.verbs.ATTACK),setTimeout(()=>{this.hero.face(this.hero.dir)},this.hero.getDur(h.verbs.ATTACK)))}handleHeroAttackFrame(){let t=this.hero.getNextPoiByDir(this.hero.dir,1),i=this.hero.getWeaponbox(),e={npc:this.checkNPC(t,i),tiles:this.checkTiles(t,i)};if(e.npc&&e.npc.data.ai&&!this.interact.npc){let a={},o={x:e.npc.position.x+e.npc.width/2,y:e.npc.position.y+e.npc.height/2},n={x:this.hero.hitbox.x+this.hero.hitbox.width/2,y:this.hero.hitbox.y+this.hero.hitbox.height/2},d=Math.atan2(o.y-n.y,o.x-n.x),l=this.map.data.tilesize;a.x=o.x+Math.cos(d)*l,a.y=o.y+Math.sin(d)*l,this.interact.npc={},this.interact.npc.sprite=e.npc,this.interact.npc.sprite.attacked=!0,this.interact.npc.spring=new D(this.player,e.npc.position.x,e.npc.position.y,120,3.5),this.interact.npc.spring.poi=a}e.tiles&&e.tiles.attack.length&&e.tiles.attack.forEach(a=>{a.attack&&this.handleHeroTileAttack(t,this.hero.dir,a)})}handleAttackNCP(t){if(this.interact.npc.spring.isResting)this.interact.npc.sprite.attacked=!1,this.interact.npc.sprite.stats&&(this.interact.npc.sprite.stats.health-=this.hero.data.stats.power,this.interact.npc.sprite.stats.health<=0&&(this.smokeObject(this.interact.npc.sprite),this.player.gameaudio.hitSound(h.verbs.SMASH),this.map.killObj("npcs",this.interact.npc.sprite))),this.interact.npc=null;else{this.interact.npc.spring.blit(t);let i={map:this.checkMap(this.interact.npc.spring.position,this.interact.npc.sprite),npc:this.checkNPC(this.interact.npc.spring.position,this.interact.npc.sprite),tiles:this.checkTiles(this.interact.npc.spring.position,this.interact.npc.sprite),camera:this.checkCamera(this.interact.npc.spring.position,this.interact.npc.sprite)};!i.map&&!i.npc&&!i.camera&&!this.canHeroTileStop(this.interact.npc.sprite.position,null,i)&&(this.interact.npc.sprite.position.x=this.interact.npc.spring.position.x,this.interact.npc.sprite.position.y=this.interact.npc.spring.position.y)}}handleHeroFall(t,i,e){this.handleResetHeroDirs();let a=this.hero.getDur(h.verbs.FALL),n=e.action.find(k=>k.fall).coord,d=r.getSurroundingTileCoords(n),l;switch(i){case"up":l=d.bottom;break;case"down":l=d.top;break;case"left":l=d.right;break;case"right":l=d.left;break}let p=(this.hero.width-this.map.data.tilesize)/2,f=this.hero.height-this.map.data.tilesize,u={x:l.x*this.map.data.tilesize-p,y:l.y*this.map.data.tilesize-f},g=n[0]*this.map.data.tilesize,b=n[1]*this.map.data.tilesize,y=(this.hero.height-this.map.data.tilesize)/2,w=(this.hero.width-this.map.data.tilesize)/2,E={x:g-w,y:b-y};this.falling=!0,this.interact.fall={},this.interact.fall.tween=new q,this.interact.fall.tween.bind(this.hero),this.interact.fall.tween.tween({to:E,from:{x:this.hero.position.x,y:this.hero.position.y},duration:a/2,complete:()=>{setTimeout(()=>{this.interact.fall.tween.tween({to:u,from:E,duration:a/2,complete:()=>{this.falling=!1,this.hero.frameStopped=!1,this.interact.fall=null,this.hero.face(this.hero.dir)}})},a/2)}}),this.hero.cycle(h.verbs.FALL,this.hero.dir)}handleHeroTiles(t,i,e){if(this.jumping||this.hero.isJumping())return;e.passive.forEach(o=>{o.instance.data.friction&&(this.hero.physics.maxv=this.hero.physics.controlmaxv/o.instance.data.friction)});let a=e.passive.find(o=>o.instance.data.mask);if(a){let o=this.player.data.fx.find(n=>n.id===a.instance.data.mask);o&&!this.interact.mask&&(this.interact.mask=new A({...o,spawn:{x:this.hero.position.x,y:this.hero.position.y}},this.map))}}handleHeroNPCAction(t,i,e){e.canInteract(i)&&e.doInteract(i)}handleHeroTileAttack(t,i,e){e.instance.canAttack()&&e.instance.attack(e.coord)}handleControls(t,i){t.left?(i.physics.vx=r.limit(i.physics.vx-i.speed,-i.physics.controlmaxv,i.physics.controlmaxv),i.idle.x=!1):t.right?(i.physics.vx=r.limit(i.physics.vx+i.speed,-i.physics.controlmaxv,i.physics.controlmaxv),i.idle.x=!1):i.idle.x=!0,t.up?(i.physics.vy=r.limit(i.physics.vy-i.speed,-i.physics.controlmaxv,i.physics.controlmaxv),i.idle.y=!1):t.down?(i.physics.vy=r.limit(i.physics.vy+i.speed,-i.physics.controlmaxv,i.physics.controlmaxv),i.idle.y=!1):i.idle.y=!0}handleThrow(t){t.throwing=this.hero.dir;let i,e,a=this.map.data.tilesize*2;t.throwing==="left"&&(i=t.position.x-a,e=t.hero.footbox.y-(t.height-this.hero.footbox.height)),t.throwing==="right"&&(i=t.position.x+a,e=t.hero.footbox.y-(t.height-this.hero.footbox.height)),t.throwing==="up"&&(i=t.position.x,e=t.position.y-a),t.throwing==="down"&&(i=t.position.x,e=this.hero.footbox.y+a),this.interact.tile.spring=new D(this.player,t.position.x,t.position.y,60,3.5),this.interact.tile.spring.poi={x:i,y:e},this.interact.tile.spring.bind(t)}handleThrowing(t){if(this.interact.tile.spring.isResting)this.handleThrew();else{let i={map:this.checkMap(this.interact.tile.sprite.position,this.interact.tile.sprite),npc:this.checkNPC(this.interact.tile.sprite.position,this.interact.tile.sprite),camera:this.checkCamera(this.interact.tile.sprite.position,this.interact.tile.sprite)};i.map||i.npc||i.camera?this.handleThrew():this.interact.tile.spring.blit(t)}}handleThrew(){this.smokeObject(this.interact.tile.sprite),this.player.gameaudio.hitSound(h.verbs.SMASH),this.map.killObj("npcs",this.interact.tile.sprite),this.interact.tile=null}getNewHeroPosition(){if(this.hero.dir==="down")return{x:this.hero.position.x,y:0,z:0};if(this.hero.dir==="up")return{x:this.hero.position.x,y:this.map.height-this.hero.height,z:0};if(this.hero.dir==="right")return{x:0,y:this.hero.position.y,z:0};if(this.hero.dir==="left")return{x:this.map.width-this.hero.width,y:this.hero.position.y,z:0}}changeMap(t){this.player.pause(),this.player.element.classList.add("is-fader"),this.player.emit(h.broadcast.MAPEVENT,t),setTimeout(()=>{let i=v.cash(t.map),e=this.getNewHeroPosition();if(this.hero.position.x=r.def(t.spawn)?i.spawn[t.spawn].x:e.x,this.hero.position.y=r.def(t.spawn)?i.spawn[t.spawn].y:e.y,this.map.destroy(),this.map=new M(i,this),this.hero.map=this.map,this.initMap(),this.dropin&&(this.hero.position.z=-(this.camera.height/2)),this.companion){let a=structuredClone(this.hero.data.companion);a.spawn={x:this.hero.position.x,y:this.hero.position.y},this.companion.destroy(),this.companion=new S(a,this.hero)}this.player.element.classList.remove("is-fader"),this.player.resume()},1e3)}},ct=Q;var Z=class{constructor(t){this.player=t,this.sounds={},this.build()}build(){this.player.device||(this.channels={bgm:{node:new Audio,open:!1},sfx:{node:new Audio,open:!1}},this.channels.bgm.node.loop=!0,this.channels.bgm.node.volume=.4,this.channels.sfx.node.loop=!1,this.channels.sfx.node.volume=.6)}addSound(t){this.player.device||this.sounds[t.id]||(this.sounds[t.id]=t,this.sounds[t.id].playing=!1)}hitSound(t){let i=this.sounds[t];if(i){let e=this.channels[i.channel];e.node.src=i.src,e.node.play()}}playSound(t){let i=this.sounds[t];if(i&&!i.playing){let e=this.channels[i.channel],a=e.node.src.split("/").pop();i.src.split("/").pop()!==a&&(e.node.src=i.src),this.sounds[t].playing=!0,e.node.play()}}stopSound(t){let i=this.sounds[t];if(i&&i.playing){let e=this.channels[i.channel];this.sounds[t].playing=!1,e.node.pause()}}},pt=Z;var tt=class extends H{constructor(){super(),this.ready=!1,this.paused=!0,this.stopped=!1,this.Loader=v,this.controls={a:!1,aHold:!1,b:!1,bHold:!1,left:!1,right:!1,up:!1,down:!1},this.previousElapsed=null,this.detect()}detect(){this.device=/Mobi/i.test(window.navigator.userAgent),this.installed=window.navigator.standalone||window.matchMedia("(display-mode: standalone)").matches}debug(){this.query=new URLSearchParams(window.location.search);let t=this.query.get("map"),i=this.query.get("spawn"),e=this.query.get("resolution");t&&(this.heroData.map=`maps/${t}`,this.heroData.spawn=0),e&&(this.resolution=this.getResolution(Number(e))),i&&(this.heroData.spawn=Number(i))}async load(){this.loader=new v,this.loader.loadJson("game.json").then(t=>{this.data=t,this.heroData=r.merge(this.data.heroes[this.data.hero.sprite],this.data.hero),this.resolution=this.getResolution(this.device?2:this.data.resolution),this.debug(),this.width=this.data.width/this.resolution,this.height=this.data.height/this.resolution,this.build(),this.onRotate();let i=0,e=t.bundle.filter(a=>{let o=a.split("/").pop().split(".").pop();return this.device?o!=="mp3":!0}).map(a=>this.loader.load(a).then(()=>{i++,this.splashLoad.innerHTML=this.getSplash(`Loaded ${i} of ${e.length} game resources...`)}));Promise.all(e).then(()=>{this.splashLoad.innerHTML=this.getSplash("Press Start"),this.gameaudio=new pt(this),this.gamepad=new at(this),this.data.plugin===h.plugins.TOPVIEW&&(this.gamebox=new ct(this)),this.bind(),Promise.resolve()})})}getResolution(t){return t>this.data.maxresolution?this.data.maxresolution:t}getSplash(t){return`
            <div>
                <div>${this.data.name}: Save #${this.data.save}, Release v${this.data.release}</div>
                <div>${t}</div>
            </div>
        `}getMergedData(t,i,e=!1){let a=this.data[i].find(o=>o.id===t.id);return a?r.merge(a,t,e):t}build(){this.element=document.createElement("div"),this.element.className="_2dk",this.element.dataset.resolution=this.resolution,this.screen=document.createElement("div"),this.screen.className="_2dk__screen",this.screen.style.width=`${this.width}px`,this.screen.style.height=`${this.height}px`,this.splash=document.createElement("div"),this.splash.className="_2dk__splash",this.splashInfo=document.createElement("div"),this.splashInfo.className="_2dk__splash__info",this.splashInfo.innerHTML=`<div>Rotate to Landscape.</div><div>${this.installed?"Webapp Installed":"Install Webapp"}</div>`,this.splashLoad=document.createElement("div"),this.splashLoad.className="_2dk__splash__load",this.splashLoad.innerHTML=this.getSplash("Loading game bundle..."),this.splashUpdate=document.createElement("div"),this.splashUpdate.className="_2dk__splash__update",this.splashUpdate.innerHTML="<div>Update Available</div>",this.splash.appendChild(this.splashInfo),this.splash.appendChild(this.splashLoad),this.splash.appendChild(this.splashUpdate),this.element.appendChild(this.splash),this.element.appendChild(this.screen),document.body.appendChild(this.element)}bind(){this.gamepad.on("left-press",this.onDpadPress.bind(this)),this.gamepad.on("right-press",this.onDpadPress.bind(this)),this.gamepad.on("up-press",this.onDpadPress.bind(this)),this.gamepad.on("down-press",this.onDpadPress.bind(this)),this.gamepad.on("left-release",this.onDpadRelease.bind(this)),this.gamepad.on("right-release",this.onDpadRelease.bind(this)),this.gamepad.on("up-release",this.onDpadRelease.bind(this)),this.gamepad.on("down-release",this.onDpadRelease.bind(this)),this.gamepad.on("start-press",this.onPressStart.bind(this)),this.gamepad.on("a-press",this.onPressA.bind(this)),this.gamepad.on("a-release",this.onReleaseA.bind(this)),this.gamepad.on("a-holdpress",this.onPressHoldA.bind(this)),this.gamepad.on("a-holdrelease",this.onReleaseHoldA.bind(this)),this.gamepad.on("b-press",this.onPressB.bind(this)),this.gamepad.on("b-holdpress",this.onPressHoldB.bind(this)),this.gamepad.on("b-release",this.onReleaseB.bind(this)),this.gamepad.on("b-holdrelease",this.onReleaseHoldB.bind(this)),window.onresize=this.onRotate.bind(this)}pause(){this.paused=!0,this.gamepad.clear(),this.gamebox.pause(!0)}stop(){this.stopped=!0,this.gamepad.clear(),this.gamebox.pause(!0)}resume(){this.paused=!1,this.stopped=!1,this.gamebox.pause(!1)}onRotate(){window.screen.orientation.type.includes("landscape")&&this.ready?this.resume():this.ready&&(this.pause(),this.stop())}onReady(){this.ready||(this.ready=!0,this.element.classList.add("is-started"),this.go(this.onGameBlit.bind(this)))}onGameBlit(t){if(this.previousElapsed=t,this.stopped||this.gamebox.blit(t),!this.paused){let i=this.gamepad.checkDpad();i.length?i.forEach(e=>{e.dpad.forEach(a=>{this.gamebox.pressD(a)})}):(this.gamebox.releaseD(),this.gamebox.handleHero(this.gamebox.hero.getNextPoi(),this.gamebox.hero.dir)),this.controls.aHold?this.gamebox.holdA():this.controls.a&&this.gamebox.pressA(),this.controls.bHold?this.gamebox.holdB():this.controls.b&&this.gamebox.pressB()}}onPressStart(){this.ready||this.onReady(),this.paused?(this.resume(),this.emit(h.broadcast.RESUMED)):(this.pause(),this.stop(),this.emit(h.broadcast.PAUSED))}onDpadPress(t){this.controls[t]=!0}onDpadRelease(t){this.controls[t]=!1}onPressA(){this.controls.a=!0}onPressHoldA(){this.controls.aHold=!0}onReleaseA(){this.controls.a=!1,this.gamebox.releaseA&&this.gamebox.releaseA()}onReleaseHoldA(){this.controls.a=!1,this.controls.aHold=!1,this.gamebox.releaseHoldA&&this.gamebox.releaseHoldA()}onPressB(){this.controls.b=!0}onPressHoldB(){this.controls.bHold=!0}onReleaseB(){this.controls.b=!1,this.controls.bHold=!1,this.gamebox.releaseB&&this.gamebox.releaseB()}onReleaseHoldB(){this.controls.b=!1,this.controls.bHold=!1,this.gamebox.releaseHoldB&&this.gamebox.releaseHoldB()}},ut=tt;var it=class{constructor(t){this.player=t,this.scope=window.location.pathname.replace(/index\.html$/,""),this.config={scope:this.scope},this.worker=`${this.scope}sw.js`}update(t){this.player.splashUpdate.classList.add("has-update"),this.player.splashUpdate.addEventListener("click",()=>{t.waiting&&t.waiting.postMessage("SKIP_WAITING")})}register(){if(r.dev()){r.log("[2dk] Skip service worker for studio dev demo!");return}"serviceWorker"in navigator?navigator.serviceWorker.register(this.worker,this.config).then(t=>{t.waiting&&(r.log("[2dk] Service worker installed."),this.update(t)),t.addEventListener("updatefound",()=>{t.installing&&t.installing.addEventListener("statechange",()=>{t.waiting&&(navigator.serviceWorker.controller?this.update(t):r.log("[2dk] Service worker initialized for the first time"))})});let i=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{i||(window.location.reload(),i=!0)})}).catch(t=>{r.error(`[2dk] Service worker failed with ${t}`)}):r.log("[2dk] Service workers not available!")}deregister(){navigator.serviceWorker.getRegistrations().then(t=>{t.forEach(i=>{i.unregister().then(e=>{r.log("[2dk] Unregistered Service Worker",e)})})})}},ft=it;var et=class{constructor(){window.onload=()=>{this.player=new ut,this.gameworker=new ft(this.player),this.player.load().then(()=>{this.gameworker.register()})}}},mt=new et;window.app2dk=mt;var te=mt;})();
