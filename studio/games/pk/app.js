(()=>{"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function i(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}function s(t,e){return s=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},s(t,e)}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&s(t,e)}function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(t)}function o(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function h(t,e){return!e||"object"!==n(e)&&"function"!=typeof e?o(t):e}function r(t){return r=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},r(t)}var l=window.getComputedStyle(document.documentElement),c=function(t){return l.getPropertyValue(t)};const d={verbs:{PUSH:"push",PULL:"pull",GRAB:"grab",LIFT:"lift",WALK:"walk",FACE:"face",JUMP:"jump",FALL:"fall",THROW:"throw",SMASH:"smash",ATTACK:"attack"},tiles:{HOLES:"holes",GRASS:"grass",WATER:"water",LEDGE:"ledge",STAIRS:"stairs",SWITCH:"switch"},keys:{A:88,B:90,UP:38,HOME:72,DOWN:40,LEFT:37,RIGHT:39,START:13,SELECT:32,UPLEFT:111,UPRIGHT:222,DOWNLEFT:333,DOWNRIGHT:444},plugins:{TOPVIEW:"topview"},events:{DOOR:"door",WARP:"warp",BOUNDARY:"boundary",CUTSCENE:"cutscene"},broadcast:{PAUSED:"paused",RESUMED:"resumed",MAPEVENT:"mapevent"},npc:{ROAM:"roam",FLOAT:"float",WANDER:"wander"},facing:{UP:"up",DOWN:"down",LEFT:"left",RIGHT:"right"},opposites:{y:"x",x:"y",up:"down",down:"up",left:"right",right:"left"},colors:{red:c("--red"),grey:c("--grey"),blue:c("--blue"),teal:c("--teal"),pink:c("--pink"),black:c("--black"),green:c("--green"),white:c("--white"),purple:c("--purple"),yellow:c("--yellow"),greyDark:c("--grey-dark"),blueDark:c("--blue-dark"),charcoal:c("--charcoal"),charcoal2:c("--charcoal2")}};var u={dev:function(){return/^file:|^http:\/\/localhost/.test(window.location.href)},log:function(){if(u.dev()){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];console.log.apply(console,e)}},func:function(t){return"function"==typeof t},def:function(t){return void 0!==t},error:function(){if(u.dev()){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];console.error.apply(console,e)}},merge:function(t,e,i){return t=structuredClone(t),e=structuredClone(e),Object.keys(e).forEach((function(s){t[s]&&!i||(t[s]=e[s])})),t},contains:function(t,e){var i=!1;return e.x+e.width<=t.x+t.width&&e.x>=t.x&&e.y+e.height<=t.y+t.height&&e.y>=t.y&&(i=!0),i},collide:function(t,e){var i=!1;return t.x<e.x+e.width&&t.x+t.width>e.x&&t.y<e.y+e.height&&t.height+t.y>e.y&&(i={x:Math.max(0,t.x-e.x),y:Math.max(0,t.y-e.y),width:Math.min(e.width,t.x-e.x+t.width)-Math.max(0,t.x-e.x),height:Math.min(e.height,t.y-e.y+t.height)-Math.max(0,t.y-e.y)}),i},drawTileCel:function(t,e,i,s,a,n,o,h){t.drawImage(e,a,n,i,i,o*s,h*s,s,s)},drawMapTile:function(t,e,i,s,a,n,o){if(Array.isArray(i))for(var h=0,r=i.length;h<r;h++)this.drawTileCel(t,e,s,a,i[h][0],i[h][1],n,o);else t.clearRect(n*a,o*a,a,a)},drawMapTiles:function(t,e,i,s,a){for(var n=i.length;n--;)for(var o=i[n],h=o.length;h--;){var r=o[h];this.drawMapTile(t,e,r,s,a,h,n)}},getParams:function(t){var e=decodeURIComponent(t).match(/[#|?].*$/g),i={};if(e)for(var s=(e=(e=e[0].replace(/^\?|^#|^\/|\/$|\[|\]/g,"")).split("&")).length;s--;){var a=e[s].split("="),n=a[0],o=a[1];i[n]?(Array.isArray(i[n])||(i[n]=[i[n]]),i[n].push(o)):i[n]=o}return i},random:function(t,e){return t+Math.floor(Math.random()*e)},limit:function(t,e,i){return t<e?e:t>i?i:t},goToZero:function(t){return t?t-t/Math.abs(t):0},getDistance:function(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}};const p=u,f=function(){function e(){t(this,e),this.handlers={},this.animate=null,this.started=!1,this.cycle=null}return i(e,[{key:"go",value:function(t){var e=this;if(this.started)return this;this.started=!0,this.animate=function(i){e.cycle=window.requestAnimationFrame(e.animate),p.func(t)&&t(i)},this.cycle=window.requestAnimationFrame(this.animate)}},{key:"stop",value:function(){window.cancelAnimationFrame(this.cycle),this.animate=null,this.started=!1,this.cycle=null}},{key:"on",value:function(t,e){var i=this;t.split(" ").forEach((function(t){p.func(e)&&(i.handlers[t]||(i.handlers[t]=[]),i.handlers[t].push(e))}))}},{key:"off",value:function(t,e){if(!this.handlers[t])return this;if(e){for(var i=this.handlers[t].length;i--;)if(this.handlers[t][i]===e){this.handlers[t].splice(i,1);break}}else delete this.handlers[t]}},{key:"emit",value:function(t){for(var e=this,i=arguments.length,s=new Array(i>1?i-1:0),a=1;a<i;a++)s[a-1]=arguments[a];if(!this.handlers[t])return this;this.handlers[t].forEach((function(t){t.apply(e,s)}))}}]),e}();var y=[],v={a:{key:d.keys.A,elem:null,timer:null,touched:!1,hold:0,text:"A",gamepad:[0]},b:{key:d.keys.B,elem:null,timer:null,touched:!1,hold:0,text:"B",gamepad:[1]},start:{key:d.keys.START,elem:null,timer:null,touched:!1,hold:0,text:"Start",menu:!0,gamepad:[9]},select:{key:d.keys.SELECT,elem:null,hold:0,timer:null,touched:!1,text:"Select",menu:!0,gamepad:[8]},"up-left":{key:d.keys.UPLEFT,elem:null,timer:null,touched:!1,dpad:["left","up"]},up:{key:d.keys.UP,elem:null,timer:null,touched:!1,dpad:["up"],axes:[0,-1]},"up-right":{key:d.keys.UPRIGHT,elem:null,timer:null,touched:!1,dpad:["right","up"]},left:{key:d.keys.LEFT,elem:null,timer:null,touched:!1,dpad:["left"],axes:[-1,0]},neutral:{elem:null,dpad:[]},right:{key:d.keys.RIGHT,elem:null,timer:null,touched:!1,dpad:["right"],axes:[1,0]},"down-left":{key:d.keys.DOWNLEFT,elem:null,timer:null,touched:!1,dpad:["left","down"]},down:{key:d.keys.DOWN,elem:null,timer:null,touched:!1,dpad:["down"],axes:[0,1]},"down-right":{key:d.keys.DOWNRIGHT,elem:null,timer:null,touched:!1,dpad:["right","down"]}};const m=function(e){a(l,e);var s,n,o=(s=l,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=r(s);if(n){var i=r(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return h(this,t)});function l(e){var i;return t(this,l),(i=o.call(this)).player=e,i.build(),i.bind(),i}return i(l,[{key:"clear",value:function(){var t=this;setTimeout((function(){t.clearTouches(),t.cancelTouches()}),300)}},{key:"bind",value:function(){this.element.addEventListener("touchstart",this.onTouchStart.bind(this),!1),this.element.addEventListener("touchmove",this.onTouchMove.bind(this),!1),this.element.addEventListener("touchend",this.onTouchEnd.bind(this),!1),document.addEventListener("keyup",this.onKeyUp.bind(this),!1),document.addEventListener("keydown",this.onKeyDown.bind(this),!1),window.addEventListener("gamepadconnected",this.onGamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this.onGamepadDisconnected.bind(this))}},{key:"build",value:function(){var t=this;this.element=document.createElement("div"),this.dpad=document.createElement("div"),this.btns=document.createElement("div"),this.element.className="_2dk__gamepad",this.dpad.className="_2dk__gamepad__dpad",this.btns.className="_2dk__gamepad__btns",this.element.appendChild(this.dpad),this.element.appendChild(this.btns),Object.keys(v).forEach((function(e){v[e].btn=e.split("-"),v[e].elem=document.createElement("div"),v[e].elem.className="_2dk__gamepad__".concat(e),v[e].elem.dataset.key=v[e].key,v[e].text&&(v[e].elem.innerHTML="<span>".concat(v[e].text,"</span>")),v[e].dpad?t.dpad.appendChild(v[e].elem):t.btns.appendChild(v[e].elem)})),this.player.element.appendChild(this.element),this.player.device||(this.element.style.display="none")}},{key:"checkDpad",value:function(){var t=[];return Object.keys(v).forEach((function(e){v[e].touched&&v[e].dpad&&t.push(v[e])})),t.sort((function(t){return t.key===d.keys.UP||t.key===d.keys.DOWN?1:-1}))}},{key:"getControl",value:function(t){var e=null;return Object.keys(v).forEach((function(i){v[i].key===t&&(e=v[i])})),e}},{key:"getGamepad",value:function(t){var e=null;return Object.keys(v).forEach((function(i){v[i].gamepad&&-1!==v[i].gamepad.indexOf(t)&&(e=v[i])})),e}},{key:"getAxes",value:function(t,e){var i=null;return Object.keys(v).forEach((function(s){v[s].axes&&v[s].axes[t]===e&&(i=v[s])})),i}},{key:"getTouched",value:function(t,e){for(var i=0;i<t.length;i++){var s=document.elementFromPoint(t[i].pageX,t[i].pageY);if(Number(s.dataset.key)===e.key)return e}return null}},{key:"onTouchStart",value:function(t){t.preventDefault();for(var e=0;e<t.touches.length;e++){var i=document.elementFromPoint(t.touches[e].pageX,t.touches[e].pageY),s=Number(i.dataset.key);if(s){var a=this.getControl(s);this.startTouch(a)}}return!1}},{key:"onTouchMove",value:function(t){var e=this;t.preventDefault();for(var i=0;i<t.touches.length;i++){var s=document.elementFromPoint(t.touches[i].pageX,t.touches[i].pageY),a=Number(s.dataset.key);if(a){var n=this.getControl(a);n&&this.startTouch(n)}Object.keys(v).forEach((function(i){v[i].touched&&(e.getTouched(t.touches,v[i])||e.cancelTouch(v[i]))}))}return!1}},{key:"onTouchEnd",value:function(t){var e=this;return t.preventDefault(),t.touches.length?Object.keys(v).forEach((function(i){v[i].touched&&(e.getTouched(t.touches,v[i])||e.cancelTouch(v[i]))})):(this.clearTouches(),this.cancelTouches()),!1}},{key:"onKeyDown",value:function(t){if(-1===y.indexOf(t.keyCode)){y.push(t.keyCode);var e=this.getControl(t.keyCode);e&&this.startTouch(e)}}},{key:"onKeyUp",value:function(t){if(-1!==y.indexOf(t.keyCode)){y.splice(y.indexOf(t.keyCode),1);var e=this.getControl(t.keyCode);e&&this.cancelTouch(e)}}},{key:"handleGamepadAxes",value:function(t){var e={x:this.getAxes(0,t.axes[0]),y:this.getAxes(1,t.axes[1])};e.x&&-1===y.indexOf(e.x.key)?(y.push(e.x.key),this.startTouch(e.x)):e.x||(-1!==y.indexOf(d.keys.LEFT)&&(y.splice(y.indexOf(d.keys.LEFT),1),this.cancelTouch(v.left)),-1!==y.indexOf(d.keys.RIGHT)&&(y.splice(y.indexOf(d.keys.RIGHT),1),this.cancelTouch(v.right))),e.y&&-1===y.indexOf(e.y.key)?(y.push(e.y.key),this.startTouch(e.y)):e.y||(-1!==y.indexOf(d.keys.UP)&&(y.splice(y.indexOf(d.keys.UP),1),this.cancelTouch(v.up)),-1!==y.indexOf(d.keys.DOWN)&&(y.splice(y.indexOf(d.keys.DOWN),1),this.cancelTouch(v.down)))}},{key:"handleGamepadButtons",value:function(t){for(var e=t.buttons.length;e--;){var i=this.getGamepad(e);i&&-1===y.indexOf(i.key)&&t.buttons[e].pressed?(y.push(i.key),this.startTouch(i)):i&&-1!==y.indexOf(i.key)&&!t.buttons[e].pressed&&(y.splice(y.indexOf(i.key),1),this.cancelTouch(i))}}},{key:"onGamepadConnected",value:function(){var t=this,e=navigator.getGamepads()[0];this.stop(),this.go((function(){e=navigator.getGamepads()[0],t.handleGamepadAxes(e),t.handleGamepadButtons(e)})),p.log("GamePad Connected: ".concat(e.id),e)}},{key:"onGamepadDisconnected",value:function(){this.stop()}},{key:"clearTouches",value:function(){Object.keys(v).forEach((function(t){v[t].elem.classList.remove("is-active")}))}},{key:"cancelTouches",value:function(){var t=this;Object.keys(v).forEach((function(e){v[e].touched&&t.cancelTouch(v[e])}))}},{key:"cancelTouch",value:function(t){t.timer&&(clearInterval(t.timer),t.timer=null),t.elem.classList.remove("is-active"),t.touched=!1,this.handleTouchEnd(t)}},{key:"startTouch",value:function(t){var e=this;t.timer||(t.elem.classList.add("is-active"),t.touched=!0,this.handleTouchStart(t),Object.prototype.hasOwnProperty.call(t,"hold")&&!t.menu&&(t.timer=setInterval((function(){e.handleTouchStart(t)}),8)))}},{key:"handleTouchStart",value:function(t){var e=this;t.touched&&t.menu&&t.hold>0?t.hold++:Object.prototype.hasOwnProperty.call(t,"hold")?(t.hold++,t.hold>50?this.emit("".concat(t.btn[0],"-holdpress")):this.emit("".concat(t.btn[0],"-press"))):t.dpad?t.dpad.forEach((function(i,s){e.emit("".concat(t.btn[s],"-press"),i)})):this.emit("".concat(t.btn[0],"-press"),null)}},{key:"handleTouchEnd",value:function(t){var e=this;Object.prototype.hasOwnProperty.call(t,"hold")?(t.hold>50?this.emit("".concat(t.btn[0],"-holdrelease")):this.emit("".concat(t.btn[0],"-release")),t.hold=0):t.dpad?t.dpad.forEach((function(i,s){e.emit("".concat(t.btn[s],"-release"),i)})):this.emit("".concat(t.btn[0],"-release"),null)}}]),l}(f);var g={};const x=function(){function e(){t(this,e)}return i(e,[{key:"load",value:function(t){var e=t.split("/").pop().split(".").pop();return"png"===e?this.loadImage(t):"mp3"===e?this.loadAudio(t):"json"===e?this.loadJson(t):void 0}},{key:"loadImage",value:function(t){return new Promise((function(e,i){if(g[t])return e(g[t]);var s=new Image;s.onload=function(){g[t]=s,e(g[t])},s.onerror=function(){i()},s.src=t}))}},{key:"loadAudio",value:function(t){return new Promise((function(e){if(g[t])return e(g[t]);var i=new Audio;i.addEventListener("loadedmetadata",(function(){g[t]=!0,i=null,e(g[t])}),!1),i.muted=!0,i.volume=0,i.src=t,i.load()}))}},{key:"loadJson",value:function(t){return new Promise((function(e){if(g[t])return e(g[t]);fetch(t).then((function(i){i.json().then((function(i){g[t]=i,e(g[t])}))}))}))}}],[{key:"cash",value:function(t,e){return e&&(g[t]=e),t?g[t]:g}}]),e}();function b(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}const k=function(){function e(){t(this,e),this.data=null,this.ready=!1,this.pressed=!1,this.active=!1,this.isResolve=!1,this.resolve=null,this.reject=null,this.timeout=null,this.debounce=750,this.duration=250,this.build()}return i(e,[{key:"build",value:function(){this.element=document.createElement("div"),this.element.className="_2dk__dialogue"}},{key:"write",value:function(t){this.element.innerHTML="<p>".concat(t,"</p>")}},{key:"clear",value:function(){this.element.innerHTML=""}},{key:"auto",value:function(t){var e=this;this.active||(this.timeout&&clearTimeout(this.timeout),this.data&&this.element.classList.remove("_2dk__dialogue--".concat(this.data.type)),this.data=structuredClone(t),this.element.classList.add("_2dk__dialogue--".concat(this.data.type)),this.element.classList.add("is-texting"),this.write(this.data.text.shift()),this.timeout=setTimeout((function(){e.teardown()}),3*this.debounce))}},{key:"play",value:function(t){var e=this;if(!this.active)return this.active=!0,new Promise((function(i,s){e.data=structuredClone(t),e.isResolve=!0,e.resolve=i,e.reject=s,e.element.classList.add("_2dk__dialogue--".concat(e.data.type)),e.element.classList.add("is-texting"),e.write(e.data.text.shift()),e.timeout=setTimeout((function(){e.ready=!0}),e.debounce)}))}},{key:"check",value:function(t,e){var i=this;if(this.active&&this.ready&&(!this.active||!this.pressed)&&(this.pressed=!0,"text"===this.data.type&&(this.data.text.length?(this.write(this.data.text.shift()),this.timeout=setTimeout((function(){i.pressed=!1}),this.debounce)):(this.isResolve?this.resolve():this.reject(),this.teardown())),"prompt"===this.data.type))if(this.data.text.length){var s=[this.data.text.shift()];this.data.text.length||s.push('\n                        <span style="color: '.concat(d.colors.teal,';">A: ').concat(this.data.yes.label,'</span>, \n                        <span style="color: ').concat(d.colors.blue,';">B: ').concat(this.data.no.label,"</span>")),this.write(s.join("<br />")),this.timeout=setTimeout((function(){i.pressed=!1}),this.debounce)}else t?(this.isResolve=!0,this.data.type="text",this.data.text=this.data.yes.text,this.timeout=setTimeout((function(){i.pressed=!1,i.check(!0,!1)}),this.duration)):e&&(this.isResolve=!1,this.data.type="text",this.data.text=this.data.no.text,this.timeout=setTimeout((function(){i.pressed=!1,i.check(!1,!0)}),this.duration))}},{key:"teardown",value:function(){var t=this;this.element.classList.remove("_2dk__dialogue--".concat(this.data.type)),this.element.classList.remove("is-texting"),this.data=null,this.ready=!1,this.pressed=!1,this.isResolve=!1,this.resolve=null,this.reject=null,this.timeout=setTimeout((function(){t.clear(),t.active=!1,t.timeout=null}),this.duration)}}]),e}(),w=function(){function e(i,s){t(this,e),this.data=i,this.map=s,this.gamebox=this.map.gamebox,this.scale=this.data.scale||1,this.width=this.data.width/this.scale,this.height=this.data.height/this.scale,this.dir=this.data.dir||this.data.spawn.dir||"down",this.verb=this.data.verb||d.verbs.FACE,this.image=x.cash(this.data.image),this.speed=1,this.frame=0,this.opacity=i.opacity||1,this.position={x:this.data.spawn&&this.data.spawn.x||0,y:this.data.spawn&&this.data.spawn.y||0,z:this.data.spawn&&this.data.spawn.z||0},this.physics={vx:this.data.vx||0,vy:this.data.vy||0,vz:this.data.vz||0,maxv:this.data.maxv||4,controlmaxv:this.data.controlmaxv||4},this.offset={x:this.gamebox.offset.x+this.position.x,y:this.gamebox.offset.y+this.position.y},this.idle={x:!0,y:!0},this.hitbox={x:this.position.x+this.data.hitbox.x/this.scale,y:this.position.y+this.data.hitbox.y/this.scale,width:this.data.hitbox.width/this.scale,height:this.data.hitbox.height/this.scale},this.footbox={x:this.hitbox.x,y:this.hitbox.y+this.hitbox.height/2,width:this.hitbox.width,height:this.hitbox.height/2},this.layer=this.data.layer||"background",this.spritecel=this.getCel(),this.previousElapsed=null,this.resetElapsed=!1,this.frameStopped=!1}return i(e,[{key:"destroy",value:function(){}},{key:"visible",value:function(){return p.collide(this.gamebox.camera,{x:this.position.x,y:this.position.y,width:this.width,height:this.height})}},{key:"isHero",value:function(){return this===this.gamebox.hero}},{key:"isCompanion",value:function(){return this===this.gamebox.companion}},{key:"isLifted",value:function(){return p.def(this.hero)}},{key:"isIdle",value:function(){return this.idle.x&&this.idle.y}},{key:"blit",value:function(t){this.visible()&&(null===this.previousElapsed&&(this.previousElapsed=t),this.applyFrame(t))}},{key:"update",value:function(){this.visible()&&this.updateStack()}},{key:"updateStack",value:function(){this.handleVelocity(),this.handleGravity(),this.applyPosition(),this.applyHitbox(),this.applyOffset(),this.applyGravity()}},{key:"render",value:function(){this.visible()&&(p.func(this.renderBefore)&&this.renderBefore(),this.isHero()||this.isCompanion()||(this.data.type===d.npc.FLOAT?this.layer="foreground":this.hitbox.width*this.hitbox.height!=this.width*this.height&&(this.hitbox.y>this.gamebox.hero.hitbox.y?this.layer="foreground":this.layer="background")),this.data.shadow&&this.verb!==d.verbs.FALL&&this.gamebox.layers[this.layer].onCanvas.context.drawImage(this.image,Math.abs(this.data.shadow.offsetX),Math.abs(this.data.shadow.offsetY),this.data.width,this.data.height,this.offset.x,this.offset.y,this.width,this.height),this.opacity&&(this.gamebox.layers[this.layer].onCanvas.context.globalAlpha=this.opacity),this.gamebox.layers[this.layer].onCanvas.context.drawImage(this.image,this.spritecel[0],this.spritecel[1],this.data.width,this.data.height,this.offset.x,this.offset.y+this.position.z,this.width,this.height),this.gamebox.layers[this.layer].onCanvas.context.globalAlpha=1,p.func(this.renderAfter)&&this.renderAfter())}},{key:"cycle",value:function(t,e){this.dir=e,this.verb=t}},{key:"face",value:function(t){this.cycle(d.verbs.FACE,t)}},{key:"handleVelocity",value:function(){this.idle.x&&(this.physics.vx=p.goToZero(this.physics.vx)),this.idle.y&&(this.physics.vy=p.goToZero(this.physics.vy))}},{key:"handleGravity",value:function(){this.physics.vz++}},{key:"applyPosition",value:function(){this.isLifted()&&!this.throwing?(this.position.x=this.hero.position.x+this.hero.width/2-this.width/2,this.position.y=this.hero.position.y-this.height+42):this.isLifted()||(this.position=this.getNextPoi())}},{key:"applyHitbox",value:function(){this.hitbox.x=this.position.x+this.data.hitbox.x/this.scale,this.hitbox.y=this.position.y+this.data.hitbox.y/this.scale,this.footbox.x=this.hitbox.x,this.footbox.y=this.hitbox.y+this.hitbox.height/2}},{key:"applyOffset",value:function(){this.offset={x:this.gamebox.offset.x+this.position.x,y:this.gamebox.offset.y+this.position.y}}},{key:"applyGravity",value:function(){this.position.z=this.getNextZ(),this.position.z>0&&(this.position.z=0)}},{key:"applyFrame",value:function(t){if(!this.frameStopped){if(this.frame=0,this.resetElapsed&&(this.resetElapsed=!1,this.previousElapsed=t),this.data.verbs[this.verb][this.dir].stepsX)if(this.verb===d.verbs.LIFT&&this.isIdle())p.log("static lift...");else{var e=t-this.previousElapsed;this.frame=Math.min(Math.floor(e/this.data.verbs[this.verb].dur*this.data.verbs[this.verb][this.dir].stepsX),this.data.verbs[this.verb][this.dir].stepsX-1),e>=this.data.verbs[this.verb].dur&&(this.previousElapsed=t,this.data.verbs[this.verb].stop?this.frameStopped=!0:this.frame=0)}this.spritecel=this.getCel()}}},{key:"getCel",value:function(){return[Math.abs(this.data.verbs[this.verb][this.dir].offsetX)+this.data.width*this.frame,Math.abs(this.data.verbs[this.verb][this.dir].offsetY)]}},{key:"getDur",value:function(t){return this.data.verbs[t].dur||0}},{key:"getNextX",value:function(){return this.position.x+p.limit(this.physics.vx,-this.physics.maxv,this.physics.maxv)}},{key:"getNextY",value:function(){return this.position.y+p.limit(this.physics.vy,-this.physics.maxv,this.physics.maxv)}},{key:"getNextZ",value:function(){return this.position.z+p.limit(this.physics.vz,-this.physics.maxv,this.physics.maxv)}},{key:"getNextPoi",value:function(){return{x:this.getNextX(),y:this.getNextY(),z:this.getNextZ()}}},{key:"getNextPoiByDir",value:function(t,e){return e&&"left"===t&&(e=-this.physics.controlmaxv),e&&"right"===t&&(e=this.physics.controlmaxv),e&&"up"===t&&(e=-this.physics.controlmaxv),e&&"down"===t&&(e=this.physics.controlmaxv),e||(e=0),{x:"left"===t||"right"===t?this.getNextX()+e:this.position.x,y:"up"===t||"down"===t?this.getNextY()+e:this.position.y,z:this.position.z}}},{key:"getHitbox",value:function(t){return{x:t.x+this.data.hitbox.x/this.scale,y:t.y+this.data.hitbox.y/this.scale,width:this.hitbox.width,height:this.hitbox.height}}},{key:"getFootbox",value:function(t){return{x:t.x+this.data.hitbox.x/this.scale,y:t.y+(this.data.hitbox.y/this.scale+this.hitbox.height/2),width:this.footbox.width,height:this.footbox.height}}}]),e}();const T=function(e){a(l,e);var s,n,o=(s=l,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=r(s);if(n){var i=r(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return h(this,t)});function l(e,i){var s;return t(this,l),(s=o.call(this,e,i)).states=structuredClone(s.data.states),s.dialogue=null,s.controls={},s.counter=s.data.ai?60:0,s.cooldown=0,s.collided=!1,s.attacked=!1,s.data.stats&&(s.stats=structuredClone(s.data.stats)),s.shift(),s}return i(l,[{key:"destroy",value:function(){}},{key:"shift",value:function(){this.states.length&&(this.state=this.states.shift(),this.dir=this.state.dir,this.verb=this.state.verb)}},{key:"payload",value:function(){var t=this;this.data.payload.dialogue&&!this.dialogue&&(this.dialogue=this.gamebox.dialogue.play(this.data.payload.dialogue),this.dialogue.then((function(){t.handleDialogue()})).catch((function(){t.handleDialogue()})))}},{key:"update",value:function(){this.visible()&&(this.gamebox.handleControls(this.controls,this),this.updateStack())}},{key:"applyPosition",value:function(){var t=this.getNextPoi(),e={map:this.gamebox.checkMap(t,this),npc:this.gamebox.checkNPC(t,this),hero:this.gamebox.checkHero(t,this),tiles:this.gamebox.checkTiles(t,this)},i=e.map||e.npc||e.hero||this.gamebox.canHeroTileStop(t,null,e),s=!(e.map||e.npc||e.hero||this.gamebox.canHeroTileStop(t,null,e));i&&!this.collided&&this.data.ai===d.npc.WANDER&&(this.collided=!0,this.cooldown=240,this.counter=0,this.controls={}),e.hero&&this.data.ai===d.npc.ROAM?("left"===this.dir&&(this.gamebox.hero.physics.vx=-1),"right"===this.dir&&(this.gamebox.hero.physics.vx=1),"up"===this.dir&&(this.gamebox.hero.physics.vy=-1),"down"===this.dir&&(this.gamebox.hero.physics.vy=1)):s&&(this.position=t)}},{key:"handleDialogue",value:function(){this.dialogue=null,this.dir=this.state.dir,this.verb=this.state.verb}},{key:"canInteract",value:function(t){return this.state.action&&this.state.action.dir&&t===this.state.action.dir}},{key:"doInteract",value:function(){this.data.payload&&this.payload(),this.state.action.sound&&this.gamebox.player.gameaudio.hitSound(this.state.action.sound),this.state.action.verb&&this.data.verbs[this.state.action.verb]&&(this.verb=this.state.action.verb,this.dir=this.state.dir),this.state.action.shift&&this.shift()}}]),l}(w);const A=function(e){a(l,e);var s,n,o=(s=l,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=r(s);if(n){var i=r(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return h(this,t)});function l(e,i){return t(this,l),o.call(this,e,i)}return i(l,[{key:"blit",value:function(t){this.visible()&&(null===this.previousElapsed&&(this.previousElapsed=t),this.data.type===d.npc.FLOAT&&this.position.y--,this.applyFrame(t))}},{key:"getCel",value:function(){return[Math.abs(this.data.offsetX)+this.data.width*this.frame,Math.abs(this.data.offsetY)]}},{key:"applyFrame",value:function(t){if(this.frame=0,this.data.stepsX){var e=t-this.previousElapsed;this.frame=Math.floor(e/this.data.dur*this.data.stepsX),e>=this.data.dur&&(this.data.kill?this.map.killObj("fx",this):(this.previousElapsed=t,this.frame=this.data.stepsX-1,this.data.type===d.npc.FLOAT&&(this.position.y=this.data.spawn.y)))}this.spritecel=this.getCel()}}]),l}(w);var E=function(){function e(i,s){t(this,e),this.data=i,this.map=s,this.gamebox=this.map.gamebox,this.frame=0,this.pushed=[],this.spliced=[],this.previousElapsed=null}return i(e,[{key:"destroy",value:function(){}},{key:"blit",value:function(t){if(null===this.previousElapsed&&(this.previousElapsed=t),this.frame=0,this.data.stepsX){var e=t-this.previousElapsed;this.frame=Math.min(Math.floor(e/this.data.dur*this.data.stepsX),this.data.stepsX-1),e>=this.data.dur&&(this.previousElapsed=t,this.frame=0)}}},{key:"getTile",value:function(){return[this.data.offsetX+this.frame*this.map.data.tilesize,this.data.offsetY]}},{key:"canInteract",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return t?this.data.actions.find((function(e){return e.verb===t})):this.data.actions}},{key:"canAttack",value:function(){return this.data.actions&&this.data.actions.find((function(t){return t.verb===d.verbs.ATTACK}))}},{key:"attack",value:function(t){this.splice(t),this.map.gamebox.smokeObject({position:{x:t[0]*this.map.data.tilesize,y:t[1]*this.map.data.tilesize},width:this.map.data.tilesize,height:this.map.data.tilesize})}},{key:"splice",value:function(t){if(!this.isSpliced(t))for(var e=this.pushed.length;e--;)if(this.pushed[e][0]===t[0]&&this.pushed[e][1]===t[1])return this.spliced.push(this.pushed[e]),this.pushed.splice(e,1),!0}},{key:"push",value:function(t){this.isPushed(t)||this.pushed.push(t)}},{key:"isPushed",value:function(t){return this.pushed.find((function(e){return e[0]===t[0]&&e[1]===t[1]}))}},{key:"isSpliced",value:function(t){return this.spliced.find((function(e){return e[0]===t[0]&&e[1]===t[1]}))}}]),e}(),R=function(){function e(i){t(this,e),this.data=i,this.build()}return i(e,[{key:"build",value:function(){this.canvas=document.createElement("canvas"),this.canvas.className="_2dk__layer",this.canvas.dataset.layer=this.data.id,this.context=this.canvas.getContext("2d"),this.update(this.data.width,this.data.height)}},{key:"update",value:function(t,e){this.data.width=t,this.data.height=e,this.canvas.style.width="".concat(t,"px"),this.canvas.style.height="".concat(e,"px"),this.canvas.width=t,this.canvas.height=e}},{key:"clear",value:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}},{key:"destroy",value:function(){this.clear(),this.canvas.width=0,this.canvas.height=0,this.context=null,this.canvas=null}}]),e}();const O=function(){function e(i,s){t(this,e),this.data=i,this.gamebox=s,this.camera=this.gamebox.camera,this.width=this.data.width,this.height=this.data.height,this.image=x.cash(i.image),this.layers={background:null,foreground:null},this.activeTiles=[],this.fx=[],this.npcs=[],this.offset={x:0,y:0},this.build()}return i(e,[{key:"destroy",value:function(){var t=this;Object.keys(this.layers).forEach((function(e){t.layers[e].offCanvas.destroy()})),this.layers=null,this.activeTiles.forEach((function(t){t.destroy()})),this.activeTiles=null,this.npcs.forEach((function(t){t.destroy()})),this.npcs=null,this.fx.forEach((function(t){t.destroy()})),this.fx=null,this.image=null}},{key:"build",value:function(){var t=this;Object.keys(this.layers).forEach((function(e){t.addLayer(e)})),this.data.fx.forEach((function(e){t.fx.push(new A(t.gamebox.player.getMergedData(e,"fx",!0),t))})),this.data.npcs.forEach((function(e){t.npcs.push(new T(t.gamebox.player.getMergedData(e,"npcs"),t))})),this.data.tiles.forEach((function(e){t.activeTiles.push(new E(e,t))}))}},{key:"addLayer",value:function(t){var e=this.gamebox.camera.width+2*this.data.tilesize,i=this.gamebox.camera.height+2*this.data.tilesize;this.layers[t]={},this.layers[t].offCanvas=new R({id:t,width:e,height:i}),this.layers[t].offCanvas.canvas.width="".concat(e*this.gamebox.camera.resolution),this.layers[t].offCanvas.canvas.height="".concat(i*this.gamebox.camera.resolution)}},{key:"blit",value:function(t){this.activeTiles.forEach((function(e){e.blit(t)})),this.npcs.forEach((function(e){e.blit(t)})),this.fx.forEach((function(e){e.blit(t)}))}},{key:"update",value:function(t){this.offset=t,this.npcs.forEach((function(t){t.update()})),this.fx.forEach((function(t){t.update()}))}},{key:"render",value:function(t){this.clear(),this.camera=t,this.renderBox=this.getRenderbox(t);var e=this.npcs.filter((function(t){return t.data.type!==d.npc.FLOAT&&"background"===t.layer})),i=this.npcs.filter((function(t){return t.data.type===d.npc.FLOAT||"foreground"===t.layer}));this.renderTextures("background"),e.forEach((function(t){t.render()})),this.renderTextures("foreground"),i.forEach((function(t){t.render()})),this.fx.forEach((function(t){t.render()})),this.gamebox.player.query.debug&&this.renderDebug()}},{key:"renderDebug",value:function(){var t=this;this.gamebox.getVisibleEvents().forEach((function(e){t.gamebox.layers.foreground.onCanvas.context.globalAlpha=.5,t.gamebox.layers.foreground.onCanvas.context.fillStyle=d.colors.blue,t.gamebox.layers.foreground.onCanvas.context.fillRect(t.offset.x+e.coords[0]*t.data.tilesize,t.offset.y+e.coords[1]*t.data.tilesize,t.data.tilesize,t.data.tilesize)})),this.data.spawn.forEach((function(e){t.gamebox.layers.foreground.onCanvas.context.fillStyle=d.colors.yellow,t.gamebox.layers.foreground.onCanvas.context.fillRect(t.offset.x+e.x,t.offset.y+e.y,t.gamebox.hero.width,t.gamebox.hero.height)}));var e=this.gamebox.getVisibleActiveTiles();this.gamebox.layers.foreground.onCanvas.context.fillStyle=d.colors.pink,e.forEach((function(e){e.pushed.forEach((function(e){t.gamebox.layers.foreground.onCanvas.context.fillRect(t.offset.x+e[0]*t.data.tilesize,t.offset.y+e[1]*t.data.tilesize,t.data.tilesize,t.data.tilesize)}))})),this.gamebox.layers.foreground.onCanvas.context.globalAlpha=1}},{key:"renderTextures",value:function(t){p.drawMapTiles(this.layers[t].offCanvas.context,this.image,this.renderBox.textures[t],this.data.tilesize,this.data.tilesize),this.gamebox.layers[t].onCanvas.context.drawImage(this.layers[t].offCanvas.canvas,0,0,this.layers[t].offCanvas.canvas.width,this.layers[t].offCanvas.canvas.height,this.renderBox.bleed.x,this.renderBox.bleed.y,this.layers[t].offCanvas.canvas.width,this.layers[t].offCanvas.canvas.height)}},{key:"clear",value:function(){var t=this;Object.keys(this.layers).forEach((function(e){t.layers[e].offCanvas.clear()}))}},{key:"getRenderbox",value:function(t){var e={x:Math.floor(t.x/this.data.tilesize)-1,y:Math.floor(t.y/this.data.tilesize)-1,width:t.width+2*this.data.tilesize,height:t.height+2*this.data.tilesize,bleed:{},textures:{}};return e.bleed=this.getBleed(e,t),e.textures=this.getTextures(e,t),e}},{key:"getBleed",value:function(t,e){return{x:-(e.x-t.x*this.data.tilesize),y:-(e.y-t.y*this.data.tilesize)}}},{key:"getTextures",value:function(t){var e=this,i=t.height/this.data.tilesize,s=t.width/this.data.tilesize,a={};return Object.keys(this.data.textures).forEach((function(n){var o=0;for(a[n]=[];o<i;){a[n][o]=[];var h=t.y+o;if(e.data.textures[n][h])for(var r=0;r<s;){var l=t.x+r;if(e.data.textures[n][h][l]){var c=structuredClone(e.data.textures[n][h][l]),d=e.getActiveTile(n,[l,h],c);"foreground"===n&&h*e.data.tilesize<e.gamebox.hero.position.y?a.background[o][r]=a.background[o][r].concat(c):a[n][o][r]=c,d&&a[n][o][r].push(d)}else a[n][o][r]=0;r++}o++}})),a}},{key:"spliceActiveTile",value:function(t,e){this.getActiveTiles(t).splice(e)}},{key:"getActiveTiles",value:function(t){return this.activeTiles.find((function(e){return e.data.group===t}))}},{key:"getActiveTile",value:function(t,e,i){for(var s=this.data.tiles.filter((function(e){return e.layer===t})),a=s.length;a--;){var n=s[a],o=i[i.length-1],h=this.getActiveTiles(n.group),r=n.stepsX,l=h.isPushed(e),c=h.isSpliced(e);if(h.pushed.length)for(var d=h.pushed.length;d--;){var u=h.pushed[d];if(u[0]===e[0]&&u[1]===e[1]&&r)return h.getTile()}if(n.offsetX===o[0]&&n.offsetY===o[1]){if(!l&&!c)return h.push(e),!0;if(c)return i.pop(),i}}}},{key:"addNPC",value:function(t){this.npcs.push(t)}},{key:"addFX",value:function(t){this.fx.push(t)}},{key:"killObj",value:function(t,e){this[t].splice(this[t].indexOf(e),1),e.destroy(),e=null}}]),e}();const C=function(e){a(l,e);var s,n,o=(s=l,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=r(s);if(n){var i=r(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return h(this,t)});function l(e,i){var s;return t(this,l),(s=o.call(this,e,i)).layer="heroground",s}return i(l,[{key:"visible",value:function(){return!0}},{key:"update",value:function(){this.gamebox.handleControls(this.gamebox.player.controls,this),this.handleVelocity(),this.handleGravity(),this.applyGravity()}},{key:"renderAfter",value:function(){if(this.verb===d.verbs.ATTACK&&this.data.weapon&&this.data.weapon[this.dir].length&&this.gamebox.layers[this.layer].onCanvas.context.drawImage(this.image,Math.abs(this.data.weapon[this.dir][this.frame].offsetX),Math.abs(this.data.weapon[this.dir][this.frame].offsetY),this.data.weapon[this.dir][this.frame].width,this.data.weapon[this.dir][this.frame].height,this.offset.x+this.data.weapon[this.dir][this.frame].positionX,this.offset.y+this.data.weapon[this.dir][this.frame].positionY,this.data.weapon[this.dir][this.frame].width/this.scale,this.data.weapon[this.dir][this.frame].height/this.scale),this.gamebox.player.query.debug){if(this.gamebox.layers.foreground.onCanvas.context.globalAlpha=.25,this.gamebox.layers.foreground.onCanvas.context.fillStyle=d.colors.white,this.gamebox.layers.foreground.onCanvas.context.fillRect(this.offset.x,this.offset.y,this.width,this.height),this.gamebox.layers.foreground.onCanvas.context.globalAlpha=.5,this.gamebox.layers.foreground.onCanvas.context.fillStyle=d.colors.red,this.gamebox.layers.foreground.onCanvas.context.fillRect(this.offset.x+this.data.hitbox.x/this.scale,this.offset.y+this.data.hitbox.y/this.scale,this.hitbox.width,this.hitbox.height),this.gamebox.layers.foreground.onCanvas.context.fillStyle=d.colors.green,this.gamebox.layers.foreground.onCanvas.context.fillRect(this.offset.x+this.data.hitbox.x/this.scale,this.offset.y+this.data.hitbox.y/this.scale+this.hitbox.height/2,this.footbox.width,this.footbox.height),this.gamebox.attacking){var t=this.getWeaponbox("offset");this.gamebox.layers.foreground.onCanvas.context.fillStyle=d.colors.teal,this.gamebox.layers.foreground.onCanvas.context.fillRect(t.x,t.y,t.width,t.height)}this.gamebox.layers.foreground.onCanvas.context.globalAlpha=1}}},{key:"applyPosition",value:function(t,e){this.dir=e,this.position.x=t.x,this.position.y=t.y,this.applyHitbox()}},{key:"applyOffset",value:function(){var t=Math.abs(this.map.offset.x),e=Math.abs(this.map.offset.y);this.offset={x:this.gamebox.camera.width/2-this.width/2,y:this.gamebox.camera.height/2-this.height/2},t<=0&&(this.offset.x=this.position.x),t>=this.map.width-this.gamebox.camera.width&&(this.offset.x=this.position.x+this.map.offset.x),e<=0&&(this.offset.y=this.position.y),e>=this.map.height-this.gamebox.camera.height&&(this.offset.y=this.position.y+this.map.offset.y)}},{key:"applyCycle",value:function(){this.verb===d.verbs.LIFT?this.cycle(d.verbs.LIFT,this.dir):this.gamebox.jumping?this.cycle(d.verbs.JUMP,this.dir):this.gamebox.attacking?this.cycle(d.verbs.ATTACK,this.dir):this.idle.x&&this.idle.y?this.face(this.dir):this.cycle(d.verbs.WALK,this.dir)}},{key:"getWeaponbox",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"position",i=this.data.weapon[this.dir].reduce((function(i,s){var a=Math.abs(t[e].x+s.positionX);return a<i?a:i}),999999),s=this.data.weapon[this.dir].reduce((function(i,s){var a=Math.abs(t[e].y+s.positionY);return a<i?a:i}),999999);return{x:i,y:s,width:this.data.weapon[this.dir].reduce((function(i,s){var a=Math.abs(t[e].x+s.positionX+s.width);return a>i?a:i}),0)-i,height:this.data.weapon[this.dir].reduce((function(i,s){var a=Math.abs(t[e].y+s.positionY+s.height);return a>i?a:i}),0)-s}}}]),l}(w),P=function(){function e(i){var s=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:30,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1.5,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:.1;t(this,e),this.player=i,this.position={x:a,y:n},this.poi={x:a,y:n},this.velocity={x:0,y:0},this.mass=r,this.stiffness=o,this.damping=h,this.errorMargin=.001,this.isResting=!1,this.sprite=null,this.previousElapsed=null,this.player.on(d.broadcast.PAUSED,(function(){s.previousElapsed=null}))}return i(e,[{key:"bind",value:function(t){this.sprite=t}},{key:"blit",value:function(t){if(null===this.previousElapsed&&(this.previousElapsed=t),Math.abs(this.position.x-this.poi.x)<this.errorMargin&&Math.abs(this.position.y-this.poi.y)<this.errorMargin)return this.previousElapsed=t,void(this.isResting=!0);var e=(t-this.previousElapsed)/1e3;this.previousElapsed=t,this.isResting=!1;var i=(-this.stiffness*(this.position.x-this.poi.x)+-this.damping*this.velocity.x)/this.mass,s=(-this.stiffness*(this.position.y-this.poi.y)+-this.damping*this.velocity.y)/this.mass;this.velocity.x+=i*e,this.velocity.y+=s*e,this.position.x+=this.velocity.x*e,this.position.y+=this.velocity.y*e,this.sprite&&(this.sprite.position.x=this.position.x,this.sprite.position.y=this.position.y)}}]),e}();const H=function(e){a(c,e);var s,n,l=(s=c,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=r(s);if(n){var i=r(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return h(this,t)});function c(e,i){var s;return t(this,c),(s=l.call(this,e,i.map)).layer=s.data.type===d.npc.FLOAT?"foreground":"heroground",s.hero=i,s.spring=new P(s.gamebox.player,s.position.x,s.position.y,10),s.spring.bind(o(s)),s}return i(c,[{key:"visible",value:function(){return!0}},{key:"destroy",value:function(){}},{key:"blit",value:function(t){this.visible()&&(null===this.previousElapsed&&(this.previousElapsed=t),this.data.type===d.npc.WALK&&this.blitWalk(),this.data.type===d.npc.FLOAT&&this.blitFloat(),this.spring.blit(t),this.applyFrame(t))}},{key:"blitFloat",value:function(){this.position.z=-2*this.map.data.tilesize,this.hero.position.x+this.hero.width/2>this.position.x+this.width/2?this.dir="right":this.dir="left"}},{key:"blitWalk",value:function(){var t=p.getDistance(this.position,this.spring.poi);(!this.hero.idle.x||!this.hero.idle.y||this.hero.idle.x&&this.hero.idle.y&&t>this.map.data.tilesize/2)&&this.data.bounce&&0===this.position.z&&(this.physics.vz=-8),Math.ceil(this.hero.position.x)>Math.floor(this.position.x)?this.dir="right":this.dir="left"}},{key:"applyPosition",value:function(){this.data.type===d.npc.WALK&&this.applyWalkPosition(),this.data.type===d.npc.FLOAT&&this.applyFloatPosition()}},{key:"applyFloatPosition",value:function(){var t={},e={x:this.hero.position.x+this.hero.width/2,y:this.hero.position.y+this.hero.height/2},i=this.position.x+this.width/2,s=this.position.y+this.height/2;"right"===this.hero.dir&&e.x>i&&(t.x=e.x-this.width,t.y=e.y),"left"===this.hero.dir&&e.x<i&&(t.x=e.x,t.y=e.y),"up"===this.hero.dir&&e.y<s&&(t.x=e.x-this.width/2,t.y=e.y+this.height),"down"===this.hero.dir&&e.y>s&&(t.x=e.x-this.width/2,t.y=e.y),t.x&&t.y&&(this.spring.poi=t)}},{key:"applyWalkPosition",value:function(){var t={};"right"===this.hero.dir&&this.hero.position.x>this.position.x&&(t.x=this.hero.position.x-this.width/2,t.y=this.hero.footbox.y-(this.height-this.hero.footbox.height)),"left"===this.hero.dir&&this.hero.position.x<this.position.x&&(t.x=this.hero.position.x+this.hero.width-this.width/2,t.y=this.hero.footbox.y-(this.height-this.hero.footbox.height)),"up"===this.hero.dir&&this.hero.position.y<this.position.y&&(t.x=this.hero.position.x+this.hero.width/2-this.width/2,t.y=this.hero.position.y+this.hero.height-this.height/2),"down"===this.hero.dir&&this.hero.position.y>this.position.y&&(t.x=this.hero.position.x+this.hero.width/2-this.width/2,t.y=this.hero.position.y-this.height/2),t.x&&t.y&&(this.spring.poi=t)}}]),c}(w);function z(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,s)}return i}function L(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?z(Object(i),!0).forEach((function(e){b(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):z(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}var S=[d.verbs.GRAB,d.verbs.LIFT],M=[d.verbs.LIFT,d.verbs.PULL,d.verbs.PUSH,d.verbs.FALL,d.verbs.ATTACK],D=[d.tiles.STAIRS,d.tiles.WATER,d.tiles.GRASS,d.tiles.HOLES],j=[d.tiles.STAIRS,d.tiles.GRASS],F=i((function e(i,s,a,n,o){t(this,e),this.x=i,this.y=s,this.width=a,this.height=n,this.resolution=o}));const B=function(){function e(i){var s=this;t(this,e),this.player=i,this.step=1,this.offset={x:0,y:0},this.camera=new F(0,0,this.player.width*this.player.resolution,this.player.height*this.player.resolution,this.player.resolution),this.layers={background:null,heroground:null,foreground:null};var a=x.cash(this.player.heroData.map),n=this.player.heroData;this.map=new O(a,this),n.spawn=a.spawn[n.spawn],this.hero=new C(n,this.map),Object.keys(n.sounds).forEach((function(t){s.player.gameaudio.addSound({id:t,src:n.sounds[t],channel:"sfx"})})),n.companion&&(n.companion=this.player.getMergedData(n.companion,"npcs"),n.companion.spawn={x:this.hero.position.x,y:this.hero.position.y},this.companion=new H(n.companion,this.hero)),this.dialogue=new k,this.build(),this.initMap()}return i(e,[{key:"clear",value:function(){var t=this;Object.keys(this.layers).forEach((function(e){t.layers[e].onCanvas.clear()}))}},{key:"build",value:function(){var t=this;this.element=document.createElement("div"),this.element.className="_2dk__gamebox",Object.keys(this.layers).forEach((function(e){t.addLayer(e)})),this.player.screen.appendChild(this.element),this.player.screen.appendChild(this.dialogue.element)}},{key:"pause",value:function(t){t?(this.hero.face(this.hero.dir),this.player.gameaudio.stopSound(this.map.data.id)):this.player.gameaudio.playSound(this.map.data.id)}},{key:"addLayer",value:function(t){this.layers[t]={},this.layers[t].onCanvas=new R({id:t,width:this.camera.width,height:this.camera.height}),this.layers[t].onCanvas.canvas.width="".concat(this.camera.width*this.camera.resolution),this.layers[t].onCanvas.canvas.height="".concat(this.camera.height*this.camera.resolution),this.element.appendChild(this.layers[t].onCanvas.canvas)}},{key:"initMap",value:function(){this.update(this.hero.position),this.hero.applyOffset(),this.player.gameaudio.addSound({id:this.map.data.id,src:this.map.data.sound,channel:"bgm"}),this.dialogue.auto({text:[this.map.data.name]})}},{key:"blit",value:function(){}},{key:"update",value:function(){}},{key:"pressD",value:function(){}},{key:"releaseD",value:function(){}},{key:"pressA",value:function(){}},{key:"holdA",value:function(){}},{key:"releaseA",value:function(){}},{key:"releaseHoldA",value:function(){}},{key:"pressB",value:function(){}},{key:"holdB",value:function(){}},{key:"releaseB",value:function(){}},{key:"releaseHoldB",value:function(){}},{key:"smokeObject",value:function(t){var e=this.player.getMergedData({id:"smoke",kill:!0,spawn:{x:t.position.x+t.width/2-this.map.data.tilesize/2,y:t.position.y+t.height/2-this.map.data.tilesize/2}},"fx");this.map.addFX(new A(e,this.map)),this.map.addFX(new A(p.merge(e,{spawn:{x:origin.x-this.map.data.tilesize/4,y:origin.y-this.map.data.tilesize/4},vx:-8,vy:-8}),this.map)),this.map.addFX(new A(p.merge(e,{spawn:{x:origin.x+this.map.data.tilesize/4,y:origin.y-this.map.data.tilesize/4},vx:8,vy:-8}),this.map)),this.map.addFX(new A(p.merge(e,{spawn:{x:origin.x-this.map.data.tilesize/4,y:origin.y+this.map.data.tilesize/4},vx:-8,vy:8}),this.map)),this.map.addFX(new A(p.merge(e,{spawn:{x:origin.x+this.map.data.tilesize/4,y:origin.y+this.map.data.tilesize/4},vx:8,vy:8}),this.map))}},{key:"getVisibleColliders",value:function(){for(var t=[],e=this.map.data.collision.length;e--;)p.collide(this.camera,{width:this.map.data.collider,height:this.map.data.collider,x:this.map.data.collision[e][0]*this.map.data.collider,y:this.map.data.collision[e][1]*this.map.data.collider})&&t.push(this.map.data.collision[e]);return t}},{key:"getVisibleEvents",value:function(){for(var t=[],e=this.map.data.events.length;e--;)p.collide(this.camera,{width:this.map.data.tilesize,height:this.map.data.tilesize,x:this.map.data.events[e].coords[0]*this.map.data.tilesize,y:this.map.data.events[e].coords[1]*this.map.data.tilesize})&&t.push(this.map.data.events[e]);return t}},{key:"getVisibleNPCs",value:function(){for(var t=[],e=this.map.npcs.length;e--;)p.collide(this.camera,{x:this.map.npcs[e].position.x,y:this.map.npcs[e].position.y,width:this.map.npcs[e].width,height:this.map.npcs[e].height})&&t.push(this.map.npcs[e]);return t}},{key:"getVisibleActiveTiles",value:function(){for(var t=[],e=this.map.activeTiles.length;e--;)for(var i=this.map.activeTiles[e].pushed.length;i--;)p.collide(this.camera,{width:this.map.data.tilesize,height:this.map.data.tilesize,x:this.map.activeTiles[e].pushed[i][0]*this.map.data.tilesize,y:this.map.activeTiles[e].pushed[i][1]*this.map.data.tilesize})&&-1===t.indexOf(this.map.activeTiles[e])&&t.push(this.map.activeTiles[e]);return t}},{key:"checkCamera",value:function(t,e){var i=!1;return(t.x<=this.camera.x||t.x>=this.camera.x+this.camera.width-e.width)&&(i=!0),(t.y<=this.camera.y||t.y>=this.camera.y+this.camera.height-e.height)&&(i=!0),i}},{key:"checkHero",value:function(t,e){var i=!1,s=p.collide(e.getHitbox(t),this.hero.hitbox);return s&&(i=s),i}},{key:"checkMap",value:function(t,e){for(var i=e.getHitbox(t),s=this.getVisibleColliders(),a=s.length;a--;){var n={width:this.map.data.collider,height:this.map.data.collider,x:s[a][0]*this.map.data.collider,y:s[a][1]*this.map.data.collider,layer:"foreground"};if(p.collide(i,n))return!0}return!1}},{key:"checkEvents",value:function(t,e){for(var i=this.getVisibleEvents(),s=i.length;s--;){var a={width:this.map.data.tilesize,height:this.map.data.tilesize,x:i[s].coords[0]*this.map.data.tilesize,y:i[s].coords[1]*this.map.data.tilesize},n=i[s].dir,o=i[s].type===d.events.BOUNDARY,h=o?L(L({},e.position),{},{width:e.width,height:e.height}):e.hitbox,r=p.collide(h,a),l=r.width*r.height/(a.width*a.height)*100,c=!n||e.dir===n;if(r&&(o?l>=50:l>=20)&&c)return Object.assign(i[s],{collides:r,amount:l})}return!1}},{key:"checkNPC",value:function(t,e){var i=this.getVisibleNPCs(),s=e;p.func(e.getHitbox)&&(s=e.getHitbox(t));for(var a=i.length;a--;)if(!i[a].hero&&i[a]!==e&&p.collide(s,i[a].hitbox))return i[a];return!1}},{key:"checkTiles",value:function(t,e){var i=this,s={action:[],attack:[],passive:[]};return this.getVisibleActiveTiles().forEach((function(a){var n=e;p.func(e.getFootbox)&&p.func(e.getHitbox)&&(n=-1!==D.indexOf(a.data.group)?e.getFootbox(t):e.getHitbox(t)),a.pushed.forEach((function(t){var e={width:i.map.data.tilesize,height:i.map.data.tilesize,x:t[0]*i.map.data.tilesize,y:t[1]*i.map.data.tilesize},o=p.collide(n,e);if(o){var h=o.width*o.height/(i.map.data.tilesize*i.map.data.tilesize)*100,r={jump:!(!a.data.actions||!a.canInteract(d.verbs.JUMP)),fall:!(!a.data.actions||!a.canInteract(d.verbs.FALL)),stop:!(!a.data.actions||!a.data.actions.find((function(t){return-1!==S.indexOf(t.verb)}))),group:a.data.group,coord:t,action:!(!a.data.actions||!a.data.actions.find((function(t){return-1!==M.indexOf(t.verb)}))),attack:!(!a.data.actions||!a.canAttack()),camera:-1!==j.indexOf(a.data.group),amount:h,tilebox:e,collides:o,instance:a};r.action&&s.action.push(r),r.attack&&s.attack.push(r),(!r.action&&!r.attack||r.attack&&r.camera)&&s.passive.push(r)}}))})),!!(s.action.length||s.attack.length||s.passive.length)&&s}}]),e}();var N=function(t){return t};const _=function(e){a(l,e);var s,n,o=(s=l,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=r(s);if(n){var i=r(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return h(this,t)});function l(){var e;return t(this,l),(e=o.call(this)).sprite=null,e}return i(l,[{key:"bind",value:function(t){this.sprite=t}},{key:"tween",value:function(t){var e=this,i=null,s=t.to.x-t.from.x,a=t.to.y-t.from.y;p.func(t.ease)||(t.ease=N),this.stop(),this.go((function(n){null===i&&(i=n);var o=n-i,h={x:s*t.ease(o/t.duration)+t.from.x,y:a*t.ease(o/t.duration)+t.from.y};e.sprite?(e.sprite.position.x=h.x,e.sprite.position.y=h.y):p.func(t.update)&&t.update(h),o>t.duration&&(t.complete(h),e.stop())}))}}]),l}(f);const I=function(e){a(l,e);var s,n,o=(s=l,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=r(s);if(n){var i=r(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return h(this,t)});function l(e){var i;return t(this,l),(i=o.call(this,e)).interact={npc:null,tile:null,fall:null,push:0},i.parkour=null,i.attacking=!1,i.jumping=!1,i.falling=!1,i.locked=!1,i.dropin=!1,i.keyTimer=null,i}return i(l,[{key:"blit",value:function(t){this.clear(),this.hero.blit(t),this.companion&&this.companion.blit(t),this.map.blit(t),this.interact.tile&&this.interact.tile.sprite&&this.interact.tile.spring&&this.handleThrowing(t),this.interact.npc&&this.interact.npc.sprite&&this.interact.npc.spring&&this.handleAttackNCP(t),this.dropin&&0===this.hero.position.z&&(this.dropin=!1),this.update(),this.hero.update(),this.companion&&this.companion.update(),this.map.update(this.offset),this.companion&&this.companion.data.type!==d.npc.FLOAT&&this.companion.hitbox.y<this.hero.hitbox.y&&this.companion.render(),this.hero.render(),this.companion&&this.companion.data.type!==d.npc.FLOAT&&this.companion.hitbox.y>this.hero.hitbox.y&&this.companion.render(),this.map.render(this.camera),this.companion&&this.companion.data.type===d.npc.FLOAT&&this.companion.render()}},{key:"update",value:function(){var t=this.hero.position.x-(this.camera.width/2-this.hero.width/2),e=this.hero.position.y-(this.camera.height/2-this.hero.height/2),i={};t>=0&&t<=this.map.width-this.camera.width?i.x=-t:t>=this.map.width-this.camera.width?i.x=-(this.map.width-this.camera.width):i.x=0,e>=0&&e<=this.map.height-this.camera.height?i.y=-e:e>=this.map.height-this.camera.height?i.y=-(this.map.height-this.camera.height):i.y=0,this.offset=i,this.camera.x=Math.abs(i.x),this.camera.y=Math.abs(i.y)}},{key:"pressD",value:function(t){if(!this.dropin){var e=this.hero.getNextPoiByDir(t);this.handleHero(e,t)}}},{key:"releaseD",value:function(){this.locked||this.jumping||this.falling||this.attacking||this.dropin||(this.interact.push&&(this.interact.push=0),this.interact.tile?this.hero.cycle(this.hero.verb,this.hero.dir):this.hero.face(this.hero.dir))}},{key:"pressA",value:function(){if(!(this.locked||this.jumping||this.falling||this.attacking||this.dropin)){var t=this.hero.getNextPoiByDir(this.hero.dir,1),e={npc:this.checkNPC(t,this.hero),tiles:this.checkTiles(t,this.hero)};e.npc?this.handleHeroNPCAction(t,this.hero.dir,e.npc):e.tiles&&e.tiles.action.length&&e.tiles.action[0].action&&e.tiles.action[0].instance.canInteract(d.verbs.LIFT)&&!this.interact.tile?(this.interact.tile=e.tiles.action[0],this.hero.cycle(d.verbs.GRAB,this.hero.dir)):this.hero.verb!==d.verbs.LIFT&&this.hero.verb!==d.verbs.GRAB&&this.handleHeroJump(t,this.hero.dir)}}},{key:"holdA",value:function(){this.jumping||this.falling||this.attacking||this.dropin||p.log("A Hold")}},{key:"releaseA",value:function(){this.jumping||this.falling||this.attacking||this.dropin||(this.dialogue.check(!0,!1),this.handleReleaseA())}},{key:"releaseHoldA",value:function(){this.jumping||this.falling||this.attacking||this.dropin||this.handleReleaseA()}},{key:"pressB",value:function(){this.attacking||this.dropin||this.jumping||this.hero.verb===d.verbs.LIFT||this.handleHeroAttack()}},{key:"holdB",value:function(){this.jumping||this.falling||this.attacking||this.dropin||p.log("B Hold")}},{key:"releaseB",value:function(){this.jumping||this.falling||this.dropin||(this.attacking&&(this.attacking=!1),this.dialogue.check(!1,!0))}},{key:"releaseHoldB",value:function(){this.jumping||this.falling||this.dropin||(this.attacking&&(this.attacking=!1),p.log("B Hold Release"))}},{key:"canHeroMoveWhileJumping",value:function(t,e,i){return!(i.map||i.npc||i.camera||i.tiles&&i.tiles.action.length&&i.tiles.action.find((function(t){return t.stop})))}},{key:"canHeroResetMaxV",value:function(){return this.hero.physics.maxv!==this.hero.physics.controlmaxv&&this.hero.verb!==d.verbs.LIFT}},{key:"canHeroEventDoor",value:function(t,e,i){return i.event.type===d.events.DOOR}},{key:"canHeroEventBoundary",value:function(t,e,i){return i.event.type===d.events.BOUNDARY&&i.camera}},{key:"canHeroTileStop",value:function(t,e,i){return i.tiles&&i.tiles.action.length&&i.tiles.action.find((function(t){return t.stop}))}},{key:"canHeroTileFall",value:function(t,e,i){var s=this;return i.tiles&&i.tiles.action.length&&i.tiles.action.find((function(t){return t.fall&&p.contains(t.tilebox,s.hero.footbox)}))}},{key:"canHeroLift",value:function(t,e){return e===d.opposites[this.hero.dir]}},{key:"canHeroTileJump",value:function(t,e,i){return i.tiles&&i.tiles.passive.length&&i.tiles.passive[0].jump&&(i.tiles.passive[0].collides.width>i.tiles.passive[0].tilebox.width/2||i.tiles.passive[0].collides.height>i.tiles.passive[0].tilebox.height/2)&&this.hero.verb!==d.verbs.LIFT&&i.tiles.passive[0].instance.canInteract(d.verbs.JUMP).dir===e}},{key:"applyHero",value:function(t,e){this.hero.applyPosition(t,e),this.hero.applyOffset(),this.hero.applyCycle()}},{key:"handleReleaseA",value:function(){this.jumping||this.attacking||this.dropin||(this.hero.verb===d.verbs.GRAB&&this.hero.face(this.hero.dir),this.hero.verb===d.verbs.LIFT?this.interact.tile.throw?this.handleHeroThrow():this.interact.tile.throw=!0:this.interact.tile=null)}},{key:"handleCriticalReset",value:function(){this.keyTimer&&(clearTimeout(this.keyTimer),this.keyTimer=null),this.player.controls[this.hero.dir]=!1,this.hero.face(this.hero.dir),this.parkour=!1,this.jumping=!1,this.falling=!1,this.attacking=!1}},{key:"handleHero",value:function(t,e){var i={map:this.checkMap(t,this.hero),npc:this.checkNPC(t,this.hero),tiles:this.checkTiles(t,this.hero),event:this.checkEvents(t,this.hero),camera:this.checkCamera(t,this.hero)};if((this.locked||this.jumping||this.falling||this.parkour||this.dropin)&&(this.interact.push=0),!(this.locked||this.falling||this.parkour||this.attacking))if(this.jumping)this.canHeroMoveWhileJumping(t,e,i)&&this.applyHero(t,e);else{if(i.event){if(this.canHeroEventBoundary(t,e,i))return void this.handleHeroEventBoundary(t,e,i.event);if(this.canHeroEventDoor(t,e,i))return void this.handleHeroEventDoor(t,e,i.event)}if(i.npc)this.handleHeroPush(t,e);else if(i.map)this.handleHeroPush(t,e);else if(i.camera)this.handleHeroCamera(t,e);else if(this.hero.verb!==d.verbs.GRAB){if(i.tiles){if(this.canHeroTileJump(t,e,i))this.handleHeroTileJump(t,e,i.tiles.passive[0]);else{if(this.canHeroTileStop(t,e,i))return void this.handleHeroPush(t,e,i.tiles.action[0]);if(this.canHeroTileFall(t,e,i))return void this.handleHeroFall(t,e,i.tiles)}this.handleHeroTiles(t,e,i.tiles)}else this.canHeroResetMaxV(t,e,i)&&(this.hero.physics.maxv=this.hero.physics.controlmaxv);this.applyHero(t,e)}else this.canHeroLift(t,e,i)&&this.handleHeroLift(t,e)}}},{key:"handleHeroJump",value:function(){var t=this;this.hero.data.verbs[d.verbs.JUMP]&&(this.jumping=!0,this.hero.cycle(d.verbs.JUMP,this.hero.dir),this.hero.physics.vz=-16,this.player.gameaudio.hitSound(d.verbs.JUMP),this.keyTimer=setTimeout((function(){t.jumping=!1,t.hero.face(t.hero.dir)}),this.hero.getDur(d.verbs.JUMP)))}},{key:"handleHeroTileJump",value:function(t,e,i){var s,a,n=this;"left"===e&&(s={x:(a={x:i.tilebox.x-this.map.data.tilesize*i.instance.data.elevation,y:i.tilebox.y}).x,y:a.y-(this.hero.height-this.map.data.tilesize)/2}),"right"===e&&(s={x:(a={x:i.tilebox.x+this.map.data.tilesize*i.instance.data.elevation,y:i.tilebox.y}).x-(this.hero.width-this.map.data.tilesize),y:a.y-(this.hero.height-this.map.data.tilesize)/2}),"up"===e&&(s={x:(a={x:i.tilebox.x,y:i.tilebox.y-this.map.data.tilesize*i.instance.data.elevation}).x-(this.hero.width-this.map.data.tilesize)/2,y:a.y}),"down"===e&&(s={x:(a={x:i.tilebox.x,y:i.tilebox.y+this.map.data.tilesize*i.instance.data.elevation}).x-(this.hero.width-this.map.data.tilesize)/2,y:a.y-(this.hero.height-this.map.data.tilesize)});var o=this.getVisibleEvents().find((function(t){return t.coords[0]*n.map.data.tilesize===a.x&&t.coords[1]*n.map.data.tilesize===a.y}));["left","right","up","down"].forEach((function(t){n.player.controls[t]=!1})),this.jumping=!0,this.hero.cycle(d.verbs.JUMP,e),this.hero.physics.vz=-24,this.player.gameaudio.hitSound("parkour"),this.parkour={},this.parkour.tween=new _,this.parkour.tween.bind(this.hero),this.parkour.tween.tween({to:s,from:{x:this.hero.position.x,y:this.hero.position.y},duration:this.hero.getDur(d.verbs.JUMP),complete:function(){o?(n.hero.cycle(d.verbs.FALL,e),setTimeout((function(){n.dropin=!0,n.hero.frameStopped=!1,n.handleCriticalReset(),n.handleHeroEventDoor(t,e,o),n.jumping=!1,n.parkour=null}),n.hero.getDur(d.verbs.FALL))):(n.jumping=!1,n.parkour=null,n.hero.face(e))}})}},{key:"handleHeroPush",value:function(t,e){if(this.interact.push++,this.hero.verb!==d.verbs.LIFT&&this.interact.push>this.map.data.tilesize){if(!this.hero.data.verbs[d.verbs.PUSH])return;this.hero.cycle(d.verbs.PUSH,e)}else this.hero.verb!==d.verbs.LIFT&&this.hero.cycle(d.verbs.WALK,e)}},{key:"handleHeroCamera",value:function(t,e){this.hero.cycle(this.hero.verb,e)}},{key:"handleHeroEventDoor",value:function(t,e,i){this.changeMap(i),this.player.stop()}},{key:"handleHeroEventBoundary",value:function(t,e,i){this.changeMap(i),this.player.stop()}},{key:"handleHeroLift",value:function(t,e){var i=this;this.locked=!0,this.hero.cycle(d.verbs.PULL,e),setTimeout((function(){var t=i.map.getActiveTiles(i.interact.tile.group).getTile();i.player.gameaudio.hitSound(d.verbs.LIFT),i.map.spliceActiveTile(i.interact.tile.group,i.interact.tile.coord),i.interact.tile.sprite=new w({type:d.npc.FLOAT,layer:"foreground",width:i.map.data.tilesize,height:i.map.data.tilesize,spawn:{x:i.interact.tile.coord[0]*i.map.data.tilesize,y:i.interact.tile.coord[1]*i.map.data.tilesize},image:i.map.data.image,hitbox:{x:0,y:0,width:i.map.data.tilesize,height:i.map.data.tilesize},verbs:{face:{down:{offsetX:t[0],offsetY:t[1]}}}},i.map),i.interact.tile.sprite.hero=i.hero,i.map.addNPC(i.interact.tile.sprite),i.hero.cycle(d.verbs.LIFT,i.hero.dir),i.hero.physics.maxv=i.hero.physics.controlmaxv/2,i.locked=!1}),this.hero.getDur(d.verbs.LIFT))}},{key:"handleHeroThrow",value:function(){this.hero.face(this.hero.dir),this.player.gameaudio.hitSound(d.verbs.THROW),this.hero.physics.maxv=this.hero.physics.controlmaxv,this.handleThrow(this.interact.tile.sprite)}},{key:"handleHeroAttack",value:function(){var t=this;if(this.hero.data.verbs[d.verbs.ATTACK]){this.attacking=!0,this.hero.resetElapsed=!0,this.hero.cycle(d.verbs.ATTACK,this.hero.dir);var e=this.hero.getNextPoiByDir(this.hero.dir,1),i=this.hero.getWeaponbox(),s={npc:this.checkNPC(e,i),tiles:this.checkTiles(e,i)};if(s.npc&&s.npc.data.ai){var a={};"left"===this.hero.dir||"right"===this.hero.dir?this.hero.position.y<s.npc.position.y?a.y=s.npc.position.y-(s.npc.position.y-this.hero.position.y):a.y=this.hero.position.y-(this.hero.position.y-s.npc.position.y):this.hero.position.x<s.npc.position.x?a.x=s.npc.position.x-(s.npc.position.x-this.hero.position.x):a.x=this.hero.position.x-(this.hero.position.x-s.npc.position.x),"left"===this.hero.dir&&(a.x=s.npc.position.x-this.map.data.tilesize),"right"===this.hero.dir&&(a.x=s.npc.position.x+this.map.data.tilesize),"up"===this.hero.dir&&(a.y=s.npc.position.y-this.map.data.tilesize),"down"===this.hero.dir&&(a.y=s.npc.position.y+this.map.data.tilesize),this.interact.npc={},this.interact.npc.sprite=s.npc,this.interact.npc.sprite.attacked=!0,this.interact.npc.spring=new P(this.player,s.npc.position.x,s.npc.position.y,120,3.5),this.interact.npc.spring.poi=a}s.tiles&&s.tiles.attack.length&&s.tiles.attack.forEach((function(i){i.attack&&t.handleHeroTileAttack(e,t.hero.dir,i)})),this.player.gameaudio.hitSound(d.verbs.ATTACK),setTimeout((function(){t.hero.face(t.hero.dir)}),this.hero.getDur(d.verbs.ATTACK))}}},{key:"handleAttackNCP",value:function(t){if(this.interact.npc.spring.isResting)this.interact.npc.sprite.attacked=!1,this.interact.npc.sprite.stats&&(this.interact.npc.sprite.stats.health-=this.hero.data.stats.power,this.interact.npc.sprite.stats.health<=0&&(this.smokeObject(this.interact.npc.sprite),this.player.gameaudio.hitSound(d.verbs.SMASH),this.map.killObj("npcs",this.interact.npc.sprite))),this.interact.npc=null;else{this.interact.npc.spring.blit(t);var e={map:this.checkMap(this.interact.npc.spring.position,this.interact.npc.sprite),npc:this.checkNPC(this.interact.npc.spring.position,this.interact.npc.sprite),tiles:this.checkTiles(this.interact.npc.spring.position,this.interact.npc.sprite),camera:this.checkCamera(this.interact.npc.spring.position,this.interact.npc.sprite)};e.map||e.npc||e.camera||this.canHeroTileStop(this.interact.npc.sprite.position,null,e)||(this.interact.npc.sprite.position.x=this.interact.npc.spring.position.x,this.interact.npc.sprite.position.y=this.interact.npc.spring.position.y)}}},{key:"handleHeroFall",value:function(t,e,i){var s,a,n=this,o=this.hero.getDur(d.verbs.FALL),h=i.action.find((function(t){return t.fall}));"left"===this.hero.dir&&(s={x:(h.coord[0]+1)*this.map.data.tilesize,y:h.coord[1]*this.map.data.tilesize},a={x:s.x,y:s.y-(this.hero.height-this.map.data.tilesize)/2}),"right"===this.hero.dir&&(s={x:(h.coord[0]-1)*this.map.data.tilesize,y:h.coord[1]*this.map.data.tilesize},a={x:s.x-(this.hero.width-this.map.data.tilesize),y:s.y-(this.hero.height-this.map.data.tilesize)/2}),"up"===this.hero.dir&&(s={x:h.coord[0]*this.map.data.tilesize,y:(h.coord[1]+1)*this.map.data.tilesize},a={x:s.x-(this.hero.width-this.map.data.tilesize)/2,y:s.y}),"down"===this.hero.dir&&(s={x:h.coord[0]*this.map.data.tilesize,y:(h.coord[1]-1)*this.map.data.tilesize},a={x:s.x-(this.hero.width-this.map.data.tilesize)/2,y:s.y-(this.hero.height-this.map.data.tilesize)}),this.falling=!0,this.interact.fall={},this.interact.fall.tween=new _,this.interact.fall.tween.bind(this.hero),this.interact.fall.tween.tween({to:{x:h.coord[0]*this.map.data.tilesize-(this.hero.width-this.map.data.tilesize)/2,y:h.coord[1]*this.map.data.tilesize-(this.hero.height-this.map.data.tilesize)/2},from:{x:this.hero.position.x,y:this.hero.position.y},duration:o/2,complete:function(){setTimeout((function(){n.interact.fall.tween.tween({to:a,from:{x:n.hero.position.x,y:n.hero.position.y},duration:o/2,complete:function(){n.falling=!1,n.hero.frameStopped=!1,n.interact.fall=null,n.hero.face(n.hero.dir)}})}),o/2)}}),this.hero.cycle(d.verbs.FALL,this.hero.dir)}},{key:"handleHeroTiles",value:function(t,e,i){var s=this;i.passive.forEach((function(t){t.instance.data.friction&&(s.hero.physics.maxv=s.hero.physics.controlmaxv/t.instance.data.friction)}))}},{key:"handleHeroNPCAction",value:function(t,e,i){i.canInteract(e)&&i.doInteract(e)}},{key:"handleHeroTileAttack",value:function(t,e,i){i.instance.canAttack()&&i.instance.attack(i.coord)}},{key:"handleControls",value:function(t,e){t.left?(e.physics.vx=p.limit(e.physics.vx-e.speed,-e.physics.controlmaxv,e.physics.controlmaxv),e.idle.x=!1):t.right?(e.physics.vx=p.limit(e.physics.vx+e.speed,-e.physics.controlmaxv,e.physics.controlmaxv),e.idle.x=!1):e.idle.x=!0,t.up?(e.physics.vy=p.limit(e.physics.vy-e.speed,-e.physics.controlmaxv,e.physics.controlmaxv),e.idle.y=!1):t.down?(e.physics.vy=p.limit(e.physics.vy+e.speed,-e.physics.controlmaxv,e.physics.controlmaxv),e.idle.y=!1):e.idle.y=!0,e.data.ai&&!e.attacked&&(e.data.ai===d.npc.ROAM&&this.handleRoam(e),e.data.ai===d.npc.WANDER&&this.handleWander(e))}},{key:"handleThrow",value:function(t){var e,i;t.throwing=this.hero.dir;var s=2*this.map.data.tilesize;"left"===t.throwing&&(e=t.position.x-s,i=t.hero.footbox.y-(t.height-this.hero.footbox.height)),"right"===t.throwing&&(e=t.position.x+s,i=t.hero.footbox.y-(t.height-this.hero.footbox.height)),"up"===t.throwing&&(e=t.position.x,i=t.position.y-s),"down"===t.throwing&&(e=t.position.x,i=this.hero.footbox.y+s),this.interact.tile.spring=new P(this.player,t.position.x,t.position.y,60,3.5),this.interact.tile.spring.poi={x:e,y:i},this.interact.tile.spring.bind(t)}},{key:"handleThrowing",value:function(t){if(this.interact.tile.spring.isResting)this.handleThrew();else{var e={map:this.checkMap(this.interact.tile.sprite.position,this.interact.tile.sprite),npc:this.checkNPC(this.interact.tile.sprite.position,this.interact.tile.sprite),camera:this.checkCamera(this.interact.tile.sprite.position,this.interact.tile.sprite)};e.map||e.npc||e.camera?this.handleThrew():this.interact.tile.spring.blit(t)}}},{key:"handleThrew",value:function(){this.smokeObject(this.interact.tile.sprite),this.player.gameaudio.hitSound(d.verbs.SMASH),this.map.killObj("npcs",this.interact.tile.sprite),this.interact.tile=null}},{key:"handleRoam",value:function(t){var e=["left","right","up","down"];t.counter?t.counter--:(t.counter=p.random(64,192),t.dir=e[p.random(0,e.length)]),e.forEach((function(e){e===t.dir?t.controls[e]=1:t.controls[e]=0}))}},{key:"handleWander",value:function(t){if(t.cooldown)return t.cooldown--;t.counter?t.counter--:(t.counter=p.random(100,200),t.stepsX=p.random(4,60),t.stepsY=p.random(4,60),t.collided?(t.collided=!1,t.dirX=d.opposites[t.dirX],t.dirY=d.opposites[t.dirY]):(t.dirX=["left","right"][p.random(0,2)],t.dirY=["down","up"][p.random(0,2)])),t.stepsX?(t.stepsX--,t.controls[t.dirX]=1,t.controls[d.opposites[t.dirX]]=0,t.data.verbs[t.verb][t.dirX]&&(t.dir=t.dirX)):(t.controls.left=0,t.controls.right=0),t.stepsY?(t.stepsY--,t.controls[t.dirY]=1,t.controls[d.opposites[t.dirY]]=0,t.data.verbs[t.verb][t.dirY]&&(t.dir=t.dirY)):(t.controls.up=0,t.controls.down=0),t.stepsX||t.stepsY?(t.data.bounce&&0===t.position.z&&(t.physics.vz=-6),t.data.verbs[d.verbs.WALK]&&(t.verb=d.verbs.WALK)):(t.verb=d.verbs.FACE,t.controls={})}},{key:"getNewHeroPosition",value:function(){return"down"===this.hero.dir?{x:this.hero.position.x,y:0,z:0}:"up"===this.hero.dir?{x:this.hero.position.x,y:this.map.height-this.hero.height,z:0}:"right"===this.hero.dir?{x:0,y:this.hero.position.y,z:0}:"left"===this.hero.dir?{x:this.map.width-this.hero.width,y:this.hero.position.y,z:0}:void 0}},{key:"changeMap",value:function(t){var e=this;this.player.pause(),this.player.element.classList.add("is-fader"),this.player.emit(d.broadcast.MAPEVENT,t),setTimeout((function(){var i=x.cash(t.map),s=e.getNewHeroPosition();if(e.hero.position.x=p.def(t.spawn)?i.spawn[t.spawn].x:s.x,e.hero.position.y=p.def(t.spawn)?i.spawn[t.spawn].y:s.y,e.map.destroy(),e.map=new O(i,e),e.hero.map=e.map,e.initMap(),e.dropin&&(e.hero.position.z=-e.camera.height/2),e.companion){var a=structuredClone(e.hero.data.companion);a.spawn={x:e.hero.position.x,y:e.hero.position.y},e.companion.destroy(),e.companion=new H(a,e.hero)}e.player.element.classList.remove("is-fader"),e.player.resume()}),1e3)}}]),l}(B),W=function(){function e(i){t(this,e),this.player=i,this.sounds={},this.build()}return i(e,[{key:"build",value:function(){this.player.device||(this.channels={bgm:{node:new Audio,open:!1},sfx:{node:new Audio,open:!1}},this.channels.bgm.node.loop=!0,this.channels.bgm.node.volume=.4,this.channels.sfx.node.loop=!1,this.channels.sfx.node.volume=.8)}},{key:"addSound",value:function(t){this.player.device||this.sounds[t.id]||(this.sounds[t.id]=t,this.sounds[t.id].playing=!1)}},{key:"hitSound",value:function(t){var e=this.sounds[t];if(e){var i=this.channels[e.channel];i.node.src=e.src,i.node.play()}}},{key:"playSound",value:function(t){var e=this.sounds[t];if(e&&!e.playing){var i=this.channels[e.channel],s=i.node.src.split("/").pop();e.src.split("/").pop()!==s&&(i.node.src=e.src),this.sounds[t].playing=!0,i.node.play()}}},{key:"stopSound",value:function(t){var e=this.sounds[t];if(e&&e.playing){var i=this.channels[e.channel];this.sounds[t].playing=!1,i.node.pause()}}}]),e}();const X=function(e){a(l,e);var s,n,o=(s=l,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=r(s);if(n){var i=r(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return h(this,t)});function l(){var e;return t(this,l),(e=o.call(this)).ready=!1,e.paused=!0,e.stopped=!1,e.Loader=x,e.controls={a:!1,aHold:!1,b:!1,bHold:!1,left:!1,right:!1,up:!1,down:!1},e.query=p.getParams(window.location.search),e.previousElapsed=null,e.detect(),e}return i(l,[{key:"detect",value:function(){this.device=/Mobi/i.test(window.navigator.userAgent),this.installed=window.navigator.standalone||window.matchMedia("(display-mode: standalone)").matches}},{key:"debug",value:function(){this.query.map&&(this.heroData.map="maps/".concat(this.query.map),this.heroData.spawn=0),this.query.resolution&&(this.resolution=this.getResolution(Number(this.query.resolution))),this.query.spawn&&(this.heroData.spawn=Number(this.query.spawn))}},{key:"load",value:function(){var t=this;this.loader=new x,this.loader.loadJson("game.json").then((function(e){t.data=e,t.heroData=p.merge(t.data.heroes[t.data.hero.sprite],t.data.hero),t.resolution=t.getResolution(t.device?2:t.data.resolution),t.debug(),t.width=t.data.width/t.resolution,t.height=t.data.height/t.resolution,t.build(),t.onRotate();var i=0,s=e.bundle.filter((function(e){var i=e.split("/").pop().split(".").pop();return!t.device||"mp3"!==i})).map((function(e){return t.loader.load(e).then((function(){i++,t.splashLoad.innerHTML=t.getSplash("Loaded ".concat(i," of ").concat(s.length," game resources..."))}))}));Promise.all(s).then((function(){t.splashLoad.innerHTML=t.getSplash("Press Start"),t.gameaudio=new W(t),t.gamepad=new m(t),t.data.plugin===d.plugins.TOPVIEW&&(t.gamebox=new I(t)),t.bind()}))}))}},{key:"getResolution",value:function(t){return t>this.data.maxresolution?this.data.maxresolution:t}},{key:"getSplash",value:function(t){return"\n            <div>\n                <div>".concat(this.data.name,": Save #").concat(this.data.save,", Release v").concat(this.data.release,"</div>\n                <div>").concat(t,"</div>\n            </div>\n        ")}},{key:"getMergedData",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=this.data[e].find((function(e){return e.id===t.id}));return s?p.merge(s,t,i):t}},{key:"getOrientation",value:function(){return"orientation"in window?window.orientation:window.screen.orientation.angle}},{key:"build",value:function(){this.element=document.createElement("div"),this.element.className="_2dk",this.element.dataset.resolution=this.resolution,this.screen=document.createElement("div"),this.screen.className="_2dk__screen",this.screen.style.width="".concat(this.width,"px"),this.screen.style.height="".concat(this.height,"px"),this.splash=document.createElement("div"),this.splash.className="_2dk__splash",this.splashInfo=document.createElement("div"),this.splashInfo.className="_2dk__splash__info",this.splashInfo.innerHTML="<div>Rotate to Landscape.</div><div>".concat(this.installed?"Webapp Installed":"Install Webapp","</div>"),this.splashLoad=document.createElement("div"),this.splashLoad.className="_2dk__splash__load",this.splashLoad.innerHTML=this.getSplash("Loading game bundle..."),this.splash.appendChild(this.splashInfo),this.splash.appendChild(this.splashLoad),this.element.appendChild(this.splash),this.element.appendChild(this.screen),document.body.appendChild(this.element)}},{key:"bind",value:function(){this.gamepad.on("left-press",this.onDpadPress.bind(this)),this.gamepad.on("right-press",this.onDpadPress.bind(this)),this.gamepad.on("up-press",this.onDpadPress.bind(this)),this.gamepad.on("down-press",this.onDpadPress.bind(this)),this.gamepad.on("left-release",this.onDpadRelease.bind(this)),this.gamepad.on("right-release",this.onDpadRelease.bind(this)),this.gamepad.on("up-release",this.onDpadRelease.bind(this)),this.gamepad.on("down-release",this.onDpadRelease.bind(this)),this.gamepad.on("start-press",this.onPressStart.bind(this)),this.gamepad.on("a-press",this.onPressA.bind(this)),this.gamepad.on("a-release",this.onReleaseA.bind(this)),this.gamepad.on("a-holdpress",this.onPressHoldA.bind(this)),this.gamepad.on("a-holdrelease",this.onReleaseHoldA.bind(this)),this.gamepad.on("b-press",this.onPressB.bind(this)),this.gamepad.on("b-holdpress",this.onPressHoldB.bind(this)),this.gamepad.on("b-release",this.onReleaseB.bind(this)),this.gamepad.on("b-holdrelease",this.onReleaseHoldB.bind(this)),window.onresize=this.onRotate.bind(this)}},{key:"pause",value:function(){this.paused=!0,this.gamepad.clear(),this.gamebox.pause(!0)}},{key:"stop",value:function(){this.stopped=!0,this.gamepad.clear(),this.gamebox.pause(!0)}},{key:"resume",value:function(){this.paused=!1,this.stopped=!1,this.gamebox.pause(!1)}},{key:"onRotate",value:function(){90===Math.abs(this.getOrientation())&&this.ready?this.resume():this.ready&&(this.pause(),this.stop())}},{key:"onReady",value:function(){this.ready||(this.ready=!0,this.element.classList.add("is-started"),this.go(this.onGameBlit.bind(this)))}},{key:"onGameBlit",value:function(t){var e=this;if(this.previousElapsed=t,this.stopped||this.gamebox.blit(t),!this.paused){var i=this.gamepad.checkDpad();i.length?i.forEach((function(t){t.dpad.forEach((function(t){e.gamebox.pressD(t)}))})):(this.gamebox.releaseD(),this.gamebox.handleHero(this.gamebox.hero.getNextPoi(),this.gamebox.hero.dir)),this.controls.aHold?this.gamebox.holdA():this.controls.a&&this.gamebox.pressA(),this.controls.bHold?this.gamebox.holdB():this.controls.b&&this.gamebox.pressB()}}},{key:"onPressStart",value:function(){this.ready||this.onReady(),this.paused?(this.resume(),this.emit(d.broadcast.RESUMED)):(this.pause(),this.stop(),this.emit(d.broadcast.PAUSED))}},{key:"onDpadPress",value:function(t){this.controls[t]=!0}},{key:"onDpadRelease",value:function(t){this.controls[t]=!1}},{key:"onPressA",value:function(){this.controls.a=!0}},{key:"onPressHoldA",value:function(){this.controls.aHold=!0}},{key:"onReleaseA",value:function(){this.controls.a=!1,this.gamebox.releaseA&&this.gamebox.releaseA()}},{key:"onReleaseHoldA",value:function(){this.controls.a=!1,this.controls.aHold=!1,this.gamebox.releaseHoldA&&this.gamebox.releaseHoldA()}},{key:"onPressB",value:function(){this.controls.b=!0}},{key:"onPressHoldB",value:function(){this.controls.bHold=!0}},{key:"onReleaseB",value:function(){this.controls.b=!1,this.controls.bHold=!1,this.gamebox.releaseB&&this.gamebox.releaseB()}},{key:"onReleaseHoldB",value:function(){this.controls.b=!1,this.controls.bHold=!1,this.gamebox.releaseHoldB&&this.gamebox.releaseHoldB()}}]),l}(f);var G=function(){function e(){var i=this;t(this,e),this.scope=window.location.pathname.replace(/index\.html$/,""),this.config={scope:this.scope},this.worker="".concat(this.scope,"sw.js"),window.onload=function(){i.player=new X,i.player.load(),i.register(),i.bind()}}return i(e,[{key:"bind",value:function(){this.player.on(d.broadcast.MAPEVENT,(function(t){p.log(d.broadcast.MAPEVENT,t)}))}},{key:"register",value:function(){p.dev()?p.log("[2dk] Skip service worker for studio dev demo!"):"serviceWorker"in navigator?navigator.serviceWorker.register(this.worker,this.config).then((function(t){t.installing?p.log("[2dk] Service worker installing."):t.waiting?p.log("[2dk] Service worker installed."):t.active&&p.log("[2dk] Service worker active!")})).catch((function(t){p.error("[2dk] Service worker failed with ".concat(t))})):p.log("[2dk] Service workers not available!")}},{key:"deregister",value:function(){navigator.serviceWorker.getRegistrations().then((function(t){t.forEach((function(t){t.unregister().then((function(t){p.log("[2dk] Unregistered Service Worker",t)}))}))}))}}]),e}();window.app2dk=new G,window.app})();