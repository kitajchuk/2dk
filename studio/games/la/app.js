(()=>{var $={dev(){return/^file:|^http:\/\/(localhost|127\.0\.0\.1)/.test(window.location.href)},log(...r){$.dev()&&console.log.apply(console,["[2dk]",...r])},func(r){return typeof r=="function"},def(r){return r!=null},error(...r){$.dev()&&console.error.apply(console,r)},merge(r,t,i){r=structuredClone(r),t=structuredClone(t);for(let e in t)(!r[e]||i)&&(r[e]=t[e]);return r},contains(r,t){let i=!1;return t.x+t.width<=r.x+r.width&&t.x>=r.x&&t.y+t.height<=r.y+r.height&&t.y>=r.y&&(i=!0),i},collide(r,t,i=0){return r.x+i<t.x+t.width-i&&r.x+r.width-i>t.x+i&&r.y+i<t.y+t.height-i&&r.height+r.y-i>t.y+i?{x:Math.max(0,r.x-t.x),y:Math.max(0,r.y-t.y),width:Math.min(t.width,r.x-t.x+r.width)-Math.max(0,r.x-t.x),height:Math.min(t.height,r.y-t.y+r.height)-Math.max(0,r.y-t.y)}:!1},drawTileCel(r,t,i,e,s,h,o,l){r.drawImage(t,s,h,i,i,o*e,l*e,e,e)},drawMapTile(r,t,i,e,s,h,o){if(Array.isArray(i))for(let l=0,d=i.length;l<d;l++)this.drawTileCel(r,t,e,s,i[l][0],i[l][1],h,o);else r.clearRect(h*s,o*s,s,s)},drawMapTiles(r,t,i,e,s){for(let h=i.length;h--;){let o=i[h];for(let l=o.length;l--;){let d=o[l];this.drawMapTile(r,t,d,e,s,l,h)}}},getSurroundingTileCoords(r){return{topLeft:{x:r[0]-1,y:r[1]-1},top:{x:r[0],y:r[1]-1},topRight:{x:r[0]+1,y:r[1]-1},left:{x:r[0]-1,y:r[1]},right:{x:r[0]+1,y:r[1]},bottomLeft:{x:r[0]-1,y:r[1]+1},bottom:{x:r[0],y:r[1]+1},bottomRight:{x:r[0]+1,y:r[1]+1}}},random(r,t){return Math.floor(Math.random()*(t-r+1))+r},limit(r,t,i){return r<t?t:r>i?i:r},goToZero(r){return r?r-r/Math.abs(r):0},getDistance(r,t){return Math.sqrt(Math.pow(t.x-r.x,2)+Math.pow(t.y-r.y,2))}},n=$;var It=window.getComputedStyle(document.documentElement),y=r=>It.getPropertyValue(r),D={verbs:{RUN:"run",PUSH:"push",PULL:"pull",GRAB:"grab",LIFT:"lift",WALK:"walk",FACE:"face",JUMP:"jump",FALL:"fall",THROW:"throw",ATTACK:"attack",OPEN:"open",CLOSE:"close",TALK:"talk",READ:"read"},map:{types:{WORLD:"world",INDOOR:"indoor"}},tiles:{HOLES:"holes",GRASS:"grass",WATER:"water",LEDGE:"ledge",STAIRS:"stairs",SWITCH:"switch"},keys:{A:"KeyX",B:"KeyZ",UP:"ArrowUp",DOWN:"ArrowDown",LEFT:"ArrowLeft",RIGHT:"ArrowRight",START:"Enter",SELECT:"Space",UPLEFT:"ArrowUpLeft",UPRIGHT:"ArrowUpRight",DOWNLEFT:"ArrowDownLeft",DOWNRIGHT:"ArrowDownRight"},plugins:{TOPVIEW:"topview"},events:{DOOR:"door",WARP:"warp",DIALOGUE:"dialogue",BOUNDARY:"boundary",CUTSCENE:"cutscene"},broadcast:{PAUSED:"paused",RESUMED:"resumed",MAPEVENT:"mapevent"},hero:{modes:{WEAPON:"weapon",PROJECTILE:"projectile"},interact:{READ:"read",GRAB:"grab"}},npc:{ai:{WALK:"walk",ROAM:"roam",FLOAT:"float",WANDER:"wander",FACE:"face"},types:{DOOR:"door",SWITCH:"switch",ENEMY:"enemy"}},facing:{UP:"up",DOWN:"down",LEFT:"left",RIGHT:"right"},opposites:{y:"x",x:"y",up:"down",down:"up",left:"right",right:"left"},dialogue:{types:{TEXT:"text",PROMPT:"prompt"},verbs:{TALK:"talk",READ:"read"}},colors:{red:y("--red"),grey:y("--grey"),blue:y("--blue"),teal:y("--teal"),pink:y("--pink"),black:y("--black"),green:y("--green"),white:y("--white"),purple:y("--purple"),yellow:y("--yellow"),greyDark:y("--grey-dark"),blueDark:y("--blue-dark"),charcoal:y("--charcoal"),charcoal2:y("--charcoal2")}},C=[D.facing.UP,D.facing.DOWN,D.facing.LEFT,D.facing.RIGHT],a=D;var Q=class{constructor(){this.handlers={},this.animate=null,this.started=!1,this.cycle=null}go(t){if(this.started)return this;this.started=!0,this.animate=i=>{this.cycle=window.requestAnimationFrame(this.animate),n.func(t)&&t(i)},this.cycle=window.requestAnimationFrame(this.animate)}stop(){window.cancelAnimationFrame(this.cycle),this.animate=null,this.started=!1,this.cycle=null}on(t,i){t.split(" ").forEach(s=>{n.func(i)&&(this.handlers[s]||(this.handlers[s]=[]),this.handlers[s].push(i))})}off(t,i){if(!this.handlers[t])return this;if(i){for(let e=this.handlers[t].length;e--;)if(this.handlers[t][e]===i){this.handlers[t].splice(e,1);break}}else delete this.handlers[t]}emit(t,...i){if(!this.handlers[t])return this;this.handlers[t].forEach(e=>{e.apply(this,i)})}},E=Q;var S=[],Ft=8,mt=50,Ht=[a.keys.UPLEFT,a.keys.UPRIGHT,a.keys.DOWNLEFT,a.keys.DOWNRIGHT],gt=[a.keys.UP,a.keys.DOWN,a.keys.LEFT,a.keys.RIGHT],c={a:{key:a.keys.A,elem:null,timer:null,touched:!1,hold:0,text:"A",gamepad:[0]},b:{key:a.keys.B,elem:null,timer:null,touched:!1,hold:0,text:"B",gamepad:[1]},start:{key:a.keys.START,elem:null,timer:null,touched:!1,hold:0,text:"Start",menu:!0,gamepad:[9]},select:{key:a.keys.SELECT,elem:null,hold:0,timer:null,touched:!1,text:"Select",menu:!0,gamepad:[8]},"up-left":{key:a.keys.UPLEFT,elem:null,timer:null,touched:!1,dpad:["left","up"]},up:{key:a.keys.UP,elem:null,timer:null,touched:!1,dpad:["up"],axes:[0,-1]},"up-right":{key:a.keys.UPRIGHT,elem:null,timer:null,touched:!1,dpad:["right","up"]},left:{key:a.keys.LEFT,elem:null,timer:null,touched:!1,dpad:["left"],axes:[-1,0]},neutral:{elem:null,dpad:[]},right:{key:a.keys.RIGHT,elem:null,timer:null,touched:!1,dpad:["right"],axes:[1,0]},"down-left":{key:a.keys.DOWNLEFT,elem:null,timer:null,touched:!1,dpad:["left","down"]},down:{key:a.keys.DOWN,elem:null,timer:null,touched:!1,dpad:["down"],axes:[0,1]},"down-right":{key:a.keys.DOWNRIGHT,elem:null,timer:null,touched:!1,dpad:["right","down"]}},M=class extends E{constructor(t){super(),this.player=t,this.build(),this.bind()}clear(){setTimeout(()=>{this.clearTouches(),this.cancelTouches()},300)}bind(){this.element.addEventListener("touchstart",this.onTouchStart.bind(this),!1),this.element.addEventListener("touchmove",this.onTouchMove.bind(this),!1),this.element.addEventListener("touchend",this.onTouchEnd.bind(this),!1),document.addEventListener("keyup",this.onKeyUp.bind(this),!1),document.addEventListener("keydown",this.onKeyDown.bind(this),!1),window.addEventListener("gamepadconnected",this.onGamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this.onGamepadDisconnected.bind(this))}build(){this.element=document.createElement("div"),this.dpad=document.createElement("div"),this.btns=document.createElement("div"),this.menu=document.createElement("div"),this.element.className="_2dk__gamepad",this.dpad.className="_2dk__gamepad__dpad",this.btns.className="_2dk__gamepad__btns",this.menu.className="_2dk__gamepad__menu",this.element.appendChild(this.dpad),this.element.appendChild(this.btns),this.element.appendChild(this.menu),this.diagonaldpad=this.player.data.diagonaldpad,this.availableControls=Object.keys(c),this.functionalControls=Object.keys(c).reduce((t,i)=>(i==="neutral"||!this.diagonaldpad&&Ht.includes(c[i].key)||t.push(i),t),[]),this.availableControls.forEach(t=>{let i=this.functionalControls.some(e=>e===t);c[t].btn=t.split("-"),c[t].elem=document.createElement("div"),c[t].elem.className=`_2dk__gamepad__${t}`,c[t].elem.role="button",c[t].key&&(c[t].elem.dataset.key=c[t].key),i||(c[t].elem.dataset.off="true"),this.renderButtonText(t),c[t].dpad?this.dpad.appendChild(c[t].elem):c[t].menu?this.menu.appendChild(c[t].elem):this.btns.appendChild(c[t].elem)}),this.player.element.appendChild(this.element),this.player.device||(this.element.style.display="none")}renderButtonText(t){c[t].text&&(c[t].elem.innerHTML=`<span>${c[t].text}</span>`)}canReceiveInput(t){let i=gt.includes(t),e=S.some(o=>gt.includes(o)),s=this.diagonaldpad||!i?!0:!e,h=!S.includes(t);return s&&h}pushInput(t){S.push(t)}removeInput(t){S.includes(t)&&S.splice(S.indexOf(t),1)}checkDpad(){let t=[];return this.functionalControls.forEach(i=>{c[i].touched&&c[i].dpad&&t.push(c[i])}),t.sort(i=>i.key===a.keys.UP||i.key===a.keys.DOWN?1:-1)}getControl(t){let i=null;return this.availableControls.forEach(e=>{c[e].key===t&&(i=c[e])}),i}getGamepad(t){let i=null;return this.availableControls.forEach(e=>{c[e].gamepad&&c[e].gamepad.indexOf(t)!==-1&&(i=c[e])}),i}getAxes(t,i){let e=null;return this.availableControls.forEach(s=>{c[s].axes&&c[s].axes[t]===i&&(e=c[s])}),e}getTouched(t,i){for(let e=0;e<t.length;e++)if(document.elementFromPoint(t[e].pageX,t[e].pageY).dataset.key===i.key)return i;return null}onTouchStart(t){t.preventDefault();for(let i=0;i<t.touches.length;i++){let e=document.elementFromPoint(t.touches[i].pageX,t.touches[i].pageY);if(e.dataset.key){let s=this.getControl(e.dataset.key);this.startTouch(s)}}return!1}onTouchMove(t){t.preventDefault();for(let i=0;i<t.touches.length;i++){let e=document.elementFromPoint(t.touches[i].pageX,t.touches[i].pageY);if(e.dataset.key){let s=this.getControl(e.dataset.key);s&&this.startTouch(s)}this.functionalControls.forEach(s=>{c[s].touched&&(this.getTouched(t.touches,c[s])||this.cancelTouch(c[s]))})}return!1}onTouchEnd(t){return t.preventDefault(),t.touches.length?this.availableControls.forEach(i=>{c[i].touched&&(this.getTouched(t.touches,c[i])||this.cancelTouch(c[i]))}):(this.clearTouches(),this.cancelTouches()),!1}onKeyDown(t){if(this.canReceiveInput(t.code)){this.pushInput(t.code);let i=this.getControl(t.code);i&&this.startTouch(i)}}onKeyUp(t){if(!this.canReceiveInput(t.code)){this.removeInput(t.code);let i=this.getControl(t.code);i&&this.cancelTouch(i)}}handleGamepadAxes(t){let i={x:this.getAxes(0,t.axes[0]),y:this.getAxes(1,t.axes[1])};i.x&&this.canReceiveInput(i.x.key)?(this.pushInput(i.x.key),this.startTouch(i.x)):i.x||(this.canReceiveInput(a.keys.LEFT)||(this.removeInput(a.keys.LEFT),this.cancelTouch(c.left)),this.canReceiveInput(a.keys.RIGHT)||(this.removeInput(a.keys.RIGHT),this.cancelTouch(c.right))),i.y&&this.canReceiveInput(i.y.key)?(this.pushInput(i.y.key),this.startTouch(i.y)):i.y||(this.canReceiveInput(a.keys.UP)||(this.removeInput(a.keys.UP),this.cancelTouch(c.up)),this.canReceiveInput(a.keys.DOWN)||(this.removeInput(a.keys.DOWN),this.cancelTouch(c.down)))}handleGamepadButtons(t){for(let i=t.buttons.length;i--;){let e=this.getGamepad(i);e&&this.canReceiveInput(e.key)&&t.buttons[i].pressed?(this.pushInput(e.key),this.startTouch(e)):e&&!this.canReceiveInput(e.key)&&!t.buttons[i].pressed&&(this.removeInput(e.key),this.cancelTouch(e))}}onGamepadConnected(){let t=navigator.getGamepads()[0];this.stop(),this.go(()=>{t=navigator.getGamepads()[0],this.handleGamepadAxes(t),this.handleGamepadButtons(t)}),n.log(`GamePad Connected: ${t.id}`,t)}onGamepadDisconnected(){this.stop()}clearTouches(){this.availableControls.forEach(t=>{c[t].elem.classList.remove("is-active")})}cancelTouches(){this.availableControls.forEach(t=>{c[t].touched&&this.cancelTouch(c[t])})}cancelTouch(t){t.timer&&(clearInterval(t.timer),t.timer=null),t.elem.classList.remove("is-active"),t.touched=!1,this.handleTouchEnd(t)}startTouch(t){t.timer||(t.elem.classList.add("is-active"),t.touched=!0,this.handleTouchStart(t),Object.prototype.hasOwnProperty.call(t,"hold")&&!t.menu&&(t.timer=setInterval(()=>{this.handleTouchStart(t)},Ft)))}handleTouchStart(t){if(t.touched&&t.menu&&t.hold>0){t.hold++;return}Object.prototype.hasOwnProperty.call(t,"hold")?(t.hold++,t.hold>mt?this.emit(`${t.btn[0]}-holdpress`):this.emit(`${t.btn[0]}-press`)):t.dpad?t.dpad.forEach((i,e)=>{this.emit(`${t.btn[e]}-press`,i)}):this.emit(`${t.btn[0]}-press`,null)}handleTouchEnd(t){Object.prototype.hasOwnProperty.call(t,"hold")?(t.hold>mt?this.emit(`${t.btn[0]}-holdrelease`):this.emit(`${t.btn[0]}-release`),t.hold=0):t.dpad?t.dpad.forEach((i,e)=>{this.emit(`${t.btn[e]}-release`,i)}):this.emit(`${t.btn[0]}-release`,null)}};var V=class{constructor(t){this.device=t,this.sounds={},this.build()}build(){this.device||(this.channels={bgm:{node:new Audio,open:!1},sfx:{node:new Audio,open:!1}},this.channels.bgm.node.loop=!0,this.channels.bgm.node.volume=.4,this.channels.sfx.node.loop=!1,this.channels.sfx.node.volume=.6)}stop(){if(!this.device)for(let t in this.sounds)this.stopSound(t)}addSound(t){this.device||this.sounds[t.id]||(this.sounds[t.id]=t,this.sounds[t.id].playing=!1)}hitSound(t){let i=this.sounds[t];if(i){let e=this.channels[i.channel];e.node.src=i.src,e.node.play()}}playSound(t){let i=this.sounds[t];if(i&&!i.playing){let e=this.channels[i.channel],s=e.node.src.split("/").pop();i.src.split("/").pop()!==s&&(e.node.src=i.src),this.sounds[t].playing=!0,e.node.play()}}stopSound(t){let i=this.sounds[t];if(i&&i.playing){let e=this.channels[i.channel];this.sounds[t].playing=!1,e.node.pause()}}},xt=V;var x={},K=class{static cash(t,i){return i&&(x[t]=i),t?x[t]:x}load(t){let i=t.split("/").pop().split(".").pop();if(i==="png")return this.loadImage(t);if(i==="mp3")return this.loadAudio(t);if(i==="json")return this.loadJson(t)}loadImage(t){return new Promise((i,e)=>{if(x[t])return i(x[t]);let s=new Image;s.onload=()=>{x[t]=s,i(x[t])},s.onerror=()=>{e()},s.src=t})}loadAudio(t){return new Promise(i=>{if(x[t])return i(x[t]);let e=new Audio;e.addEventListener("loadedmetadata",()=>{x[t]=!0,e=null,i(x[t])},!1),e.muted=!0,e.volume=0,e.src=t,e.load()})}loadJson(t){return new Promise(i=>{if(x[t])return i(x[t]);fetch(t).then(e=>{e.json().then(s=>{x[t]=s,i(x[t])})})})}},b=K;var J=class{constructor(t){this.gamebox=t,this.player=this.gamebox.player,this.data=null,this.ready=!1,this.pressed=!1,this.active=!1,this.isAuto=!1,this.isResolve=!1,this.resolve=null,this.reject=null,this.timeout=null,this.debounce=750,this.duration=250,this.build()}destroy(){this.teardown(),this.element.remove()}build(){this.element=document.createElement("div"),this.element.className="_2dk__dialogue",this.player.screen.appendChild(this.element)}writeText(t){this.element.innerHTML=`<div class="_2dk__dialogue__text">${t}</div>`}writePrompt(t){t.push(`<span class="a">A: ${this.data.yes.label}</span>`),t.push("<span>,&nbsp;</span>"),t.push(`<span class="b">B: ${this.data.no.label}</span>`)}clearText(){this.element.innerHTML=""}clearTimeout(){clearTimeout(this.timeout),this.timeout=null}auto(t){this.active||(this.clearTimeout(),this.isAuto=!0,this.data=structuredClone(t),this.element.classList.add("is-texting"),this.writeText(this.data.text.shift()),this.timeout=setTimeout(()=>{this.teardown()},this.debounce*3))}play(t){return(this.active||this.isAuto)&&this.reset(),this.active=!0,new Promise((i,e)=>{this.data=structuredClone(t),this.isResolve=!0,this.resolve=i,this.reject=e,this.element.classList.add("is-texting");let s=[`<div>${this.data.text.shift()}</div>`];!this.data.text.length&&this.data.type===a.dialogue.types.PROMPT&&this.writePrompt(s),this.writeText(s.join("")),this.timeout=setTimeout(()=>{this.ready=!0},this.duration)})}check(t,i){if(!(!this.active||!this.ready||this.active&&this.pressed))switch(this.pressed=!0,this.data.type){case a.dialogue.types.TEXT:this.handleText();break;case a.dialogue.types.PROMPT:this.handlePrompt(t,i);break}}handleText(){this.data.text.length?(this.writeText(this.data.text.shift()),this.timeout=setTimeout(()=>{this.pressed=!1},this.duration)):(this.isResolve?this.resolve():this.reject(),this.teardown())}handlePrompt(t,i){if(this.data.text.length){let e=[`<div>${this.data.text.shift()}</div>`];this.data.text.length||this.writePrompt(e),this.writeText(e.join("")),this.timeout=setTimeout(()=>{this.pressed=!1},this.duration)}else t?(this.isResolve=!0,this.data.type=a.dialogue.types.TEXT,this.data.text=this.data.yes.text,this.timeout=setTimeout(()=>{this.pressed=!1,this.check(!0,!1)},this.duration)):i&&(this.isResolve=!1,this.data.type=a.dialogue.types.TEXT,this.data.text=this.data.no.text,this.timeout=setTimeout(()=>{this.pressed=!1,this.check(!1,!0)},this.duration))}reset(){this.clearTimeout(),this.data=null,this.ready=!1,this.pressed=!1,this.isAuto=!1,this.isResolve=!1,this.resolve=null,this.reject=null}teardown(){this.reset(),this.element.classList.remove("is-texting"),this.timeout=setTimeout(()=>{this.clearText(),this.active=!1,this.timeout=null},this.duration)}},yt=J;var g=class{constructor(t,i){this.data=t,this.map=i,this.gamebox=this.map.gamebox,this.player=this.gamebox.player,this.gamequest=this.gamebox.gamequest,this.layer=t.layer||"heroground",this.scale=this.data.scale||1,this.width=this.data.width/this.scale,this.height=this.data.height/this.scale,this.dir=this.data.dir||this.data.spawn.dir||"down",this.verb=this.data.verb||a.verbs.FACE,this.image=b.cash(this.data.image),this.speed=1,this.frame=0,this.opacity=t.opacity||1,this.position={x:this.data.spawn&&this.data.spawn.x||0,y:this.data.spawn&&this.data.spawn.y||0,z:this.data.spawn&&this.data.spawn.z||0},this.physics={vx:this.data.vx||0,vy:this.data.vy||0,vz:this.data.vz||0,maxv:this.data.maxv||4,controlmaxv:this.data.controlmaxv||4,maxvstatic:this.data.maxv||4,controlmaxvstatic:this.data.controlmaxv||4},this.offset={x:this.gamebox.offset.x+this.position.x,y:this.gamebox.offset.y+this.position.y},this.idle={x:!0,y:!0},this.data.hitbox=this.data.hitbox||{x:0,y:0,width:this.data.width/this.scale,height:this.data.height/this.scale},this.hitbox={x:this.position.x+this.data.hitbox.x/this.scale,y:this.position.y+this.data.hitbox.y/this.scale,width:this.data.hitbox.width/this.scale,height:this.data.hitbox.height/this.scale},this.footbox={x:this.hitbox.x,y:this.hitbox.y+this.hitbox.height/2,width:this.hitbox.width,height:this.hitbox.height/2},this.spritecel=this.getCel(),this.previousElapsed=null,this.resetElapsed=!1,this.frameStopped=!1,this.controls={left:!1,right:!1,up:!1,down:!1},this.hitTimer=0,this.stillTimer=0,this.stats=this.data.stats?structuredClone(this.data.stats):{power:1,health:1,strength:0},this.maxHealth=this.stats.health}destroy(){}can(t){return!!this.data.verbs[t]}is(t){return this.verb===t}cycle(t,i){t!==this.verb&&(this.frame=0),this.dir=i,this.verb=t}face(t){this.cycle(a.verbs.FACE,t)}visible(){return n.collide(this.gamebox.camera,this.getFullbox())}hit(t=1,i=50){this.hitTimer=i,this.stillTimer=i,this.frame=0,this.resetPhysics(),this.face(this.dir),this.stats&&(this.stats.health=Math.max(this.stats.health-t,0))}isIdle(){return this.idle.x&&this.idle.y}isHitOrStill(){return this.hitTimer>0||this.stillTimer>0}isJumping(){return this.position.z<0}checkStat(t,i){return this.stats[t]>=i}updateStat(t,i){if(t==="health"){this.stats[t]=Math.min(this.stats[t]+i,this.maxHealth);return}this.stats[t]+=i}blit(t){this.visible()&&(this.previousElapsed===null&&(this.previousElapsed=t),this.hitTimer>0&&(this.hitTimer--,this.hitTimer===0&&this.handleHealthCheck()),this.stillTimer>0&&this.stillTimer--,this.applyFrame(t),n.func(this.blitAfter)&&this.blitAfter(t))}update(){this.visible()&&this.updateStack()}updateStack(){this.handleVelocity(),this.handleGravity(),this.applyPosition(),this.applyHitbox(),this.applyOffset(),this.applyGravity()}render(){this.visible()&&(n.func(this.renderBefore)&&this.renderBefore(),this.data.shadow&&!this.is(a.verbs.FALL)&&this.gamebox.draw(this.image,this.data.shadow.offsetX,this.data.shadow.offsetY,this.data.width,this.data.height,this.offset.x,this.offset.y,this.width,this.height),this.applyOpacity(),this.gamebox.draw(this.image,this.spritecel[0],this.spritecel[1],this.data.width,this.data.height,this.offset.x,this.offset.y+this.position.z,this.width,this.height),n.func(this.renderAfter)&&this.renderAfter(),this.player.query.get("debug")&&this.renderDebug())}renderDebug(){this.gamebox.mapLayer.context.save(),this.gamebox.mapLayer.context.globalAlpha=.25,this.gamebox.mapLayer.context.fillStyle=a.colors.white,this.gamebox.mapLayer.context.fillRect(this.offset.x,this.offset.y,this.width,this.height),this.gamebox.mapLayer.context.globalAlpha=.5,this.gamebox.mapLayer.context.fillStyle=a.colors.red,this.gamebox.mapLayer.context.fillRect(this.offset.x+this.data.hitbox.x/this.scale,this.offset.y+this.data.hitbox.y/this.scale,this.hitbox.width,this.hitbox.height),this.gamebox.mapLayer.context.fillStyle=a.colors.green,this.gamebox.mapLayer.context.fillRect(this.offset.x+this.data.hitbox.x/this.scale,this.offset.y+this.data.hitbox.y/this.scale+this.hitbox.height/2,this.footbox.width,this.footbox.height),this.gamebox.mapLayer.context.restore()}handleVelocity(){this.idle.x&&(this.physics.vx=n.goToZero(this.physics.vx)),this.idle.y&&(this.physics.vy=n.goToZero(this.physics.vy))}handleGravity(){this.physics.vz++}handleHealthCheck(){}handleControls(){this.stillTimer||(this.controls.left?(this.physics.vx=n.limit(this.physics.vx-this.speed,-this.physics.controlmaxv,this.physics.controlmaxv),this.idle.x=!1):this.controls.right?(this.physics.vx=n.limit(this.physics.vx+this.speed,-this.physics.controlmaxv,this.physics.controlmaxv),this.idle.x=!1):this.idle.x=!0,this.controls.up?(this.physics.vy=n.limit(this.physics.vy-this.speed,-this.physics.controlmaxv,this.physics.controlmaxv),this.idle.y=!1):this.controls.down?(this.physics.vy=n.limit(this.physics.vy+this.speed,-this.physics.controlmaxv,this.physics.controlmaxv),this.idle.y=!1):this.idle.y=!0)}applyOpacity(){this.opacity&&(this.gamebox.mapLayer.context.globalAlpha=this.opacity),this.hitTimer>0&&this.hitTimer%5===0&&(this.gamebox.mapLayer.context.globalAlpha=.25)}applyPosition(){this.position=this.getNextPoi()}applyHitbox(){this.hitbox.x=this.position.x+this.data.hitbox.x/this.scale,this.hitbox.y=this.position.y+this.data.hitbox.y/this.scale,this.footbox.x=this.hitbox.x,this.footbox.y=this.hitbox.y+this.hitbox.height/2}applyOffset(){this.offset={x:this.gamebox.offset.x+this.position.x,y:this.gamebox.offset.y+this.position.y}}applyGravity(){this.position.z=this.getNextZ(),this.position.z>0&&(this.position.z=0)}applyFrame(t){if(!this.frameStopped){if(this.resetElapsed&&(this.resetElapsed=!1,this.previousElapsed=t),this.data.verbs[this.verb][this.dir].stepsX)if(this.is(a.verbs.LIFT)&&this.isIdle())n.log("Static lift...");else{let i=this.data.verbs[this.verb].dur/this.data.verbs[this.verb][this.dir].stepsX,e=t-this.previousElapsed;e>=i&&(this.previousElapsed=t-e%i,this.frame++,this.frame>=this.data.verbs[this.verb][this.dir].stepsX&&(this.previousElapsed=null,this.data.verbs[this.verb].stop?(this.frame=this.data.verbs[this.verb][this.dir].stepsX-1,this.frameStopped=!0):this.frame=0))}else this.frame=0;this.spritecel=this.getCel()}}getCel(){return[this.data.verbs[this.verb][this.dir].offsetX+this.data.width*this.frame,this.data.verbs[this.verb][this.dir].offsetY]}getDur(t){return this.data.verbs[t].dur||0}getNextX(){return this.position.x+n.limit(this.physics.vx,-this.physics.maxv,this.physics.maxv)}getNextY(){return this.position.y+n.limit(this.physics.vy,-this.physics.maxv,this.physics.maxv)}getNextZ(){return this.position.z+n.limit(this.physics.vz,-this.physics.maxv,this.physics.maxv)}resetPhysics(){this.physics.vx=0,this.physics.vy=0,this.physics.vz=0}getNextPoi(){return{x:this.getNextX(),y:this.getNextY(),z:this.getNextZ()}}getNextPoiByDir(t,i){return i&&t==="left"&&(i=-this.physics.controlmaxv),i&&t==="right"&&(i=this.physics.controlmaxv),i&&t==="up"&&(i=-this.physics.controlmaxv),i&&t==="down"&&(i=this.physics.controlmaxv),i||(i=0),{x:t==="left"||t==="right"?this.getNextX()+i:this.position.x,y:t==="up"||t==="down"?this.getNextY()+i:this.position.y,z:this.position.z}}getHitbox(t){return{x:t.x+this.data.hitbox.x/this.scale,y:t.y+this.data.hitbox.y/this.scale,width:this.hitbox.width,height:this.hitbox.height}}getFootbox(t){return{x:t.x+this.data.hitbox.x/this.scale,y:t.y+(this.data.hitbox.y/this.scale+this.hitbox.height/2),width:this.footbox.width,height:this.footbox.height}}getFullbox(t=null){let i=t||this.position;return{x:i.x,y:i.y+i.z,width:this.width,height:this.height}}canTileStop(t){return t.tiles&&t.tiles.action.length&&t.tiles.action.find(i=>i.stop)}},I=class extends g{constructor(t,i){super(t,i)}checkQuestFlag(t){if(this.data.action?.quest?.checkFlag){let{key:i,value:e}=this.data.action.quest.checkFlag;if(i===t)return this.gamequest.checkQuest(i,e)}return!1}isQuestFlagComplete(){if(this.data.action?.quest?.checkFlag){let{key:t}=this.data.action.quest.checkFlag;return this.gamequest.getCompleted(t)}return!1}handleQuestFlagCheck(){}handleQuestItemCheck(){}handleQuestFlagUpdate(t){if(!this.data.action?.quest?.setFlag&&!t)return;let{key:i,value:e}=t||this.data.action.quest.setFlag;this.gamequest.getCompleted(i)||(this.gamequest.hitQuest(i,e),this.gamebox.checkQuestFlags(i))}handleQuestItemUpdate(){}};var A=class extends g{constructor(t,i,e,s){let h=t.dirs?t.dirs[i].width:t.width,o=t.dirs?t.dirs[i].height:t.height,l={x:e.position.x+e.width/2-h/2,y:e.position.y+e.height/2-o/2};switch(i){case"left":l.x-=h;break;case"right":l.x+=h;break;case"up":l.y-=o;break;case"down":l.y+=o;break}let d={x:0,y:0,width:h,height:o},p=t.dirs?{face:{down:t.dirs.down,up:t.dirs.up,left:t.dirs.left,right:t.dirs.right}}:{face:{[i]:{offsetX:t.offsetX,offsetY:t.offsetY}}},u={dir:i,spawn:l,width:h,height:o,hitbox:d,verbs:p,...t};super(u,s),this.hitCounter=0,this.npc=e,this.map.addObject("sprites",this),this.sparks()}sparks(){this.data.fx&&this.gamebox.smokeObject(this,this.data.fx),this.data.sound&&this.player.gameaudio.hitSound(this.data.sound)}update(){this.visible()&&(this.controls[this.dir]=!0,this.handleControls(),this.updateStack())}kill(){this.map.killObject("sprites",this),this.sparks(),this.npc.projectile=null}applyPosition(){let t=this.getNextPoi(),i={map:this.gamebox.checkMap(t,this),npc:this.gamebox.checkNPC(t,this),hero:this.gamebox.checkHero(t,this),tiles:this.gamebox.checkTiles(t,this),doors:this.gamebox.checkDoor(t,this),camera:this.gamebox.checkCamera(t,this)};if(i.map||i.hero||i.doors||i.camera||i.npc&&i.npc!==this.npc||this.canTileStop(i)){i.hero&&!this.gamebox.hero.isHitOrStill()&&!this.gamebox.hero.canShield(this)&&this.gamebox.hero.hit(this.data.power),this.kill();return}this.position=t}};var z=class extends I{constructor(t,i,e){super(t,i),this.mapId=e,this.states=structuredClone(this.data.states),this.dialogue=null,this.aiCounter=this.data.ai?60:0,this.projectileCounter=this.data.projectile?120:0,this.projectile=null,this.dirX=null,this.dirY=null,this.stepsX=0,this.stepsY=0,this.pushed=null,this.initialize()}initialize(){let i=this.gamebox.hero.items.find(e=>e.mapId===this.mapId)?1:0;this.setState(i)}hit(...t){super.hit(...t),this.aiCounter=0}setState(t){this.states.length&&(this.stateIndex=t,this.state=this.states[this.stateIndex],this.dir=this.state.dir,this.verb=this.state.verb)}payload(){this.data.payload.dialogue&&!this.dialogue&&(this.data.payload.dialogue.type===a.dialogue.types.TEXT&&this.handlePayloadQuest(),this.dialogue=this.gamebox.dialogue.play(this.data.payload.dialogue),this.dialogue.then(()=>{this.resetDialogue(),this.handleAI(),this.gamebox.hero.itemGet&&this.gamebox.hero.resetItemGet(),this.data.payload.dialogue.type===a.dialogue.types.PROMPT&&this.handlePayloadQuest()}).catch(()=>{this.resetDialogue()}))}resetDialogue(){this.dialogue=null,this.dir=this.state.dir,this.verb=this.state.verb}update(){this.visible()&&(this.handleControls(),this.handleAI(),this.handleProjectile(),this.updateStack())}applyPosition(){this.pushed?this.applyPushedPosition():this.data.ai===a.npc.ai.FLOAT?this.applyFloatPosition():this.applyNormalPosition()}applyPushedPosition(){let t={x:this.position.x,y:this.position.y,z:this.position.z};switch(this.pushed.dir){case"left":t.x-=1;break;case"right":t.x+=1;break;case"up":t.y-=1;break;case"down":t.y+=1;break}let i={map:this.gamebox.checkMap(t,this),npc:this.gamebox.checkNPC(t,this),tiles:this.gamebox.checkTiles(t,this),doors:this.gamebox.checkDoor(t,this),camera:this.gamebox.checkCamera(t,this)};if(i.map||i.npc||i.doors||i.camera||this.canTileStop(i)){this.pushed=null,this.gamebox.locked=!1;return}this.position=t,this.position.x===this.pushed.poi.x&&this.position.y===this.pushed.poi.y&&(this.pushed=null,this.gamebox.locked=!1)}applyFloatPosition(){let t=this.getNextPoi(),i={map:this.gamebox.checkMap(t,this),doors:this.gamebox.checkDoor(t,this)};if(i.map||i.doors){this.position.z=-(this.map.data.tilesize*.75),this.handleAI();return}this.position={x:t.x,y:t.y,z:-(this.map.data.tilesize*.75)}}applyNormalPosition(){let t=this.getNextPoi(),i={map:this.gamebox.checkMap(t,this),npc:this.gamebox.checkNPC(t,this),hero:this.gamebox.checkHero(t,this),tiles:this.gamebox.checkTiles(t,this),doors:this.gamebox.checkDoor(t,this),empty:this.gamebox.checkEmpty(t,this)},e=i.map||i.npc||i.hero||i.doors||this.canTileStop(i)||this.canTileFall(t,i);if(i.hero&&this.gamebox.hero.canShield(this)&&this.data.ai===a.npc.ai.ROAM){switch(this.dir){case"left":this.gamebox.hero.physics.vx=-1;break;case"right":this.gamebox.hero.physics.vx=1;break;case"up":this.gamebox.hero.physics.vy=-1;break;case"down":this.gamebox.hero.physics.vy=1;break}return}if(e){(this.data.ai===a.npc.ai.ROAM||this.data.ai===a.npc.ai.WALK)&&(this.aiCounter=0),this.handleAI();return}this.position=t}handleAI(){if(!this.stillTimer&&this.data.ai)switch(this.data.ai){case a.npc.ai.ROAM:this.handleRoam();break;case a.npc.ai.FLOAT:case a.npc.ai.WANDER:this.handleWander();break}}handleRoam(){if(this.aiCounter)this.aiCounter--;else{let t=this.data.ai===a.npc.ai.WALK?240:120,i=this.data.ai===a.npc.ai.WALK?360:240;this.aiCounter=n.random(t,i);let e=this.dir,s=C[n.random(0,C.length-1)];if(e===s){this.aiCounter=0,this.handleRoam();return}this.dir=s,this.can(a.verbs.WALK)&&(this.verb=a.verbs.WALK)}for(let t=C.length;t--;)this.controls[C[t]]=C[t]===this.dir}handleWander(){if(this.aiCounter)this.aiCounter--;else{let t=this.dirX,i=this.dirY,e=["left","right"][n.random(0,2)],s=["down","up"][n.random(0,2)];if(t===e&&i===s){this.handleWander();return}this.aiCounter=n.random(60,120),this.stepsX=n.random(30,60),this.stepsY=n.random(30,60),this.dirX=e,this.dirY=s}this.stepsX?(this.stepsX--,this.controls[this.dirX]=!0,this.controls[a.opposites[this.dirX]]=!1,this.data.verbs[this.verb][this.dirX]&&(this.dir=this.dirX)):(this.controls.left=!1,this.controls.right=!1),this.stepsY?(this.stepsY--,this.controls[this.dirY]=!0,this.controls[a.opposites[this.dirY]]=!1,this.data.verbs[this.verb][this.dirY]&&(this.dir=this.dirY)):(this.controls.up=!1,this.controls.down=!1),!this.stepsX&&!this.stepsY?(this.verb=a.verbs.FACE,this.controls={}):(this.data.bounce&&this.position.z===0&&(this.physics.vz=-6),this.can(a.verbs.WALK)&&(this.verb=a.verbs.WALK))}handleProjectile(){if(this.data.projectile&&!this.projectile){if(this.isHitOrStill()){this.projectileCounter=120;return}if(this.projectileCounter>0&&(this.projectileCounter--,this.projectileCounter===0)){if(n.random(0,100)<=25){let i=this.gamebox.player.getMergedData({id:this.data.projectile},"projectiles");this.projectile=new A(i,this.dir,this,this.map)}this.projectileCounter=120}}}canInteract(t){return this.state.action&&(!this.state.action.dir||t===this.state.action.dir)}canDoAction(t){return this.data.action&&this.data.action.verb&&t===this.data.action.verb}canHitHero(){return this.data.type===a.npc.types.ENEMY&&!this.isHitOrStill()&&!this.gamebox.hero.canShield(this)}canTileFall(t,i){let{tiles:e,empty:s}=i,h=e&&e.action.filter(l=>l.fall),o=this.getHitbox(t);return h&&h.length?h.some(l=>n.collide(l.tilebox,o)):s?s.some(l=>n.collide(l,o)):!1}doInteract(){if(this.data.payload){if(!this.canDoPayload())return;this.payload()}this.state.action.sound&&!this.gamebox.hero.itemGet&&this.player.gameaudio.hitSound(this.state.action.sound),this.state.action.verb&&this.data.verbs[this.state.action.verb]&&(this.verb=this.state.action.verb,this.dir=this.state.dir),this.state.action.shift&&this.setState(this.stateIndex+1)}canDoPayload(){if(this.data.payload.quest?.checkItem){let{id:t,dialogue:i}=this.data.payload.quest.checkItem;if(!this.gamebox.hero.itemCheck(t))return i&&this.gamebox.dialogue.auto(i),!1}if(this.data.payload.quest?.checkFlag){let{key:t}=this.data.payload.quest.checkFlag;return this.checkQuestFlag(t)}return!0}handleHealthCheck(){this.stats&&this.stats.health<=0&&(this.handleQuestFlagUpdate(),this.gamebox.smokeObject(this,this.data.action.fx),this.map.killObject("npcs",this),this.data.action.sound&&this.player.gameaudio.hitSound(this.data.action.sound),this.data.drops&&!this.circularCheckQuestFlag()&&this.gamebox.itemDrop(this.data.drops,this.position))}circularCheckQuestFlag(){if(this.data.action.quest?.checkFlag&&this.data.action.quest?.setFlag&&this.data.action.quest?.dropItem){let{key:t}=this.data.action.quest.checkFlag,{key:i}=this.data.action.quest.setFlag;if(t===i)return this.gamequest.getCompleted(t)}return!1}handlePayloadQuest(){if(this.data.payload.quest?.checkItem){let{id:t}=this.data.payload.quest.checkItem;this.handleQuestItemCheck(t)}this.data.payload.quest?.setFlag&&this.handleQuestFlagUpdate(this.data.payload.quest.setFlag),this.data.payload.quest?.setItem&&this.handleQuestItemUpdate(this.data.payload.quest.setItem)}handleQuestItemUpdate(t){this.gamebox.hero.giveItem(t,this.mapId)}handleQuestFlagCheck(t){if(this.checkQuestFlag(t)){if(this.data.action.quest.setFlag){let{key:i,value:e}=this.data.action.quest.setFlag;if(i===t&&this.isQuestFlagComplete())return;this.gamequest.hitQuest(i,e)}this.gamequest.completeQuest(t),this.data.action.quest.dropItem&&this.gamebox.keyItemDrop(this.data.action.quest.dropItem,this.position)}}handleQuestItemCheck(t){if(this.gamebox.hero.itemCheck(t)){let i=this.gamebox.hero.getItem(t);i&&i.collect&&this.gamebox.hero.takeCollectible(t)}}};var m=class extends g{constructor(t,i){t.type===a.npc.ai.FLOAT&&(t.layer="foreground"),super(t,i),this.paused=!1}blit(t){this.visible()&&(this.paused||(this.previousElapsed===null&&(this.previousElapsed=t),this.data.type===a.npc.ai.FLOAT&&this.position.y--,this.applyFrame(t)))}getCel(){return[this.data.offsetX+this.data.width*this.frame,this.data.offsetY]}applyFrame(t){if(this.data.stepsX){let i=this.data.dur/this.data.stepsX,e=t-this.previousElapsed;e>=i&&(this.previousElapsed=t-e%i,this.frame++,this.frame>=this.data.stepsX&&(this.data.kill?this.map.killObject("fx",this):(this.previousElapsed=null,this.frame=0,this.data.type===a.npc.ai.FLOAT&&(this.position.y=this.data.spawn.y))))}else this.frame=0;this.spritecel=this.getCel()}};var O=class extends I{constructor(t,i){super(t,i),this.open=!1,this.opening=!1,this.closing=!1,this.counter=0,this.rumble=0,this.originalX=this.position.x,this.dialogue=null,this.states=structuredClone(this.data.states),this.initialize()}initialize(){if(this.data.action){let t=this.isQuestFlagComplete();this.open=this.data.action.verb===a.verbs.OPEN?!!t:!t,this.counter=this.open?this.data.height:0}this.setState(0)}setState(t){this.states.length&&(this.stateIndex=t,this.state=this.states[this.stateIndex],this.dir=this.state.dir,this.verb=this.state.verb)}payload(){this.data.payload.dialogue&&!this.dialogue&&(this.dialogue=this.gamebox.dialogue.play(this.data.payload.dialogue),this.dialogue.then(()=>{this.resetDialogue(),this.data.payload.quest?.setFlag&&this.handleQuestFlagUpdate(this.data.payload.quest.setFlag)}).catch(()=>{this.resetDialogue()}))}resetDialogue(){this.dialogue=null}render(){this.visible()&&(this.gamebox.draw(this.image,this.spritecel[0],this.spritecel[1],this.data.width,this.data.height-this.counter,this.offset.x,this.offset.y+this.counter,this.width,this.height-this.counter),this.player.query.get("debug")&&this.renderDebug())}applyPosition(){if(!this.open){if(this.opening){if(this.rumble>0){this.rumble--,this.position.x+=this.rumble%2===0?-3:3;return}this.counter++,this.position.x+=this.counter%2===0?-3:3,this.counter%5===0&&this.applyFX(),this.counter%15===0&&this.applySound(),this.counter>=this.data.height&&(this.opening=!1,this.open=!0,this.position.x=this.originalX);return}if(this.closing){this.counter--,this.position.x+=this.counter%2===0?-3:3,this.counter%5===0&&this.applyFX(),this.counter%15===0&&this.applySound(),this.counter<=0&&(this.closing=!1,this.open=!1,this.position.x=this.originalX);return}this.position=this.getNextPoi()}}applySound(){this.data.action.sound&&this.player.gameaudio.hitSound(this.data.action.sound)}applyFX(){if(!this.data.action.fx)return;let t=this.map.gamebox.player.getMergedData({id:this.data.action.fx,kill:!0},"fx");this.map.addObject("fx",new m(n.merge(t,{spawn:{x:this.position.x+this.width/2-t.width/2,y:this.position.y+this.height-t.height/2},vy:-n.random(0,this.height/2)}),this.map)),this.map.addObject("fx",new m(n.merge(t,{spawn:{x:this.position.x-t.width/2,y:this.position.y+this.height-t.height/2},vx:-n.random(0,16),vy:-n.random(0,this.height/2)}),this.map)),this.map.addObject("fx",new m(n.merge(t,{spawn:{x:this.position.x+this.width-t.width/2,y:this.position.y+this.height-t.height/2},vx:n.random(0,16),vy:-n.random(0,this.height/2)}),this.map)),this.width>this.map.data.tilesize&&(this.map.addObject("fx",new m(n.merge(t,{spawn:{x:this.position.x+this.width/4-t.width/2,y:this.position.y+this.height-t.height/2},vx:-n.random(0,16),vy:-n.random(0,this.height/2)}),this.map)),this.map.addObject("fx",new m(n.merge(t,{spawn:{x:this.position.x+this.width-this.width/4-t.width/2,y:this.position.y+this.height-t.height/2},vx:n.random(0,16),vy:-n.random(0,this.height/2)}),this.map)))}canInteract(t){return this.state.action&&(!this.state.action.dir||t===this.state.action.dir)}canDoAction(t){return this.data.action&&this.data.action.verb&&t===this.data.action.verb}doInteract(){this.opening||this.closing||this.data.payload&&this.payload()}doAction(t){if(!(this.opening||this.closing)){if(this.open){this.open=!1,this.closing=!0,this.counter=this.height;return}this.opening=!0,this.counter=0,this.rumble=60}}handleQuestInteractionCheck(){if(this.data.action.quest.checkFlag){let{key:t,dialogue:i}=this.data.action.quest.checkFlag;if(this.isQuestFlagComplete())return;if(!this.checkQuestFlag(t)){i&&this.gamebox.dialogue.auto(i);return}this.handleQuestFlagCheck(t)}if(this.data.action.quest.checkItem){let{id:t,dialogue:i}=this.data.action.quest.checkItem;if(!this.gamebox.hero.itemCheck(t)){i&&this.gamebox.dialogue.auto(i);return}this.handleQuestItemCheck(t)}}handleQuestFlagCheck(t){if(this.checkQuestFlag(t)){if(this.gamequest.completeQuest(t),this.data.action.quest.setFlag){let{key:i,value:e}=this.data.action.quest.setFlag;this.gamequest.hitQuest(i,e)}this.handleDoAction()}}handleQuestItemCheck(t){if(this.gamebox.hero.itemCheck(t)){let i=this.gamebox.hero.getItem(t);i&&i.collect&&this.gamebox.hero.takeCollectible(t),this.handleDoAction()}}handleDoAction(){let t=this.open?a.verbs.CLOSE:a.verbs.OPEN;this.canDoAction(t)&&this.doAction(t)}};var Z=class{constructor(t){this.data=t,this.build()}build(){this.canvas=document.createElement("canvas"),this.canvas.className="_2dk__layer",this.canvas.dataset.layer=this.data.id,this.context=this.canvas.getContext("2d"),this.update(this.data.width,this.data.height)}update(t,i){this.data.width=t,this.data.height=i,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${i}px`,this.canvas.width=t,this.canvas.height=i}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}destroy(){this.clear(),this.canvas.width=0,this.canvas.height=0,this.context=null,this.canvas=null}},q=Z;var tt=class{constructor(t,i){this.data=t,this.map=i,this.gamebox=this.map.gamebox,this.frame=0,this.pushed=[],this.spliced=[],this.previousElapsed=null}destroy(){}blit(t){this.previousElapsed===null&&(this.previousElapsed=t),this.applyFrame(t)}applyFrame(t){if(this.data.stepsX){let i=this.data.dur/this.data.stepsX,e=t-this.previousElapsed;e>=i&&(this.previousElapsed=t-e%i,this.frame++,this.frame>=this.data.stepsX&&(this.previousElapsed=null,this.frame=0))}else this.frame=0}getTile(){return[this.data.offsetX+this.frame*this.map.data.tilesize,this.data.offsetY]}canInteract(t=null){return t?this.data.actions.find(i=>i.verb===t):this.data.actions}canAttack(){return this.data.actions&&this.data.actions.find(t=>t.verb===a.verbs.ATTACK)}attack(t,i){this.splice(t);let e={position:{x:t[0]*this.map.data.tilesize,y:t[1]*this.map.data.tilesize},width:this.map.data.tilesize,height:this.map.data.tilesize};i.drops&&this.gamebox.itemDrop(i.drops,e.position),this.gamebox.smokeObject(e,i.fx)}splice(t){if(!this.isSpliced(t)){for(let i=this.pushed.length;i--;)if(this.pushed[i][0]===t[0]&&this.pushed[i][1]===t[1])return this.spliced.push(this.pushed[i]),this.pushed.splice(i,1),!0}}push(t){this.isPushed(t)||this.pushed.push(t)}isPushed(t){return this.pushed.find(i=>i[0]===t[0]&&i[1]===t[1])}isSpliced(t){return this.spliced.find(i=>i[0]===t[0]&&i[1]===t[1])}},bt=tt;var it=class{constructor(t,i){this.data=t,this.gamebox=i,this.player=this.gamebox.player,this.camera=this.gamebox.camera,this.width=this.data.width,this.height=this.data.height,this.image=b.cash(t.image),this.layers={background:null,foreground:null},this.offset={x:0,y:0},this.activeTiles=[],this.fx=[],this.npcs=[],this.doors=[],this.items=[],this.sprites=[]}destroy(){for(let t in this.layers)this.layers[t].offCanvas.destroy();this.layers=null;for(let t=this.activeTiles.length;t--;)this.activeTiles[t].destroy();this.activeTiles=null;for(let t=this.npcs.length;t--;)this.npcs[t].destroy();this.npcs=null;for(let t=this.doors.length;t--;)this.doors[t].destroy();this.doors=null;for(let t=this.fx.length;t--;)this.fx[t].destroy();this.fx=null;for(let t=this.items.length;t--;)this.items[t].destroy();this.items=null;for(let t=this.sprites.length;t--;)this.sprites[t].destroy();this.sprites=null,this.image=null}initialize(){for(let t in this.layers)this.addLayer(t);for(let t=this.data.fx.length;t--;)this.fx.push(new m(this.player.getMergedData(this.data.fx[t],"fx",!0),this));for(let t=this.data.npcs.length;t--;)this.data.npcs[t].type===a.npc.types.DOOR?this.doors.push(new O(this.player.getMergedData(this.data.npcs[t],"npcs"),this)):this.npcs.push(new z(this.player.getMergedData(this.data.npcs[t],"npcs"),this,`npc-${this.data.id}-${t}`));for(let t=this.data.tiles.length;t--;)this.activeTiles.push(new bt(this.data.tiles[t],this))}addLayer(t){let i=this.gamebox.camera.width+this.data.tilesize*2,e=this.gamebox.camera.height+this.data.tilesize*2;this.layers[t]={},this.layers[t].offCanvas=new q({id:t,width:i,height:e}),this.layers[t].offCanvas.canvas.width=`${i*this.gamebox.camera.resolution}`,this.layers[t].offCanvas.canvas.height=`${e*this.gamebox.camera.resolution}`}blit(t){for(let i=this.activeTiles.length;i--;)this.activeTiles[i].blit(t);for(let i=this.npcs.length;i--;)this.npcs[i].blit(t);for(let i=this.doors.length;i--;)this.doors[i].blit(t);for(let i=this.fx.length;i--;)this.fx[i].blit(t);for(let i=this.sprites.length;i--;)this.sprites[i].blit(t);for(let i=this.items.length;i--;)this.items[i].blit(t)}update(t){this.offset=t;for(let i=this.npcs.length;i--;)this.npcs[i].update();for(let i=this.doors.length;i--;)this.doors[i].update();for(let i=this.fx.length;i--;)this.fx[i].update();for(let i=this.sprites.length;i--;)this.sprites[i].update();for(let i=this.items.length;i--;)this.items[i].update()}render(t,i){this.clear(),this.renderBox=this.getRenderbox(),this.gamebox.renderQueue.add({render:this.renderTextures.bind(this,"background"),layer:"background"}),this.renderSprites(t,i),this.gamebox.renderQueue.add({render:this.renderTextures.bind(this,"foreground"),layer:"foreground"})}renderSprites(t,i){let e=[t,...this.fx,...this.npcs,...this.doors,...this.items,...this.sprites];i&&e.push(i),e.sort((s,h)=>s.position.y+s.height-(h.position.y+h.height));for(let s=0;s<e.length;s++)this.gamebox.renderQueue.add(e[s])}renderDebug(){let t=this.gamebox.getVisibleColliders();this.gamebox.mapLayer.context.save(),this.gamebox.mapLayer.context.globalAlpha=.5;for(let i=t.length;i--;)this.gamebox.mapLayer.context.fillStyle=a.colors.red,this.gamebox.mapLayer.context.fillRect(this.offset.x+t[i][0]*this.data.collider,this.offset.y+t[i][1]*this.data.collider,this.data.collider,this.data.collider);this.gamebox.mapLayer.context.restore()}renderTextures(t){n.drawMapTiles(this.layers[t].offCanvas.context,this.image,this.renderBox.textures[t],this.data.tilesize,this.data.tilesize),this.gamebox.draw(this.layers[t].offCanvas.canvas,0,0,this.layers[t].offCanvas.canvas.width,this.layers[t].offCanvas.canvas.height,this.renderBox.bleed.x,this.renderBox.bleed.y,this.layers[t].offCanvas.canvas.width,this.layers[t].offCanvas.canvas.height)}clear(){for(let t in this.layers)this.layers[t].offCanvas.clear()}getRenderbox(){let t={x:Math.floor(this.camera.x/this.data.tilesize)-1,y:Math.floor(this.camera.y/this.data.tilesize)-1,width:this.camera.width+this.data.tilesize*2,height:this.camera.height+this.data.tilesize*2,bleed:{},textures:{}};return t.bleed=this.getBleed(t),t.textures=this.getTextures(t),t}getBleed(t){return{x:-(this.camera.x-t.x*this.data.tilesize),y:-(this.camera.y-t.y*this.data.tilesize)}}getTextures(t){let i=t.height/this.data.tilesize,e=t.width/this.data.tilesize,s={};for(let h in this.data.textures){let o=0;for(s[h]=[];o<i;){s[h][o]=[];let l=t.y+o;if(this.data.textures[h][l]){let d=0;for(;d<e;){let p=t.x+d;if(this.data.textures[h][l][p]){let u=structuredClone(this.data.textures[h][l][p]),f=this.getActiveTile(h,[p,l],u);h==="foreground"&&this.checkShiftableForeground(h,l,p,u)?s.background[o][d]=s.background[o][d].concat(u):s[h][o][d]=u,f&&s[h][o][d].push(f)}else s[h][o][d]=0;d++}}o++}}return s}checkShiftableForeground(t,i,e,s){if(t!=="foreground")return!1;let h={x:e*this.data.tilesize,y:i*this.data.tilesize,width:this.data.tilesize,height:this.data.tilesize},o={hero:n.collide(h,this.gamebox.hero.getFullbox()),companion:this.gamebox.companion?n.collide(h,this.gamebox.companion.getFullbox()):!1};if(!o.hero&&!o.companion)return!1;let l=structuredClone(this.data.textures.background[i][e]);if(s===0||l===0||(s=s[s.length-1],l=l[l.length-1],s[0]!==l[0]&&s[1]!==l[1]))return!1;let d=this.gamebox.hero.position.y+this.gamebox.hero.height;if(h.y+h.height<d){let u=i+1;return this.data.textures[t][u][e]?u*this.data.tilesize+this.data.tilesize<d:!0}return!1}spliceActiveTile(t,i){this.getActiveTiles(t).splice(i)}getActiveTiles(t){return this.activeTiles.find(i=>i.data.group===t)}getActiveTile(t,i,e){let s=this.data.tiles.filter(h=>h.layer===t);for(let h=s.length;h--;){let o=s[h],l=e[e.length-1],d=this.getActiveTiles(o.group),p=o.stepsX,u=d.isPushed(i),f=d.isSpliced(i);if(d.pushed.length)for(let T=d.pushed.length;T--;){let v=d.pushed[T];if(v[0]===i[0]&&v[1]===i[1]&&p)return d.getTile()}if(o.offsetX===l[0]&&o.offsetY===l[1]){if(!u&&!f)return d.push(i),!0;if(f)return e.pop(),e}}}getEvent(t){return this.data.events.find(i=>i.coords[0]===t[0]&&i.coords[1]===t[1])}addObject(t,i){this[t].push(i)}killObject(t,i){this[t].splice(this[t].indexOf(i),1),i.destroy(),i=null}},et=it;var st=class{constructor(t,i=0,e=0,s=30,h=1.5,o=.1){this.player=t,this.position={x:i,y:e},this.poi={x:i,y:e},this.velocity={x:0,y:0},this.mass=o,this.stiffness=s,this.damping=h,this.errorMargin=.001,this.isResting=!1,this.sprite=null,this.previousElapsed=null,this.onPaused=this.handlePaused.bind(this),this.player.on(a.broadcast.PAUSED,this.onPaused)}destroy(){this.player.off(a.broadcast.PAUSED,this.onPaused)}handlePaused(){this.previousElapsed=null}bind(t){this.sprite=t}blit(t){if(this.previousElapsed===null&&(this.previousElapsed=t),Math.abs(this.position.x-this.poi.x)<this.errorMargin&&Math.abs(this.position.y-this.poi.y)<this.errorMargin){this.previousElapsed=t,this.isResting=!0;return}let e=(t-this.previousElapsed)/1e3;this.previousElapsed=t,this.isResting=!1;let s=-this.stiffness*(this.position.x-this.poi.x),h=-this.damping*this.velocity.x,o=(s+h)/this.mass,l=-this.stiffness*(this.position.y-this.poi.y),d=-this.damping*this.velocity.y,p=(l+d)/this.mass;this.velocity.x+=o*e,this.velocity.y+=p*e,this.position.x+=this.velocity.x*e,this.position.y+=this.velocity.y*e,this.sprite&&(this.sprite.position.x=this.position.x,this.sprite.position.y=this.position.y)}},G=st;var X=class extends g{constructor(t,i){super(t,i),this.currency=this.data.currency||0,this.itemGet=null,this.liftedTile=null,this.maskFX=null,this.items=[],this.controls=this.player.controls,this.killed=!1,this.deathCounter=0,this.projectile=null,this.mode=a.hero.modes.WEAPON,this.interact=null,this.parkour=null,this.falling=null,this.lastPositionOnGround=this.position}visible(){return!0}hit(...t){super.hit(...t),this.physics.vz=-6}jump(){this.maskFX=null,this.resetMaxV(),this.cycle(a.verbs.JUMP,this.dir),this.physics.vz=-(this.map.data.tilesize/3),this.player.gameaudio.hitSound(a.verbs.JUMP)}resetMaxV(){this.gamebox.running?(this.physics.maxv=this.physics.controlmaxvstatic*1.75,this.physics.controlmaxv=this.physics.controlmaxvstatic*1.75):(this.physics.maxv=this.physics.maxvstatic,this.physics.controlmaxv=this.physics.controlmaxvstatic)}resetItemGet(){this.itemGet=null,this.stillTimer=0,this.face("down")}checkStat(t,i){return this.getStat(t)>=i}getStat(t){let i=this.items.filter(e=>e.stat?.key===t);return this.stats[t]+i.reduce((e,s)=>e+s.stat.value,0)}itemCheck(t){let i=this.getItem(t);return i&&i.collect&&i.collected>0||i}getItem(t){return this.items.find(i=>i.id===t)}hasJump(){return this.items.some(t=>t.verb===a.verbs.JUMP)}hasProjectile(){return this.items.some(t=>t.projectile)}fireProjectile(){let t=this.items.find(e=>e.projectile);if(!t)return;let i=this.gamebox.player.getMergedData({id:t.projectile},"projectiles");this.projectile=new ht(i,this.dir,this,this.map)}collectItem(t){let i=this.getItem(t);if(i){i.collected++;return}this.giveItem(t)}takeCollectible(t){let i=this.getItem(t);i&&i.collect&&(i.collected=Math.max(0,i.collected-1))}giveItem(t,i){let e=this.player.getMergedData({id:t,mapId:i},"items");this.items.push(e),this.data.verbs.item?.down&&(this.itemGet=new at(this.position,e,this.map,this),this.stillTimer=1/0,this.cycle("item","down"),this.player.gameaudio.hitSound("itemGet")),e.equip&&this.equip(e.equip),e.currency&&this.receive(e.currency),e.collect&&(e.collected=1)}takeItem(t){let i=this.items.find(e=>e.id===t);i&&(this.items.splice(this.items.indexOf(i),1),i.equip&&this.unequip(i.equip))}pay(t){this.currency=Math.max(0,this.currency-t)}receive(t){this.currency+=t}equip(t){this.data.equipped[t]=!0}unequip(t){this.data.equipped[t]=!1}isEquipped(t){return this.data.equipped[t]||!1}hasWeapon(){return this.data.equipped.weapon&&this.data.weapon?.[this.dir]?.length}hasShield(){return this.data.equipped.shield&&this.data.shield?.[this.verb]?.[this.dir]?.length}blitAfter(t){this.maskFX&&this.maskFX.blit(t),this.itemGet&&this.itemGet.blit(t),this.liftedTile&&this.liftedTile.blit(t)}update(){this.handleControls(),this.handlePassiveInteraction(),this.handleVelocity(),this.handleGravity(),this.applyGravity(),this.maskFX&&this.maskFX.update(),this.itemGet&&this.itemGet.update(),this.liftedTile&&this.liftedTile.update()}renderAfter(){this.maskFX&&this.maskFX.render(),this.itemGet&&this.itemGet.render(),this.liftedTile&&this.liftedTile.render(),this.hasWeapon()&&this.is(a.verbs.ATTACK)&&this.mode===a.hero.modes.WEAPON&&(this.gamebox.draw(this.image,this.data.weapon[this.dir][this.frame].offsetX,this.data.weapon[this.dir][this.frame].offsetY,this.data.weapon[this.dir][this.frame].width,this.data.weapon[this.dir][this.frame].height,this.offset.x+this.data.weapon[this.dir][this.frame].positionX,this.offset.y+this.data.weapon[this.dir][this.frame].positionY,this.data.weapon[this.dir][this.frame].width/this.scale,this.data.weapon[this.dir][this.frame].height/this.scale),this.frame>0&&this.handleAttackFrame()),this.hasShield()&&!this.gamebox.attacking&&this.gamebox.draw(this.image,this.data.shield[this.verb][this.dir][this.frame].offsetX,this.data.shield[this.verb][this.dir][this.frame].offsetY,this.data.shield[this.verb][this.dir][this.frame].width,this.data.shield[this.verb][this.dir][this.frame].height,this.offset.x+this.data.shield[this.verb][this.dir][this.frame].positionX,this.offset.y+this.position.z+this.data.shield[this.verb][this.dir][this.frame].positionY,this.data.shield[this.verb][this.dir][this.frame].width/this.scale,this.data.shield[this.verb][this.dir][this.frame].height/this.scale),this.player.query.get("debug")&&this.renderAfterDebug()}renderAfterDebug(){if(this.gamebox.mapLayer.context.globalAlpha=.5,this.gamebox.mapLayer.context.fillStyle=a.colors.teal,this.hasWeapon()&&this.is(a.verbs.ATTACK)){let t=this.getWeaponbox("offset");this.gamebox.mapLayer.context.fillRect(t.x,t.y,t.width,t.height)}if(this.hasShield()){let t=this.getShieldbox("offset");this.gamebox.mapLayer.context.fillRect(t.x,t.y,t.width,t.height)}}handlePassiveInteraction(){let t=this.getNextPoiByDir(this.dir,1),i={npc:this.gamebox.checkNPC(t,this),door:this.gamebox.checkDoor(t,this),tiles:this.gamebox.checkTiles(t,this)},e=!this.is(a.verbs.LIFT)&&!this.is(a.verbs.GRAB)&&!this.is(a.verbs.PULL),s=i.door&&i.door.canInteract(this.dir),h=i.npc&&i.npc.canInteract(this.dir),o=this.canGrabTile(i)||!e;return this.gamebox.dialogue.active||s||h?this.interact=a.hero.interact.READ:o?this.interact=a.hero.interact.GRAB:e&&(this.interact=null),{poi:t,collision:i}}handleAttackFrame(){let t=this.getNextPoiByDir(this.dir,1),i=this.getWeaponbox(),e={npc:this.gamebox.checkNPC(t,i),tiles:this.gamebox.checkTiles(t,i),item:this.gamebox.checkItems(t,i)};if(e.item&&this.gamebox.handleHeroItem(t,this.dir,e.item),e.npc&&!e.npc.hitTimer&&e.npc.canDoAction(a.verbs.ATTACK)&&e.npc.hit(this.getStat("power")),e.tiles&&e.tiles.attack.length){for(let s=e.tiles.attack.length;s--;)if(e.tiles.attack[s].attack){let h=e.tiles.attack[s].instance.canAttack();h&&e.tiles.attack[s].instance.attack(e.tiles.attack[s].coord,h)}}}handleHealthCheck(){this.stats.health<=0&&(this.killed=!0,this.stillTimer=1/0,this.deathCounter=240,this.maskFX&&(this.maskFX.paused=!0),this.data.verbs.kill?.down&&(this.cycle("kill","down"),this.player.gameaudio.stop(),this.player.gameaudio.hitSound("death")))}applyPosition(t,i){if(this.parkour){this.applyParkour(),this.applyHitbox();return}if(this.falling){this.applyFalling(),this.applyHitbox();return}this.gamebox.jumping||(this.lastPositionOnGround={x:this.position.x,y:this.position.y}),this.dir=i,this.position.x=t.x,this.position.y=t.y,this.applyHitbox(),this.applyHeroMask()}applyFalling(){if(this.position.x===this.falling.reset.x&&this.position.y===this.falling.reset.y){this.falling=null,this.frameStopped=!1,this.gamebox.falling=!1,this.face(this.dir),this.hit(.25);return}this.position.x===this.falling.to.x&&this.position.y===this.falling.to.y&&(this.falling.didReset=!0,this.falling.resetCounter?this.falling.resetCounter>0&&this.falling.resetCounter--:this.falling.resetCounter=30),this.applyFallingPosition()}applyFallingPosition(){if(this.falling.resetCounter&&this.falling.resetCounter>0)return;let t={x:this.position.x,y:this.position.y,z:this.position.z},i=2,e=this.falling.didReset?this.falling.reset:this.falling.to;Math.abs(t.x-e.x)>i?t.x+=t.x<e.x?i:-i:t.x=e.x,Math.abs(t.y-e.y)>i?t.y+=t.y<e.y?i:-i:t.y=e.y,this.position=t}applyParkour(){if(this.parkour.didEventDoor){if(this.frameStopped){this.frameStopped=!1,this.gamebox.dropin=!0,this.applyParkourComplete();return}return}if(this.position.x===this.parkour.poi.x&&this.position.y===this.parkour.poi.y){if(this.parkour.isEventDoor){this.parkour.event.verb&&this.can(this.parkour.event.verb)?(this.parkour.didEventDoor=!0,this.cycle(this.parkour.event.verb,this.parkour.dir)):this.applyParkourComplete();return}this.applyParkourLanding();return}this.applyParkourPosition()}applyParkourPosition(){let t={x:this.position.x,y:this.position.y,z:this.position.z},i=this.parkour.elevation===1?4:this.parkour.elevation*3;switch(this.parkour.dir){case"left":t.x=Math.max(t.x-i,this.parkour.poi.x);break;case"right":t.x=Math.min(t.x+i,this.parkour.poi.x);break;case"up":t.y=Math.max(t.y-i,this.parkour.poi.y);break;case"down":t.y=Math.min(t.y+i,this.parkour.poi.y);break}this.position=t}applyParkourComplete(){this.gamebox.handleCriticalReset(),this.gamebox.handleHeroEventDoor(this.parkour.poi,this.parkour.dir,this.parkour.event),this.gamebox.jumping=!1,this.parkour=null}applyParkourLanding(){let t=this.parkour.activeTiles&&this.parkour.activeTiles.canAttack();t&&this.parkour.activeTiles.attack([this.parkour.tile[0]/this.map.data.tilesize,this.parkour.tile[1]/this.map.data.tilesize],t),this.face(this.parkour.dir),this.gamebox.jumping=!1,this.parkour=null;let i=this.player.gamepad.checkDpad();if(i.length)for(let e=0;e<i.length;e++)for(let s=0;s<i[e].dpad.length;s++)this.player.controls[i[e].dpad[s]]=!0}applyHeroMask(){if(this.maskFX){let t=this.position.x+(this.width-this.maskFX.width)/2,i=this.position.y+(this.height-this.maskFX.height);this.maskFX.position.x=t,this.maskFX.position.y=i,this.isIdle()&&this.maskFX.frame===this.maskFX.data.stepsX-1?this.maskFX.paused=!0:this.maskFX.paused=!1}}applyOffset(){let t={x:Math.abs(this.map.offset.x),y:Math.abs(this.map.offset.y)};this.offset={x:this.gamebox.camera.width/2-this.width/2,y:this.gamebox.camera.height/2-this.height/2},t.x<=0&&(this.offset.x=this.position.x),t.x>=this.map.width-this.gamebox.camera.width&&(this.offset.x=this.position.x+this.map.offset.x),t.y<=0&&(this.offset.y=this.position.y),t.y>=this.map.height-this.gamebox.camera.height&&(this.offset.y=this.position.y+this.map.offset.y)}applyCycle(){this.parkour||this.falling||(this.is(a.verbs.LIFT)?this.cycle(a.verbs.LIFT,this.dir):this.gamebox.jumping?this.cycle(a.verbs.JUMP,this.dir):this.gamebox.attacking?this.cycle(a.verbs.ATTACK,this.dir):this.gamebox.running?this.cycle(a.verbs.RUN,this.dir):this.idle.x&&this.idle.y?this.face(this.dir):this.cycle(a.verbs.WALK,this.dir))}getWeaponbox(t="position"){return{x:this[t].x+this.data.weapon[this.dir][this.frame].positionX,y:this[t].y+this.data.weapon[this.dir][this.frame].positionY,width:this.data.weapon[this.dir][this.frame].width,height:this.data.weapon[this.dir][this.frame].height}}getShieldbox(t="position"){return{x:this[t].x+this.data.shield[this.verb][this.dir][this.frame].positionX,y:this[t].y+this.data.shield[this.verb][this.dir][this.frame].positionY,width:this.data.shield[this.verb][this.dir][this.frame].width,height:this.data.shield[this.verb][this.dir][this.frame].height}}getPositionForNewMap(){if(this.dir==="down")return{x:this.position.x,y:0,z:0};if(this.dir==="up")return{x:this.position.x,y:this.map.height-this.height,z:0};if(this.dir==="right")return{x:0,y:this.position.y,z:0};if(this.dir==="left")return{x:this.map.width-this.width,y:this.position.y,z:0}}canMoveWhileJumping(t){return!t.map&&!t.npc&&!t.camera&&!(t.tiles&&t.tiles.action.length&&t.tiles.action.find(i=>i.stop))}canResetMaxV(){return this.physics.maxv!==this.physics.controlmaxv&&!this.is(a.verbs.LIFT)}canEventDoor(t){return t.event.type===a.events.DOOR}canEventBoundary(t){return t.event.type===a.events.BOUNDARY&&t.camera}canEventDialogue(t){return t.event.type===a.events.DIALOGUE&&t.event.payload}canLift(t){return t===a.opposites[this.dir]}canGrabTile(t){return t.tiles&&t.tiles.action.length&&t.tiles.action[0].action&&t.tiles.action[0].instance.canInteract(a.verbs.LIFT)&&this.can(a.verbs.LIFT)&&this.can(a.verbs.GRAB)}canTileJump(t,i){let e=i.tiles&&i.tiles.passive.length;if(this.is(a.verbs.LIFT)||!e)return!1;let s=i.tiles.passive.filter(o=>o.jump);if(!s.length)return!1;let h=s[0];return s.length>1?s.every(o=>o.instance.canInteract(a.verbs.JUMP).dir===t):(h.collides.width>h.tilebox.width/2||h.collides.height>h.tilebox.height/2)&&h.instance.canInteract(a.verbs.JUMP).dir===t}canTileFall(t,i){let{tiles:e,empty:s}=i,h=e&&e.action.filter(l=>l.fall),o=5;if(h&&h.length)return h.some(l=>n.collide(l.tilebox,this.footbox,o));if(s){let l=s.find(f=>n.collide(f,this.footbox,o));if(!l)return!1;let d=[l.x/this.map.data.tilesize,l.y/this.map.data.tilesize];return this.map.getEvent(d)||this.gamebox.getEmptyTile(d,"foreground")!==0?!1:!!l}return!1}canShield(t){return this.hasShield()?this.dir==="left"&&t.hitbox.x+t.hitbox.width<=this.hitbox.x||this.dir==="right"&&t.hitbox.x>=this.hitbox.x+this.hitbox.width||this.dir==="up"&&t.hitbox.y+t.hitbox.height<=this.hitbox.y||this.dir==="down"&&t.hitbox.y>=this.hitbox.y+this.hitbox.height:!1}},ht=class extends A{constructor(t,i,e,s){super(t,i,e,s),this.hero=e}applyPosition(){let t=this.getNextPoi(),i={map:this.gamebox.checkMap(t,this),npc:this.gamebox.checkNPC(t,this),tiles:this.gamebox.checkTiles(t,this),doors:this.gamebox.checkDoor(t,this),camera:this.gamebox.checkCamera(t,this)};if(i.map||i.npc||i.doors||i.camera||this.canTileStop(i)){i.npc&&i.npc.data.type===a.npc.types.ENEMY&&!i.npc.isHitOrStill()&&i.npc.hit(this.data.power),this.kill();return}this.position=t}},at=class extends g{constructor(t,{verb:i,...e},s,h){let o={spawn:t,hitbox:{x:0,y:0,width:e.width,height:e.height},verbs:{face:{down:{offsetX:e.offsetX,offsetY:e.offsetY}}},...e};super(o,s),this.hero=h}applyPosition(){this.position={x:this.hero.position.x+this.hero.width/2-this.width/2,y:this.hero.position.y,z:-this.height}}},W=class extends g{constructor(t,i,e,s){let h=i.getTile(),o={width:e.data.tilesize,height:e.data.tilesize,image:e.data.image,spawn:t,hitbox:{x:0,y:0,width:e.data.tilesize,height:e.data.tilesize},verbs:{face:{down:{offsetX:h[0],offsetY:h[1]}}}};super(o,e),this.hero=s,this.throwing=!1,this.activeTiles=i}destroy(){let t=this.activeTiles.canAttack();t?.drops&&this.gamebox.itemDrop(t.drops,this.position),t?.sound&&this.player.gameaudio.hitSound(t.sound),this.gamebox.smokeObject(this,t?.fx),this.gamebox.interact.tile=null,this.hero.liftedTile=null,this.spring.destroy()}blit(t){if(!this.spring)return;if(this.spring.isResting){this.destroy();return}let i={map:this.gamebox.checkMap(this.position,this),npc:this.gamebox.checkNPC(this.position,this),camera:this.gamebox.checkCamera(this.position,this)};if(i.map||i.npc||i.camera){this.destroy();return}this.spring.blit(t)}applyPosition(){if(!this.throwing){this.position={x:this.hero.position.x+this.hero.width/2-this.width/2,y:this.hero.hitbox.y,z:-this.height};return}this.position=this.getNextPoi()}throw(){this.hero.face(this.hero.dir),this.player.gameaudio.hitSound(a.verbs.THROW),this.hero.physics.maxv=this.hero.physics.controlmaxv,this.hero.interact=null,this.throwing=!0;let t,i,e=this.map.data.tilesize*2;switch(this.hero.dir){case"left":t=this.position.x-e,i=this.hero.footbox.y-(this.height-this.hero.footbox.height);break;case"right":t=this.position.x+e,i=this.hero.footbox.y-(this.height-this.hero.footbox.height);break;case"up":t=this.position.x,i=this.position.y-e;break;case"down":t=this.position.x,i=this.hero.footbox.y+e;break}this.spring=new G(this.player,this.position.x,this.position.y,60,3.5),this.spring.poi={x:t,y:i},this.spring.bind(this)}};var F=class extends g{constructor(t,i){super(t,i.map),this.hero=i,this.spring=new G(this.player,this.position.x,this.position.y,10),this.spring.bind(this)}destroy(){this.spring.destroy()}visible(){return!0}blit(t){if(this.visible()){switch(this.previousElapsed===null&&(this.previousElapsed=t),this.data.type){case a.npc.ai.WALK:this.blitWalk();break;case a.npc.ai.FLOAT:this.blitFloat();break}this.spring.blit(t),this.applyFrame(t)}}blitFloat(){this.position.z=-this.map.data.tilesize,this.hero.position.x+this.hero.width/2>this.position.x+this.width/2?this.dir="right":this.dir="left"}blitWalk(){let t=n.getDistance(this.position,this.spring.poi);(!this.hero.idle.x||!this.hero.idle.y||this.hero.idle.x&&this.hero.idle.y&&t>this.map.data.tilesize/2)&&this.data.bounce&&this.position.z===0&&(this.physics.vz=-8),Math.ceil(this.hero.position.x)>Math.floor(this.position.x)?this.dir="right":this.dir="left"}applyPosition(){this.data.type===a.npc.ai.WALK&&this.applyWalkPosition(),this.data.type===a.npc.ai.FLOAT&&this.applyFloatPosition()}applyFloatPosition(){let t={},i={x:this.hero.position.x+this.hero.width/2,y:this.hero.position.y+this.hero.height/2},e={x:this.position.x+this.width/2,y:this.position.y+this.height/2};this.hero.dir==="right"&&i.x>e.x&&(t.x=i.x-this.width,t.y=i.y),this.hero.dir==="left"&&i.x<e.x&&(t.x=i.x,t.y=i.y),this.hero.dir==="up"&&i.y<e.y&&(t.x=i.x-this.width/2,t.y=i.y+this.height),this.hero.dir==="down"&&i.y>e.y&&(t.x=i.x-this.width/2,t.y=i.y),t.x&&t.y&&(this.spring.poi=t)}applyWalkPosition(){let t={};this.hero.dir==="right"&&this.hero.position.x>this.position.x&&(t.x=this.hero.position.x-this.width/2,t.y=this.hero.footbox.y-(this.height-this.hero.footbox.height)),this.hero.dir==="left"&&this.hero.position.x<this.position.x&&(t.x=this.hero.position.x+this.hero.width-this.width/2,t.y=this.hero.footbox.y-(this.height-this.hero.footbox.height)),this.hero.dir==="up"&&this.hero.position.y<this.position.y&&(t.x=this.hero.position.x+this.hero.width/2-this.width/2,t.y=this.hero.position.y+this.hero.height-this.height/2),this.hero.dir==="down"&&this.hero.position.y>this.position.y&&(t.x=this.hero.position.x+this.hero.width/2-this.width/2,t.y=this.hero.position.y-this.height/2),t.x&&t.y&&(this.spring.poi=t)}};function P(r,t){this.x=r,this.y=t,this.delays=[]}P.prototype.process=function(){};P.prototype.countSurroundingCellsWithValue=function(r,t){for(var i=0,e=0;e<r.length;e++)r[e]!==null&&r[e][t]&&i++;return i};P.prototype.delay=function(r,t){this.delays.push({steps:r,action:t})};P.prototype.reset=function(){};P.prototype.getSurroundingCellsAverageValue=function(r,t){for(var i=0,e=0;e<r.length;e++)r[e]!==null&&(r[e][t]||r[e][t]===0)&&(i+=r[e][t]);return i/r.length};function ot(r){this.width=24,this.height=24,this.options=r,this.wrap=!1,this.TOPLEFT={index:0,x:-1,y:-1},this.TOP={index:1,x:0,y:-1},this.TOPRIGHT={index:2,x:1,y:-1},this.LEFT={index:3,x:-1,y:0},this.RIGHT={index:4,x:1,y:0},this.BOTTOMLEFT={index:5,x:-1,y:1},this.BOTTOM={index:6,x:0,y:1},this.BOTTOMRIGHT={index:7,x:1,y:1},this.randomGenerator=Math.random;var t=[null,null,null,null,null,null,null,null];this.options.hexTiles&&(t=[null,null,null,null,null,null]),this.step=function(){var s,h;for(s=0;s<this.height;s++)for(h=0;h<this.width;h++)this.grid[s][h].reset();for(s=this.height-1;s>=0;s--)for(h=this.width-1;h>=0;h--){this.fillNeighbors(t,h,s);var o=this.grid[s][h];o.process(t);for(var l=0;l<o.delays.length;l++)o.delays[l].steps--,o.delays[l].steps<=0&&(o.delays[l].action(o),o.delays.splice(l,1),l--)}};var i=[{diffX:function(){return-1},diffY:function(){return-1}},{diffX:function(){return 0},diffY:function(){return-1}},{diffX:function(){return 1},diffY:function(){return-1}},{diffX:function(){return-1},diffY:function(){return 0}},{diffX:function(){return 1},diffY:function(){return 0}},{diffX:function(){return-1},diffY:function(){return 1}},{diffX:function(){return 0},diffY:function(){return 1}},{diffX:function(){return 1},diffY:function(){return 1}}];if(this.options.hexTiles&&(this.options.flatTopped?i=[{diffX:function(){return-1},diffY:function(s){return s%2?-1:0}},{diffX:function(){return 0},diffY:function(){return-1}},{diffX:function(){return 1},diffY:function(s){return s%2?-1:0}},{diffX:function(){return 1},diffY:function(s){return s%2?0:1}},{diffX:function(){return 0},diffY:function(){return 1}},{diffX:function(){return-1},diffY:function(s){return s%2?0:1}}]:i=[{diffX:function(s,h){return h%2?0:-1},diffY:function(){return-1}},{diffX:function(s,h){return h%2?1:0},diffY:function(){return-1}},{diffX:function(){return-1},diffY:function(){return 0}},{diffX:function(){return 1},diffY:function(){return 0}},{diffX:function(s,h){return h%2?0:-1},diffY:function(){return 1}},{diffX:function(s,h){return h%2?1:0},diffY:function(){return 1}}]),this.fillNeighbors=function(s,h,o){for(var l=0;l<i.length;l++){var d=h+i[l].diffX(h,o),p=o+i[l].diffY(h,o);this.wrap&&(d=(d+this.width)%this.width,p=(p+this.height)%this.height),!this.wrap&&(d<0||p<0||d>=this.width||p>=this.height)?s[l]=null:s[l]=this.grid[p][d]}},this.initialize=function(s){s.sort(function(u,f){return u.distribution>f.distribution?1:-1});for(var h=0,o=0;o<s.length;o++)h+=s[o].distribution,s[o].distribution=h;this.grid=[];for(var l=0;l<this.height;l++){this.grid[l]=[];for(var d=0;d<this.width;d++){var p=this.randomGenerator()*100;for(o=0;o<s.length;o++)if(p<=s[o].distribution){this.grid[l][d]=new this.cellTypes[s[o].name](d,l);break}}}},this.cellTypes={},this.registerCellType=function(s,h,o){if(this.cellTypes[s]=function(d,p){if(P.call(this,d,p),o&&o.call(this,d,p),h)for(var u in h)typeof h[u]!="function"&&(typeof h[u]=="object"?this[u]=JSON.parse(JSON.stringify(h[u])):this[u]=h[u])},this.cellTypes[s].prototype=Object.create(P.prototype),this.cellTypes[s].prototype.constructor=this.cellTypes[s],this.cellTypes[s].prototype.cellType=s,h)for(var l in h)typeof h[l]=="function"&&(this.cellTypes[s].prototype[l]=h[l])},r)for(var e in r)this[e]=r[e]}ot.prototype.initializeFromGrid=function(r,t){this.grid=[];for(var i=0;i<this.height;i++){this.grid[i]=[];for(var e=0;e<this.width;e++)for(var s=0;s<r.length;s++)if(r[s].gridValue===t[i][e]){this.grid[i][e]=new this.cellTypes[r[s].name](e,i);break}}};ot.prototype.createGridFromValues=function(r,t){for(var i=[],e=0;e<this.height;e++){i[e]=[];for(var s=0;s<this.width;s++){i[e][s]=t;for(var h=this.grid[e][s],o=0;o<r.length;o++)h.cellType==r[o].cellType&&h[r[o].hasProperty]&&(i[e][s]=r[o].value)}}return i};var Rt={World:ot,Cell:P},vt=Rt;var rt=class{constructor(){this.controller=new E,this.map=null,this.world=null,this.tiles=null,this.textures=[]}destroy(){this.controller.stop()}initialize(t){let{algo:i,textures:e}=t.cellauto;return this.map=structuredClone(t),this.algo=i,this.textureStack=e,this.tiles=null,this.walls=this.map.cellauto.walls,this.textures=this.map.textures.background,this.world=new vt.World({width:this.map.tilewidth,height:this.map.tileheight,cellSize:this.map.tilesize}),this.textureStack.forEach(({name:s},h)=>{this.register(s,h+1)}),this.world.initialize(this.textureStack.map(({name:s,distribution:h})=>({name:s,distribution:h}))),this}register(t,i){let e=Dt[this.algo],{options:s,init:h}=e(i);this.world.registerCellType(t,s,h)}generate(t){return new Promise(i=>{this.controller.go(()=>{let e=[];this.world.step();for(let s=0;s<this.world.height;s++)for(let h=0;h<this.world.width;h++){let l=this.world.grid[s][h].getValue();this.textures[s][h]=l===0?this.walls.texture:this.textureStack[l-1].texture,e.push(l)}this.tiles&&this.tiles.join("")===e.join("")&&(this.controller.stop(),i({spawn:this.spawn(),textures:structuredClone(this.textures)})),this.tiles=e,t({textures:structuredClone(this.textures)})})})}spawn(){let t=null;for(let i=0;i<this.world.height&&!t;i++)for(let e=0;e<this.world.width;e++){let h=this.world.grid[i][e].getValue();if(t===null&&h>0&&e>0&&i>0&&e<this.world.width-1&&i<this.world.height-1){let o=n.getSurroundingTileCoords([e,i]);if(Object.keys(o).map(p=>{let u=o[p];return this.world.grid[u.y][u.x].getValue()}).every(p=>p>0)){t={x:e*this.map.tilesize,y:i*this.map.tilesize,dir:"down"};break}}}return t}},Dt={maze:function(r){return{options:{getValue:function(){return this.alive?0:r},process:function(t){let i=this.countSurroundingCellsWithValue(t,"wasAlive");this.simulated<20&&(this.alive=i===1||i===2&&this.alive),this.simulated>20&&i===2&&(this.alive=!0),this.simulated+=1},reset:function(){this.wasAlive=this.alive}},init:function(){this.alive=Math.random()>.5,this.simulated=0}}},caves:function(r){return{options:{getValue:function(){return this.open?r:0},process:function(t){let i=this.countSurroundingCellsWithValue(t,"wasOpen");this.open=this.wasOpen&&i>=4||i>=6},reset:function(){this.wasOpen=this.open}},init:function(){this.alive=Math.random()>.5,this.simulated=0}}}},wt=rt;var nt=class{constructor(t){this.gamebox=t,this.quests={},this.completed={}}hitQuest(t,i){this.completed[t]||(this.quests[t]||(this.quests[t]=0),this.quests[t]+=i)}completeQuest(t){this.completed[t]=!0,this.quests[t]&&delete this.quests[t]}getQuest(t){return this.quests[t]?this.quests[t]:0}getCompleted(t){return this.completed[t]??!1}checkQuest(t,i){return this.quests[t]?this.quests[t]>=i:0}},kt=nt;var N=class extends g{constructor(t,i,e){let s={spawn:t,hitbox:{x:0,y:0,width:i.width,height:i.height},verbs:{face:{down:{offsetX:i.offsetX,offsetY:i.offsetY}}},...i};super(s,e),this.bounce=6,this.killCounter=60*6}applyPosition(){this.killCounter>0&&(this.killCounter--,this.killCounter===0&&this.map.killObject("items",this)),this.bounce>0&&this.position.z===0&&(this.physics.vz=-this.bounce,this.bounce--),this.position=this.getNextPoi()}applyOpacity(){this.killCounter<=60*2&&this.killCounter%5===0&&(this.gamebox.mapLayer.context.globalAlpha=.25)}canPickup(){return this.bounce===0}};var B=class extends g{constructor(t,i,e){let s={spawn:t,hitbox:{x:0,y:0,width:i.width,height:i.height},verbs:{face:{down:{offsetX:i.offsetX,offsetY:i.offsetY}}},...i};super(s,e),this.bounce=6}applyPosition(){this.bounce>0&&this.position.z===0&&(this.physics.vz=-this.bounce,this.bounce--),this.position=this.getNextPoi()}canPickup(){return this.bounce===0}};var Y=String.raw,H=(r,t,i=30)=>Y`
        <style>
            #${r.id} {
                width: ${r.width}px;
                height: ${r.height}px;
                background-image: url(${r.image});
                background-position: -${r.offsetX}px -${r.offsetY}px;
                transform: scale( 0.65 ) rotate( ${i}deg );
                transform-origin: center center;
            }
        </style>
        <span class="_2dk__gamepad__sprite" id="${r.id}"></span>
        <span>${t}</span>
    `,Tt=r=>{let t=r.gamebox.hero;return Y`
        <div>Hero: ${t.data.name}</div>
        <div>Health: ${t.getStat("health")}</div>
        <div>Power: ${t.getStat("power")}</div>
        <div>Strength: ${t.getStat("strength")}</div>
        <div>${r.data.currency}: ${t.currency}</div>
        <div>Weapon: ${t.data.equipped.weapon?"Equipped":"Not Equipped"}</div>
        <div>Shield: ${t.data.equipped.shield?"Equipped":"Not Equipped"}</div>
    `},_=(r,t)=>Y`
        <div>${r.name}: Save #${r.save}, Release v${r.release}</div>
        <div>${t}</div>
    `,Ct=r=>Y`
        <div>Rotate to Landscape.</div>
        <div>${r?"Webapp Installed":"Install Webapp"}</div>
    `;var j=class{constructor(t){this.gamebox=t,this.map=this.gamebox.map,this.player=this.gamebox.player,this.gamepad=this.player.gamepad,this.hero=this.gamebox.hero,this.buttons={a:null,b:null}}blit(t){}render(){this.renderHealth(),this.renderCurrency(),this.renderKeys(),this.renderItems(),this.renderButtons()}renderButtons(){if(this.gamebox.hero.interact){if(this.buttons.a!==this.gamebox.hero.interact){switch(this.gamebox.hero.interact){case a.hero.interact.READ:let t=this.player.data.hud.interact?.read;t?c.a.elem.innerHTML=H(t,"A",0):this.gamepad.renderButtonText("a");break;case a.hero.interact.GRAB:let i=this.hero.items.find(e=>e.stat&&e.stat.key==="strength");i?c.a.elem.innerHTML=H(i,"A"):this.gamepad.renderButtonText("a");break}this.buttons.a=this.gamebox.hero.interact}}else if(this.buttons.a!==a.verbs.JUMP){let t=this.hero.items.find(i=>i.verb===a.verbs.JUMP);t?c.a.elem.innerHTML=H(t,"A"):this.gamepad.renderButtonText("a"),this.buttons.a=a.verbs.JUMP}if(this.gamebox.hero.mode!==this.buttons.b)switch(this.gamebox.hero.mode){case a.hero.modes.WEAPON:let t=this.hero.items.find(e=>e.equip==="weapon");t&&(c.b.elem.innerHTML=H(t,"B"),this.buttons.b=a.hero.modes.WEAPON);break;case a.hero.modes.PROJECTILE:let i=this.hero.items.find(e=>e.projectile);i&&(c.b.elem.innerHTML=H(i,"B"),this.buttons.b=a.hero.modes.PROJECTILE);break}}renderHealth(){let e=this.map.data.tilesize,s=this.hero.getStat("health"),h=this.hero.maxHealth;this.gamebox.mapLayer.context.save(),this.gamebox.mapLayer.context.globalAlpha=.5,this.gamebox.mapLayer.context.fillStyle=a.colors.yellow,this.gamebox.mapLayer.context.beginPath(),this.gamebox.mapLayer.context.roundRect(20,20,e*h,e/4,2),this.gamebox.mapLayer.context.fill(),this.gamebox.mapLayer.context.closePath(),this.gamebox.mapLayer.context.globalAlpha=1,this.gamebox.mapLayer.context.fillStyle=a.colors.red,this.gamebox.mapLayer.context.beginPath(),this.gamebox.mapLayer.context.roundRect(20,20,e*s,e/4,2),this.gamebox.mapLayer.context.fill(),this.gamebox.mapLayer.context.closePath(),this.gamebox.mapLayer.context.fillStyle="transparent",this.gamebox.mapLayer.context.strokeStyle=a.colors.white,this.gamebox.mapLayer.context.lineWidth=2,this.gamebox.mapLayer.context.beginPath(),this.gamebox.mapLayer.context.roundRect(20,20,e*h,e/4,2),this.gamebox.mapLayer.context.stroke(),this.gamebox.mapLayer.context.closePath(),this.gamebox.mapLayer.context.restore()}renderCurrency(){let s=`x${this.hero.currency}`;if(this.gamebox.mapLayer.context.save(),this.player.data.hud.currency){let h=this.player.data.hud.currency.width,o=this.player.data.hud.currency.height,l=(o-16)/2,d=20+h+s.length*16,p=20-l/2;this.gamebox.mapLayer.context.drawImage(b.cash(this.player.data.hud.currency.image),this.player.data.hud.currency.offsetX,this.player.data.hud.currency.offsetY,h,o,this.gamebox.mapLayer.data.width-d,p,h,o),this.gamebox.mapLayer.context.font="24px Calamity-Bold",this.gamebox.mapLayer.context.fillStyle=a.colors.white,this.gamebox.mapLayer.context.textAlign="right",this.gamebox.mapLayer.context.textBaseline="top",this.gamebox.mapLayer.context.fillText(s,this.gamebox.mapLayer.data.width-20,20)}this.gamebox.mapLayer.context.restore()}renderKeys(){let e=this.hero.items.find(o=>o.id==="key"),h=`x${e?e.collected:0}`;if(this.gamebox.mapLayer.context.save(),this.player.data.hud.keys){let o=this.player.data.hud.keys.width,l=this.player.data.hud.keys.height,d=(l-16)/2,p=20+o+h.length*16,u=60-d/2;this.gamebox.mapLayer.context.drawImage(b.cash(this.player.data.hud.keys.image),this.player.data.hud.keys.offsetX,this.player.data.hud.keys.offsetY,o,l,this.gamebox.mapLayer.data.width-p,u,o,l),this.gamebox.mapLayer.context.font="24px Calamity-Bold",this.gamebox.mapLayer.context.fillStyle=a.colors.white,this.gamebox.mapLayer.context.textAlign="right",this.gamebox.mapLayer.context.textBaseline="top",this.gamebox.mapLayer.context.fillText(h,this.gamebox.mapLayer.data.width-20,60)}this.gamebox.mapLayer.context.restore()}renderItems(){let t=this.hero.items.find(i=>i.equip==="shield");t&&this.gamebox.mapLayer.context.drawImage(b.cash(t.image),t.offsetX,t.offsetY,t.width,t.height,20,50,t.width,t.height)}};var U=class{constructor(t,i){this.player=t,this.onReady=i,this.step=1,this.dropin=!1,this.offset={x:0,y:0},this.camera=new lt(0,0,this.player.width*this.player.resolution,this.player.height*this.player.resolution,this.player.resolution),this.mapLayer=null,this.gamequest=new kt(this),this.renderQueue=new dt(this),this.dialogue=new yt(this),this.currentMusic=null;let e=b.cash(this.player.heroData.map),s=structuredClone(this.player.heroData);this.build();let h=()=>{this.map=new et(e,this),s.spawn=e.spawn[s.spawn],this.hero=new X(s,this.map),this.seedItems(),this.hud=new j(this);for(let o in this.player.data.sounds)this.player.gameaudio.addSound({id:o,src:this.player.data.sounds[o],channel:"sfx"});s.companion&&(s.companion=this.player.getMergedData(s.companion,"npcs"),s.companion.spawn={x:this.hero.position.x,y:this.hero.position.y},this.companion=new F(s.companion,this.hero)),this.onReady(),this.initMap()};e.cellauto?(this.cellauto=new wt,this.cellauto.initialize(e),this.cellauto.generate(({textures:o})=>{e.textures.background=o}).then(({textures:o,spawn:l})=>{e.textures.background=o,e.spawn=[l],n.log("Cellauto map ready!"),h()})):h()}destroy(){this.hero.destroy(),this.companion?.destroy(),this.map.destroy(),this.cellauto?.destroy(),this.mapLayer.destroy(),this.dialogue.destroy(),this.element.remove()}clear(){this.mapLayer.clear()}draw(...t){this.mapLayer.context.drawImage(...t)}build(){this.element=document.createElement("div"),this.element.className="_2dk__gamebox",this.mapLayer=new q({id:"gameground",width:this.camera.width,height:this.camera.height}),this.mapLayer.canvas.width=`${this.camera.width*this.camera.resolution}`,this.mapLayer.canvas.height=`${this.camera.height*this.camera.resolution}`,this.element.appendChild(this.mapLayer.canvas),this.player.screen.appendChild(this.element)}pause(t){t?this.player.gameaudio.stopSound(this.currentMusic):this.player.gameaudio.playSound(this.currentMusic)}blit(){}update(){}pressD(){}releaseD(){}pressA(){}holdA(){}releaseA(){}releaseHoldA(){}pressB(){}holdB(){}releaseB(){}releaseHoldB(){}smokeObject(t,i="smoke"){let e={x:t.position.x+t.width/2-this.map.data.tilesize/2,y:t.position.y+t.height/2-this.map.data.tilesize/2},s=this.player.getMergedData({id:i,kill:!0,spawn:e},"fx");this.map.addObject("fx",new m(s,this.map)),this.map.addObject("fx",new m(n.merge(s,{spawn:{x:e.x-this.map.data.tilesize/4,y:e.y-this.map.data.tilesize/4},vx:-8,vy:-8}),this.map)),this.map.addObject("fx",new m(n.merge(s,{spawn:{x:e.x+this.map.data.tilesize/4,y:e.y-this.map.data.tilesize/4},vx:8,vy:-8}),this.map)),this.map.addObject("fx",new m(n.merge(s,{spawn:{x:e.x-this.map.data.tilesize/4,y:e.y+this.map.data.tilesize/4},vx:-8,vy:8}),this.map)),this.map.addObject("fx",new m(n.merge(s,{spawn:{x:e.x+this.map.data.tilesize/4,y:e.y+this.map.data.tilesize/4},vx:8,vy:8}),this.map))}itemDrop(t,i){let e=t[n.random(0,t.length-1)],s=n.random(0,100);if(!n.def(e.chance)||s<=e.chance){let h=this.player.getMergedData({id:e.id},"items"),o={x:i.x+this.map.data.tilesize/2-h.width/2,y:i.y+this.map.data.tilesize/2-h.height/2};this.map.addObject("items",new N(o,h,this.map))}}keyItemDrop(t,i){let e=this.player.getMergedData({id:t.id,dialogue:t.dialogue},"items"),s={x:i.x+this.map.data.tilesize/2-e.width/2,y:i.y+this.map.data.tilesize/2-e.height/2};this.map.addObject("items",new B(s,e,this.map))}seedItems(){let t=this.player.query.get("items");if(t){let i=t.split(",");for(let e=i.length;e--;){let s=i[e],h=this.player.getMergedData({id:s},"items");this.hero.items.push(h),h.equip&&this.hero.equip(h.equip)}}}getRenderBox(){return this.map.renderBox?{x:this.map.renderBox.x*this.map.data.tilesize,y:this.map.renderBox.y*this.map.data.tilesize,width:this.map.renderBox.width,height:this.map.renderBox.height}:this.camera}getVisibleColliders(){let t=[];for(let i=this.map.data.collision.length;i--;)n.collide(this.getRenderBox(),{width:this.map.data.collider,height:this.map.data.collider,x:this.map.data.collision[i][0]*this.map.data.collider,y:this.map.data.collision[i][1]*this.map.data.collider})&&t.push(this.map.data.collision[i]);return t}getVisibleEvents(){let t=[];for(let i=this.map.data.events.length;i--;)n.collide(this.getRenderBox(),{x:this.map.data.events[i].coords[0]*this.map.data.tilesize,y:this.map.data.events[i].coords[1]*this.map.data.tilesize,width:this.map.data.events[i].width||this.map.data.tilesize,height:this.map.data.events[i].height||this.map.data.tilesize})&&t.push(this.map.data.events[i]);return t}getVisibleNPCs(t="npcs"){let i=[];for(let e=this.map[t].length;e--;)n.collide(this.getRenderBox(),this.map[t][e].getFullbox())&&i.push(this.map[t][e]);return i}getVisibleItems(){let t=[];for(let i=this.map.items.length;i--;)n.collide(this.getRenderBox(),this.map.items[i].getFullbox())&&t.push(this.map.items[i]);return t}getVisibleActiveTiles(){let t=[];for(let i=this.map.activeTiles.length;i--;)for(let e=this.map.activeTiles[i].pushed.length;e--;)n.collide(this.getRenderBox(),{width:this.map.data.tilesize,height:this.map.data.tilesize,x:this.map.activeTiles[i].pushed[e][0]*this.map.data.tilesize,y:this.map.activeTiles[i].pushed[e][1]*this.map.data.tilesize})&&t.indexOf(this.map.activeTiles[i])===-1&&t.push(this.map.activeTiles[i]);return t}getVisibleEmptyTiles(t="background"){let i=[];if(!this.map.renderBox)return i;for(let e=0;e<this.map.renderBox.textures[t].length;e++)for(let s=0;s<this.map.renderBox.textures[t][e].length;s++){let h={x:(this.map.renderBox.x+s)*this.map.data.tilesize,y:(this.map.renderBox.y+e)*this.map.data.tilesize,width:this.map.data.tilesize,height:this.map.data.tilesize},o=n.collide(this.getRenderBox(),h),l=this.map.renderBox.textures[t][e][s]===0;o&&l&&i.push(h)}return i}getEmptyTile(t,i="background"){return this.map.data.textures[i][t[1]][t[0]]}checkCamera(t,i){let e=!1;return t.x<=this.camera.x&&(e="left"),t.x>=this.camera.x+this.camera.width-i.width&&(e="right"),t.y<=this.camera.y&&(e="up"),t.y>=this.camera.y+this.camera.height-i.height&&(e="down"),e}checkHero(t,i){return n.collide(i.getHitbox(t),this.hero.hitbox)}checkMap(t,i){let e=i.getHitbox(t),s=this.getVisibleColliders();for(let h=s.length;h--;){let o={width:this.map.data.collider,height:this.map.data.collider,x:s[h][0]*this.map.data.collider,y:s[h][1]*this.map.data.collider};if(n.collide(e,o))return!0}return!1}checkEvents(t,i){let e=this.getVisibleEvents();for(let s=e.length;s--;){let h={x:e[s].coords[0]*this.map.data.tilesize,y:e[s].coords[1]*this.map.data.tilesize,width:e[s].width||this.map.data.tilesize,height:e[s].height||this.map.data.tilesize},o=e[s].dir,l=o?i.dir===o:!0,d=h.y===0||h.x===0?i.getFullbox(t):i.getHitbox(t);if(n.collide(d,h,20)&&l)return e[s]}return!1}checkNPC(t,i,e="npcs"){let s=this.getVisibleNPCs(e).filter(o=>o.data.ai!==a.npc.ai.FLOAT),h=n.func(i.getHitbox)?i.getHitbox(t):i;for(let o=s.length;o--;)if(!s[o].hero&&s[o]!==i&&n.collide(h,s[o].hitbox)&&!(e==="doors"&&s[o].open))return s[o];return!1}checkDoor(t,i){return this.checkNPC(t,i,"doors")}checkItems(t,i){let e=this.getVisibleItems(),s=n.func(i.getHitbox)?i.getHitbox(t):i;for(let h=e.length;h--;)if(n.collide(s,e[h].hitbox))return e[h]}checkEmpty(t,i,e="background"){let s=this.getVisibleEmptyTiles(e),h=[];for(let o=s.length;o--;)n.collide(i.getHitbox(t),s[o])&&h.push(s[o]);return h.length?h:!1}checkTiles(t,i){let e={action:[],attack:[],passive:[]},s=this.getVisibleActiveTiles();for(let h=s.length;h--;){let o=s[h],l=n.func(i.getFootbox)&&n.func(i.getHitbox),d=Ot.indexOf(o.data.group)!==-1,p=l?d?i.getFootbox(t):i.getHitbox(t):i;for(let u=o.pushed.length;u--;){let f=o.pushed[u],T={width:this.map.data.tilesize,height:this.map.data.tilesize,x:f[0]*this.map.data.tilesize,y:f[1]*this.map.data.tilesize},v=n.collide(p,T);if(v){let w=v.width*v.height/(p.width*p.height)*100,k={jump:!!(o.data.actions&&o.canInteract(a.verbs.JUMP)),fall:!!(o.data.actions&&o.canInteract(a.verbs.FALL)),stop:!!(o.data.actions&&o.data.actions.find(R=>Mt.indexOf(R.verb)!==-1)),group:o.data.group,coord:f,action:!!(o.data.actions&&o.data.actions.find(R=>zt.indexOf(R.verb)!==-1)),attack:!!(o.data.actions&&o.canAttack()),camera:o.data.friction||o.data.mask,amount:w,tilebox:T,collides:v,instance:o};k.action&&e.action.push(k),k.attack&&e.attack.push(k),(!k.action&&!k.attack||k.attack&&k.camera)&&e.passive.push(k)}}}return e.action.length||e.attack.length||e.passive.length?e:!1}checkQuestFlags(t){for(let i=this.map.doors.length;i--;)this.map.doors[i].handleQuestFlagCheck(t);for(let i=this.map.npcs.length;i--;)this.map.npcs[i].handleQuestFlagCheck(t)}initMap(){this.map.initialize(),this.update(this.hero.position),this.hero.applyOffset(),this.player.gameaudio.addSound({id:this.map.data.id,src:this.map.data.sound,channel:"bgm"}),this.currentMusic=this.map.data.id,this.dialogue.auto({text:[this.map.data.name]})}afterChangeMap(t){if(this.map.destroy(),this.map=new et(t,this),this.hero.map=this.map,this.initMap(),this.dropin&&(this.hero.position.z=-(this.camera.height/2)),this.companion){let i=structuredClone(this.hero.data.companion);i.spawn={x:this.hero.position.x,y:this.hero.position.y},this.companion.destroy(),this.companion=new F(i,this.hero)}this.player.fadeIn(),this.player.resume()}changeMap(t){this.player.pause(),this.player.fadeOut(),setTimeout(()=>{let i=b.cash(t.map),e=this.hero.getPositionForNewMap();this.hero.position.x=n.def(t.spawn)?i.spawn[t.spawn].x:e.x,this.hero.position.y=n.def(t.spawn)?i.spawn[t.spawn].y:e.y,this.afterChangeMap(i)},1e3)}changeCellautoMap(t,i,e){this.player.pause(),this.player.fadeOut(),setTimeout(()=>{let s=b.cash(this.hero.data.map);this.hero.position=this.hero.getPositionForNewMap(),this.cellauto.initialize(s),this.cellauto.generate(({textures:h})=>{s.textures.background=h}).then(({textures:h,spawn:o})=>{s.textures.background=h,s.spawn=[o],this.hero.dir=i,this.hero.position.x=o.x,this.hero.position.y=o.y,this.afterChangeMap(s)})},1e3)}},Mt=[a.verbs.GRAB,a.verbs.LIFT],zt=[a.verbs.LIFT,a.verbs.PULL,a.verbs.PUSH,a.verbs.FALL,a.verbs.ATTACK],Ot=[a.tiles.STAIRS,a.tiles.WATER,a.tiles.GRASS,a.tiles.HOLES],lt=class{constructor(t,i,e,s,h){this.x=t,this.y=i,this.width=e,this.height=s,this.resolution=h}},dt=class{constructor(t){this.gamebox=t,this.blit()}blit(){this.background=[],this.heroground=[],this.foreground=[]}add(t){this[t.layer].push(t)}render(){for(let t=this.background.length;t--;)this.safeRender(this.background[t]);for(let t=0;t<this.heroground.length;t++)this.safeRender(this.heroground[t]);for(let t=this.foreground.length;t--;)this.safeRender(this.foreground[t])}safeRender(t){this.gamebox.mapLayer.context.save(),t.render(),this.gamebox.mapLayer.context.restore()}};var ct=class extends U{constructor(t,i){super(t,i),this.interact={tile:null,push:0},this.attacking=!1,this.running=!1,this.jumping=!1,this.falling=!1,this.locked=!1,this.liftLocked=!1}blit(t){if(this.clear(),this.hero.deathCounter>0&&this.hero.deathCounter--,this.hero.killed&&this.hero.deathCounter===0){this.player.reset();return}this.renderQueue.blit(t),this.hero.blit(t),this.hud.blit(t),this.companion&&this.companion.blit(t),this.map.blit(t),this.dropin&&this.hero.position.z===0&&(this.dropin=!1),this.update(),this.hero.update(),this.companion&&this.companion.update(),this.map.update(this.offset),this.map.render(this.hero,this.companion),this.renderQueue.render(),this.player.query.get("debug")&&this.map.renderDebug(),this.hud.render()}update(){let t=this.hero.position.x-(this.camera.width/2-this.hero.width/2),i=this.hero.position.y-(this.camera.height/2-this.hero.height/2),e={};t>=0&&t<=this.map.width-this.camera.width?e.x=-t:t>=this.map.width-this.camera.width?e.x=-(this.map.width-this.camera.width):e.x=0,i>=0&&i<=this.map.height-this.camera.height?e.y=-i:i>=this.map.height-this.camera.height?e.y=-(this.map.height-this.camera.height):e.y=0,this.offset=e,this.camera.x=Math.abs(e.x),this.camera.y=Math.abs(e.y)}pressD(t){if(this.dropin||this.hero.isHitOrStill())return;let i=this.hero.getNextPoiByDir(t);this.handleHero(i,t)}releaseD(){this.locked||this.jumping||this.falling||this.attacking||this.dropin||this.hero.isHitOrStill()||(this.running&&(this.running=!1,this.hero.resetMaxV()),this.interact.push&&(this.interact.push=0),this.interact.tile?this.hero.cycle(this.hero.verb,this.hero.dir):this.hero.face(this.hero.dir))}pressA(){if(this.locked||this.jumping||this.falling||this.attacking||this.dropin||this.dialogue.active||this.liftLocked||this.hero.isHitOrStill())return;let t=this.hero.getNextPoiByDir(this.hero.dir,1),i={npc:this.checkNPC(t,this.hero),door:this.checkDoor(t,this.hero),tiles:this.checkTiles(t,this.hero)};i.door?this.handleHeroDoorAction(t,this.hero.dir,i.door):i.npc?this.handleHeroNPCAction(t,this.hero.dir,i.npc):this.hero.canGrabTile(i)&&!this.interact.tile?(this.interact.tile=i.tiles.action[0],this.hero.cycle(a.verbs.GRAB,this.hero.dir)):!this.hero.is(a.verbs.LIFT)&&!this.hero.is(a.verbs.GRAB)&&this.hero.hasJump()&&this.handleHeroJump(t,this.hero.dir)}holdA(){n.log("A Hold"),this.jumping||this.falling||this.attacking||this.dropin||this.hero.isHitOrStill()}releaseA(){if(this.hero.itemGet){this.dialogue.check(!0,!1);return}this.jumping||this.falling||this.attacking||this.dropin||this.hero.isHitOrStill()||(this.dialogue.check(!0,!1),this.handleReleaseA())}releaseHoldA(){n.log("A Hold Release"),!(this.jumping||this.falling||this.attacking||this.dropin||this.hero.isHitOrStill())&&this.handleReleaseA()}handleReleaseA(){this.jumping||this.attacking||this.dropin||this.running||this.hero.isHitOrStill()||(this.liftLocked&&(this.liftLocked=!1),this.hero.is(a.verbs.GRAB)&&this.hero.face(this.hero.dir),this.hero.is(a.verbs.LIFT)?this.interact.tile.throw&&this.hero.liftedTile?this.hero.liftedTile.throw():this.interact.tile.throw=!0:this.interact.tile=null)}pressB(){if(!(this.falling||this.attacking||this.dropin||this.dialogue.active||this.hero.isHitOrStill())&&!this.jumping&&!this.hero.is(a.verbs.LIFT))switch(this.player.data.bButton){case a.verbs.RUN:this.handleHeroRun();break;case a.verbs.ATTACK:this.handleHeroAttack();break}}holdB(){n.log("B Hold"),!(this.jumping||this.falling||this.attacking||this.dropin||this.hero.isHitOrStill())&&this.player.data.bButton===a.verbs.RUN&&this.handleHeroRun()}releaseB(){this.jumping||this.falling||this.dropin||this.hero.isHitOrStill()||(this.running&&(this.running=!1,this.hero.resetMaxV()),this.attacking&&(this.attacking=!1,this.hero.face(this.hero.dir)),this.dialogue.check(!1,!0))}releaseHoldB(){n.log("B Hold Release"),!(this.jumping||this.falling||this.dropin||this.hero.isHitOrStill())&&(this.running&&(this.running=!1,this.hero.resetMaxV()),this.attacking&&(this.attacking=!1,this.hero.face(this.hero.dir)))}isPushing(){return this.interact.push>this.map.data.tilesize}isPushingNPC(){return this.interact.push>this.map.data.tilesize*2}applyHero(t,i){this.hero.applyPosition(t,i),this.hero.applyOffset(),this.hero.applyCycle()}handleResetHeroDirs(){for(let t=C.length;t--;)this.player.controls[C[t]]=!1}handleCriticalReset(){this.handleResetHeroDirs(),this.hero.face(this.hero.dir),this.jumping=!1,this.falling=!1,this.attacking=!1,this.running=!1,this.hero.resetMaxV()}handleHero(t,i){if(this.hero.isHitOrStill())return;if(this.hero.parkour||this.hero.falling){this.applyHero(t,i);return}if((this.locked||this.jumping||this.falling||this.dropin)&&(this.interact.push=0),this.locked||this.falling||this.attacking||this.liftLocked)return;let e={map:this.checkMap(t,this.hero),npc:this.checkNPC(t,this.hero),door:this.checkDoor(t,this.hero),item:this.checkItems(t,this.hero),tiles:this.checkTiles(t,this.hero),event:this.checkEvents(t,this.hero),empty:this.checkEmpty(t,this.hero),camera:this.checkCamera(t,this.hero)};if(this.jumping){this.hero.canMoveWhileJumping(e)&&this.applyHero(t,i),this.hero.position.z===0&&(this.jumping=!1,this.hero.face(i));return}if(e.event)if(this.hero.canEventBoundary(e)){this.handleHeroEventBoundary(t,i,e.event);return}else if(this.hero.canEventDoor(e)){this.handleHeroEventDoor(t,i,e.event);return}else this.hero.canEventDialogue(e)&&this.handleHeroEventDialogue(t,i,e.event);if(!(e.item&&(this.handleHeroItem(t,i,e.item),e.item.data.collect))){if(e.door){this.handleHeroPush(t,i);return}if(e.npc){if(e.npc.canHitHero()){this.hero.hit(e.npc.stats.power);return}this.handleHeroPush(t,i),e.npc.canDoAction(a.verbs.PUSH)&&this.handleHeroPushNPC(t,i,e);return}if(e.map){this.handleHeroPush(t,i);return}if(e.camera){this.handleHeroCamera(t,i),this.map.data.cellauto&&this.handleHeroEdgeBoundary(t,i,e);return}if(this.hero.is(a.verbs.GRAB)){this.hero.canLift(i)&&this.handleHeroLift(t,i);return}if(this.hero.canTileFall(t,e,5)){this.handleHeroFall(t,i,e);return}if(e.tiles){if(this.hero.canTileJump(i,e))this.handleHeroTileJump(t,i,e.tiles.passive.filter(s=>s.jump));else if(this.hero.canTileStop(e)){this.handleHeroPush(t,i,e.tiles.action[0]);return}this.handleHeroTiles(t,i,e.tiles)}else this.hero.canResetMaxV(t,i,e)&&this.hero.resetMaxV();(!e.tiles||!e.tiles.passive.length)&&(this.hero.maskFX=null),this.applyHero(t,i)}}handleHeroJump(){this.hero.can(a.verbs.JUMP)&&(this.jumping=!0,this.hero.jump())}handleHeroTileJump(t,i,e){this.handleResetHeroDirs();let s=i==="left"||i==="right"?0:1,h=i==="left"||i==="up"?-1:1,o=e[0],l=this.map.data.textures[o.instance.data.layer],d=[...o.coord];d[s]+=h;let p=l[d[1]][d[0]],u=p[p.length-1],f=u,T=o.instance.data.elevation||1;if(!o.instance.data.elevation)for(;f[0]===u[0]&&f[1]===u[1];){d[s]+=h;let L=l[d[1]][d[0]];f=L[L.length-1],T++}let v,w;i==="left"||i==="right"?(w=[o.tilebox.x+h*this.map.data.tilesize,o.tilebox.y],T=1):w=[o.tilebox.x,o.tilebox.y+h*(this.map.data.tilesize*T)];let k=this.getVisibleEvents().find(L=>L.coords[0]*this.map.data.tilesize===w[0]&&L.coords[1]*this.map.data.tilesize===w[1]),R=k&&k.type===a.events.DOOR,St=this.map.activeTiles.find(L=>L.isPushed([w[0]/this.map.data.tilesize,w[1]/this.map.data.tilesize]));switch(i){case"left":v={x:w[0]-(this.hero.width-this.map.data.tilesize),y:this.hero.position.y};break;case"right":v={x:w[0],y:this.hero.position.y};break;case"up":v={x:this.hero.position.x,y:w[1]};break;case"down":v={x:this.hero.position.x,y:w[1]-(this.hero.height-this.map.data.tilesize)};break}this.jumping=!0,this.hero.cycle(a.verbs.JUMP,i),this.hero.physics.vz=-(this.map.data.tilesize/4),this.player.gameaudio.hitSound("parkour"),this.hero.parkour={poi:v,dir:i,tile:w,event:k,elevation:T,isEventDoor:R,activeTiles:St}}handleHeroPushNPC(t,i,e){if(e.npc.canDoAction(a.verbs.PUSH)&&this.isPushingNPC()){this.locked=!0,this.hero.face(i);let s={},h=this.map.data.tilesize;switch(i){case"left":s.x=e.npc.position.x-h,s.y=e.npc.position.y;break;case"right":s.x=e.npc.position.x+h,s.y=e.npc.position.y;break;case"up":s.x=e.npc.position.x,s.y=e.npc.position.y-h;break;case"down":s.x=e.npc.position.x,s.y=e.npc.position.y+h;break}e.npc.pushed={poi:s,dir:i},e.npc.data.action.sound&&this.player.gameaudio.hitSound(e.npc.data.action.sound)}}handleHeroPush(t,i){if(this.interact.push++,!this.hero.is(a.verbs.LIFT)&&this.isPushing()){if(!this.hero.can(a.verbs.PUSH))return;this.hero.cycle(a.verbs.PUSH,i)}else this.hero.is(a.verbs.LIFT)||this.hero.cycle(a.verbs.WALK,i)}handleHeroItem(t,i,e){e.canPickup()&&(e.data.sound&&this.player.gameaudio.hitSound(e.data.sound),e.data.currency&&this.hero.receive(e.data.currency),e.data.stat&&this.hero.updateStat(e.data.stat.key,e.data.stat.value),e.data.collect&&(this.hero.collectItem(e.data.id),e.data.dialogue&&this.dialogue.play(e.data.dialogue).then(()=>{this.hero.resetItemGet()}).catch(()=>{this.hero.resetItemGet()})),this.map.killObject("items",e))}handleHeroCamera(t,i){this.hero.cycle(this.hero.verb,i)}handleHeroEventCleanup(){this.hero.liftedTile=null,this.interact.tile=null,this.dialogue.teardown()}handleHeroEventDoor(t,i,e){this.handleHeroEventCleanup(),this.player.stop(),this.changeMap(e)}handleHeroEventBoundary(t,i,e){this.handleHeroEventCleanup(),this.player.stop(),this.changeMap(e)}handleHeroEdgeBoundary(t,i,e){e.camera===i&&(this.handleHeroEventCleanup(),this.player.stop(),this.changeCellautoMap(t,i,e))}handleHeroEventDialogue(t,i,e){this.dialogue.auto({text:e.payload.dialogue.text}),e.sound&&(this.currentMusic=e.sound.split("/").pop().split(".")[0],this.player.gameaudio.addSound({id:this.currentMusic,src:e.sound,channel:"bgm"}),this.player.gameaudio.playSound(this.currentMusic))}handleHeroLift(t,i){let e=this.interact.tile.instance.data.actions.find(s=>s.verb===a.verbs.LIFT);if(e?.stat){let{key:s,value:h}=e.stat;if(!this.hero.checkStat(s,h)){this.liftLocked=!0,this.dialogue.auto(e.stat.dialogue),this.hero.cycle(a.verbs.PULL,i);return}}this.locked=!0,this.hero.cycle(a.verbs.PULL,i),setTimeout(()=>{let s=this.map.getActiveTiles(this.interact.tile.group),h={x:this.interact.tile.coord[0]*this.map.data.tilesize,y:this.interact.tile.coord[1]*this.map.data.tilesize};this.player.gameaudio.hitSound(a.verbs.LIFT),this.map.spliceActiveTile(this.interact.tile.group,this.interact.tile.coord),this.hero.liftedTile=new W(h,s,this.map,this.hero),this.hero.cycle(a.verbs.LIFT,this.hero.dir),this.hero.physics.maxv=this.hero.physics.controlmaxv/2,this.locked=!1},this.hero.getDur(a.verbs.LIFT))}handleHeroRun(){this.player.gamepad.checkDpad().length&&(this.running||!this.hero.is(a.verbs.WALK)&&!this.hero.can(a.verbs.RUN)||(this.running=!0,this.hero.cycle(a.verbs.RUN,this.hero.dir),this.hero.physics.maxv=this.hero.physics.controlmaxvstatic*1.75,this.hero.physics.controlmaxv=this.hero.physics.controlmaxvstatic*1.75))}handleHeroAttack(){if(this.attacking||!this.hero.can(a.verbs.ATTACK))return;let t=this.hero.hasWeapon()&&this.hero.mode===a.hero.modes.WEAPON,i=this.hero.hasProjectile()&&this.hero.mode===a.hero.modes.PROJECTILE;!t&&!i||(i&&this.hero.fireProjectile(),this.attacking=!0,this.hero.resetElapsed=!0,this.hero.cycle(a.verbs.ATTACK,this.hero.dir),t&&this.player.gameaudio.hitSound(a.verbs.ATTACK),setTimeout(()=>{this.hero.face(this.hero.dir)},this.hero.getDur(a.verbs.ATTACK)))}handleHeroFall(t,i,e){this.handleResetHeroDirs();let s=[];if(e.tiles)s=e.tiles.action.find(f=>f.fall).coord;else if(e.empty){let f=e.empty[0];s=[f.x/this.map.data.tilesize,f.y/this.map.data.tilesize]}let h=s[0]*this.map.data.tilesize,o=s[1]*this.map.data.tilesize,l=(this.hero.height-this.map.data.tilesize)/2,d=(this.hero.width-this.map.data.tilesize)/2,p={x:h-d,y:o-l},u={x:this.hero.lastPositionOnGround.x,y:this.hero.lastPositionOnGround.y};switch(i){case"left":u.x+=this.map.data.tilesize/4;break;case"right":u.x-=this.map.data.tilesize/4;break;case"up":u.y+=this.map.data.tilesize/2;break;case"down":u.y-=this.map.data.tilesize/4;break}this.falling=!0,this.hero.cycle(a.verbs.FALL,this.hero.dir),this.player.gameaudio.hitSound("parkour"),this.hero.falling={to:p,reset:u}}handleHeroTiles(t,i,e){this.jumping||this.hero.isJumping()||(this.handleFrictionTiles(e),this.handleMaskTiles(e))}handleMaskTiles(t){let i=t.passive.filter(h=>h.instance.data.mask),e=i.find(h=>h.instance.data.mask),s=Math.ceil(i.reduce((h,o)=>h+o.amount,0));if(e&&s>=100){let h=this.player.getMergedData({id:e.instance.data.mask},"fx");h&&!this.hero.maskFX&&(this.hero.maskFX=new m({...h,spawn:{x:this.hero.position.x,y:this.hero.position.y}},this.map))}else(!e||s<100)&&this.hero.maskFX&&(this.hero.maskFX=null)}handleFrictionTiles(t){let i=t.passive.filter(s=>s.instance.data.friction),e=Math.ceil(i.reduce((s,h)=>s+h.amount,0));if(i.length&&e>=100)for(let s=i.length;s--;)this.hero.physics.maxv=this.hero.physics.controlmaxv/i[s].instance.data.friction;else this.hero.canResetMaxV()&&this.hero.resetMaxV()}handleHeroDoorAction(t,i,e){if(e.canInteract(i)){e.doInteract(i);return}if(e.data.action?.quest){e.handleQuestInteractionCheck();return}e.handleDoAction()}handleHeroNPCAction(t,i,e){e.canInteract(i)&&e.doInteract(i)}},Pt=ct;var pt=class extends E{constructor(){super(),this.initialize(),this.detect()}initialize(){this.ready=!1,this.paused=!0,this.stopped=!1,this.controls={a:!1,aHold:!1,b:!1,bHold:!1,left:!1,right:!1,up:!1,down:!1}}reset(){super.stop(),this.gamepad.clear(),this.gamebox.destroy(),this.gameaudio.stop(),this.hideMenu(),this.initialize(),this.element.classList.remove("is-started","is-fader"),this.gamebox=null}detect(){this.device=/Mobi/i.test(window.navigator.userAgent),this.installed=window.navigator.standalone||window.matchMedia("(display-mode: standalone)").matches}debug(){this.query=new URLSearchParams(window.location.search);let t=this.query.get("map"),i=this.query.get("spawn"),e=this.query.get("resolution");t&&(this.heroData.map=`maps/${t}`,this.heroData.spawn=0),e&&(this.resolution=this.getResolution(Number(e))),i&&(this.heroData.spawn=Number(i))}async load(){this.loader=new b,this.loader.loadJson("game.json").then(t=>{this.data=t,this.heroData=n.merge(this.data.heroes[this.data.hero.sprite],this.data.hero),this.resolution=this.getResolution(this.device?2:this.data.resolution),this.debug(),this.width=this.data.width/this.resolution,this.height=this.data.height/this.resolution,this.build(),this.onRotate();let i=0,e=t.bundle.filter(s=>{let h=s.split("/").pop().split(".").pop();return this.device?h!=="mp3":!0}).map(s=>this.loader.load(s).then(()=>{i++,this.splashLoad.innerHTML=_(this.data,`Loaded ${i} of ${e.length} game resources...`)}));Promise.all(e).then(()=>{this.splashLoad.innerHTML=_(this.data,"Press Start"),this.gamepad=new M(this),this.gameaudio=new xt(this.device),this.bind(),Promise.resolve()})})}getResolution(t){return t>this.data.maxresolution?this.data.maxresolution:t}getMergedData(t,i,e=!1){let s=this.data[i].find(h=>h.id===t.id);return s?n.merge(s,t,e):t}build(){this.element=document.createElement("div"),this.element.className="_2dk",this.element.dataset.resolution=this.resolution,this.buildSplash(),this.buildScreen(),this.buildMenu(),document.body.appendChild(this.element)}buildMenu(){this.menu=document.createElement("div"),this.menu.className="_2dk__menu",this.element.appendChild(this.menu)}buildScreen(){this.screen=document.createElement("div"),this.screen.className="_2dk__screen",this.screen.style.width=`${this.width}px`,this.screen.style.height=`${this.height}px`,this.element.appendChild(this.screen)}buildSplash(){this.splash=document.createElement("div"),this.splash.className="_2dk__splash",this.splashInfo=document.createElement("div"),this.splashInfo.className="_2dk__splash__info",this.splashInfo.innerHTML=Ct(this.installed),this.splashLoad=document.createElement("div"),this.splashLoad.className="_2dk__splash__load",this.splashLoad.innerHTML=_(this.data,"Loading game bundle..."),this.splashUpdate=document.createElement("div"),this.splashUpdate.className="_2dk__splash__update",this.splashUpdate.innerHTML="<div>Update Available</div>",this.splash.appendChild(this.splashInfo),this.splash.appendChild(this.splashLoad),this.splash.appendChild(this.splashUpdate),this.element.appendChild(this.splash)}showMenu(){this.gamebox.hero&&(this.menu.innerHTML=Tt(this)),this.menu.classList.add("is-active")}hideMenu(){this.menu.classList.remove("is-active")}fadeOut(){this.element.classList.add("is-fader")}fadeIn(){this.element.classList.remove("is-fader")}bind(){this.gamepad.on("left-press",this.onDpadPress.bind(this)),this.gamepad.on("right-press",this.onDpadPress.bind(this)),this.gamepad.on("up-press",this.onDpadPress.bind(this)),this.gamepad.on("down-press",this.onDpadPress.bind(this)),this.gamepad.on("left-release",this.onDpadRelease.bind(this)),this.gamepad.on("right-release",this.onDpadRelease.bind(this)),this.gamepad.on("up-release",this.onDpadRelease.bind(this)),this.gamepad.on("down-release",this.onDpadRelease.bind(this)),this.gamepad.on("start-press",this.onPressStart.bind(this)),this.gamepad.on("select-press",this.onPressSelect.bind(this)),this.gamepad.on("a-press",this.onPressA.bind(this)),this.gamepad.on("a-release",this.onReleaseA.bind(this)),this.gamepad.on("a-holdpress",this.onPressHoldA.bind(this)),this.gamepad.on("a-holdrelease",this.onReleaseHoldA.bind(this)),this.gamepad.on("b-press",this.onPressB.bind(this)),this.gamepad.on("b-holdpress",this.onPressHoldB.bind(this)),this.gamepad.on("b-release",this.onReleaseB.bind(this)),this.gamepad.on("b-holdrelease",this.onReleaseHoldB.bind(this)),window.onresize=this.onRotate.bind(this)}go(){super.go(this.onGameBlit.bind(this))}pause(){super.stop(),this.paused=!0,this.gamepad.clear(),this.gamebox.pause(!0)}stop(){super.stop(),this.stopped=!0,this.gamepad.clear(),this.gamebox.pause(!0)}resume(){this.go(),this.paused=!1,this.stopped=!1,this.gamebox.pause(!1)}onRotate(){window.screen.orientation.type.includes("landscape")&&this.ready?this.resume():this.ready&&(this.pause(),this.stop())}onReady(){this.ready||(this.ready=!0,this.element.classList.add("is-started"),this.data.plugin===a.plugins.TOPVIEW&&(this.gamebox=new Pt(this,this.go.bind(this))))}onGameBlit(t){if(this.stopped||this.gamebox.blit(t),!this.paused){let i=this.gamepad.checkDpad();if(!i.length)this.gamebox.releaseD(),this.gamebox.handleHero(this.gamebox.hero.getNextPoi(),this.gamebox.hero.dir);else for(let e=0;e<i.length;e++)for(let s=0;s<i[e].dpad.length;s++)this.gamebox.pressD(i[e].dpad[s]);this.controls.aHold?this.gamebox.holdA():this.controls.a&&this.gamebox.pressA(),this.controls.bHold?this.gamebox.holdB():this.controls.b&&this.gamebox.pressB()}}onPressStart(){this.gamebox?.hero?.killed||(this.ready||this.onReady(),this.paused?(this.resume(),this.hideMenu(),this.emit(a.broadcast.RESUMED)):(this.pause(),this.stop(),this.showMenu(),this.emit(a.broadcast.PAUSED)))}onPressSelect(){if(this.ready&&this.gamebox.hero.hasProjectile())switch(this.gamebox.hero.mode){case a.hero.modes.WEAPON:this.gamebox.hero.mode=a.hero.modes.PROJECTILE;break;case a.hero.modes.PROJECTILE:this.gamebox.hero.mode=a.hero.modes.WEAPON;break}}onDpadPress(t){this.controls[t]=!0}onDpadRelease(t){this.controls[t]=!1}onPressA(){this.controls.a=!0}onPressHoldA(){this.controls.aHold=!0}onReleaseA(){this.controls.a=!1,this.gamebox&&this.gamebox.releaseA&&this.gamebox.releaseA()}onReleaseHoldA(){this.controls.a=!1,this.controls.aHold=!1,this.gamebox&&this.gamebox.releaseHoldA&&this.gamebox.releaseHoldA()}onPressB(){this.controls.b=!0}onPressHoldB(){this.controls.bHold=!0}onReleaseB(){this.controls.b=!1,this.controls.bHold=!1,this.gamebox&&this.gamebox.releaseB&&this.gamebox.releaseB()}onReleaseHoldB(){this.controls.b=!1,this.controls.bHold=!1,this.gamebox&&this.gamebox.releaseHoldB&&this.gamebox.releaseHoldB()}},Lt=pt;var ut=class{constructor(t){this.player=t,this.scope=window.location.pathname.replace(/index\.html$/,""),this.config={scope:this.scope},this.worker=`${this.scope}sw.js`}update(t){this.player.splashUpdate.classList.add("has-update"),this.player.splashUpdate.addEventListener("click",()=>{t.waiting&&t.waiting.postMessage("SKIP_WAITING")})}register(){if(n.dev()){n.log("Skip service worker for studio dev demo!");return}"serviceWorker"in navigator?navigator.serviceWorker.register(this.worker,this.config).then(t=>{t.waiting&&(n.log("Service worker installed."),this.update(t)),t.addEventListener("updatefound",()=>{t.installing&&t.installing.addEventListener("statechange",()=>{t.waiting&&(navigator.serviceWorker.controller?this.update(t):n.log("Service worker initialized for the first time"))})});let i=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{i||(window.location.reload(),i=!0)})}).catch(t=>{n.error(`Service worker failed with ${t}`)}):n.log("Service workers not available!")}deregister(){navigator.serviceWorker.getRegistrations().then(t=>{t.forEach(i=>{i.unregister().then(e=>{n.log("Unregistered Service Worker",e)})})})}},At=ut;var ft=class{constructor(){window.onload=()=>{this.player=new Lt,this.gameworker=new At(this.player),this.player.load().then(()=>{this.gameworker.register()})}}},Et=new ft;window.app2dk=Et;var Be=Et;})();
