(()=>{var Dt=window.getComputedStyle(document.documentElement),y=o=>Dt.getPropertyValue(o),_={player:{fps:60,fadeDur:parseInt(y("--fade-duration"),10),hideDur:parseInt(y("--hide-duration"),10),deviceResolution:2},physics:{maxv:4,speed:1},verbs:{PUSH:"push",PULL:"pull",GRAB:"grab",LIFT:"lift",WALK:"walk",FACE:"face",JUMP:"jump",FALL:"fall",THROW:"throw",ATTACK:"attack",OPEN:"open",CLOSE:"close",TALK:"talk",READ:"read",SWIM:"swim",DIVE:"dive",ATTRACT:"attract"},map:{types:{WORLD:"world",INDOOR:"indoor"}},tiles:{HOLES:"holes",GRASS:"grass",WATER:"water",LEDGE:"ledge",STAIRS:"stairs"},keys:{A:"KeyX",B:"KeyZ",UP:"ArrowUp",DOWN:"ArrowDown",LEFT:"ArrowLeft",RIGHT:"ArrowRight",START:"Enter",SELECT:"Space",UPLEFT:"ArrowUpLeft",UPRIGHT:"ArrowUpRight",DOWNLEFT:"ArrowDownLeft",DOWNRIGHT:"ArrowDownRight"},plugins:{TOPVIEW:"topview"},events:{DOOR:"door",DIALOGUE:"dialogue",BOUNDARY:"boundary",ELEVATION:"elevation"},broadcast:{PAUSED:"paused",RESUMED:"resumed"},layers:{BACKGROUND:"background",SPRITES:"sprites",FOREGROUND:"foreground",ELEVATION:"elevation"},hero:{modes:{WEAPON:"weapon",PROJECTILE:"projectile"},interact:{READ:"read",GRAB:"grab"}},npc:{ai:{WALK:"walk",ROAM:"roam",STEP:"step",FLOAT:"float",WANDER:"wander"},types:{DOOR:"door",ENEMY:"enemy"}},facing:{UP:"up",DOWN:"down",LEFT:"left",RIGHT:"right"},opposites:{y:"x",x:"y",up:"down",down:"up",left:"right",right:"left"},dialogue:{types:{TEXT:"text",PROMPT:"prompt"},verbs:{TALK:"talk",READ:"read"}},quest:{dialogue:{NO_CHECK:"noCheck",SET_ITEM:"setItem",SET_FLAG:"setFlag",TAKE_ITEM:"takeItem",CHECK_ITEM:"checkItem",CHECK_FLAG:"checkFlag",CHECK_STATUS:"checkStatus",CHECK_COMPANION:"checkCompanion"},action:{SET_FLAG:"setFlag",DROP_ITEM:"dropItem",CHECK_FLAG:"checkFlag",CHECK_ITEM:"checkItem",SET_COMPANION:"setCompanion"}},colors:{red:y("--red"),grey:y("--grey"),blue:y("--blue"),teal:y("--teal"),pink:y("--pink"),black:y("--black"),green:y("--green"),white:y("--white"),purple:y("--purple"),yellow:y("--yellow"),greyDark:y("--grey-dark"),blueDark:y("--blue-dark"),charcoal:y("--charcoal"),charcoal2:y("--charcoal2")}},k=[_.facing.UP,_.facing.DOWN,_.facing.LEFT,_.facing.RIGHT],h=_;var ht={dev(){return/^file:|^http:\/\/(localhost|127\.0\.0\.1)/.test(window.location.href)},log(...o){ht.dev()&&console.log.apply(console,["[2dk]",...o])},func(o){return typeof o=="function"},def(o){return o!=null},error(...o){ht.dev()&&console.error.apply(console,o)},merge(o,t,e){o=structuredClone(o),t=structuredClone(t);for(let i in t)(!o[i]||e)&&(o[i]=t[i]);return o},collide(o,t,e=0){return o.x+e<t.x+t.width-e&&o.x+o.width-e>t.x+e&&o.y+e<t.y+t.height-e&&o.height+o.y-e>t.y+e?{x:Math.max(0,o.x-t.x),y:Math.max(0,o.y-t.y),width:Math.min(t.width,o.x-t.x+o.width)-Math.max(0,o.x-t.x),height:Math.min(t.height,o.y-t.y+o.height)-Math.max(0,o.y-t.y)}:!1},getCollisionAmount(o,t){return o.width*o.height/(t.width*t.height)*100},getTotalCollisionAmount(o){return Math.ceil(o.reduce((t,e)=>t+e.amount,0))},getMostCollidingTile(o){return o.reduce((t,e)=>t?e.amount>t.amount?e:t:e,null)},getPerceptionBox(o,t,e,i){let s={x:Math.floor(o.x/i),y:Math.floor(o.y/i)},a={x:Math.floor((o.x+t)/i),y:Math.floor((o.y+e)/i)};return{tileBox:{x:s.x-1,y:s.y-1,width:a.x-s.x+3,height:a.y-s.y+3}}},drawTileCel(o,t,e,i,s,a,r,l,c=null){let d=c?.x??0,u=c?.y??0;o.drawImage(t,s,a,e,e,r*i+d,l*i+u,i,i)},drawMapTile(o,t,e,i,s,a,r,l=null){if(Array.isArray(e))for(let c=0,d=e.length;c<d;c++)this.drawTileCel(o,t,i,s,e[c][0],e[c][1],a,r,l);else l===null&&o.clearRect(a*s,r*s,s,s)},drawMapTiles(o,t,e,i,s,a=null){for(let r=e.length;r--;){let l=e[r];for(let c=l.length;c--;){let d=l[c];this.drawMapTile(o,t,d,i,s,c,r,a)}}},getSurroundingTileCoords(o){return{topLeft:{x:o[0]-1,y:o[1]-1},top:{x:o[0],y:o[1]-1},topRight:{x:o[0]+1,y:o[1]-1},left:{x:o[0]-1,y:o[1]},right:{x:o[0]+1,y:o[1]},bottomLeft:{x:o[0]-1,y:o[1]+1},bottom:{x:o[0],y:o[1]+1},bottomRight:{x:o[0]+1,y:o[1]+1}}},random(o,t){return Math.floor(Math.random()*(t-o+1))+o},getDirectionFromAngle(o){return o>=-Math.PI/4&&o<Math.PI/4?"right":o>=Math.PI/4&&o<3*Math.PI/4?"down":o>=-3*Math.PI/4&&o<-Math.PI/4?"up":"left"},areSpritesInRange(o,t,e){return this.getDistance(o.center,t.center)<=e},canSpriteInteractWithNPCByLayer(o,t){return t.layer===o.layer||o.layer===h.layers.ELEVATION&&o.elevation&&o.elevation.event&&o.elevation.event.checkElevationAccessToSprite(t.position,t)},limit(o,t,e){return o<t?t:o>e?e:o},goToZero(o){return o?o-o/Math.abs(o):0},upAndDown(o,t){return o%t>t/2?t-o%t:o%t},getDistance(o,t){return Math.sqrt(Math.pow(t.x-o.x,2)+Math.pow(t.y-o.y,2))}},n=ht;var z=class{constructor(t){this.player=t,this.gamepad=null,this.gamepadConnected=!1,this.build(),this.bind()}blit(t){for(let e=0;e<this.blitControls.length;e++){let i=p[this.blitControls[e]];if(i.touched&&n.def(i.hold)){if(t-i.holdTime>=Mt){this.player.controls[`${i.btn[0]}Hold`]=!0;return}i.hold++}}}blitNativeGamepad(){this.gamepadConnected&&(this.gamepad=navigator.getGamepads()[0],this.handleGamepadAxes(),this.handleGamepadButtons())}clear(){setTimeout(()=>{this.clearTouches(),this.cancelTouches()},300)}bind(){this.element.addEventListener("touchstart",this.onTouchStart.bind(this),!1),this.element.addEventListener("touchmove",this.onTouchMove.bind(this),!1),this.element.addEventListener("touchend",this.onTouchEnd.bind(this),!1),document.addEventListener("keyup",this.onKeyUp.bind(this),!1),document.addEventListener("keydown",this.onKeyDown.bind(this),!1),window.addEventListener("gamepadconnected",this.onGamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this.onGamepadDisconnected.bind(this))}build(){this.element=document.createElement("div"),this.dpad=document.createElement("div"),this.btns=document.createElement("div"),this.menu=document.createElement("div"),this.element.className="_2dk__gamepad",this.dpad.className="_2dk__gamepad__dpad",this.btns.className="_2dk__gamepad__btns",this.menu.className="_2dk__gamepad__menu",this.element.appendChild(this.dpad),this.element.appendChild(this.btns),this.element.appendChild(this.menu),this.diagonaldpad=this.player.data.diagonaldpad,this.availableControls=Object.keys(p),this.functionalControls=Object.keys(p).reduce((t,e)=>(e==="neutral"||!this.diagonaldpad&&Ft.includes(p[e].key)||t.push(e),t),[]),this.blitControls=this.availableControls.filter(t=>n.def(p[t].hold)),this.availableControls.forEach(t=>{let e=this.functionalControls.some(i=>i===t);p[t].btn=t.split("-"),p[t].elem=document.createElement("div"),p[t].elem.className=`_2dk__gamepad__${t}`,p[t].elem.role="button",p[t].key&&(p[t].elem.dataset.key=p[t].key),e||(p[t].elem.dataset.off="true"),this.renderButtonText(t),p[t].dpad?this.dpad.appendChild(p[t].elem):p[t].menu?this.menu.appendChild(p[t].elem):this.btns.appendChild(p[t].elem)}),this.player.element.appendChild(this.element),!this.player.device&&!this.player.query.gamepad&&(this.element.style.display="none")}renderButtonText(t){p[t].text&&(p[t].elem.innerHTML=`<span>${p[t].text}</span>`)}canReceiveInput(t){let e=bt.includes(t),i=O.some(r=>bt.includes(r)),s=this.diagonaldpad||!e?!0:!i,a=!O.includes(t);return s&&a}pushInput(t){O.push(t)}removeInput(t){O.includes(t)&&O.splice(O.indexOf(t),1)}checkDpad(){let t=[];return this.functionalControls.forEach(e=>{p[e].touched&&p[e].dpad&&t.push(p[e])}),t.sort(e=>e.key===h.keys.UP||e.key===h.keys.DOWN?1:-1)}getControl(t){let e=null;return this.availableControls.forEach(i=>{p[i].key===t&&(e=p[i])}),e}getTouched(t,e){for(let i=0;i<t.length;i++)if(document.elementFromPoint(t[i].pageX,t[i].pageY).dataset.key===e.key)return e;return null}onTouchStart(t){t.preventDefault();for(let e=0;e<t.touches.length;e++){let i=document.elementFromPoint(t.touches[e].pageX,t.touches[e].pageY);if(i.dataset.key){let s=this.getControl(i.dataset.key);this.startTouch(s)}}return!1}onTouchMove(t){t.preventDefault();for(let e=0;e<t.touches.length;e++){let i=document.elementFromPoint(t.touches[e].pageX,t.touches[e].pageY);if(i.dataset.key){let s=this.getControl(i.dataset.key);s&&this.startTouch(s)}this.functionalControls.forEach(s=>{p[s].touched&&(this.getTouched(t.touches,p[s])||this.cancelTouch(p[s]))})}return!1}onTouchEnd(t){return t.preventDefault(),t.touches.length?this.availableControls.forEach(e=>{p[e].touched&&(this.getTouched(t.touches,p[e])||this.cancelTouch(p[e]))}):(this.clearTouches(),this.cancelTouches()),!1}onKeyDown(t){if(this.canReceiveInput(t.code)){this.pushInput(t.code);let e=this.getControl(t.code);e&&this.startTouch(e)}}onKeyUp(t){if(!this.canReceiveInput(t.code)){this.removeInput(t.code);let e=this.getControl(t.code);e&&this.cancelTouch(e)}}clearTouches(){this.availableControls.forEach(t=>{p[t].elem.classList.remove("is-active")})}cancelTouches(){this.availableControls.forEach(t=>{p[t].touched&&this.cancelTouch(p[t])})}cancelTouch(t){if(t.elem.classList.remove("is-active"),t.touched=!1,t.dpad)t.dpad.forEach((e,i)=>{this.player.controls[e]=!1});else switch(t.btn[0]){case"start":case"select":this.player.controls[t.btn[0]]=!1;break;default:n.def(t.holdTime)&&(t.hold=0,t.holdTime=null),this.player.controls[t.btn[0]]=!1,this.player.controls[`${t.btn[0]}Release`]=!0;break}}startTouch(t){if(t.elem.classList.add("is-active"),t.dpad)t.touched=!0,t.dpad.forEach(e=>{this.player.controls[e]=!0});else{if(t.touched)return;switch(t.touched=!0,t.btn[0]){case"start":if(!this.player.ready||this.player.ready&&this.player.paused){this.player.onPressStart();return}this.player.controls.start=!0;break;case"select":this.player.ready&&(this.player.controls.select=!0);break;default:n.def(t.hold)&&(t.holdTime=performance.now()),this.player.controls[t.btn[0]]=!0;break}}}getGamepad(t){let e=null;return this.availableControls.forEach(i=>{p[i].gamepad&&p[i].gamepad.indexOf(t)!==-1&&(e=p[i])}),e}getAxes(t,e){let i=null;return this.availableControls.forEach(s=>{p[s].axes&&p[s].axes[t]===e&&(i=p[s])}),i}handleGamepadAxes(){let t={x:this.getAxes(0,this.gamepad.axes[0]),y:this.getAxes(1,this.gamepad.axes[1])};t.x&&this.canReceiveInput(t.x.key)?(this.pushInput(t.x.key),this.startTouch(t.x)):t.x||(this.canReceiveInput(h.keys.LEFT)||(this.removeInput(h.keys.LEFT),this.cancelTouch(p.left)),this.canReceiveInput(h.keys.RIGHT)||(this.removeInput(h.keys.RIGHT),this.cancelTouch(p.right))),t.y&&this.canReceiveInput(t.y.key)?(this.pushInput(t.y.key),this.startTouch(t.y)):t.y||(this.canReceiveInput(h.keys.UP)||(this.removeInput(h.keys.UP),this.cancelTouch(p.up)),this.canReceiveInput(h.keys.DOWN)||(this.removeInput(h.keys.DOWN),this.cancelTouch(p.down)))}handleGamepadButtons(){for(let t=this.gamepad.buttons.length;t--;){let e=this.getGamepad(t);e&&this.canReceiveInput(e.key)&&this.gamepad.buttons[t].pressed?(this.pushInput(e.key),this.startTouch(e)):e&&!this.canReceiveInput(e.key)&&!this.gamepad.buttons[t].pressed&&(this.removeInput(e.key),this.cancelTouch(e))}}onGamepadConnected(){this.gamepadConnected=!0,this.gamepad=navigator.getGamepads()[0],n.log(`GamePad Connected: ${this.gamepad.id}`,this.gamepad)}onGamepadDisconnected(){this.gamepadConnected=!1,n.log("GamePad Disconnected")}},O=[],Mt=400,Ft=[h.keys.UPLEFT,h.keys.UPRIGHT,h.keys.DOWNLEFT,h.keys.DOWNRIGHT],bt=[h.keys.UP,h.keys.DOWN,h.keys.LEFT,h.keys.RIGHT],p={a:{key:h.keys.A,elem:null,touched:!1,hold:0,holdTime:null,text:"A",gamepad:[0]},b:{key:h.keys.B,elem:null,touched:!1,hold:0,holdTime:null,text:"B",gamepad:[1]},start:{key:h.keys.START,elem:null,touched:!1,text:"Start",menu:!0,gamepad:[9]},select:{key:h.keys.SELECT,elem:null,touched:!1,text:"Select",menu:!0,gamepad:[8]},"up-left":{key:h.keys.UPLEFT,elem:null,touched:!1,dpad:["left","up"]},up:{key:h.keys.UP,elem:null,touched:!1,dpad:["up"],axes:[0,-1]},"up-right":{key:h.keys.UPRIGHT,elem:null,touched:!1,dpad:["right","up"]},left:{key:h.keys.LEFT,elem:null,touched:!1,dpad:["left"],axes:[-1,0]},neutral:{elem:null,dpad:[]},right:{key:h.keys.RIGHT,elem:null,touched:!1,dpad:["right"],axes:[1,0]},"down-left":{key:h.keys.DOWNLEFT,elem:null,touched:!1,dpad:["left","down"]},down:{key:h.keys.DOWN,elem:null,touched:!1,dpad:["down"],axes:[0,1]},"down-right":{key:h.keys.DOWNRIGHT,elem:null,touched:!1,dpad:["right","down"]}};var at=class{constructor(t){this.device=t,this.sounds={},this.build()}build(){this.device||(this.channels={bgm:{node:new Audio,open:!1},sfx:{node:new Audio,open:!1},hero:{node:new Audio,open:!1}},this.channels.bgm.node.loop=!0,this.channels.bgm.node.volume=.4,this.channels.sfx.node.loop=!1,this.channels.sfx.node.volume=.6,this.channels.hero.node.loop=!1,this.channels.hero.node.volume=.6)}stop(){if(!this.device)for(let t in this.sounds)this.stopSound(t)}addSound(t){this.device||this.sounds[t.id]||(this.sounds[t.id]=t,this.sounds[t.id].playing=!1)}hitSound(t){let e=this.sounds[t];if(e){let i=this.channels[e.channel];i.node.src=e.src,i.node.play()}}heroSound(t){let e=this.sounds[t];if(e){let i=this.channels.hero;i.node.src=e.src,i.node.play()}}playSound(t){let e=this.sounds[t];if(e&&!e.playing){let i=this.channels[e.channel],s=i.node.src.split("/").pop();e.src.split("/").pop()!==s&&(i.node.src=e.src),this.sounds[t].playing=!0,i.node.play()}}stopSound(t){let e=this.sounds[t];if(e&&e.playing){let i=this.channels[e.channel];this.sounds[t].playing=!1,i.node.pause()}}},vt=at;var I=class o{static storageKey="_2dk_game_storage";static heroProps=["dir","stats","position","layer","currency","equipped","items","health","maxHealth","magic","maxMagic","status","statusEffects","totalDeaths","enemiesKilled"];constructor(t){this.player=t,this.storage={},this.mount()}mount(){let t=localStorage.getItem(o.storageKey);t&&(this.storage=JSON.parse(t))}get(t){return this.storage[t]}set(t,e){this.storage[t]=e}remove(t){delete this.storage[t]}save(){localStorage.setItem(o.storageKey,JSON.stringify(this.storage))}reset(){this.storage={},this.save()}persist(t){this.set("map",`maps/${t.map.data.id}.json`),this.set("quests",t.gamequest.completed),t.companion?this.set("companion",{id:t.companion.data.id,type:t.companion.data.type}):this.remove("companion");for(let e of o.heroProps)this.set(e,t.hero[e]);this.save()}};var x={},g=class{static cash(t,e){return e&&(x[t]=e),t?x[t]:x}load(t){let e=t.split("/").pop().split(".").pop();if(e==="png")return this.loadImage(t);if(e==="mp3")return this.loadAudio(t);if(e==="json")return this.loadJson(t)}loadImage(t){return new Promise((e,i)=>{if(x[t])return e(x[t]);let s=new Image;s.onload=()=>{x[t]=s,e(x[t])},s.onerror=()=>{i()},s.src=t})}loadAudio(t){return new Promise(e=>{if(x[t])return e(x[t]);let i=new Audio;i.addEventListener("loadedmetadata",()=>{x[t]=!0,i=null,e(x[t])},!1),i.muted=!0,i.volume=0,i.src=t,i.load()})}loadJson(t){return new Promise(e=>{if(x[t])return e(x[t]);fetch(t).then(i=>{i.json().then(s=>{x[t]=s,e(x[t])})})})}async loadBundle(t,e,i){let s=await this.loadJson(t),a=0,r=e?s.bundle.filter(l=>l.split("/").pop().split(".").pop()!=="mp3"):s.bundle;return await Promise.all(r.map(async l=>{await this.load(l),a++,i(a,r.length)})),s}};var N=class{constructor(){this.handlers={},this.rafId=null,this.animate=null,this.started=!1}go(t){if(this.started)return this;this.started=!0,this.animate=e=>{this.rafId=window.requestAnimationFrame(this.animate),t(e)},this.rafId=window.requestAnimationFrame(this.animate)}stop(){window.cancelAnimationFrame(this.rafId),this.rafId=null,this.animate=null,this.started=!1}on(t,e){t.split(" ").forEach(s=>{this.handlers[s]||(this.handlers[s]=[]),this.handlers[s].push(e)})}off(t,e){if(!this.handlers[t])return this;if(e){for(let i=this.handlers[t].length;i--;)if(this.handlers[t][i]===e){this.handlers[t].splice(i,1);break}}else delete this.handlers[t]}emit(t,...e){if(!this.handlers[t])return this;this.handlers[t].forEach(i=>{i.apply(this,e)})}};var S=String.raw,tt=o=>S`
        <div>${o}</div>
    `,kt=o=>S`
        <div>${o.name}: Save #${o.save}, Release ${o.release}</div>
    `,wt=o=>S`
        <div>Rotate to Landscape.</div>
        <div>${o?"Webapp Installed":"Install Webapp"}</div>
    `,Tt=o=>S`
        <div class="_2dk__dialogue__text">${o}</div>
    `,Ct=(o,t)=>S`
        <div>${o}</div>
        <span class="a">A: ${t.yes.label}</span>
        <span>,&nbsp;</span>
        <span class="b">B: ${t.no.label}</span>
    `,L=(o,t,e=30)=>S`
        <style>
            #${o.id} {
                width: ${o.width}px;
                height: ${o.height}px;
                background-image: url(${o.image});
                background-position: -${o.offsetX}px -${o.offsetY}px;
                transform: scale( 0.65 ) rotate( ${e}deg );
                transform-origin: center center;
            }
        </style>
        <span class="_2dk__gamepad__sprite" id="${o.id}"></span>
        <span>${t}</span>
    `,At=o=>{let t=o.gamebox.hero,e=Object.keys(o.gamebox.gamequest.completed);return S`
        <div class="_2dk__menu__tabs">
            <div class="_2dk__menu__tab is-active" data-tab="stats">Stats</div>
            <div class="_2dk__menu__tab" data-tab="items">Items</div>
            <div class="_2dk__menu__tab" data-tab="quests">Quests</div>
            <div class="_2dk__menu__tab" data-tab="save">Save & Quit</div>
        </div>
        <div class="_2dk__menu__contents">
            <div class="_2dk__menu__content is-active" data-content="stats">
                <div>Hero: ${t.data.name}</div>
                <div>Power: ${t.getStat("power")}</div>
                <div>Strength: ${t.getStat("strength")}</div>
                <div>Weapon: ${t.equipped.weapon?"Equipped":"Unequipped"}</div>
                <div>Shield: ${t.equipped.shield?"Equipped":"Unequipped"}</div>
                <div>Enemies Killed: ${t.enemiesKilled}</div>
                <div>Total Deaths: ${t.totalDeaths}</div>
            </div>
            <div class="_2dk__menu__content" data-content="items">...</div>
            <div class="_2dk__menu__content" data-content="quests">
                ${e.map(i=>S`
                    <div>${i}</div>
                `).join("")}
            </div>
            <div class="_2dk__menu__content" data-content="save">
                <div class="btns">
                    <div class="_2dk__menu__save btn" data-save="true">Save & Quit</div>
                    <div class="_2dk__menu__reset btn" data-reset="true">Reset Game</div>
                </div>
            </div>
        </div>
    `};var Q=class{constructor(t){this.gamebox=t,this.player=this.gamebox.player,this.data=null,this.ready=!1,this.pressed=!1,this.active=!1,this.isAuto=!1,this.isResolve=!1,this.resolve=null,this.reject=null,this.timeout=null,this.debounce=750,this.duration=250,this.build()}destroy(){this.teardown(),this.element.remove()}build(){this.element=document.createElement("div"),this.element.className="_2dk__dialogue",this.player.screen.appendChild(this.element)}writeText(t){this.element.innerHTML=Tt(t)}writePrompt(t){this.writeText(Ct(t,this.data))}clearText(){this.element.innerHTML=""}clearTimeout(){clearTimeout(this.timeout),this.timeout=null}auto(t){this.active||(this.clearTimeout(),this.isAuto=!0,this.data=structuredClone(t),this.element.classList.add("is-texting"),this.writeText(this.data.text.shift()),this.timeout=setTimeout(()=>{this.teardown()},this.debounce*3))}play(t){return(this.active||this.isAuto)&&this.reset(),this.active=!0,new Promise((e,i)=>{this.data=structuredClone(t),this.isResolve=!0,this.resolve=e,this.reject=i,this.element.classList.add("is-texting");let s=this.data.text.shift();!this.data.text.length&&this.data.type===h.dialogue.types.PROMPT?this.writePrompt(s):this.writeText(s),this.timeout=setTimeout(()=>{this.ready=!0},this.duration)})}check(t){if(!(!this.active||!this.ready||this.active&&this.pressed))switch(this.pressed=!0,this.data.type){case h.dialogue.types.TEXT:this.handleText();break;case h.dialogue.types.PROMPT:this.handlePrompt(t);break}}handleText(){this.data.text.length?(this.writeText(this.data.text.shift()),this.timeout=setTimeout(()=>{this.pressed=!1},this.duration)):(this.isResolve?this.resolve():this.reject(),this.teardown())}handlePrompt(t){if(this.data.text.length){let e=this.data.text.shift();this.data.text.length?this.writeText(e):this.writePrompt(e),this.timeout=setTimeout(()=>{this.pressed=!1},this.duration);return}switch(t){case"A":this.isResolve=!0,this.data.type=h.dialogue.types.TEXT,this.data.text=this.data.yes.text,this.timeout=setTimeout(()=>{this.pressed=!1,this.check("A")},this.duration);break;case"B":this.isResolve=!1,this.data.type=h.dialogue.types.TEXT,this.data.text=this.data.no.text,this.timeout=setTimeout(()=>{this.pressed=!1,this.check("B")},this.duration);break}}reset(){this.clearTimeout(),this.data=null,this.ready=!1,this.pressed=!1,this.isAuto=!1,this.isResolve=!1,this.resolve=null,this.reject=null}teardown(){this.reset(),this.element.classList.remove("is-texting"),this.timeout=setTimeout(()=>{this.clearText(),this.active=!1,this.timeout=null},this.duration)}};var f=class{constructor(t,e){this.data=t,this.map=e,this.gamebox=this.map.gamebox,this.player=this.gamebox.player,this.gamequest=this.gamebox.gamequest,this.layer=t.layer||h.layers.SPRITES,this.scale=this.data.scale||1,this.width=this.data.width/this.scale,this.height=this.data.height/this.scale,this.dir=this.data.dir||this.data.spawn?.dir||"down",this.verb=this.data.verb||h.verbs.FACE,this.image=g.cash(this.data.image),this.frame=0,this.opacity=t.opacity||1,this.position={x:this.data.spawn&&this.data.spawn.x||0,y:this.data.spawn&&this.data.spawn.y||0,z:this.data.spawn&&this.data.spawn.z||0},this.prio=this.position.y+this.height,this.onscreen=!1,this.speed=h.physics.speed,this.physics={vx:this.data.vx||0,vy:this.data.vy||0,vz:this.data.vz||0,maxv:this.data.maxv||h.physics.maxv,controlmaxv:this.data.controlmaxv||this.data.maxv||h.physics.maxv},this.offset={x:this.position.x-this.gamebox.camera.x,y:this.position.y-this.gamebox.camera.y},this.idle={x:!0,y:!0},this.data.hitbox=this.data.hitbox||{x:0,y:0,width:this.data.width/this.scale,height:this.data.height/this.scale},this.hitbox={x:this.position.x+this.data.hitbox.x/this.scale,y:this.position.y+this.data.hitbox.y/this.scale,width:this.data.hitbox.width/this.scale,height:this.data.hitbox.height/this.scale},this.footbox={x:this.hitbox.x,y:this.hitbox.y+this.hitbox.height/2,width:this.hitbox.width,height:this.hitbox.height/2},this.center={x:this.position.x+this.width/2,y:this.position.y+this.height/2},this.perceptionBox=n.getPerceptionBox(this.position,this.width,this.height,this.map.data.tilesize),this.spritecel=this.getCel(),this.previousElapsed=null,this.resetElapsed=!1,this.frameStopped=!1,this.controls={left:!1,right:!1,up:!1,down:!1},this.hitTimer=0,this.stillTimer=0,this.stats={power:this.data.stats?.power??1,strength:this.data.stats?.strength??0},this.health=this.data.stats?.health??1,this.maxHealth=this.health,this.elevation=null,this.lockElevation=!1}destroy(){}can(t){return!!this.data.verbs[t]}is(t){return this.verb===t}cycle(t,e){t!==this.verb&&(this.frame=0),this.dir=e,this.verb=t}face(t){this.cycle(h.verbs.FACE,t)}hit(t=1,e=50){this.hitTimer=e,this.stillTimer=e,this.frame=0,this.health=Math.max(this.health-t,0),this.resetPhysics()}isIdle(){return this.idle.x&&this.idle.y}isOnGround(){return this.position.z===0}isHitOrStill(){return this.hitTimer>0||this.stillTimer>0}isJumping(){return this.position.z<0}visible(){return this.onscreen=n.collide(this.gamebox.camera,this.getFullbox()),this.hero||(this.onscreen?this.map.addAllSprite(this):this.map.removeAllSprite(this)),this.onscreen}blit(t){this.visible()&&(this.previousElapsed===null&&(this.previousElapsed=t),this.hitTimer>0&&(this.hitTimer--,this.hitTimer===0&&this.handleHealthCheck()),this.stillTimer>0&&this.stillTimer--,this.applyFrame(t),n.func(this.blitAfter)&&this.blitAfter(t))}update(){this.onscreen&&this.updateStack()}updateStack(){this.handleVelocity(),this.handleGravity(),this.applyPosition(),this.applyPriority(),this.applyHitbox(),this.applyOffset(),this.applyGravity()}render(){if(!this.onscreen)return;n.func(this.renderBefore)&&this.renderBefore(),this.data.shadow&&!this.is(h.verbs.FALL)&&!this.is(h.verbs.DIVE)&&!this.is(h.verbs.SWIM)&&this.gamebox.draw(this.image,this.data.shadow.offsetX,this.data.shadow.offsetY,this.data.width,this.data.height,this.offset.x,this.offset.y,this.width,this.height),this.applyOpacity();let t=this.data.verbs[this.verb][this.dir].flipX,e=this.data.verbs[this.verb][this.dir].flipY,i=this.data.verbs[this.verb][this.dir].gapX;i=i?i*this.frame:0,this.player.renderLayer.context.save(),this.player.renderLayer.context.translate(t?this.width:0,e?this.height:0),this.player.renderLayer.context.scale(t?-1:1,e?-1:1),this.gamebox.draw(this.image,this.spritecel[0]+i,this.spritecel[1],this.data.width,this.data.height,this.offset.x*(t?-1:1),this.offset.y*(e?-1:1)+this.position.z,this.width,this.height),this.player.renderLayer.context.restore(),n.func(this.renderAfter)&&this.renderAfter(),this.player.query.debug&&this.renderDebug()}renderDebug(){this.player.renderLayer.context.save(),this.player.renderLayer.context.globalAlpha=.25,this.player.renderLayer.context.fillStyle=h.colors.white,this.player.renderLayer.context.fillRect(this.offset.x,this.offset.y,this.width,this.height),this.player.renderLayer.context.globalAlpha=.5,this.player.renderLayer.context.fillStyle=h.colors.red,this.player.renderLayer.context.fillRect(this.offset.x+this.data.hitbox.x/this.scale,this.offset.y+this.data.hitbox.y/this.scale,this.hitbox.width,this.hitbox.height),this.player.renderLayer.context.fillStyle=h.colors.green,this.player.renderLayer.context.fillRect(this.offset.x+this.data.hitbox.x/this.scale,this.offset.y+this.data.hitbox.y/this.scale+this.hitbox.height/2,this.footbox.width,this.footbox.height),this.player.renderLayer.context.restore()}handleVelocity(){this.idle.x&&(this.physics.vx=n.goToZero(this.physics.vx)),this.idle.y&&(this.physics.vy=n.goToZero(this.physics.vy))}handleGravity(){this.physics.vz++}handleResetControls(){for(let t=k.length;t--;)this.controls[k[t]]=!1}handleHealthCheck(){}handleControls(){this.stillTimer||(this.controls.left?(this.physics.vx=n.limit(this.physics.vx-this.speed,-this.physics.controlmaxv,this.physics.controlmaxv),this.idle.x=!1):this.controls.right?(this.physics.vx=n.limit(this.physics.vx+this.speed,-this.physics.controlmaxv,this.physics.controlmaxv),this.idle.x=!1):this.idle.x=!0,this.controls.up?(this.physics.vy=n.limit(this.physics.vy-this.speed,-this.physics.controlmaxv,this.physics.controlmaxv),this.idle.y=!1):this.controls.down?(this.physics.vy=n.limit(this.physics.vy+this.speed,-this.physics.controlmaxv,this.physics.controlmaxv),this.idle.y=!1):this.idle.y=!0)}handleElevation(t,e,{disableAccessCheck:i=!1}={}){let s=!1,a=e.event&&e.event.isElevation;a&&!this.elevation&&!i&&e.event.checkElevationAccess(t,this)&&(this.elevation={event:e.event},this.layer=h.layers.ELEVATION),!a&&this.elevation&&!this.lockElevation&&!this.isJumping()&&(this.elevation=null,this.layer=h.layers.SPRITES,s=!0);let r=e.map&&e.event&&this.elevation&&n.collide(e.map,e.event.eventbox);return{isElevationEvent:a,isElevationCollider:r,wasElevationEvent:s}}applyOpacity(){this.opacity&&(this.player.renderLayer.context.globalAlpha=this.opacity),this.hitTimer>0&&this.hitTimer%5===0&&(this.player.renderLayer.context.globalAlpha=.25)}applyPosition(){this.position=this.getNextPoi()}applyPriority(){this.prio=this.position.y+this.height}applyHitbox(){this.hitbox.x=this.position.x+this.data.hitbox.x/this.scale,this.hitbox.y=this.position.y+this.data.hitbox.y/this.scale,this.footbox.x=this.hitbox.x,this.footbox.y=this.hitbox.y+this.hitbox.height/2,this.center.x=this.hitbox.x+this.hitbox.width/2,this.center.y=this.hitbox.y+this.hitbox.height/2,this.perceptionBox=n.getPerceptionBox(this.position,this.width,this.height,this.map.data.tilesize)}applyOffset(){this.offset={x:this.position.x-this.gamebox.camera.x,y:this.position.y-this.gamebox.camera.y}}applyGravity(){let t=this.getNextZ();t>0?this.position.z=0:this.position.z=t}applyFrame(t){if(!this.frameStopped){if(this.resetElapsed&&(this.resetElapsed=!1,this.previousElapsed=t),this.data.verbs[this.verb][this.dir].stepsX){if(!(this.is(h.verbs.LIFT)&&this.isIdle())){let e=this.data.verbs[this.verb].dur/this.data.verbs[this.verb][this.dir].stepsX,i=t-this.previousElapsed;i>=e&&(this.previousElapsed=t-i%e,this.frame++,this.frame>=this.data.verbs[this.verb][this.dir].stepsX&&(this.previousElapsed=null,this.data.verbs[this.verb].stop?(this.frame=this.data.verbs[this.verb][this.dir].stepsX-1,this.frameStopped=!0):this.frame=0))}}else this.frame=0;this.spritecel=this.getCel()}}getCel(){return[this.data.verbs[this.verb][this.dir].offsetX+this.data.width*this.frame,this.data.verbs[this.verb][this.dir].offsetY]}getDur(t){return this.data.verbs[t].dur||0}getNextX(){return this.position.x+n.limit(this.physics.vx,-this.physics.maxv,this.physics.maxv)}getNextY(){return this.position.y+n.limit(this.physics.vy,-this.physics.maxv,this.physics.maxv)}getNextZ(){return this.position.z+n.limit(this.physics.vz,-this.physics.maxv,this.physics.maxv)}resetPhysics(){this.physics.vx=0,this.physics.vy=0,this.physics.vz=0}getNextPoi(){return{x:this.getNextX(),y:this.getNextY(),z:this.getNextZ()}}getNextPoiByDir(t,e){return e&&t==="left"&&(e=-this.physics.maxv),e&&t==="right"&&(e=this.physics.maxv),e&&t==="up"&&(e=-this.physics.maxv),e&&t==="down"&&(e=this.physics.maxv),e||(e=0),{x:t==="left"||t==="right"?this.getNextX()+e:this.position.x,y:t==="up"||t==="down"?this.getNextY()+e:this.position.y,z:this.position.z}}getHitbox(t){return{x:t.x+this.data.hitbox.x/this.scale,y:t.y+this.data.hitbox.y/this.scale,width:this.hitbox.width,height:this.hitbox.height}}getFootbox(t){return{x:t.x+this.data.hitbox.x/this.scale,y:t.y+(this.data.hitbox.y/this.scale+this.hitbox.height/2),width:this.footbox.width,height:this.footbox.height}}getFullbox(t=null){let e=t||this.position;return{x:e.x,y:e.y+e.z,width:this.width,height:this.height}}canTileStop(t){return t.tiles&&t.tiles.action.length&&t.tiles.action.find(e=>e.stop)}},R=class extends f{constructor(t,e){super(t,e)}checkQuestFlag(t){if(this.data.action?.quest?.checkFlag){let{key:e,value:i}=this.data.action.quest.checkFlag;if(e===t)return this.gamequest.checkQuest(e,i)}return!1}handleQuestFlagCheck(){}handleQuestItemCheck(){}handleQuestFlagUpdate(t){if(!this.data.action?.quest?.setFlag&&!t)return;let{key:e,value:i,reset:s}=t||this.data.action.quest.setFlag;this.gamequest.getCompleted(e)||(this.gamequest.hitQuest(e,i,s),this.gamebox.checkQuestFlags(e))}handleQuestItemUpdate(){}};var E=class extends R{constructor(t,e,i){super(t,e),this.mapId=i,this.states=this.data.states,this.stateIndex=0,this.quests=this.data.payload?.quest?this.data.payload.quest:[],this.questIndex=0,this.questStatusCheck=this.data.payload?.checkStatus||null,this.status=this.data.status||null,this.dialogue=null,this.aiCounter=this.data.ai?60:0,this.aiCoolDown=this.data.ai===h.npc.ai.WALK?60:0,this.dirX=null,this.dirY=null,this.stepsX=0,this.stepsY=0,this.lastDir=this.dir,this.lastFrame=0,this.pushed=null,this.floatCounter=0,this.floatCounter2=0,this.floatOffset=-(this.map.data.tilesize/2),this.attractRange=this.map.data.tilesize*3,this.attractCounter=0,this.attractDuration=128,this.initialize()}initialize(){this.initializeState(),this.initializeQuest()}resetWalk(){this.aiCounter=0,this.aiCoolDown=60,this.face(this.dir),this.handleResetControls()}freezeWalk(){this.stillTimer=1/0,this.aiCounter=0,this.aiCoolDown=60,this.handleResetControls(),this.face(h.opposites[this.gamebox.hero.dir])}isEnemy(){return this.data.type===h.npc.types.ENEMY}update(){this.onscreen&&(this.handleControls(),this.handleAI(),this.updateStack())}applyPosition(){this.stillTimer>0||(this.pushed?this.applyPushedPosition():this.data.ai===h.npc.ai.FLOAT?this.applyFloatPosition():this.applyNormalPosition())}applyPushedPosition(){let t={x:this.position.x,y:this.position.y,z:this.position.z};switch(this.pushed.dir){case"left":t.x-=1;break;case"right":t.x+=1;break;case"up":t.y-=1;break;case"down":t.y+=1;break}let e={map:this.gamebox.checkMap(t,this),npc:this.gamebox.checkNPC(t,this),enemy:this.gamebox.checkEnemy(t,this),tiles:this.gamebox.checkTiles(t,this),doors:this.gamebox.checkDoor(t,this),camera:this.gamebox.checkCamera(t,this)};if(e.map||e.npc||e.enemy||e.doors||e.camera||this.canTileStop(e)){this.pushed=null,this.gamebox.locked=!1;return}this.position=t,this.position.x===this.pushed.poi.x&&this.position.y===this.pushed.poi.y&&(this.pushed=null,this.gamebox.locked=!1)}applyFloatPosition(){let t=this.isEnemy()?0:this.floatOffset,e=this.getNextPoi(),i={map:this.gamebox.checkMap(e,this),doors:this.gamebox.checkDoor(e,this)};if(this.data.bounce&&(this.physics.vz=-n.upAndDown(this.floatCounter2,60),this.floatCounter++,this.floatCounter%2===0&&this.floatCounter2++),i.map||i.doors){this.position.z=t+this.physics.vz,this.handleAI();return}this.position.x=e.x,this.position.y=e.y,this.position.z=t+this.physics.vz}applyNormalPosition(){let t=this.getNextPoi(),{collision:e,isMapCollision:i}=this.gamebox.checkElevationCollision(t,this,{doors:this.gamebox.checkDoor(t,this),empty:this.gamebox.checkEmpty(t,this),hero:this.gamebox.checkHero(t,this),npc:this.gamebox.checkNPC(t,this),enemy:this.gamebox.checkEnemy(t,this),tiles:this.elevation?!1:this.gamebox.checkTiles(t,this)},void 0,{disableAccessCheck:!0}),s=e.doors||i||e.npc||e.enemy||e.hero||e.event&&!e.event.isElevation||this.canTileStop(e);if(this.data.action?.verb===h.verbs.ATTRACT&&this.handleAttract(t),s){switch(this.data.ai){case h.npc.ai.ROAM:case h.npc.ai.STEP:this.aiCounter=0;break;case h.npc.ai.WALK:this.resetWalk();break}this.handleAI();return}this.position=t}handleAI(){if(!this.stillTimer&&this.data.ai)switch(this.data.ai){case h.npc.ai.WALK:this.handleWalk();break;case h.npc.ai.ROAM:this.handleRoam();break;case h.npc.ai.FLOAT:case h.npc.ai.WANDER:this.handleWander();break;case h.npc.ai.STEP:this.handleStep();break}}handleWalk(){if(this.aiCounter)this.aiCounter--,this.aiCounter===0&&this.resetWalk();else{if(this.aiCoolDown>0){this.aiCoolDown--;return}let t=60,e=120;this.aiCounter=n.random(t,e);let i=this.dir,s=k[n.random(0,k.length-1)];if(i===s){this.aiCounter=0,this.handleWalk();return}this.dir=s,this.can(h.verbs.WALK)&&(this.verb=h.verbs.WALK),this.handleResetControls(),this.controls[this.dir]=!0}}handleStep(){if(this.aiCounter){this.aiCounter--;let t=this.data.verbs[this.verb].dur/this.data.verbs[this.verb][this.dir].stepsX;if(this.previousElapsed-this.lastUpdateTime>=t&&this.handleResetControls(),this.frame===this.lastFrame)return;this.lastFrame=this.frame,this.lastUpdateTime=this.previousElapsed,this.handleResetControls(),this.controls[this.lastDir]=!0}else{let t=this.lastDir,e=k[n.random(0,k.length-1)];if(t===e){this.aiCounter=0,this.handleStep();return}this.lastDir=e,this.aiCounter=n.random(120,240),this.handleResetControls(),this.can(h.verbs.WALK)&&(this.verb=h.verbs.WALK)}}handleRoam(){if(this.aiCounter)this.aiCounter--;else{let t=this.dir,e=k[n.random(0,k.length-1)];if(t===e){this.aiCounter=0,this.handleRoam();return}this.dir=e,this.aiCounter=n.random(120,240),this.can(h.verbs.WALK)&&(this.verb=h.verbs.WALK)}this.handleResetControls(),this.controls[this.dir]=!0}handleWander(){if(this.aiCounter)this.aiCounter--;else{let t=this.dirX,e=this.dirY,i=["left","right"][n.random(0,2)],s=["down","up"][n.random(0,2)];if(t===i&&e===s){this.handleWander();return}let a=this.data.ai===h.npc.ai.FLOAT?90:30,r=this.data.ai===h.npc.ai.FLOAT?180:60;this.aiCounter=n.random(60,120),this.stepsX=n.random(a,r),this.stepsY=n.random(a,r),this.dirX=i,this.dirY=s}this.stepsX?(this.stepsX--,this.controls[this.dirX]=!0,this.controls[h.opposites[this.dirX]]=!1,this.data.verbs[this.verb][this.dirX]&&(this.dir=this.dirX)):(this.controls.left=!1,this.controls.right=!1),this.stepsY?(this.stepsY--,this.controls[this.dirY]=!0,this.controls[h.opposites[this.dirY]]=!1,this.data.verbs[this.verb][this.dirY]&&(this.dir=this.dirY)):(this.controls.up=!1,this.controls.down=!1),!this.stepsX&&!this.stepsY?(this.verb=h.verbs.FACE,this.controls={}):(this.data.bounce&&this.isOnGround()&&(this.physics.vz=-6),this.can(h.verbs.WALK)&&(this.verb=h.verbs.WALK))}handleAttract(t){if(!this.data.action?.quest?.setCompanion||this.stillTimer>0)return;n.areSpritesInRange(this,this.gamebox.hero,this.attractRange)?(this.attractCounter++,this.attractCounter>=this.attractDuration&&this.isOnGround()&&(this.stillTimer=1/0,this.data.spawn.quest.checkSpawn&&this.gamequest.completeQuest(this.data.spawn.quest.checkSpawn.key),this.gamebox.spawnCompanion({...this.data.action.quest.setCompanion,dir:this.dir,verb:this.verb},this.position),this.map.killObject("npcs",this))):this.attractCounter=0}canInteract(t){return this.state.action&&(!this.state.action.dir||t===this.state.action.dir)}canDoAction(t){return this.data.action&&this.data.action.verb&&t===this.data.action.verb}canTileStop(t){let{tiles:e,empty:i}=t;if(i&&i.length)return!0;let s=e&&e.action.filter(a=>a.fall||a.swim||a.stop);return!!(s&&s.length)}doInteract(){this.data.payload&&this.handleQuestDialogue()}initializeState(){if(this.states.length===1)this.setState(0);else{let e=this.gamequest.getCompleted(this.mapId)?1:0;this.setState(e)}}setState(t){this.states.length&&(this.stateIndex=t,this.state=this.states[this.stateIndex],this.dir=this.state.dir,this.verb=this.state.verb)}handleInteractionState(){this.state.action.sound&&!this.gamebox.hero.itemGet&&this.player.gameaudio.hitSound(this.state.action.sound),this.state.action.verb&&this.data.verbs[this.state.action.verb]&&(this.verb=this.state.action.verb,this.dir=this.state.dir),this.state.action.shift&&this.setState(this.stateIndex+1)}initializeQuest(){if(this.quests.length===1)this.setQuest(0);else if(this.quests.length>1)for(let t=0;t<this.quests.length;t++){let e=this.getQuestId(this.quests[t].type,t);if(!this.gamequest.getCompleted(e)){this.setQuest(t);break}}}getQuestId(t,e){return`${this.mapId}-${t}-${e}`}setQuest(t){this.questIndex=t,this.quest=this.quests[this.questIndex]}getNextQuest(){return this.quests[this.questIndex+1]}getPreviousQuest(){return this.quests[this.questIndex-1]}advanceQuest(){this.getNextQuest()&&this.setQuest(this.questIndex+1)}advanceQuestRecursive(){this.getNextQuest()&&(this.setQuest(this.questIndex+1),this.handleQuestDialogue())}resetQuestDialogue(){this.dialogue=null,this.dir=this.state.dir,this.verb=this.state.verb,this.gamebox.hero.itemGet&&this.gamebox.hero.resetItemGet()}playQuestDialogue(t,e){this.dialogue||(this.data.ai===h.npc.ai.WALK&&this.freezeWalk(),this.dialogue=this.gamebox.dialogue.play(t).then(()=>{this.stillTimer=0,this.resetQuestDialogue(),this.handleAI(),e&&e()}).catch(()=>{this.resetQuestDialogue()}))}handleQuestDialogue(){if(this.quests.length===0)return;if(this.questStatusCheck){let{status:e,dialogue:i}=this.questStatusCheck;if(this.gamebox.hero.status===e){this.playQuestDialogue(i);return}}let t=this.getQuestId(this.quest.type,this.questIndex);if(this.gamequest.getCompleted(t)&&!this.getNextQuest()&&this.quest.type!==h.quest.dialogue.NO_CHECK){this.playQuestDialogue(Ht);return}switch(this.quest.type){case h.quest.dialogue.SET_ITEM:this.handleQuestItemUpdate(this.quest.id),this.gamequest.completeQuest(t),this.gamebox.playItemGetDialogue(this.quest.dialogue),this.advanceQuest(),this.handleInteractionState();break;case h.quest.dialogue.SET_FLAG:this.playQuestDialogue(this.quest.dialogue,()=>{this.gamequest.completeQuest(t),this.handlePreviousQuest(),this.advanceQuest()});break;case h.quest.dialogue.CHECK_ITEM:this.gamebox.hero.itemCheck(this.quest.id)?(this.handleQuestItemCheck(this.quest.id),this.gamequest.completeQuest(t),this.advanceQuestRecursive()):this.playQuestDialogue(this.quest.dialogue);break;case h.quest.dialogue.TAKE_ITEM:this.gamebox.hero.itemCheck(this.quest.id)&&this.playQuestDialogue(this.quest.dialogue,()=>{this.gamebox.hero.takeItem(this.quest.id),this.gamequest.completeQuest(t),this.advanceQuestRecursive()});break;case h.quest.dialogue.CHECK_FLAG:this.gamequest.getCompleted(this.quest.key)?(this.gamequest.completeQuest(t),this.advanceQuestRecursive()):this.playQuestDialogue(this.quest.dialogue);break;case h.quest.dialogue.CHECK_COMPANION:this.gamebox.checkCompanion(this.quest.id)?(this.gamequest.completeQuest(t),this.advanceQuestRecursive()):this.playQuestDialogue(this.quest.dialogue);break;case h.quest.dialogue.NO_CHECK:this.playQuestDialogue(this.quest.dialogue),this.getNextQuest()?(this.gamequest.completeQuest(t),this.advanceQuestRecursive()):this.handleInteractionState();break}}handlePreviousQuest(){let t=this.getPreviousQuest();if(t&&t.type===h.quest.dialogue.CHECK_COMPANION){this.gamequest.hitQuest(this.quest.key,1);let e=this.map.getSpawnpoolObject(this.quest.key);this.gamebox.companion.despawnQuest={questKey:this.quest.key,position:{x:e.data.spawn.x,y:e.data.spawn.y}}}else this.gamequest.completeQuest(this.quest.key)}handleQuestItemUpdate(t){let e=this.gamebox.hero.getItem(t);e&&e.collect?(this.gamebox.hero.collectItem(t,this.mapId),this.gamebox.hero.doItemGet(e)):this.gamebox.hero.giveItem(t,this.mapId),this.gamequest.completeQuest(this.mapId)}handleQuestItemCheck(t){if(this.gamebox.hero.itemCheck(t)){let e=this.gamebox.hero.getItem(t);e&&e.collect&&this.gamebox.hero.takeCollectible(t)}}},Ht={type:h.dialogue.types.TEXT,text:["This is an unhandled quest dialogue. If you want to properly end your quest use a NO_CHECK dialogue as the last entry in your quest array."]};var B=class extends R{constructor(t,e,i){super(t,e),this.mapId=i,this.open=!1,this.opening=!1,this.closing=!1,this.counter=0,this.rumble=0,this.originalX=this.position.x,this.dialogue=null,this.states=this.data.states,this.initialize()}initialize(){if(this.data.action){let t=this.gamequest.getCompleted(this.mapId);this.open=this.data.action.verb===h.verbs.OPEN?!!t:!t,this.counter=this.open?this.data.height:0}this.setState(0)}setState(t){this.states.length&&(this.stateIndex=t,this.state=this.states[this.stateIndex],this.dir=this.state.dir,this.verb=this.state.verb)}payload(){let t=this.data.payload?.quest?.[0]?.dialogue;t&&!this.dialogue&&(this.dialogue=this.gamebox.dialogue.play(t),this.dialogue.then(()=>{this.resetDialogue(),this.handleCompleteQuest()}).catch(()=>{this.resetDialogue()}))}resetDialogue(){this.dialogue=null}render(){this.onscreen&&(this.gamebox.draw(this.image,this.spritecel[0],this.spritecel[1],this.data.width,this.data.height-this.counter,this.offset.x,this.offset.y+this.counter,this.width,this.height-this.counter),this.player.query.debug&&this.renderDebug())}applyPosition(){if(!this.open){if(this.opening){if(this.rumble>0){this.rumble--,this.position.x+=this.rumble%2===0?-3:3;return}this.counter++,this.position.x+=this.counter%2===0?-3:3,this.counter%5===0&&this.applyFX(),this.counter%15===0&&this.applySound(),this.counter>=this.data.height&&(this.opening=!1,this.open=!0,this.position.x=this.originalX);return}if(this.closing){this.counter--,this.position.x+=this.counter%2===0?-3:3,this.counter%5===0&&this.applyFX(),this.counter%15===0&&this.applySound(),this.counter<=0&&(this.closing=!1,this.open=!1,this.position.x=this.originalX);return}this.position=this.getNextPoi()}}applySound(){this.data.action.sound&&this.player.gameaudio.hitSound(this.data.action.sound)}applyFX(){this.data.action.fx&&this.map.mapFX.smokeObjectBase(this,this.data.action.fx)}canInteract(t){return this.state.action&&(!this.state.action.dir||t===this.state.action.dir)}canInteractQuest(){return this.data.action.quest?.checkFlag?.dialogue||this.data.action.quest?.checkItem?.dialogue}canDoAction(t){return this.data.action&&this.data.action.verb&&t===this.data.action.verb}doInteract(){this.opening||this.closing||this.data.payload&&this.payload()}doAction(t){if(!(this.opening||this.closing)){if(this.open){this.open=!1,this.closing=!0,this.counter=this.height;return}this.opening=!0,this.counter=0,this.rumble=60}}handleQuestInteractionCheck(){if(this.data.action.quest.checkFlag){let{key:t,dialogue:e}=this.data.action.quest.checkFlag;if(this.gamequest.getCompleted(t))return;if(!this.checkQuestFlag(t)){e&&this.gamebox.dialogue.auto(e);return}this.handleQuestFlagCheck(t)}if(this.data.action.quest.checkItem){let{id:t,dialogue:e}=this.data.action.quest.checkItem;if(this.gamequest.getCompleted(this.mapId))return;if(!this.gamebox.hero.itemCheck(t)){e&&this.gamebox.dialogue.auto(e);return}this.handleQuestItemCheck(t)}}handleQuestFlagCheck(t){if(this.checkQuestFlag(t)){if(this.gamequest.completeQuest(t),this.data.action.quest.setFlag){let{key:e,value:i}=this.data.action.quest.setFlag;this.gamequest.hitQuest(e,i)}this.handleCompleteQuest()}}handleQuestItemCheck(t){if(this.gamebox.hero.itemCheck(t)){let e=this.gamebox.hero.getItem(t);e&&e.collect&&this.gamebox.hero.takeCollectible(t),this.handleCompleteQuest()}}handleCompleteQuest(){this.gamequest.completeQuest(this.mapId),this.handleDoAction()}handleDoAction(){let t=this.open?h.verbs.CLOSE:h.verbs.OPEN;this.canDoAction(t)&&this.doAction(t)}};var P=class extends f{constructor(t,e,i,s){let a=t.dirs?t.dirs[e].width:t.width,r=t.dirs?t.dirs[e].height:t.height,l={x:i.position.x+i.width/2-a/2,y:i.position.y+i.height/2-r/2};switch(e){case"left":l.x-=a;break;case"right":l.x+=a;break;case"up":l.y-=r;break;case"down":l.y+=r;break}let c={x:0,y:0,width:a,height:r},d=t.dirs?{face:{down:t.dirs.down,up:t.dirs.up,left:t.dirs.left,right:t.dirs.right}}:{face:{[e]:{offsetX:t.offsetX,offsetY:t.offsetY}}},u=i.layer,v={dir:e,spawn:l,width:a,height:r,hitbox:c,verbs:d,layer:u,...t};super(v,s),this.flightDir=e,this.flightCounter=0,this.hitCounter=0,this.sprite=i,this.elevation=this.sprite.elevation,this.lockElevation=this.elevation?this.elevation.event.isHorizontal&&(this.flightDir==="up"||this.flightDir==="down")||!this.elevation.event.isHorizontal&&(this.flightDir==="left"||this.flightDir==="right"):!1,this.map.addObject("sprites",this),this.sparks()}sparks(){this.data.fx&&this.map.mapFX.smokeObject(this,this.data.fx,{layer:this.layer}),this.data.sound&&(this.sprite===this.gamebox.hero?this.player.gameaudio.heroSound(this.data.sound):this.player.gameaudio.hitSound(this.data.sound))}update(){this.onscreen&&(this.controls[this.flightDir]=!0,this.handleFlight(),this.handleControls(),this.updateStack())}handleFlight(){this.data.spin&&(this.flightCounter++,this.flightCounter%5===0&&(this.dir==="left"?this.dir="down":this.dir==="down"?this.dir="right":this.dir==="right"?this.dir="up":this.dir==="up"&&(this.dir="left")))}kill(){this.map.killObject("sprites",this),this.sparks(),this.sprite.projectile=null}canHitHero(){return!this.gamebox.hero.isHitOrStill()&&!this.gamebox.hero.canShield(this)}applyPosition(){let t=this.getNextPoi(),{collision:e,isMapCollision:i}=this.gamebox.checkElevationCollision(this.position,this,{hero:this.gamebox.checkHero(this.position,this),doors:this.gamebox.checkDoor(this.position,this),camera:this.gamebox.checkCamera(this.position,this),npc:this.gamebox.checkNPC(this.position,this),enemy:this.gamebox.checkEnemy(this.position,this),tiles:this.elevation?!1:this.gamebox.checkTiles(this.position,this)});if(e.doors||e.camera||i||e.hero||e.npc||e.enemy&&e.enemy!==this.sprite||this.canTileStop(e)){e.hero&&this.canHitHero()&&this.gamebox.hero.hit(this.data.power),this.kill();return}this.position=t}};var D=class extends E{constructor(t,e,i){super(t,e,i),this.projectileCounter=this.data.projectile?120:0,this.projectile=null}hit(...t){super.hit(...t),this.face(this.dir),this.aiCounter=0}update(){this.onscreen&&(this.handleControls(),this.handleAI(),this.handleProjectile(),this.updateStack())}handleProjectile(){if(!(!this.data.projectile||this.projectile)){if(this.isHitOrStill()){this.projectileCounter=120;return}if(this.projectileCounter>0&&(this.projectileCounter--,this.projectileCounter===0)){if(n.random(0,100)<=25){let e=this.gamebox.player.getMergedData({id:this.data.projectile},"projectiles");this.projectile=new P(e,this.dir,this,this.map)}this.projectileCounter=120}}}canBeAttacked(t){return!this.hitTimer&&n.canSpriteInteractWithNPCByLayer(t,this)&&this.canDoAction(h.verbs.ATTACK)&&(!this.status||this.status===this.gamebox.hero.status)}canHitHero(){return!this.isHitOrStill()&&!this.gamebox.hero.isHitOrStill()&&!this.gamebox.hero.canShield(this)}handleHealthCheck(){this.stats&&this.health<=0&&(this.handleQuestFlagUpdate(),this.map.mapFX.smokeObject(this,this.data.action.fx),this.map.killObject("enemies",this),this.gamebox.hero.enemiesKilled++,this.data.action.sound&&this.player.gameaudio.hitSound(this.data.action.sound),this.data.drops&&!this.circularCheckQuestFlag()&&this.gamebox.itemDrop(this.data.drops,this.position,{layer:this.layer}))}circularCheckQuestFlag(){if(this.data.action.quest?.checkFlag&&this.data.action.quest?.setFlag&&this.data.action.quest?.dropItem){let{key:t}=this.data.action.quest.checkFlag,{key:e}=this.data.action.quest.setFlag;if(t===e)return this.gamequest.getCompleted(t)}return!1}isQuestFlagComplete(){if(this.data.action?.quest?.checkFlag){let{key:t}=this.data.action.quest.checkFlag;return this.gamequest.getCompleted(t)}return!1}handleQuestFlagCheck(t){if(this.checkQuestFlag(t)){if(this.data.action.quest.setFlag){let{key:e,value:i,reset:s}=this.data.action.quest.setFlag;if(e===t&&this.isQuestFlagComplete())return;this.gamequest.hitQuest(e,i,s)}this.gamequest.completeQuest(t),this.data.action.quest.dropItem&&this.gamebox.keyItemDrop(this.data.action.quest.dropItem,this.position,t,{layer:this.layer})}}};var X=class extends D{constructor(t,e,i){super(t,e,i),this.aggroActive=!1,this.aggroRadius=this.map.data.tilesize*4,this.aggroInterval=1e3,this.lastAggroTime=null,this.aggroSpeed=this.physics.maxv*2,this.backoffPosition=null}hit(...t){super.hit(...t),this.aggroActive=!1,this.backoffPosition=null}update(){this.onscreen&&(this.handleControls(),this.handleAI(),this.handleDetection(),this.handleProjectile(),this.updateStack())}handleAI(){this.aggroActive||super.handleAI()}handleProjectile(){this.aggroActive||super.handleProjectile()}applyPosition(){if(this.aggroActive){this.applyAggroPosition();return}super.applyPosition()}handleDetection(){if(!this.data.aggro||this.isHitOrStill()||!this.gamebox.hero.canAggroEnemy(this)){this.aggroActive=!1;return}if(this.lastAggroTime||(this.lastAggroTime=this.previousElapsed),this.previousElapsed-this.lastAggroTime<this.aggroInterval)return;this.lastAggroTime=null,n.areSpritesInRange(this,this.gamebox.hero,this.aggroRadius)?this.aggroActive=!0:this.aggroActive=!1}applyAggroPosition(){let t=this.getNextPoi();if(this.isOnGround()&&(this.physics.vz=-3),this.backoffPosition){let l=this.backoffPosition.x-this.center.x,c=this.backoffPosition.y-this.center.y,d=Math.atan2(c,l);t.x=this.position.x+this.aggroSpeed*Math.cos(d),t.y=this.position.y+this.aggroSpeed*Math.sin(d);let{isCollision:u}=this.getCollision(t);if(u){this.backoffPosition=null;return}this.position=t,Math.abs(this.center.x-this.backoffPosition.x)<1&&Math.abs(this.center.y-this.backoffPosition.y)<1&&(this.backoffPosition=null);return}let e=this.gamebox.hero.center.x-this.center.x,i=this.gamebox.hero.center.y-this.center.y,s=Math.atan2(i,e);this.dir=n.getDirectionFromAngle(s),t.x=this.position.x+this.aggroSpeed*Math.cos(s),t.y=this.position.y+this.aggroSpeed*Math.sin(s);let{collision:a,isCollision:r}=this.getCollision(t);if(a.hero&&!this.backoffPosition){let l=s+Math.PI;this.backoffPosition={x:this.center.x+Math.cos(l)*this.map.data.tilesize,y:this.center.y+Math.sin(l)*this.map.data.tilesize};return}r||(this.position=t)}getCollision(t){let e={map:this.gamebox.checkMap(t,this),npc:this.gamebox.checkNPC(t,this),enemy:this.gamebox.checkEnemy(t,this),tiles:this.gamebox.checkTiles(t,this),doors:this.gamebox.checkDoor(t,this),empty:this.gamebox.checkEmpty(t,this),hero:this.gamebox.checkHero(this.position,this)},i=e.map||e.npc||e.enemy||e.doors||this.canTileStop(e);return{collision:e,isCollision:i}}};var m=class extends f{constructor(t,e){t.type===h.npc.ai.FLOAT&&(t.layer="foreground"),t.verbs={face:{down:{offsetX:t.offsetX,offsetY:t.offsetY}}},super(t,e),this.paused=!1}blit(t){this.visible()&&(this.paused||(this.previousElapsed===null&&(this.previousElapsed=t),this.data.type===h.npc.ai.FLOAT&&this.position.y--,this.applyFrame(t)))}getCel(){return[this.data.offsetX+this.data.width*this.frame,this.data.offsetY]}applyFrame(t){if(this.data.stepsX){let e=this.data.dur/this.data.stepsX,i=t-this.previousElapsed;i>=e&&(this.previousElapsed=t-i%e,this.frame++,this.frame>=this.data.stepsX&&(this.data.kill?this.map.killObject("fx",this):(this.previousElapsed=null,this.frame=0,this.data.type===h.npc.ai.FLOAT&&(this.position.y=this.data.spawn.y))))}else this.frame=0;this.spritecel=this.getCel()}};var G=class{constructor(t,e){this.data=t,this.map=e,this.gamebox=this.map.gamebox,this.player=this.map.player,this.frame=0,this.isAnimated=!!this.data.stepsX,this.pushed=[],this.previousElapsed=null,this.initialize()}destroy(){}initialize(){for(let t=this.map.data.textures[this.data.layer].length;t--;)for(let e=this.map.data.textures[this.data.layer][t].length;e--;){let i=this.map.data.textures[this.data.layer][t][e];if(!Array.isArray(i))continue;let s=i[i.length-1];s[0]===this.data.offsetX&&s[1]===this.data.offsetY&&this.push([e,t])}}blit(t){this.previousElapsed===null&&(this.previousElapsed=t),this.applyFrame(t)}applyFrame(t){if(this.data.stepsX){let e=this.data.dur/this.data.stepsX,i=t-this.previousElapsed;i>=e&&(this.previousElapsed=t-i%e,this.frame++,this.frame>=this.data.stepsX&&(this.previousElapsed=null,this.frame=0))}else this.frame=0}getTile(){return[this.data.offsetX+this.frame*this.map.data.tilesize,this.data.offsetY]}canInteract(t=null){if(!t)return this.data.actions;for(let e=this.data.actions.length;e--;)if(this.data.actions[e].verb===t)return this.data.actions[e];return null}canAttack(){if(!this.data.actions)return null;for(let t=this.data.actions.length;t--;)if(this.data.actions[t].verb===h.verbs.ATTACK)return this.data.actions[t];return null}attack(t,e){this.splice(t);let i={position:{x:t[0]*this.map.data.tilesize,y:t[1]*this.map.data.tilesize},width:this.map.data.tilesize,height:this.map.data.tilesize};e.drops&&this.gamebox.itemDrop(e.drops,i.position),this.map.mapFX.smokeObject(i,e.fx)}push(t){let e={x:t[0]*this.map.data.tilesize,y:t[1]*this.map.data.tilesize,width:this.map.data.tilesize,height:this.map.data.tilesize,coords:t};this.pushed.push(e),this.data.fx&&this.addFX(e)}splice(t){if(this.isPushed(t)){for(let e=this.pushed.length;e--;)if(this.pushed[e].coords[0]===t[0]&&this.pushed[e].coords[1]===t[1]){this.pushed.splice(e,1),this.map.data.textures[this.data.layer][t[1]][t[0]].pop();break}}}addFX(t){let e=this.data.fx.offsetX||0,i=this.data.fx.offsetY||0,s=new m(this.player.getMergedData({id:this.data.fx.id,dur:this.data.fx.dur,type:this.data.fx.type,spawn:{x:t.x+e,y:t.y+i}},"fx",!0),this.map);this.map.addObject("fx",s)}isInArray(t,e){for(let i=t.length;i--;)if(t[i].coords[0]===e[0]&&t[i].coords[1]===e[1])return!0;return!1}isPushed(t){return this.isInArray(this.pushed,t)}};var M=class{constructor(t,e){this.data=t,this.map=e,this.eventbox={x:this.data.coords[0]*this.map.data.tilesize,y:this.data.coords[1]*this.map.data.tilesize,width:this.data.width||this.map.data.tilesize,height:this.data.height||this.map.data.tilesize},this.isSingleTile=this.eventbox.width===this.map.data.tilesize&&this.eventbox.height===this.map.data.tilesize,this.isEdgeTile=this.eventbox.x===0||this.eventbox.y===0||this.eventbox.x+this.eventbox.width===this.map.width||this.eventbox.y+this.eventbox.height===this.map.height,this.isElevation=this.data.type===h.events.ELEVATION,this.isHorizontal=this.eventbox.width>this.eventbox.height,this.isElevation&&this.extendElevationEventbox()}isBlockedByTile(){return this.isSingleTile&&this.map.getActiveTileOnCoords(this.data.coords)}checkCollision(t,e,i){let s=this.isEdgeTile?e.getFullbox(t):e.getHitbox(t),a=n.collide(this.eventbox,s);if(!a)return!1;if(this.isElevation)return!0;if(!i){let r=s.width*s.height,d=a.width*a.height/r*100>=this.map.data.tilesize;return a&&d}switch(e.dir){case"up":return a&&(this.isEdgeTile?s.y<=0:s.y<=this.eventbox.y+this.eventbox.height/2);case"down":return a&&(this.isEdgeTile?s.y+s.height>=this.map.height:s.y+s.height>=this.eventbox.y+this.eventbox.height/2);case"left":return a&&(this.isEdgeTile?s.x<=0:s.x<=this.eventbox.x+this.eventbox.width/2);case"right":return a&&(this.isEdgeTile?s.x+s.width>=this.map.width:s.x+s.width>=this.eventbox.x+this.eventbox.width/2)}}checkElevationAccess(t,e){return n.collide(this.spacerOne,e.hitbox)||n.collide(this.spacerTwo,e.hitbox)}checkElevationAccessToSprite(t,e){return this.isHorizontal?e.hitbox.x+e.hitbox.width<=this._eventbox.x||e.hitbox.x>=this._eventbox.x+this._eventbox.width:e.hitbox.y+e.hitbox.height<=this._eventbox.y||e.hitbox.y>=this._eventbox.y+this._eventbox.height}extendElevationEventbox(){this._eventbox={...this.eventbox},this.isHorizontal?(this.eventbox.width+=this.map.data.tilesize*2,this.eventbox.x-=this.map.data.tilesize,this.spacerOne={x:this.eventbox.x,y:this.eventbox.y,width:this.map.data.tilesize,height:this.eventbox.height},this.spacerTwo={x:this.eventbox.x+this.eventbox.width,y:this.eventbox.y,width:this.map.data.tilesize,height:this.eventbox.height}):(this.eventbox.height+=this.map.data.tilesize*2,this.eventbox.y-=this.map.data.tilesize,this.spacerOne={x:this.eventbox.x,y:this.eventbox.y,width:this.eventbox.width,height:this.map.data.tilesize},this.spacerTwo={x:this.eventbox.x,y:this.eventbox.y+this.eventbox.height,width:this.eventbox.width,height:this.map.data.tilesize})}};var W=class{constructor(t){this.map=t,this.player=this.map.player}smokeObject(t,e="smoke",i={}){let s={x:t.position.x+t.width/2-this.map.data.tilesize/2,y:t.position.y+t.height/2-this.map.data.tilesize/2},a=this.player.getMergedData({id:e,kill:!0,spawn:s,...i},"fx");this.map.addObject("fx",new m(a,this.map)),this.map.addObject("fx",new m(n.merge(a,{spawn:{x:s.x-this.map.data.tilesize/4,y:s.y-this.map.data.tilesize/4},vx:-8,vy:-8}),this.map)),this.map.addObject("fx",new m(n.merge(a,{spawn:{x:s.x+this.map.data.tilesize/4,y:s.y-this.map.data.tilesize/4},vx:8,vy:-8}),this.map)),this.map.addObject("fx",new m(n.merge(a,{spawn:{x:s.x-this.map.data.tilesize/4,y:s.y+this.map.data.tilesize/4},vx:-8,vy:8}),this.map)),this.map.addObject("fx",new m(n.merge(a,{spawn:{x:s.x+this.map.data.tilesize/4,y:s.y+this.map.data.tilesize/4},vx:8,vy:8}),this.map))}smokeObjectBase(t,e="smoke"){let i=this.player.getMergedData({id:e,kill:!0},"fx");this.map.addObject("fx",new m(n.merge(i,{spawn:{x:t.position.x+t.width/2-i.width/2,y:t.position.y+t.height-i.height/2},vy:-n.random(0,t.height/2)}),this.map)),this.map.addObject("fx",new m(n.merge(i,{spawn:{x:t.position.x-i.width/2,y:t.position.y+t.height-i.height/2},vx:-n.random(0,16),vy:-n.random(0,t.height/2)}),this.map)),this.map.addObject("fx",new m(n.merge(i,{spawn:{x:t.position.x+t.width-i.width/2,y:t.position.y+t.height-i.height/2},vx:n.random(0,16),vy:-n.random(0,t.height/2)}),this.map)),t.width>this.map.data.tilesize&&(this.map.addObject("fx",new m(n.merge(i,{spawn:{x:t.position.x+t.width/4-i.width/2,y:t.position.y+t.height-i.height/2},vx:-n.random(0,16),vy:-n.random(0,t.height/2)}),this.map)),this.map.addObject("fx",new m(n.merge(i,{spawn:{x:t.position.x+t.width-t.width/4-i.width/2,y:t.position.y+t.height-i.height/2},vx:n.random(0,16),vy:-n.random(0,t.height/2)}),this.map)))}};var U=class extends f{constructor({verb:t,...e},i,s){let a={hitbox:{x:0,y:0,width:e.width,height:e.height},verbs:{face:{down:{offsetX:e.offsetX,offsetY:e.offsetY}}},...e};super(a,i),this.mapId=s}applyPosition(){this.position=this.getNextPoi()}canPickup(){return!0}},et=class extends f{constructor(t,{verb:e,...i},s,a){let r={spawn:t,hitbox:{x:0,y:0,width:i.width,height:i.height},verbs:{face:{down:{offsetX:i.offsetX,offsetY:i.offsetY}}},...i};super(r,s),this.bounce=6,this.checkFlag=a}destroy(){this.checkFlag&&this.gamequest.removeCompleted(this.checkFlag)}applyPosition(){this.bounce>0&&this.isOnGround()&&(this.physics.vz=-this.bounce,this.bounce--),this.position=this.getNextPoi()}canPickup(){return this.bounce===0&&this.isOnGround()}};var j=class{constructor(t,e){this.gamebox=e,this.gamequest=this.gamebox.gamequest,this.player=this.gamebox.player,this.camera=this.gamebox.camera,this.initMap(t)}destroy(){for(let t=this.activeTiles.length;t--;)this.activeTiles[t].destroy(),this.activeTiles[t]=null;this.activeTiles=null,this.animatedTiles=null;for(let t=this.npcs.length;t--;)this.npcs[t].destroy(),this.npcs[t]=null;this.npcs=null;for(let t=this.doors.length;t--;)this.doors[t].destroy(),this.doors[t]=null;this.doors=null;for(let t=this.enemies.length;t--;)this.enemies[t].destroy(),this.enemies[t]=null;this.enemies=null;for(let t=this.fx.length;t--;)this.fx[t].destroy(),this.fx[t]=null;this.fx=null;for(let t=this.items.length;t--;)this.items[t].destroy(),this.items[t]=null;this.items=null;for(let t=this.sprites.length;t--;)this.sprites[t].destroy(),this.sprites[t]=null;this.sprites=null,this.image=null,this.events=null,this.colliders=null,this.allSprites=null,this.spawnpool=null}initMap(t){this.data=structuredClone(t),this.width=this.data.width,this.height=this.data.height,this.image=g.cash(this.data.image),this.mapFX=new W(this),this.activeTiles=[],this.animatedTiles=[],this.fx=[],this.npcs=[],this.doors=[],this.enemies=[],this.events=[],this.colliders=[],this.items=[],this.sprites=[],this.spawnpool=[],this.allSprites=[]}initSprites(){for(let t=this.data.fx.length;t--;)this.fx.push(new m(this.player.getMergedData(this.data.fx[t],"fx",!0),this)),this.addAllSprite(this.fx[t]);for(let t=this.data.npcs.length;t--;){let e=this.player.getMergedData(this.data.npcs[t],"npcs",!0),i=this.data.npcs[t].type||"npc",s=this.getMapId(i,t),a=e.spawn.quest;if(!(a?.checkSpawn&&this.gamequest.getCompleted(a.checkSpawn.key)))if(a?.checkFlag&&!this.gamequest.getCompleted(a.checkFlag.key))this.spawnpool.push({data:e,type:i,mapId:s});else if(i===h.npc.types.ENEMY){let r=e.aggro?new X(e,this,s):new D(e,this,s);this.enemies.push(r),this.addAllSprite(r)}else if(i===h.npc.types.DOOR){let r=new B(e,this,s);this.doors.push(r),this.addAllSprite(r)}else{let r=new E(e,this,s);this.npcs.push(r),this.addAllSprite(r)}}for(let t=this.data.items.length;t--;){let e=this.getMapId("item",t);this.gamequest.getCompleted(e)||(this.items.push(new U(this.player.getMergedData(this.data.items[t],"items",!0),this,e)),this.addAllSprite(this.items[t]))}}initTiles(){for(let t=this.data.tiles.length;t--;){let e=new G(this.data.tiles[t],this);this.activeTiles.push(e),e.isAnimated&&this.animatedTiles.push(e)}for(let t=this.data.events.length;t--;)this.events.push(new M(this.data.events[t],this));for(let t=this.data.collision.length;t--;)this.colliders.push({x:this.data.collision[t][0]*this.data.collider,y:this.data.collision[t][1]*this.data.collider,width:this.data.collider,height:this.data.collider})}blit(t){for(let e=this.activeTiles.length;e--;)this.activeTiles[e].blit(t);for(let e=this.npcs.length;e--;)this.npcs[e].blit(t);for(let e=this.enemies.length;e--;)this.enemies[e].blit(t);for(let e=this.doors.length;e--;)this.doors[e].blit(t);for(let e=this.fx.length;e--;)this.fx[e].blit(t);for(let e=this.sprites.length;e--;)this.sprites[e].blit(t);for(let e=this.items.length;e--;)this.items[e].blit(t)}update(){for(let t=this.npcs.length;t--;)this.npcs[t].update();for(let t=this.enemies.length;t--;)this.enemies[t].update();for(let t=this.doors.length;t--;)this.doors[t].update();for(let t=this.fx.length;t--;)this.fx[t].update();for(let t=this.sprites.length;t--;)this.sprites[t].update();for(let t=this.items.length;t--;)this.items[t].update();this.sortAllSprites()}render(){this.renderBox=this.getRenderbox(),this.gamebox.renderQueue.add({render:this.renderTextures.bind(this,"background"),layer:"background"}),this.renderAllSprites(),this.gamebox.renderQueue.add({render:this.renderTextures.bind(this,"foreground"),layer:"foreground"})}renderTextures(t){n.drawMapTiles(this.player.renderLayer.context,this.image,this.renderBox.textures[t],this.data.tilesize,this.data.tilesize,this.renderBox.bleed)}sortAllSprites(){this.allSprites.sort((t,e)=>t.prio-e.prio)}renderAllSprites(){for(let t=0;t<this.allSprites.length;t++)this.gamebox.renderQueue.add(this.allSprites[t])}renderDebug(){let t=this.gamebox.getVisibleColliders(),e=this.gamebox.getVisibleEvents();this.player.renderLayer.context.save(),this.player.renderLayer.context.globalAlpha=.5;for(let i=t.length;i--;)this.player.renderLayer.context.fillStyle=h.colors.red,this.player.renderLayer.context.fillRect(t[i].x-this.gamebox.camera.x,t[i].y-this.gamebox.camera.y,t[i].width,t[i].height);for(let i=e.length;i--;)this.player.renderLayer.context.fillStyle=h.colors.blue,this.player.renderLayer.context.fillRect(e[i].eventbox.x-this.gamebox.camera.x,e[i].eventbox.y-this.gamebox.camera.y,e[i].eventbox.width,e[i].eventbox.height);this.player.renderLayer.context.restore()}getMapId(t,e){return`${t}-${this.data.id}-${e}`}getRenderbox(){let t={x:Math.floor(this.camera.x/this.data.tilesize),y:Math.floor(this.camera.y/this.data.tilesize),width:this.camera.width+this.data.tilesize,height:this.camera.height+this.data.tilesize,bleed:{},textures:{}};return t.bleed=this.getBleed(t),t.textures=this.getTextures(t),t}getBleed(t){return{x:-Math.floor(this.camera.x-t.x*this.data.tilesize),y:-Math.floor(this.camera.y-t.y*this.data.tilesize)}}getTextures(t){let e=t.height/this.data.tilesize,i=t.width/this.data.tilesize,s={};for(let a in this.data.textures){s[a]=[];for(let r=0;r<e;r++){s[a][r]=[];let l=t.y+r;if(this.data.textures[a][l])for(let c=0;c<i;c++){let d=t.x+c;if(this.data.textures[a][l][d]){let u=[...this.data.textures[a][l][d]];if(a==="background")s[a][r][c]=this.getActiveTile([d,l],u);else{let v=this.checkShiftableForeground(l,d,u);s[a][r][c]=v?0:u}}else s[a][r][c]=0}}}return s}checkShiftableForeground(t,e,i){let s={x:e*this.data.tilesize,y:t*this.data.tilesize,width:this.data.tilesize,height:this.data.tilesize},a={hero:n.collide(s,this.gamebox.hero.getFullbox()),companion:this.gamebox.companion?n.collide(s,this.gamebox.companion.getFullbox()):!1};if(!a.hero&&!a.companion)return!1;let r=this.data.textures.background[t][e];if(i===0||r===0||(i=i[i.length-1],r=r[r.length-1],i[0]!==r[0]&&i[1]!==r[1]))return!1;let l=this.gamebox.hero.position.y+this.gamebox.hero.height;return s.y+s.height<l}spliceActiveTile(t,e){this.getActiveTiles(t).splice(e)}getActiveTiles(t){for(let e=this.activeTiles.length;e--;)if(this.activeTiles[e].data.group===t)return this.activeTiles[e];return null}getActiveTileOnCoords(t){for(let e=this.activeTiles.length;e--;)if(this.activeTiles[e].isPushed(t))return this.activeTiles[e];return null}getActiveTile(t,e){for(let i=this.animatedTiles.length;i--;)if(this.animatedTiles[i].isPushed(t))return[...e,this.animatedTiles[i].getTile()];return e}getEvent(t){for(let e=this.events.length;e--;)if(this.events[e].data.coords[0]===t[0]&&this.events[e].data.coords[1]===t[1])return this.events[e];return null}getEmptyTile(t,e="background"){return this.data.textures[e][t[1]][t[0]]}addAllSprite(t){t&&this.allSprites.indexOf(t)===-1&&this.allSprites.push(t)}removeAllSprite(t){t&&this.allSprites.indexOf(t)!==-1&&this.allSprites.splice(this.allSprites.indexOf(t),1)}addObject(t,e){this[t].push(e),this.addAllSprite(e)}killObject(t,e){this[t].indexOf(e)!==-1&&(this[t].splice(this[t].indexOf(e),1),this.removeAllSprite(e),this.gamebox.removeCollision(t,e),e.destroy(),e=null)}spawnObject(t,e,{fx:i=!0,...s}={}){if(this.spawnpool.splice(this.spawnpool.indexOf(t),1),s)for(let r in s)t.data[r]=s[r];let a=new E(t.data,this,e);this.npcs.push(a),this.addAllSprite(a),i&&(this.mapFX.smokeObject(a),this.player.gameaudio.hitSound("smash"))}getSpawnpoolObject(t){for(let e=this.spawnpool.length;e--;)if(this.spawnpool[e].data.spawn.quest.checkFlag.key===t)return this.spawnpool[e];return null}handleQuestFlagCheck(t,e=void 0){for(let i=this.spawnpool.length;i--;){let{data:s,mapId:a}=this.spawnpool[i],{key:r,value:l}=s.spawn.quest.checkFlag;if(r===t&&this.gamequest.checkQuest(r,l)){this.gamequest.completeQuest(r),this.spawnObject(this.spawnpool[i],a,e);break}}}};var ot=class{constructor(t,e=0,i=0,s=30,a=1.5,r=.1){this.player=t,this.position={x:e,y:i},this.poi={x:e,y:i},this.velocity={x:0,y:0},this.mass=r,this.stiffness=s,this.damping=a,this.errorMargin=.001,this.isResting=!1,this.sprite=null,this.previousElapsed=null,this.hiJacked=!1,this.onPaused=this.handlePaused.bind(this),this.player.on(h.broadcast.PAUSED,this.onPaused)}destroy(){this.player.off(h.broadcast.PAUSED,this.onPaused)}handlePaused(){this.previousElapsed=null}bind(t){this.sprite=t}blit(t){if(this.hiJacked)return;if(this.previousElapsed===null&&(this.previousElapsed=t),Math.abs(this.position.x-this.poi.x)<this.errorMargin&&Math.abs(this.position.y-this.poi.y)<this.errorMargin){this.previousElapsed=t,this.isResting=!0;return}let i=(t-this.previousElapsed)/1e3;this.previousElapsed=t,this.isResting=!1;let s=-this.stiffness*(this.position.x-this.poi.x),a=-this.damping*this.velocity.x,r=(s+a)/this.mass,l=-this.stiffness*(this.position.y-this.poi.y),c=-this.damping*this.velocity.y,d=(l+c)/this.mass;this.velocity.x+=r*i,this.velocity.y+=d*i,this.position.x+=this.velocity.x*i,this.position.y+=this.velocity.y*i,this.sprite&&(this.sprite.position.x=this.position.x,this.sprite.position.y=this.position.y)}},it=ot;var K=class extends f{constructor(t,e){super(t,e),this.onscreen=!0,this.magic=this.data.stats?.magic??20,this.maxMagic=this.magic,this.status=null,this.statusEffects={},this.currency=this.data.currency||0,this.equipped=this.data.equipped||{weapon:!1,shield:!1},this.enemiesKilled=0,this.totalDeaths=0,this.itemGet=null,this.liftedTile=null,this.maskFX=null,this.items=[],this.controls=this.player.controls,this.deathCounter=0,this.kickCounter=0,this.diveCounter=0,this.spinCounter=0,this.spinLocked=!1,this.spinCharged=!1,this.projectile=null,this.projectileIndex=-1,this.projectileItem=null,this.mode=h.hero.modes.WEAPON,this.interact=null,this.parkour=null,this.falling=null,this.lifting=null,this.lastPositionOnGround=this.position}visible(){return!0}hit(...t){this.falling||this.diveCounter>0||(super.hit(...t),this.destroyLiftedTile(),this.gamebox.swimming||(this.resetSpin(),this.physics.vz=-6))}isDead(){return this.deathCounter>0||this.killed}jump(){this.maskFX=null,this.resetMaxV(),this.cycle(h.verbs.JUMP,this.dir),this.physics.vz=-(this.map.data.tilesize/3),this.player.gameaudio.heroSound(h.verbs.JUMP)}swimKick(){this.kickCounter=30,this.physics.maxv=this.physics.controlmaxv*4,this.player.gameaudio.heroSound(h.verbs.JUMP)}swimDive(){this.diveCounter=120,this.cycle(h.verbs.DIVE,this.dir)}resetMaxV(){this.spinLocked?this.physics.maxv=this.physics.controlmaxv/2:this.physics.maxv=this.physics.controlmaxv}resetItemGet(){this.itemGet=null,this.stillTimer=0,this.face("down")}addMaskFX(t){this.maskFX=new rt(t,this,this.map,{x:this.position.x,y:this.position.y})}checkStat(t,e){return this.getStat(t)>=e}getStat(t){let e=0;for(let s=this.items.length;s--;)this.items[s].stat?.key===t&&(e+=this.items[s].stat.value);let i=this.statusEffects[this.status]?.[t]??0;return this.stats[t]+e+i}updateStat(t,e){switch(t){case"health":this.health=Math.max(0,Math.min(this.health+e,this.getMaxHealth()));break;case"magic":this.magic=Math.max(0,Math.min(this.magic+e,this.maxMagic));break;default:this.stats[t]+=e;break}}getMaxHealth(){return this.maxHealth*(this.statusEffects[this.status]?.maxHealth??1)}applyStatus(t){this.status=t,this.data.status[t]&&(this.statusEffects[t]=this.data.status[t],this.statusEffects[t].maxHealth&&(this.health=this.maxHealth*this.statusEffects[t].maxHealth))}removeStatus(){this.status=null,this.statusEffects={},this.health=this.maxHealth}itemCheck(t){let e=this.getItem(t);return e?e.collect?e.collected>0:!0:!1}getItem(t){return this.items.find(e=>e.id===t)}hasJump(){return this.items.some(t=>t.verb===h.verbs.JUMP)}hasSwim(){return this.items.some(t=>t.verb===h.verbs.SWIM)}hasMagic(){return this.items.some(t=>t.stat?.key==="magic")}canUseMagic(){return this.hasMagic()&&this.magic>0}collectItem(t,e){let i=this.getItem(t);if(i){i.collected++;return}this.giveItem(t,e)}takeCollectible(t){let e=this.getItem(t);e&&e.collect&&(e.collected=Math.max(0,e.collected-1))}doItemGet(t){this.data.verbs.itemGet?.down&&(this.itemGet=new lt(this.position,t,this.map,this),this.stillTimer=1/0,this.cycle("itemGet","down"),this.player.gameaudio.heroSound("itemGet"))}giveItem(t,e){let i=this.player.getMergedData({id:t,mapId:e},"items");this.getItem(t)||this.items.push(i),this.doItemGet(i),i.equip&&this.equip(i.equip),i.currency&&this.receive(i.currency),i.status&&this.applyStatus(i.status),i.cure&&i.cure===this.status&&this.removeStatus(i.cure),i.collect&&(i.collected=1)}takeItem(t){let e=this.items.find(i=>i.id===t);e&&(this.items.splice(this.items.indexOf(e),1),e.equip&&this.unequip(e.equip),e.status&&this.removeStatus())}pay(t){this.currency=Math.max(0,this.currency-t)}receive(t){this.currency+=t}equip(t){this.equipped[t]=!0}unequip(t){this.equipped[t]=!1}isEquipped(t){return this.equipped[t]||!1}hasWeapon(){return this.equipped.weapon&&this.data.weapon?.[this.dir]?.length}hasShield(){return this.equipped.shield&&this.data.shield?.[this.verb]?.[this.dir]?.length}hasProjectile(){return this.items.some(t=>t.projectile)}canCycleProjectile(){let t=this.items.filter(e=>e.projectile);return t.length>1&&this.projectileIndex<t.length-1}updateProjectileItem(){let t=this.items.filter(e=>e.projectile);this.projectileIndex>=t.length-1?this.projectileIndex=0:this.projectileIndex++,this.projectileItem=t[this.projectileIndex]}fireProjectile(){if(this.projectile||!this.projectileItem)return;let t=this.gamebox.player.getMergedData({id:this.projectileItem.projectile},"projectiles");this.projectile=new nt(t,this.dir,this,this.map)}isWeaponMode(){return this.hasWeapon()&&this.mode===h.hero.modes.WEAPON}isProjectileMode(){return this.hasProjectile()&&this.mode===h.hero.modes.PROJECTILE}blitAfter(t){this.kickCounter>0&&this.kickCounter--,this.diveCounter>0&&(this.diveCounter--,this.diveCounter===0&&this.cycle(h.verbs.SWIM,this.dir)),this.lifting&&this.blitLifting(t),this.gamebox.attacking&&this.blitAttacking(t),this.maskFX&&this.maskFX.blit(t),this.itemGet&&this.itemGet.blit(t),this.liftedTile&&this.liftedTile.blit(t),this.handlePassiveInteraction(t)}blitLifting(t){this.lifting.timeElapsed=t-this.lifting.timeStarted,this.lifting.timeElapsed>=this.getDur(h.verbs.LIFT)&&this.applyLifting()}blitAttacking(t){if(this.gamebox.attacking.timeElapsed=t-this.gamebox.attacking.timeStarted,!(this.gamebox.attacking.timeElapsed<this.getDur(h.verbs.ATTACK))){if(!this.canUseMagic()||!this.isWeaponMode()){this.resetAttacking();return}if(this.controls.b){this.controls.bHold?(this.spinCharged=!0,this.spinCounter++):(this.spinLocked=!0,this.frameStopped=!0,this.frame=this.data.verbs[this.verb][this.dir].stepsX-1,this.spritecel=this.getCel(),this.physics.maxv=this.physics.controlmaxv/2),!this.isIdle()&&this.isOnGround()&&(this.physics.vz=-3);return}this.resetAttacking()}}resetAttacking(){this.face(this.dir),this.spinCounter=0,this.frameStopped=!1,this.gamebox.attacking=null}resetSpin(){this.spinLocked=!1,this.spinCharged=!1,this.resetAttacking()}update(){if(this.gamebox.panning){this.updateWhilePanning();return}this.handleControls(),this.handleVelocity(),this.handleGravity(),this.applyGravity(),this.maskFX&&this.maskFX.update(),this.itemGet&&this.itemGet.update(),this.liftedTile&&this.liftedTile.update()}updateWhilePanning(){this.applyOffset(),this.maskFX&&this.maskFX.applyOffset()}renderAfter(){this.maskFX&&this.maskFX.render(),this.itemGet&&this.itemGet.render(),this.liftedTile&&this.liftedTile.render(),this.renderWeapon(),this.renderShield(),this.player.query.debug&&this.renderAfterDebug()}renderWeapon(){this.hasWeapon()&&this.is(h.verbs.ATTACK)&&this.mode===h.hero.modes.WEAPON&&(this.spinCharged&&this.spinCounter%5===0&&(this.player.renderLayer.context.save(),this.player.renderLayer.context.globalAlpha=.25),this.gamebox.draw(this.image,this.data.weapon[this.dir][this.frame].offsetX,this.data.weapon[this.dir][this.frame].offsetY,this.data.weapon[this.dir][this.frame].width,this.data.weapon[this.dir][this.frame].height,this.offset.x+this.data.weapon[this.dir][this.frame].positionX,this.offset.y+this.data.weapon[this.dir][this.frame].positionY,this.data.weapon[this.dir][this.frame].width/this.scale,this.data.weapon[this.dir][this.frame].height/this.scale),this.player.renderLayer.context.restore(),this.frame>0&&this.handleAttackFrame())}renderShield(){this.hasShield()&&!this.gamebox.attacking&&this.gamebox.draw(this.image,this.data.shield[this.verb][this.dir][this.frame].offsetX,this.data.shield[this.verb][this.dir][this.frame].offsetY,this.data.shield[this.verb][this.dir][this.frame].width,this.data.shield[this.verb][this.dir][this.frame].height,this.offset.x+this.data.shield[this.verb][this.dir][this.frame].positionX,this.offset.y+this.position.z+this.data.shield[this.verb][this.dir][this.frame].positionY,this.data.shield[this.verb][this.dir][this.frame].width/this.scale,this.data.shield[this.verb][this.dir][this.frame].height/this.scale)}renderAfterDebug(){if(this.player.renderLayer.context.globalAlpha=.5,this.player.renderLayer.context.fillStyle=h.colors.teal,this.hasWeapon()&&this.is(h.verbs.ATTACK)){let t=this.getWeaponbox("offset");this.player.renderLayer.context.fillRect(t.x,t.y,t.width,t.height)}if(this.hasShield()){let t=this.getShieldbox("offset");this.player.renderLayer.context.fillRect(t.x,t.y,t.width,t.height)}}handlePassiveInteraction(){let t=this.getNextPoiByDir(this.dir,1),e={npc:this.gamebox.checkNPC(t,this),door:this.gamebox.checkDoor(t,this),tiles:this.gamebox.checkTiles(t,this)},i=!this.is(h.verbs.LIFT)&&!this.is(h.verbs.GRAB)&&!this.is(h.verbs.PULL),s=e.door&&(e.door.canInteract(this.dir)||e.door.canInteractQuest()),a=e.npc&&e.npc.canInteract(this.dir),r=this.canGrabTile(e)||!i;this.gamebox.dialogue.active||s||a?this.interact=h.hero.interact.READ:r?this.interact=h.hero.interact.GRAB:i&&(this.interact=null)}handleAttackFrame(){let t=this.getWeaponbox(),e={enemy:this.gamebox.checkEnemy(this.position,t),item:this.gamebox.checkItems(this.position,t),tiles:this.gamebox.checkTiles(this.position,t)};e.item&&this.gamebox.handleHeroItem(this.position,this.dir,e.item),e.enemy&&e.enemy.canBeAttacked(this)&&e.enemy.hit(this.getStat("power")),this.handleAttackTiles({collision:e})}handleAttackTiles({collision:t,checkStop:e=!1}){if(t.tiles&&t.tiles.attack.length&&!this.spinLocked){for(let i=t.tiles.attack.length;i--;)if(t.tiles.attack[i].attack&&(!e||t.tiles.attack[i].stop)){let s=t.tiles.attack[i].instance.canAttack();s&&t.tiles.attack[i].instance.attack(t.tiles.attack[i].coord,s)}}}handleHealthCheck(){this.health<=0&&(this.stillTimer=1/0,this.deathCounter=240,this.totalDeaths++,this.maskFX&&(this.maskFX.paused=!0),this.gamebox.swimming?this.cycle(h.verbs.DIVE,"down"):this.data.verbs.die?.down&&this.cycle("die","down"),this.player.gameaudio.stop(),this.player.gameaudio.heroSound("death"))}applyPosition(t,e){if(this.parkour){this.applyParkour(),this.applyHitbox();return}if(this.falling){this.applyFalling(),this.applyHitbox();return}this.gamebox.jumping||(this.lastPositionOnGround={x:this.position.x,y:this.position.y}),this.spinLocked||(this.dir=e),this.position.x=t.x,this.position.y=t.y,this.applyHitbox(),this.applyHeroMask()}applyOpacity(){super.applyOpacity(),this.falling&&this.falling.didReset&&this.falling.resetCounter===0&&(this.player.renderLayer.context.globalAlpha=0)}destroyLiftedTile(){this.liftedTile&&this.liftedTile.destroy()}applyLifting(){let t=this.map.getActiveTiles(this.gamebox.interact.tile.group),e={x:this.gamebox.interact.tile.coord[0]*this.map.data.tilesize,y:this.gamebox.interact.tile.coord[1]*this.map.data.tilesize};this.player.gameaudio.heroSound(h.verbs.LIFT),this.map.spliceActiveTile(this.gamebox.interact.tile.group,this.gamebox.interact.tile.coord),this.liftedTile=new dt(e,t,this.map,this),this.cycle(h.verbs.LIFT,this.dir),this.physics.maxv=this.physics.controlmaxv/2,this.gamebox.locked=!1,this.lifting=null}applyFalling(){if(this.position.x===this.falling.reset.x&&this.position.y===this.falling.reset.y){this.falling=null,this.frameStopped=!1,this.gamebox.falling=!1,this.face(this.dir),this.hit(.25);return}this.position.x===this.falling.to.x&&this.position.y===this.falling.to.y&&(this.falling.didReset=!0,this.falling.resetCounter?this.falling.resetCounter>0&&this.falling.resetCounter--:this.falling.resetCounter=30),this.applyFallingPosition()}applyFallingPosition(){if(this.falling.resetCounter&&this.falling.resetCounter>0)return;let t={x:this.position.x,y:this.position.y,z:this.position.z},e=2,i=this.falling.didReset?this.falling.reset:this.falling.to;Math.abs(t.x-i.x)>e?t.x+=t.x<i.x?e:-e:t.x=i.x,Math.abs(t.y-i.y)>e?t.y+=t.y<i.y?e:-e:t.y=i.y,this.position=t}applyParkour(){if(this.parkour.didEventDoor){if(this.frameStopped){this.frameStopped=!1,this.applyParkourComplete();return}return}if(this.position.x===this.parkour.poi.x&&this.position.y===this.parkour.poi.y){if(this.parkour.isEventDoor){this.parkour.event.data.verb&&this.can(this.parkour.event.data.verb)?(this.parkour.didEventDoor=!0,this.cycle(this.parkour.event.data.verb,this.parkour.dir)):this.applyParkourComplete();return}this.applyParkourLanding();return}this.applyParkourPosition()}applyParkourPosition(){let t={x:this.position.x,y:this.position.y,z:this.position.z},e=this.parkour.elevation*2+2;switch(this.parkour.dir){case"left":t.x=Math.max(t.x-e,this.parkour.poi.x);break;case"right":t.x=Math.min(t.x+e,this.parkour.poi.x);break;case"up":t.y=Math.max(t.y-e,this.parkour.poi.y);break;case"down":t.y=Math.min(t.y+e,this.parkour.poi.y);break}this.position=t}applyParkourComplete(){this.gamebox.handleCriticalReset(),this.gamebox.handleHeroEventDoor(this.parkour.poi,this.parkour.dir,this.parkour.event),this.gamebox.jumping=!1,this.parkour=null}applyParkourLanding(){let t=this.parkour.activeTiles&&this.parkour.activeTiles.canAttack();if(t){this.parkour.activeTiles.attack(this.parkour.coords,t);let i=n.getSurroundingTileCoords(this.parkour.coords);for(let s in i){let a=[i[s].x,i[s].y];this.parkour.activeTiles.isPushed(a)&&this.parkour.activeTiles.attack(a,t)}}this.face(this.parkour.dir),this.gamebox.jumping=!1,this.parkour=null;let e=this.player.gamepad.checkDpad();if(e.length)for(let i=0;i<e.length;i++)for(let s=0;s<e[i].dpad.length;s++)this.player.controls[e[i].dpad[s]]=!0}applyHeroMask(){if(this.maskFX){let t=this.position.x+(this.width-this.maskFX.width)/2,e=this.position.y+(this.height-this.maskFX.height);this.maskFX.position.x=t,this.maskFX.position.y=e,this.isIdle()?this.maskFX.paused=!0:this.maskFX.paused=!1}}applyOffset(){if(this.gamebox.panning){super.applyOffset();return}this.offset={x:this.gamebox.camera.width/2-this.width/2,y:this.gamebox.camera.height/2-this.height/2},this.gamebox.camera.x<=0?this.offset.x=this.position.x:this.gamebox.camera.x>=this.map.width-this.gamebox.camera.width&&(this.offset.x=this.position.x-this.gamebox.camera.x),this.gamebox.camera.y<=0?this.offset.y=this.position.y:this.gamebox.camera.y>=this.map.height-this.gamebox.camera.height&&(this.offset.y=this.position.y-this.gamebox.camera.y)}applyCycle(){this.parkour||this.falling||this.spinLocked||(this.is(h.verbs.LIFT)?this.cycle(h.verbs.LIFT,this.dir):this.gamebox.swimming?this.diveCounter>0?this.cycle(h.verbs.DIVE,this.dir):this.cycle(h.verbs.SWIM,this.dir):this.gamebox.jumping||this.gamebox.dropin?this.cycle(h.verbs.JUMP,this.dir):this.gamebox.attacking?this.cycle(h.verbs.ATTACK,this.dir):this.idle.x&&this.idle.y?this.face(this.dir):this.cycle(h.verbs.WALK,this.dir))}getWeaponbox(t="position"){return{x:this[t].x+this.data.weapon[this.dir][this.frame].positionX,y:this[t].y+this.data.weapon[this.dir][this.frame].positionY,width:this.data.weapon[this.dir][this.frame].width,height:this.data.weapon[this.dir][this.frame].height,layer:this.layer,elevation:this.elevation}}getShieldbox(t="position"){return{x:this[t].x+this.data.shield[this.verb][this.dir][this.frame].positionX,y:this[t].y+this.data.shield[this.verb][this.dir][this.frame].positionY,width:this.data.shield[this.verb][this.dir][this.frame].width,height:this.data.shield[this.verb][this.dir][this.frame].height,layer:this.layer,elevation:this.elevation}}getPositionForNewMap(){if(this.dir==="down")return{x:this.position.x,y:0,z:0};if(this.dir==="up")return{x:this.position.x,y:this.map.height-this.height,z:0};if(this.dir==="right")return{x:0,y:this.position.y,z:0};if(this.dir==="left")return{x:this.map.width-this.width,y:this.position.y,z:0}}canMoveWhileJumping(t,e=!1){return!(t.map&&!e)&&!t.npc&&!t.enemy&&!t.door&&!t.camera&&!(t.tiles&&t.tiles.action.length&&t.tiles.action.find(i=>i.stop))}canResetMaxV(){return this.physics.maxv!==this.physics.controlmaxv&&!this.is(h.verbs.LIFT)&&!this.gamebox.swimming}canEventDoor(t){return t.event.data.type===h.events.DOOR}canEventBoundary(t){return t.event.data.type===h.events.BOUNDARY&&t.camera}canEventDialogue(t){return t.event.data.type===h.events.DIALOGUE&&t.event.data.dialogue}canLift(t){return t===h.opposites[this.dir]}canGrabTile(t){return!t.tiles||!t.tiles.action.length||!this.can(h.verbs.LIFT)||!this.can(h.verbs.GRAB)?!1:t.tiles.action.some(e=>e.instance.canInteract(h.verbs.LIFT))}canTileSwim(t,e){let{tiles:i}=e,s=i&&i.action.filter(r=>r.swim),a=5;return s&&s.length?s.some(r=>n.collide(r.tilebox,this.footbox,a)):!1}canTileJump(t,e){if(!(e.tiles&&e.tiles.passive.length))return!1;let s=e.tiles.passive.filter(r=>r.jump);if(!s.length)return!1;let a=s[0];return s.length>1?s.every(r=>r.instance.canInteract(h.verbs.JUMP).dir===t):(a.collides.width>a.tilebox.width/2||a.collides.height>a.tilebox.height/2)&&a.instance.canInteract(h.verbs.JUMP).dir===t}canTileFall(t,e){let{tiles:i,empty:s}=e,a=i&&i.action.filter(l=>l.fall),r=5;if(a&&a.length)return a.some(l=>n.collide(l.tilebox,this.footbox,r));if(s){let l=s.find(v=>n.collide(v,this.footbox,r));if(!l)return!1;let c=[l.x/this.map.data.tilesize,l.y/this.map.data.tilesize];return this.map.getEvent(c)||this.map.getEmptyTile(c,"foreground")!==0?!1:!!l}return!1}canShield(t,e=10){return!this.hasShield()||t.status&&t.status!==this.status?!1:this.dir==="left"&&t.hitbox.x+t.hitbox.width<=this.hitbox.x+e||this.dir==="right"&&t.hitbox.x>=this.hitbox.x+this.hitbox.width-e||this.dir==="up"&&t.hitbox.y+t.hitbox.height<=this.hitbox.y+e||this.dir==="down"&&t.hitbox.y>=this.hitbox.y+this.hitbox.height-e}canAggroEnemy(t){return!this.gamebox.dropin&&!this.isDead()}},rt=class extends m{constructor(t,e,i,s){let a={...t,spawn:s};super(a,i),this.hero=e}},nt=class extends P{constructor(t,e,i,s){super(t,e,i,s),this.hero=i}applyPosition(){let t=this.getNextPoi(),{collision:e,isMapCollision:i}=this.gamebox.checkElevationCollision(this.position,this,{doors:this.gamebox.checkDoor(this.position,this),camera:this.gamebox.checkCamera(this.position,this),npc:this.gamebox.checkNPC(this.position,this),enemy:this.gamebox.checkEnemy(this.position,this),tiles:this.elevation?!1:this.gamebox.checkTiles(this.position,this)}),s=i||e.npc||e.enemy||e.doors||e.camera||this.canTileStop(e);if(e.tiles&&this.data.spin&&this.hero.handleAttackTiles({collision:e,checkStop:!0}),s){e.enemy&&e.enemy.canBeAttacked(this)&&e.enemy.hit(this.hero.getStat("power")),this.kill();return}this.position=t}},lt=class extends f{constructor(t,{verb:e,...i},s,a){let r={spawn:t,hitbox:{x:0,y:0,width:i.width,height:i.height},verbs:{face:{down:{offsetX:i.offsetX,offsetY:i.offsetY}}},...i};super(r,s),this.hero=a}applyPosition(){this.position={x:this.hero.position.x+this.hero.width/2-this.width/2,y:this.hero.position.y,z:-this.height}}},dt=class extends f{constructor(t,e,i,s){let a=e.getTile(),r={width:i.data.tilesize,height:i.data.tilesize,image:i.data.image,spawn:t,hitbox:{x:0,y:0,width:i.data.tilesize,height:i.data.tilesize},verbs:{face:{down:{offsetX:a[0],offsetY:a[1]}}}};super(r,i),this.hero=s,this.throwing=!1,this.onscreen=!0,this.activeTiles=e}destroy(){let t=this.activeTiles.canAttack();t?.drops&&this.gamebox.itemDrop(t.drops,this.position,{layer:this.layer}),t?.sound&&this.player.gameaudio.hitSound(t.sound),this.map.mapFX.smokeObject(this,t?.fx,{layer:this.layer}),this.gamebox.interact.tile=null,this.hero.liftedTile=null,this.spring&&this.spring.destroy()}blit(t){if(!this.spring)return;if(this.spring.isResting){this.destroy();return}let{collision:e,isMapCollision:i}=this.gamebox.checkElevationCollision(this.position,this,{npc:this.gamebox.checkNPC(this.position,this),enemy:this.gamebox.checkEnemy(this.position,this),camera:this.gamebox.checkCamera(this.position,this)});if(i||e.npc||e.enemy||e.camera){e.enemy&&!e.enemy.isHitOrStill()&&e.enemy.hit(this.hero.getStat("power")),this.destroy();return}this.spring.blit(t)}applyPosition(){if(!this.throwing){this.gamebox.checkElevationCollision(this.position,this),this.position={x:this.hero.position.x+this.hero.width/2-this.width/2,y:this.hero.hitbox.y-this.height,z:0};return}this.position=this.getNextPoi()}throw(){this.hero.face(this.hero.dir),this.player.gameaudio.heroSound(h.verbs.THROW),this.hero.physics.maxv=this.hero.physics.controlmaxv,this.hero.interact=null,this.throwing=!0;let t,e,i=this.map.data.tilesize*2;switch(this.hero.dir){case"left":t=this.position.x-i-this.width,e=this.hero.footbox.y-(this.height-this.hero.footbox.height);break;case"right":t=this.position.x+i+this.width,e=this.hero.footbox.y-(this.height-this.hero.footbox.height);break;case"up":t=this.position.x,e=this.position.y-i-this.height;break;case"down":t=this.position.x,e=this.hero.footbox.y+i;break}this.spring=new it(this.player,this.position.x,this.position.y,60,3.5),this.spring.poi={x:t,y:e},this.spring.bind(this)}};var Y=class extends f{constructor(t,e){super(t,e.map),this.hero=e,this.onscreen=!0,this.bounceHeight=-8,this.spring=new it(this.player,this.position.x,this.position.y,10),this.spring.bind(this),this.despawn=!1,this.despawnQuest=null,this.despawnSpeed=2}destroy(){this.spring.destroy()}visible(){return!0}reset(){this.position.x=this.hero.position.x,this.position.y=this.hero.position.y,this.spring.position.x=this.position.x,this.spring.position.y=this.position.y,this.spring.poi.x=this.position.x,this.spring.poi.y=this.position.y,this.spring.previousElapsed=null}blitAfter(t){switch(this.data.type){case h.npc.ai.WALK:this.blitWalk();break;case h.npc.ai.FLOAT:this.blitFloat();break}this.spring.blit(t)}blitFloat(){this.position.z=-this.map.data.tilesize,this.hero.position.x+this.hero.width/2>this.position.x+this.width/2?this.dir="right":this.dir="left"}blitWalk(){let t=n.getDistance(this.position,this.spring.poi);(!this.hero.isIdle()||this.hero.isIdle()&&t>this.map.data.tilesize/2)&&this.data.bounce&&this.isOnGround()&&!this.gamebox.panning&&(this.physics.vz=this.bounceHeight),this.hero.isIdle()?this.verb=h.verbs.FACE:this.can(h.verbs.WALK)&&(this.verb=h.verbs.WALK),this.data.verbs[this.verb][this.hero.dir]?this.dir=this.hero.dir:Math.ceil(this.hero.position.x)>Math.floor(this.position.x)?this.dir="right":this.dir="left"}render(){super.render(),this.despawn&&(this.gamebox.despawnCompanion(),this.map.handleQuestFlagCheck(this.despawnQuest.questKey,{fx:!1,dir:this.dir,verb:this.verb}))}applyPosition(){this.stillTimer>0||(this.data.type===h.npc.ai.WALK&&this.applyWalkPosition(),this.data.type===h.npc.ai.FLOAT&&this.applyFloatPosition())}applyFloatPosition(){let t={};this.hero.dir==="right"&&this.hero.center.x>this.center.x&&(t.x=this.hero.center.x-this.width,t.y=this.hero.center.y),this.hero.dir==="left"&&this.hero.center.x<this.center.x&&(t.x=this.hero.center.x,t.y=this.hero.center.y),this.hero.dir==="up"&&this.hero.center.y<this.center.y&&(t.x=this.hero.center.x-this.width/2,t.y=this.hero.center.y+this.height),this.hero.dir==="down"&&this.hero.center.y>this.center.y&&(t.x=this.hero.center.x-this.width/2,t.y=this.hero.center.y),t.x&&t.y&&(this.spring.poi=t)}applyWalkPosition(){let t={};if(this.despawnQuest){this.applyDespawnPosition(t);return}this.hero.dir==="right"&&this.hero.position.x>this.position.x&&(t.x=this.hero.position.x-this.width/2,t.y=this.hero.footbox.y-(this.height-this.hero.footbox.height)),this.hero.dir==="left"&&this.hero.position.x<this.position.x&&(t.x=this.hero.position.x+this.hero.width-this.width/2,t.y=this.hero.footbox.y-(this.height-this.hero.footbox.height)),this.hero.dir==="up"&&this.hero.position.y<this.position.y&&(t.x=this.hero.position.x+this.hero.width/2-this.width/2,t.y=this.hero.position.y+this.hero.height-this.height/2),this.hero.dir==="down"&&this.hero.position.y>this.position.y&&(t.x=this.hero.position.x+this.hero.width/2-this.width/2,t.y=this.hero.position.y-this.height/2),t.x&&t.y&&(this.spring.poi=t)}applyDespawnPosition(){this.spring.hiJacked||(this.spring.hiJacked=!0,this.position.x=Math.round(this.position.x),this.position.y=Math.round(this.position.y));let t=this.getNextPoi();if(this.position.x===this.despawnQuest.position.x&&this.position.y===this.despawnQuest.position.y){this.isOnGround()&&(this.stillTimer=1/0,this.despawn=!0);return}Math.abs(t.x-this.despawnQuest.position.x)>this.despawnSpeed?t.x+=t.x<this.despawnQuest.position.x?this.despawnSpeed:-this.despawnSpeed:t.x=this.despawnQuest.position.x,Math.abs(t.y-this.despawnQuest.position.y)>this.despawnSpeed?t.y+=t.y<this.despawnQuest.position.y?this.despawnSpeed:-this.despawnSpeed:t.y=this.despawnQuest.position.y,this.position.x=t.x,this.position.y=t.y,this.data.bounce&&this.isOnGround()&&(this.physics.vz=this.bounceHeight)}};var ct=class{constructor(t,e=void 0){this.gamebox=t,this.quests={},this.reset=[],this.completed=e||{}}completeQuest(t){this.completed[t]=!0,this.removeQuest(t)}getCompleted(t){return this.completed[t]??!1}removeCompleted(t){delete this.completed[t]}hitQuest(t,e,i){this.completed[t]||(this.quests[t]||(this.quests[t]=0),i&&!this.reset.includes(t)&&this.reset.push(t),this.quests[t]+=e)}removeQuest(t){this.quests[t]&&delete this.quests[t],this.reset.includes(t)&&this.reset.splice(this.reset.indexOf(t),1)}resetQuests(){for(let t=this.reset.length;t--;)this.removeQuest(this.reset[t]);this.reset=[]}getQuest(t){return this.quests[t]?this.quests[t]:0}checkQuest(t,e){return this.quests[t]?this.quests[t]>=e:0}},St=ct;var $=class extends f{constructor(t,{verb:e,...i},s){let a={spawn:t,hitbox:{x:0,y:0,width:i.width,height:i.height},verbs:{face:{down:{offsetX:i.offsetX,offsetY:i.offsetY}}},...i};super(a,s),this.bounce=6,this.killCounter=60*6}update(){this.canPickup()&&!this.onscreen&&this.map.killObject("items",this),this.updateStack()}applyPosition(){this.killCounter>0&&(this.killCounter--,this.killCounter===0&&this.map.killObject("items",this)),this.bounce>0&&this.isOnGround()&&(this.physics.vz=-this.bounce,this.bounce--),this.position=this.getNextPoi()}applyOpacity(){this.killCounter<=60*2&&this.killCounter%5===0&&(this.player.renderLayer.context.globalAlpha=.25)}canPickup(){return this.bounce===0&&this.isOnGround()}};var V=class{constructor(t){this.gamebox=t,this.map=this.gamebox.map,this.player=this.gamebox.player,this.gamepad=this.player.gamepad,this.hero=this.gamebox.hero,this.buttons={a:null,b:null},this.gap=8}reset(){this.gamepad.renderButtonText("a"),this.gamepad.renderButtonText("b"),this.buttons.a=null,this.buttons.b=null}render(){this.offsets={topLeft:{x:20,y:20}},this.renderHealth(),this.renderMagic(),this.renderItems(),this.renderStatus(),this.renderButtons(),this.renderCurrency(),this.renderKeys(),this.renderFPS()}renderHealth(){let{x:t,y:e}=this.offsets.topLeft,i=this.player.data.tilesize,s=i/4,a=i*this.hero.health,r=i*this.hero.maxHealth;this._renderFillBar({x:t,y:e,width:a,height:s,fullWidth:r,bgColor:h.colors.yellow,fillColor:h.colors.red,borderColor:h.colors.white}),this.offsets.topLeft.y+=s+this.gap}renderMagic(){if(!this.hero.hasMagic())return;let{x:t,y:e}=this.offsets.topLeft,i=this.player.data.tilesize/8,s=this.player.data.tilesize/4,a=i*this.hero.magic,r=i*this.hero.maxMagic;this._renderFillBar({x:t,y:e,width:a,height:s,fullWidth:r,bgColor:h.colors.teal,fillColor:h.colors.blue,borderColor:h.colors.white}),this.offsets.topLeft.y+=s+this.gap}renderFPS(){if(!this.player.query.fps)return;let t=this.player.currentFPS,e=t>=55?h.colors.green:h.colors.red,i=`FPS: ${t}`,s=230,a=20;this.player.renderLayer.context.save(),this.player.renderLayer.context.font="16px Calamity-Bold",this.player.renderLayer.context.fillStyle=e,this.player.renderLayer.context.textAlign="left",this.player.renderLayer.context.textBaseline="top",this.player.renderLayer.context.fillText(i,s,a),this.player.renderLayer.context.restore()}renderItems(){let t=this.hero.items.find(s=>s.equip==="shield"),{x:e,y:i}=this.offsets.topLeft;t&&this.player.renderLayer.context.drawImage(g.cash(t.image),t.offsetX,t.offsetY,t.width,t.height,e,i,t.width,t.height)}renderStatus(){let t=this.hero.items.find(a=>a.equip==="shield"),e=this.player.data.hud.status?.[this.hero.status],i=t?60:20,{y:s}=this.offsets.topLeft;e&&this.player.renderLayer.context.drawImage(g.cash(e.image),e.offsetX,e.offsetY,e.width,e.height,i,s,e.width,e.height)}renderCurrency(){let s=`x${this.hero.currency}`;if(this.player.renderLayer.context.save(),this.player.data.hud.currency){let a=this.player.data.hud.currency.width,r=this.player.data.hud.currency.height,l=(r-16)/2,c=20+a+s.length*16,d=20-l/2;this.player.renderLayer.context.drawImage(g.cash(this.player.data.hud.currency.image),this.player.data.hud.currency.offsetX,this.player.data.hud.currency.offsetY,a,r,this.player.renderLayer.data.width-c,d,a,r),this._renderText({x:20,y:20,text:s,size:24})}this.player.renderLayer.context.restore()}renderKeys(){let i=this.hero.items.find(r=>r.id==="key"),a=`x${i?i.collected:0}`;if(this.player.renderLayer.context.save(),this.player.data.hud.keys){let r=this.player.data.hud.keys.width,l=this.player.data.hud.keys.height,c=(l-16)/2,d=20+r+a.length*16,u=60-c/2;this.player.renderLayer.context.drawImage(g.cash(this.player.data.hud.keys.image),this.player.data.hud.keys.offsetX,this.player.data.hud.keys.offsetY,r,l,this.player.renderLayer.data.width-d,u,r,l),this._renderText({x:20,y:60,text:a,size:24})}this.player.renderLayer.context.restore()}renderButtons(){if(this.gamebox.hero.interact){if(this.buttons.a!==this.gamebox.hero.interact){switch(this.gamebox.hero.interact){case h.hero.interact.READ:let t=this.player.data.hud.interact?.read;t?p.a.elem.innerHTML=L(t,"A",0):this.gamepad.renderButtonText("a");break;case h.hero.interact.GRAB:let e=this.hero.items.find(i=>i.stat&&i.stat.key==="strength");e?p.a.elem.innerHTML=L(e,"A"):this.gamepad.renderButtonText("a");break}this.buttons.a=this.gamebox.hero.interact}}else if(this.gamebox.swimming){if(this.buttons.a!==h.verbs.SWIM){let t=this.hero.items.find(e=>e.verb===h.verbs.SWIM);t?p.a.elem.innerHTML=L(t,"A"):this.gamepad.renderButtonText("a"),this.buttons.a=h.verbs.SWIM}}else if(this.buttons.a!==h.verbs.JUMP){let t=this.hero.items.find(e=>e.verb===h.verbs.JUMP);t?p.a.elem.innerHTML=L(t,"A"):this.gamepad.renderButtonText("a"),this.buttons.a=h.verbs.JUMP}if(this.gamebox.swimming)this.buttons.b!==h.verbs.DIVE&&(this.gamepad.renderButtonText("b"),this.buttons.b=h.verbs.DIVE);else if(this.gamebox.hero.mode!==this.buttons.b)switch(this.gamebox.hero.mode){case h.hero.modes.WEAPON:let t=this.hero.items.find(e=>e.equip==="weapon");t&&(p.b.elem.innerHTML=L(t,"B"),this.buttons.b=h.hero.modes.WEAPON);break;case h.hero.modes.PROJECTILE:this.hero.projectileItem&&(p.b.elem.innerHTML=L(this.hero.projectileItem,"B"),this.buttons.b=h.hero.modes.PROJECTILE);break}}_renderFillBar({x:t,y:e,width:i,height:s,fullWidth:a,bgColor:r,fillColor:l,borderColor:c}){this.player.renderLayer.context.save(),this.player.renderLayer.context.globalAlpha=.5,this.player.renderLayer.context.fillStyle=r,this.player.renderLayer.context.beginPath(),this.player.renderLayer.context.roundRect(t,e,a,s,2),this.player.renderLayer.context.fill(),this.player.renderLayer.context.closePath(),this.player.renderLayer.context.globalAlpha=1,this.player.renderLayer.context.fillStyle=l,this.player.renderLayer.context.beginPath(),this.player.renderLayer.context.roundRect(t,e,i,s,2),this.player.renderLayer.context.fill(),this.player.renderLayer.context.closePath(),this.player.renderLayer.context.fillStyle="transparent",this.player.renderLayer.context.strokeStyle=c,this.player.renderLayer.context.lineWidth=2,this.player.renderLayer.context.beginPath(),this.player.renderLayer.context.roundRect(t,e,a,s,2),this.player.renderLayer.context.stroke(),this.player.renderLayer.context.closePath(),this.player.renderLayer.context.restore()}_renderText({x:t,y:e,text:i,size:s,align:a="right"}){this.player.renderLayer.context.font=`${s}px Calamity-Bold`,this.player.renderLayer.context.fillStyle=h.colors.white,this.player.renderLayer.context.textAlign=a,this.player.renderLayer.context.textBaseline="top",this.player.renderLayer.context.fillText(i,this.player.renderLayer.data.width-t,e)}};var J=class{constructor(t){this.player=t,this.dropin=!1,this.panning=!1,this.mapChangeEvent=null;let e=this.player.query.nostorage?void 0:this.player.gamestorage.get("quests");this.gamequest=new St(this,e),this.renderQueue=new ut(this),this.dialogue=new Q(this),this.currentMusic=null,this.camera=new pt(this);let i=this.player.query.nostorage?this.player.heroData.map:this.player.gamestorage.get("map")||this.player.heroData.map,s=g.cash(i),a=structuredClone(this.player.heroData);this.map=new j(s,this),this.collision={},this.renderBox=this.getRenderBox(),a.spawn=s.spawn[a.spawn],this.dropin=a.spawn?.dropin??!1,this.hero=new K(a,this.map),this.map.addAllSprite(this.hero),this.seedStorage(),this.seedQuery(),this.hud=new V(this);for(let l in this.player.data.sounds)this.player.gameaudio.addSound({id:l,src:this.player.data.sounds[l],channel:"sfx"});let r=this.player.query.nostorage?void 0:this.player.gamestorage.get("companion");r&&this.spawnCompanion(r,{x:this.hero.position.x,y:this.hero.position.y}),this.initMap()}destroy(){this.clear(),this.hud.reset(),this.hero.destroy(),this.companion?.destroy(),this.map.destroy(),this.dialogue.destroy()}clear(){this.renderQueue.clear(),this.player.clear()}draw(...t){this.player.renderLayer.context.drawImage(...t)}pause(t){t?this.player.gameaudio.stopSound(this.currentMusic):this.player.gameaudio.playSound(this.currentMusic)}blit(t){this.hero.blit(t),this.companion&&this.companion.blit(t),this.map.blit(t)}update(){this.dropin&&this.hero.isOnGround()&&(this.dropin=!1),this.camera.update(),this.scan(),this.hero.update(),this.companion&&this.companion.update(),this.map.update()}render(){this.clear(),this.map.render(),this.renderQueue.render(),this.player.query.debug&&this.map.renderDebug(),this.hud.render()}scan(){this.renderBox=this.getRenderBox(),this.collision.colliders=this.getVisibleColliders(),this.collision.events=this.getVisibleEvents(),this.collision.activeTiles=this.getVisibleActiveTiles(),this.collision.items=this.getVisibleItems(),this.collision.npcs=this.getVisibleNPCs(),this.collision.doors=this.getVisibleNPCs("doors"),this.collision.enemies=this.getVisibleNPCs("enemies")}removeCollision(t,e){this.collision[t]&&this.collision[t].indexOf(e)!==-1&&this.collision[t].splice(this.collision[t].indexOf(e),1)}checkElevationCollision(t,e,i={},s={dirCheck:!1},a=void 0){let r={map:this.checkMap(t,e),event:this.checkEvents(t,e,s)},{isElevationEvent:l,wasElevationEvent:c,isElevationCollider:d}=e.handleElevation(t,r,a);for(let u in i)r[u]=i[u];return{collision:r,isMapCollision:r.map&&!d,isElevationEvent:l,wasElevationEvent:c,isElevationCollider:d}}pressD(){}releaseD(){}pressA(){}holdA(){}releaseA(){}releaseHoldA(){}pressB(){}holdB(){}releaseB(){}releaseHoldB(){}handleHero(t,e){}applyHero(t,e){this.hero.applyPosition(t,e),this.hero.applyPriority(),this.hero.applyOffset(),this.hero.applyCycle()}spawnCompanion(t,e){let i=this.player.getMergedData({...t,spawn:e},"npcs");this.companion=new Y(i,this.hero),this.map.addAllSprite(this.companion)}despawnCompanion(){this.companion.destroy(),this.map.removeAllSprite(this.companion),this.companion=null}checkCompanion(t){return this.companion&&this.companion.data.id===t}itemDrop(t,e,i={}){let s=structuredClone(this.player.data.drops[t]);this.hero.hasMagic()||(s=s.filter(l=>{let c=this.player.data.items.find(d=>d.id===l.id);return c.stat?c.stat.key!=="magic":!0}));let a=s[n.random(0,s.length-1)],r=n.random(0,100);if(!n.def(a.chance)||r<=a.chance){let l=this.player.getMergedData({id:a.id,...i},"items"),c={x:e.x+this.map.data.tilesize/2-l.width/2,y:e.y+this.map.data.tilesize/2-l.height/2};this.map.addObject("items",new $(c,l,this.map))}}keyItemDrop(t,e,i,s={}){let a=this.player.getMergedData({id:t.id,dialogue:t.dialogue,...s},"items"),r={x:e.x+this.map.data.tilesize/2-a.width/2,y:e.y+this.map.data.tilesize/2-a.height/2};this.map.addObject("items",new et(r,a,this.map,i))}seedQuery(){if(this.player.query.status&&this.hero.applyStatus(this.player.query.status),this.player.query.items){let t=this.player.query.items.split(",");for(let e=t.length;e--;){let i=t[e];if(!this.hero.getItem(i)){let s=this.player.getMergedData({id:i},"items");this.hero.items.push(s),s.equip&&this.hero.equip(s.equip)}}}}seedItem(t){this.hero.giveItem(t),this.hero.stillTimer=0,this.hero.itemGet=null,this.hero.face(this.hero.dir)}seedStorage(){if(!this.player.query.nostorage)for(let t of I.heroProps)this.hero[t]=this.player.gamestorage.get(t)??this.hero[t],t==="layer"&&this.hero.layer===h.layers.ELEVATION&&this.seedElevation(),t==="status"&&this.hero.status&&this.hero.applyStatus(this.hero.status)}seedElevation(){for(let t=this.map.data.events.length;t--;){if(this.map.data.events[t].type!==h.events.ELEVATION)continue;let e=new M(this.map.data.events[t],this.map);e.checkCollision(this.hero.position,this.hero,!1)&&(this.hero.elevation={event:e})}}getRenderBox(){return{x:this.camera.x-this.map.data.tilesize*2,y:this.camera.y-this.map.data.tilesize*2,width:this.camera.width+this.map.data.tilesize*4,height:this.camera.height+this.map.data.tilesize*4}}getVisibleColliders(){let t=[];for(let e=this.map.colliders.length;e--;)n.collide(this.renderBox,this.map.colliders[e])&&t.push(this.map.colliders[e]);return t}getVisibleEvents(){let t=[];for(let e=this.map.events.length;e--;)n.collide(this.renderBox,this.map.events[e].eventbox)&&t.push(this.map.events[e]);return t}getVisibleNPCs(t="npcs"){let e=[];for(let i=this.map[t].length;i--;)n.collide(this.renderBox,this.map[t][i].getFullbox())&&e.push(this.map[t][i]);return e}getVisibleItems(){let t=[];for(let e=this.map.items.length;e--;)n.collide(this.renderBox,this.map.items[e].getFullbox())&&t.push(this.map.items[e]);return t}getVisibleActiveTiles(){let t=[];for(let e=this.map.activeTiles.length;e--;)for(let i=this.map.activeTiles[e].pushed.length;i--;)if(n.collide(this.renderBox,this.map.activeTiles[e].pushed[i])){t.push(this.map.activeTiles[e]);break}return t}getNearestEmptyTiles(t){let e=[];if(!this.map.renderBox)return e;let{tileBox:i}=t.perceptionBox;for(let s=i.y;s<i.y+i.height;s++)for(let a=i.x;a<i.x+i.width;a++)this.map.data.textures.background[s]?.[a]===0&&e.push({x:a*this.map.data.tilesize,y:s*this.map.data.tilesize,width:this.map.data.tilesize,height:this.map.data.tilesize});return e}checkHero(t,e){if(e.layer!==this.hero.layer)return!1;let i=n.func(e.getHitbox)?e.getHitbox(t):e;return n.collide(i,this.hero.hitbox)}checkCamera(t,e){let i=!1,s=e.getHitbox(t);return s.x<=this.camera.x&&(i="left"),s.x>=this.camera.x+this.camera.width-s.width&&(i="right"),s.y<=this.camera.y&&(i="up"),s.y>=this.camera.y+this.camera.height-s.height&&(i="down"),i}checkMap(t,e){let i=e.getHitbox(t);for(let s=this.collision.colliders.length;s--;)if(n.collide(i,this.collision.colliders[s]))return this.collision.colliders[s];return!1}checkEvents(t,e,{dirCheck:i=!0}={}){for(let s=this.collision.events.length;s--;){let a=this.collision.events[s].data.dir;if(!(a&&i?e.dir===a:!0))continue;if(this.collision.events[s].checkCollision(t,e,!!a))return this.collision.events[s].isBlockedByTile()?!1:this.collision.events[s]}return!1}checkEventsNPC(t,e){for(let i=this.collision.events.length;i--;)if(n.collide(e.getHitbox(t),this.collision.events[i].eventbox))return this.collision.events[i].isBlockedByTile()?!1:this.collision.events[i];return!1}checkNPC(t,e,i="npcs"){let s=this.collision[i],a=n.func(e.getHitbox)?e.getHitbox(t):e;for(let r=s.length;r--;)if(!(s[r].data.ai===h.npc.ai.FLOAT&&i!=="enemies"||s[r].hero||s[r]===e||!n.canSpriteInteractWithNPCByLayer(e,s[r])||i==="doors"&&s[r].open)&&n.collide(a,s[r].hitbox))return s[r];return!1}checkDoor(t,e){return this.checkNPC(t,e,"doors")}checkEnemy(t,e){return this.checkNPC(t,e,"enemies")}checkItems(t,e){let i=n.func(e.getHitbox)?e.getHitbox(t):e;for(let s=this.collision.items.length;s--;)if(n.collide(i,this.collision.items[s].hitbox))return this.collision.items[s];return!1}checkEmpty(t,e){let i=this.getNearestEmptyTiles(e),s=[];for(let a=i.length;a--;){let r=n.collide(e.getHitbox(t),i[a]);r&&s.push({...i[a],amount:n.getCollisionAmount(r,e.hitbox)})}return s.length?s:!1}checkTiles(t,e){let i={action:[],attack:[],passive:[]},s=e.gamebox===this,a=s?e.getFootbox(t):e,r=s?e.getHitbox(t):e,l=!1;for(let c=this.collision.activeTiles.length;c--;){let d=this.collision.activeTiles[c],u=qt.indexOf(d.data.group)!==-1,v=s?u?a:r:e;for(let F=d.pushed.length;F--;){let C=d.pushed[F],w=n.collide(v,C);if(!w)continue;let b=!!(d.data.actions&&d.data.actions.some(A=>Rt.indexOf(A.verb)!==-1)),T=!!(d.data.actions&&d.canAttack()),H=!!(d.data.friction||d.data.mask),st=n.getCollisionAmount(w,v),q={action:b,attack:T,camera:H,amount:st,tilebox:C,collides:w,instance:d,coord:C.coords,group:d.data.group,jump:!!(d.data.actions&&d.canInteract(h.verbs.JUMP)),fall:!!(d.data.actions&&d.canInteract(h.verbs.FALL)),swim:!!(d.data.actions&&d.canInteract(h.verbs.SWIM)),stop:!!(d.data.actions&&d.data.actions.some(A=>Ot.indexOf(A.verb)!==-1))};b&&(l=!0,i.action.push(q)),T&&(l=!0,i.attack.push(q)),(!b&&!T||T&&H)&&(l=!0,i.passive.push(q))}}return l?i:!1}checkQuestFlags(t){for(let e=this.map.doors.length;e--;)this.map.doors[e].handleQuestFlagCheck(t);for(let e=this.map.enemies.length;e--;)this.map.enemies[e].handleQuestFlagCheck(t);this.map.handleQuestFlagCheck(t)}initMap(){this.map.initSprites(),this.map.initTiles(),this.update(),this.applyHero(this.hero.position,this.hero.dir),this.player.gameaudio.addSound({id:this.map.data.id,src:this.map.data.sound,channel:"bgm"}),this.currentMusic=this.map.data.id,this.dialogue.auto({text:[this.map.data.name]}),this.player.gamestorage.persist(this)}afterChangeMap(t){this.map.destroy(),this.map.initMap(t),this.map.addAllSprite(this.hero),this.companion&&this.map.addAllSprite(this.companion),this.initMap(),this.player.resume(),this.player.fadeIn()}changeMap(t){this.player.hardStop(),this.collision={},this.player.fadeOut().then(()=>{this.clear(),this.mapChangeEvent=null,this.gamequest.resetQuests();let e=g.cash(t.data.map),i=this.hero.getPositionForNewMap(),s=n.def(t.data.spawn)?e.spawn[t.data.spawn]:{x:i.x,y:i.y};this.hero.position.x=s.x,this.hero.position.y=s.y,this.hero.dir=s.dir||this.hero.dir,s.dropin&&(this.dropin=!0,this.hero.position.z=-(this.camera.height/2),this.hero.cycle(h.verbs.JUMP,this.hero.dir)),this.companion&&this.companion.reset(),this.afterChangeMap(e)})}},Ot=[h.verbs.GRAB,h.verbs.LIFT],Rt=[h.verbs.LIFT,h.verbs.PULL,h.verbs.PUSH,h.verbs.FALL,h.verbs.SWIM,h.verbs.ATTACK],qt=[h.tiles.STAIRS,h.tiles.WATER,h.tiles.GRASS,h.tiles.HOLES],pt=class{constructor(t){this.gamebox=t,this.player=this.gamebox.player,this.x=0,this.y=0,this.width=this.player.width*this.player.resolution,this.height=this.player.height*this.player.resolution,this.pan=null}update(){if(this.pan){this.pan.to.x===this.x&&this.pan.to.y===this.y?this.resetPan():this.updatePan();return}let t=this.gamebox.hero.position.x-(this.width/2-this.gamebox.hero.width/2),e=this.gamebox.hero.position.y-(this.height/2-this.gamebox.hero.height/2);t>=0&&t<=this.gamebox.map.width-this.width?this.x=t:t>=this.gamebox.map.width-this.width?this.x=this.gamebox.map.width-this.width:this.x=0,e>=0&&e<=this.gamebox.map.height-this.height?this.y=e:e>=this.gamebox.map.height-this.height?this.y=this.gamebox.map.height-this.height:this.y=0}resetPan(){this.pan=null,this.gamebox.panning=!1}updatePan(){let t={x:this.x,y:this.y},e=2,i=this.pan.to;Math.abs(t.x-i.x)>e?t.x+=t.x<i.x?e:-e:t.x=i.x,Math.abs(t.y-i.y)>e?t.y+=t.y<i.y?e:-e:t.y=i.y,this.x=t.x,this.y=t.y}panCamera(t,e){this.pan={to:{x:t,y:e},reset:{x:this.x,y:this.y}},this.gamebox.panning=!0,this.gamebox.handleCriticalReset()}},ut=class{constructor(t){this.gamebox=t,this.player=this.gamebox.player,this.clear()}clear(){this.background=[],this.sprites=[],this.foreground=[],this.elevation=[]}add(t){this[t.layer].push(t)}render(){for(let t=this.background.length;t--;)this.safeRender(this.background[t]);for(let t=0;t<this.sprites.length;t++)this.safeRender(this.sprites[t]);for(let t=this.foreground.length;t--;)this.safeRender(this.foreground[t]);for(let t=this.elevation.length;t--;)this.safeRender(this.elevation[t])}safeRender(t){this.player.renderLayer.context.save(),t.render(),this.player.renderLayer.context.restore()}};var mt=class extends J{constructor(t){super(t),this.interact={tile:null,push:0},this.attacking=null,this.jumping=!1,this.falling=!1,this.locked=!1,this.swimming=!1,this.liftLocked=!1}pressD(t){this.panning||this.dropin||this.hero.isHitOrStill()||this.handleHero(this.hero.getNextPoiByDir(t),t)}releaseD(){this.panning||this.locked||this.jumping||this.falling||this.attacking||this.dropin||this.swimming||this.hero.isHitOrStill()||(this.interact.push&&(this.interact.push=0),this.interact.tile?this.hero.cycle(this.hero.verb,this.hero.dir):this.hero.face(this.hero.dir))}pressA(){if(this.canBlockAPress()||this.hero.kickCounter>0)return;let t=this.hero.getNextPoiByDir(this.hero.dir,1),e={npc:this.checkNPC(t,this.hero),door:this.checkDoor(t,this.hero),tiles:this.checkTiles(t,this.hero)};if(this.swimming)this.hero.swimKick();else if(e.door)this.handleHeroDoorAction(t,this.hero.dir,e.door);else if(e.npc)this.handleHeroNPCAction(t,this.hero.dir,e.npc);else if(this.hero.canGrabTile(e)&&!this.interact.tile){let i=e.tiles.action.filter(s=>s.instance.canInteract(h.verbs.LIFT));this.interact.tile=n.getMostCollidingTile(i),this.hero.cycle(h.verbs.GRAB,this.hero.dir)}else!this.hero.is(h.verbs.LIFT)&&!this.hero.is(h.verbs.GRAB)&&this.hero.hasJump()&&this.handleHeroJump(t,this.hero.dir)}holdA(){}canBlockAPress(){return this.panning||this.locked||this.jumping||this.falling||this.attacking||this.dropin||this.dialogue.active||this.liftLocked||this.hero.isHitOrStill()}releaseA(){if(this.hero.itemGet){this.dialogue.check("A");return}this.canBlockReleaseA()||(this.dialogue.check("A"),this.handleReleaseA())}releaseHoldA(){this.canBlockReleaseA()||this.handleReleaseA()}canBlockReleaseA(){return this.panning||this.jumping||this.falling||this.attacking||this.dropin||this.hero.isHitOrStill()}handleReleaseA(){this.liftLocked&&(this.liftLocked=!1),this.hero.is(h.verbs.GRAB)&&this.hero.face(this.hero.dir),this.hero.is(h.verbs.LIFT)?this.interact.tile.throw&&this.hero.liftedTile?this.hero.liftedTile.throw():this.interact.tile.throw=!0:this.interact.tile=null}pressB(){if(!this.canBlockPressB()&&!(this.hero.diveCounter>0)){if(this.swimming){this.hero.swimDive();return}this.hero.is(h.verbs.LIFT)||this.handleHeroAttack()}}holdB(){this.canBlockPressB()}canBlockPressB(){return this.panning||this.jumping||this.falling||this.attacking||this.dropin||this.dialogue.active||this.hero.isHitOrStill()}releaseB(){if(this.hero.itemGet){this.dialogue.check("B");return}this.canBlockReleaseB()||(this.handleReleaseB(),this.dialogue.check("B"))}releaseHoldB(){this.canBlockReleaseB()||this.handleReleaseB()}canBlockReleaseB(){return this.panning||this.jumping||this.falling||this.dropin||this.hero.isHitOrStill()}handleReleaseB(){this.hero.spinLocked&&(this.hero.spinLocked=!1),this.hero.spinCharged&&(this.hero.spinCharged=!1,this.hero.updateStat("magic",-5))}handleHero(t,e){if((this.locked||this.jumping||this.falling||this.dropin)&&(this.interact.push=0),this.hero.parkour&&e!==this.hero.parkour.dir)return;if(this.hero.parkour||this.hero.falling||this.dropin){this.applyHero(t,e);return}if(this.locked||this.panning||this.falling||this.liftLocked||this.hero.isHitOrStill()||this.attacking&&!this.hero.spinLocked)return;let{collision:i,isMapCollision:s,isElevationCollider:a}=this.checkElevationCollision(t,this.hero,{door:this.checkDoor(t,this.hero),item:this.checkItems(t,this.hero),empty:this.checkEmpty(t,this.hero),camera:this.checkCamera(t,this.hero)&&!this.panning,enemy:this.checkEnemy(t,this.hero),npc:this.checkNPC(t,this.hero),tiles:this.hero.elevation?!1:this.checkTiles(t,this.hero)},{dirCheck:!this.hero.spinLocked});if(this.jumping){this.hero.canMoveWhileJumping(i,a)&&this.applyHero(t,e),this.hero.isOnGround()&&(this.jumping=!1,this.hero.face(e));return}let r=this.hero.canTileSwim(t,i),l=r&&!this.hero.hasSwim();if(i.event&&!l&&!this.hero.elevation){if(this.hero.spinLocked)return;if(this.hero.canEventBoundary(i)){this.handleHeroEventBoundary(t,e,i.event);return}else if(this.hero.canEventDoor(i)){this.handleHeroEventDoor(t,e,i.event);return}else this.hero.canEventDialogue(i)&&this.handleHeroEventDialogue(t,e,i.event)}if(!(i.item&&(this.handleHeroItem(t,e,i.item),i.item.data.collect||i.item.mapId))){if(i.door){this.handleHeroPush(t,e);return}if(i.enemy){i.enemy.canHitHero()&&this.hero.hit(i.enemy.stats.power);return}if(i.npc){this.handleHeroPush(t,e),i.npc.canDoAction(h.verbs.PUSH)&&this.handleHeroPushNPC(t,e,i);return}if(s){this.handleHeroPush(t,e);return}if(i.camera){this.handleHeroCamera(t,e);return}if(this.hero.is(h.verbs.GRAB)){this.hero.canLift(e)&&this.handleHeroLift(t,e);return}if(this.hero.canTileFall(t,i)){this.handleHeroFall(t,e,i);return}if(r?this.hero.hasSwim()?this.handleHeroTileSwim(t,e,i):this.handleHeroTileSink(t,e,i):this.swimming&&this.resetHeroSwim(),i.tiles){if(this.hero.canTileJump(e,i))this.handleHeroTileJump(t,e,i);else if(this.hero.canTileStop(i)){this.handleHeroPush(t,e);return}this.handleHeroTiles(t,e,i.tiles)}else this.hero.canResetMaxV(t,e,i)&&this.hero.resetMaxV();(!i.tiles||!i.tiles.passive.length)&&(this.hero.maskFX=null),this.applyHero(t,e)}}handleResetHeroDirs(){this.hero.handleResetControls()}handleCriticalReset(){this.handleResetHeroDirs(),this.hero.face(this.hero.dir),this.jumping=!1,this.falling=!1,this.attacking=null,this.hero.resetMaxV()}handleHeroJump(){this.hero.can(h.verbs.JUMP)&&(this.jumping=!0,this.hero.jump())}handleHeroTileJump(t,e,i){this.hero.spinLocked&&this.hero.resetSpin(),this.handleResetHeroDirs(),this.hero.destroyLiftedTile();let s=i.tiles.passive.filter(A=>A.jump),a=e==="left"||e==="right"?0:1,r=e==="left"||e==="up"?-1:1,l=n.getMostCollidingTile(s),c=this.map.data.textures[l.instance.data.layer],d=[...l.coord];d[a]+=r;let u=c[d[1]][d[0]],v=u[u.length-1],F=v,C=l.instance.data.elevation||1;if(!l.instance.data.elevation)for(;F[0]===v[0]&&F[1]===v[1];){d[a]+=r;let A=c[d[1]][d[0]];F=A[A.length-1],C++}let w,b,T;e==="left"||e==="right"?(b=[l.tilebox.x+r*this.map.data.tilesize,l.tilebox.y],C=1):b=[l.tilebox.x,l.tilebox.y+r*(this.map.data.tilesize*C)],T=[b[0]/this.map.data.tilesize,b[1]/this.map.data.tilesize];let H=this.map.getEvent(T),st=H&&H.data.type===h.events.DOOR,q=this.map.getActiveTileOnCoords(T);switch(e){case"left":w={x:b[0]-(this.hero.width-this.map.data.tilesize),y:this.hero.position.y};break;case"right":w={x:b[0],y:this.hero.position.y};break;case"up":w={x:this.hero.position.x,y:b[1]};break;case"down":w={x:this.hero.position.x,y:b[1]-(this.hero.height-this.map.data.tilesize)};break}this.jumping=!0,this.hero.cycle(h.verbs.JUMP,e),this.hero.physics.vz=-(this.map.data.tilesize/4),this.player.gameaudio.heroSound("parkour"),this.hero.parkour={poi:w,dir:e,tile:b,event:H,coords:T,elevation:C,isEventDoor:st,activeTiles:q}}handleHeroPushNPC(t,e,i){if(i.npc.canDoAction(h.verbs.PUSH)&&this.isPushingNPC()){this.locked=!0,this.hero.face(e);let s={},a=this.map.data.tilesize;switch(e){case"left":s.x=i.npc.position.x-a,s.y=i.npc.position.y;break;case"right":s.x=i.npc.position.x+a,s.y=i.npc.position.y;break;case"up":s.x=i.npc.position.x,s.y=i.npc.position.y-a;break;case"down":s.x=i.npc.position.x,s.y=i.npc.position.y+a;break}i.npc.pushed={poi:s,dir:e},i.npc.data.action.sound&&this.player.gameaudio.heroSound(i.npc.data.action.sound)}}handleHeroPush(t,e){if(!(this.swimming||this.hero.spinLocked))if(this.interact.push++,!this.hero.is(h.verbs.LIFT)&&this.isPushing()){if(!this.hero.can(h.verbs.PUSH))return;this.hero.cycle(h.verbs.PUSH,e)}else this.hero.is(h.verbs.LIFT)||this.hero.cycle(h.verbs.WALK,e)}playItemGetDialogue(t){return this.dialogue.play(t).then(()=>{this.hero.resetItemGet()}).catch(()=>{this.hero.resetItemGet()})}handleHeroItem(t,e,i){if(i.canPickup()){if(i.mapId&&(this.attacking&&(this.attacking=null),this.hero.giveItem(i.data.id,i.mapId),this.gamequest.completeQuest(i.mapId),this.playItemGetDialogue(i.data.dialogue)),i.data.sound&&this.player.gameaudio.hitSound(i.data.sound),i.data.currency&&this.hero.receive(i.data.currency),i.data.stat&&this.hero.updateStat(i.data.stat.key,i.data.stat.value),i.data.collect){let s=this.hero.getItem(i.data.id);this.hero.collectItem(i.data.id),i.checkFlag&&delete i.checkFlag,i.data.dialogue&&!s&&(this.attacking&&(this.attacking=null),this.playItemGetDialogue(i.data.dialogue))}this.map.killObject("items",i)}}handleHeroCamera(t,e){this.hero.cycle(this.hero.verb,e)}handleHeroEventCleanup(){this.hero.liftedTile=null,this.interact.tile=null,this.dialogue.teardown()}handleHeroEventDoor(t,e,i){this.handleHeroEventCleanup(),this.mapChangeEvent=i}handleHeroEventBoundary(t,e,i){this.handleHeroEventCleanup(),this.mapChangeEvent=i}handleHeroEventDialogue(t,e,i){this.dialogue.auto({text:i.data.dialogue.text}),i.data.sound&&(this.currentMusic=i.data.sound.split("/").pop().split(".")[0],this.player.gameaudio.addSound({id:this.currentMusic,src:i.data.sound,channel:"bgm"}),this.player.gameaudio.playSound(this.currentMusic))}handleHeroLift(t,e){let i=this.interact.tile.instance.data.actions.find(s=>s.verb===h.verbs.LIFT);if(i?.stat){let{key:s,value:a}=i.stat;if(!this.hero.checkStat(s,a)){this.liftLocked=!0,this.dialogue.auto(i.stat.dialogue),this.hero.cycle(h.verbs.PULL,e);return}}this.locked=!0,this.hero.cycle(h.verbs.PULL,e),this.hero.lifting={timeStarted:performance.now()}}handleHeroAttack(){if(this.attacking||!this.hero.can(h.verbs.ATTACK))return;let t=this.hero.isWeaponMode(),e=this.hero.isProjectileMode();!t&&!e||(e&&this.hero.fireProjectile(),this.attacking={timeStarted:performance.now()},this.hero.resetElapsed=!0,this.hero.cycle(h.verbs.ATTACK,this.hero.dir),t&&this.player.gameaudio.heroSound(h.verbs.ATTACK))}getFallPosition(t,e){let i=t[0]*this.map.data.tilesize,s=t[1]*this.map.data.tilesize,a=(this.hero.height-this.map.data.tilesize)/2,r=(this.hero.width-this.map.data.tilesize)/2,l={x:i-r,y:s-a},c={x:this.hero.lastPositionOnGround.x,y:this.hero.lastPositionOnGround.y};switch(e){case"left":c.x+=this.map.data.tilesize/4;break;case"right":c.x-=this.map.data.tilesize/4;break;case"up":c.y+=this.map.data.tilesize/2;break;case"down":c.y-=this.map.data.tilesize/4;break}return{fallToPosition:l,fallResetPosition:c}}handleHeroTileSink(t,e,i){this.hero.spinLocked&&this.hero.resetSpin(),this.handleResetHeroDirs(),this.hero.destroyLiftedTile();let s=i.tiles.action.filter(d=>d.swim),r=n.getMostCollidingTile(s).coord,{fallToPosition:l,fallResetPosition:c}=this.getFallPosition(r,e);this.falling=!0,this.hero.cycle(h.verbs.DIVE,this.hero.dir),this.player.gameaudio.heroSound("parkour"),this.hero.falling={to:l,reset:c}}handleHeroTileSwim(t,e,i){this.hero.spinLocked&&this.hero.resetSpin(),this.hero.destroyLiftedTile(),this.swimming=!0,this.hero.kickCounter||(this.hero.physics.maxv=this.hero.physics.controlmaxv/2),this.hero.kickCounter>0||this.hero.diveCounter>0?this.hero.canMoveWhileJumping(i)&&this.applyHero(t,e):this.hero.cycle(h.verbs.SWIM,this.hero.dir)}resetHeroSwim(){this.swimming=!1,this.hero.diveCounter=0,this.hero.kickCounter=0,this.hero.resetMaxV()}handleHeroFall(t,e,i){this.hero.spinLocked&&this.hero.resetSpin(),this.handleResetHeroDirs(),this.hero.destroyLiftedTile();let s=[];if(i.tiles){let l=i.tiles.action.filter(d=>d.fall);s=n.getMostCollidingTile(l).coord}else if(i.empty){let l=i.empty[0];s=[l.x/this.map.data.tilesize,l.y/this.map.data.tilesize]}let{fallToPosition:a,fallResetPosition:r}=this.getFallPosition(s,e);this.falling=!0,this.hero.cycle(h.verbs.FALL,this.hero.dir),this.player.gameaudio.heroSound("parkour"),this.hero.falling={to:a,reset:r}}handleHeroTiles(t,e,i){this.jumping||this.hero.isJumping()||(this.handleFrictionTiles(i),this.handleMaskTiles(i))}handleMaskTiles(t){let e=t.passive.filter(a=>a.instance.data.mask),i=e.find(a=>a.instance.data.mask),s=n.getTotalCollisionAmount(e);if(i&&s>=100){let a=this.player.getMergedData({id:i.instance.data.mask},"fx");a&&!this.hero.maskFX&&this.hero.addMaskFX(a)}else(!i||s<100)&&this.hero.maskFX&&(this.hero.maskFX=null)}handleFrictionTiles(t){let e=t.passive.filter(s=>s.instance.data.friction),i=n.getTotalCollisionAmount(e);if(e.length&&i>=100)for(let s=e.length;s--;)this.hero.physics.maxv=this.hero.physics.controlmaxv/e[s].instance.data.friction;else this.hero.canResetMaxV()&&this.hero.resetMaxV()}handleHeroDoorAction(t,e,i){if(i.canInteract(e)){i.doInteract(e);return}if(i.data.action?.quest){i.handleQuestInteractionCheck();return}i.handleDoAction()}handleHeroNPCAction(t,e,i){i.canInteract(e)&&i.doInteract(e)}isPushing(){return this.interact.push>this.map.data.tilesize}isPushingNPC(){return this.interact.push>this.map.data.tilesize*2}},Et=mt;var ft=class{constructor(t){this.data=t,this.build()}build(){this.canvas=document.createElement("canvas"),this.canvas.className="_2dk__layer",this.canvas.dataset.layer=this.data.id,this.context=this.canvas.getContext("2d"),this.update(this.data.width,this.data.height)}update(t,e){this.data.width=t,this.data.height=e,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${e}px`,this.canvas.width=t,this.canvas.height=e}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}destroy(){this.clear(),this.canvas.width=0,this.canvas.height=0,this.context=null,this.canvas=null}},It=ft;var Z=class extends N{constructor(){super(),this.build(),this.menu=new gt(this),this.gamestorage=new I(this),this.fps=h.player.fps,this.frame=0,this.interval=1e3/this.fps,this.renderLayer=null,this.loader=new g,this.Loader=g,this.Config=h,this.Utils=n,this.initialize(),this.detect(),this.buildSplash()}initialize(){this.ready=!1,this.paused=!1,this.stopped=!1,this.controls={start:!1,select:!1,a:!1,aHold:!1,aRelease:!1,b:!1,bHold:!1,bRelease:!1,left:!1,right:!1,up:!1,down:!1,_pressedA:!1,_pressedB:!1},this.handlers={},this.rafId=null,this.animate=null,this.started=!1,this.idleStarted=!1}idleGo(){this.device||this.idleStarted||(this.idleStarted=!0,this.animate=t=>{this.rafId=window.requestAnimationFrame(this.animate),this.gamepad.gamepadConnected&&this.gamepad.blitNativeGamepad(t)},this.rafId=window.requestAnimationFrame(this.animate))}go(){this.started||(this.frame=0,this.started=!0,this.currentFPS=this.fps,this.previousTime=performance.now(),this.previousFrameTime=this.previousTime,this.animate=t=>{this.rafId=window.requestAnimationFrame(this.animate);let e=t-this.previousTime;e>=this.interval&&(this.previousTime=t-e%this.interval,this.blit(this.previousTime),t-this.previousFrameTime>=1e3&&(this.currentFPS=this.frame,this.frame=0,this.previousFrameTime=t),this.frame++),this.render()},this.rafId=window.requestAnimationFrame(this.animate))}blit(t){this.blitUpdate(t),this.blitControls(t)}blitUpdate(t){this.stopped||(this.gamebox.blit(t),this.gamebox.update())}blitControls(t){if(this.stopped)return;this.gamepad.gamepadConnected&&this.gamepad.blitNativeGamepad(),this.gamepad.blit(t);let e=this.gamepad.checkDpad();if(!e.length)this.gamebox.releaseD(),this.gamebox.handleHero(this.gamebox.hero.position,this.gamebox.hero.dir);else for(let i=0;i<e.length;i++)for(let s=0;s<e[i].dpad.length;s++)this.gamebox.pressD(e[i].dpad[s]);this.controls.aHold?this.controls.aRelease?(this.controls.aHold=!1,this.controls.aRelease=!1,this.controls._pressedA=!1,this.gamebox.releaseHoldA()):this.gamebox.holdA():this.controls.aRelease?(this.controls.aRelease=!1,this.controls._pressedA=!1,this.gamebox.releaseA()):this.controls.a&&!this.controls._pressedA&&(this.controls._pressedA=!0,this.gamebox.pressA()),this.controls.bHold?this.controls.bRelease?(this.controls.bHold=!1,this.controls.bRelease=!1,this.controls._pressedB=!1,this.gamebox.releaseHoldB()):this.gamebox.holdB():this.controls.bRelease?(this.controls.bRelease=!1,this.controls._pressedB=!1,this.gamebox.releaseB()):this.controls.b&&!this.controls._pressedB&&(this.controls._pressedB=!0,this.gamebox.pressB())}render(){if(this.controls.start&&(this.controls.start=!1,this.onPressStart()),this.controls.select&&(this.controls.select=!1,this.onPressSelect()),this.gamebox.mapChangeEvent){this.gamebox.changeMap(this.gamebox.mapChangeEvent);return}if(this.gamebox.hero.deathCounter>0&&(this.gamebox.hero.deathCounter--,this.gamebox.hero.deathCounter===0)){this.reset({persist:!0});return}this.gamebox.render()}clear(){this.renderLayer.clear()}reset({persist:t=!1}={}){this.hardStop(),t&&this.gamestorage.persist(this.gamebox),this.gamebox.destroy(),this.gameaudio.stop(),this.menu.hide(),this.initialize(),this.element.classList.remove("is-started","is-fader"),delete this.gamebox}hardStop(){super.stop(),this.paused=!0,this.stopped=!0,this.gamepad.clear(),this.gamebox.pause(!0)}pause(){this.hardStop(),this.menu.show(),this.emit(h.broadcast.PAUSED),this.gamepad.gamepadConnected&&this.idleGo()}resume(){this.paused=!1,this.stopped=!1,this.gamebox.pause(!1),this.menu.hide(),this.emit(h.broadcast.RESUMED),this.go()}async load(){this.data=await this.loader.loadBundle("game.json",this.device,(t,e)=>{this.splashLoad.innerHTML=tt(`Loaded ${t} of ${e} game resources...`)}),this.debug(),this.heroData=this.getHeroData(),this.resolution=this.getResolution(),this.width=this.data.width/this.resolution,this.height=this.data.height/this.resolution,this.buildScreen(),this.buildGamebox(),this.splashLoad.innerHTML=`
        ${kt(this.data)}
        ${tt("Press Start")}
        `,this.gamepad=new z(this),this.gameaudio=new vt(this.device),this.bind(),this.idleGo()}detect(){this.device=/Mobi/i.test(window.navigator.userAgent),this.installed=window.navigator.standalone||window.matchMedia("(display-mode: standalone)").matches}debug(){let t=new URLSearchParams(window.location.search);this.query={fps:t.get("fps"),map:t.get("map"),items:t.get("items"),spawn:t.get("spawn"),debug:t.get("debug"),status:t.get("status"),gamepad:t.get("gamepad"),companion:t.get("companion"),resolution:t.get("resolution"),nostorage:t.get("nostorage")}}getHeroData(){let t=n.merge(this.data.heroes[this.data.hero.sprite],this.data.hero);return this.query.map&&(t.map=`maps/${this.query.map}`,t.spawn=0),this.query.spawn&&(t.spawn=Number(this.query.spawn)),this.query.companion&&(t.companion={id:this.query.companion,type:h.verbs.WALK}),t}getResolution(){let t=this.query.resolution?Number(this.query.resolution):this.device?h.player.deviceResolution:this.data.resolution;return t>this.data.maxresolution?this.data.maxresolution:t}getMergedData(t,e,i=!1){let s=this.data[e].find(a=>a.id===t.id);return s?n.merge(s,t,i):t}build(){this.element=document.createElement("div"),this.element.className="_2dk",document.body.appendChild(this.element)}buildSplash(){this.splash=document.createElement("div"),this.splash.className="_2dk__splash",this.splashInfo=document.createElement("div"),this.splashInfo.className="_2dk__splash__info",this.splashInfo.innerHTML=wt(this.installed),this.splashLoad=document.createElement("div"),this.splashLoad.className="_2dk__splash__load",this.splashLoad.innerHTML=tt("Loading game bundle..."),this.splashUpdate=document.createElement("div"),this.splashUpdate.className="_2dk__splash__update btn",this.splashUpdate.innerHTML="<div>Update Available</div>",this.splash.appendChild(this.splashInfo),this.splash.appendChild(this.splashLoad),this.splash.appendChild(this.splashUpdate),this.element.appendChild(this.splash)}buildScreen(){this.element.dataset.resolution=this.resolution,this.screen=document.createElement("div"),this.screen.className="_2dk__screen",this.screen.style.width=`${this.width}px`,this.screen.style.height=`${this.height}px`,this.element.appendChild(this.screen)}buildGamebox(){this.gbox=document.createElement("div"),this.gbox.className="_2dk__gamebox";let t=this.width*this.resolution,e=this.height*this.resolution;this.renderLayer=new It({id:"gamebox",width:t,height:e}),this.renderLayer.canvas.width=t*this.resolution,this.renderLayer.canvas.height=e*this.resolution,this.gbox.appendChild(this.renderLayer.canvas),this.screen.appendChild(this.gbox)}fadeOut(){return new Promise(t=>{this.element.classList.add("is-fader"),setTimeout(t,h.player.fadeDur)})}fadeIn(){return new Promise(t=>{this.element.classList.remove("is-fader"),setTimeout(t,h.player.fadeDur)})}bind(){window.onresize=this.onRotate.bind(this)}onRotate(){this.ready&&(window.screen.orientation.type.includes("landscape")?this.resume():this.pause())}onReady(){this.ready||(this.ready=!0,this.element.classList.add("is-started"),this.data.plugin===h.plugins.TOPVIEW&&(this.gamebox=new Et(this),this.gamebox.pause(!1),this.go()))}onPressStart(){if(!this.gamebox?.hero?.killed){if(this.idleStarted&&(super.stop(),this.idleStarted=!1),!this.ready){this.onReady();return}this.paused?this.resume():this.pause()}}onPressSelect(){if(this.ready&&this.gamebox.hero.hasProjectile())switch(this.gamebox.hero.mode){case h.hero.modes.WEAPON:this.gamebox.hero.mode=h.hero.modes.PROJECTILE,this.gamebox.hero.updateProjectileItem();break;case h.hero.modes.PROJECTILE:this.gamebox.hero.canCycleProjectile()?(this.gamebox.hero.updateProjectileItem(),this.gamebox.hud.buttons.b=null):this.gamebox.hero.mode=h.hero.modes.WEAPON;break}}},gt=class{constructor(t){this.player=t,this.timeout=null,this.build(),this.bind()}build(){this.element=document.createElement("div"),this.element.className="_2dk__menu",this.player.element.appendChild(this.element)}show(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.player.gamebox.hero&&(this.element.innerHTML=At(this.player)),this.element.classList.add("is-active")}hide(){this.element.classList.remove("is-active"),this.timeout=setTimeout(()=>{this.element.innerHTML=""},h.player.hideDur)}bind(){this.element.addEventListener("click",t=>{let e=t.target.closest("[data-tab]");if(e){let a=this.element.querySelector(`[data-content="${e.dataset.tab}"]`);this.element.querySelectorAll(".is-active").forEach(r=>{r.classList.remove("is-active")}),e.classList.add("is-active"),a.classList.add("is-active");return}if(t.target.closest("[data-save]")){this.player.gamestorage.persist(this.player.gamebox),this.player.reset();return}if(t.target.closest("[data-reset]")){this.player.gamestorage.reset(),this.player.reset();return}})}};var yt=class{constructor(t){this.player=t,this.scope=window.location.pathname.replace(/index\.html$/,""),this.config={scope:this.scope},this.worker=`${this.scope}sw.js`}update(t){this.player.splashUpdate.classList.add("has-update"),this.player.splashUpdate.addEventListener("click",()=>{t.waiting&&t.waiting.postMessage("SKIP_WAITING")})}register(){if(n.dev()){n.log("Skip service worker for studio dev demo!");return}"serviceWorker"in navigator?navigator.serviceWorker.register(this.worker,this.config).then(t=>{t.waiting&&(n.log("Service worker installed."),this.update(t)),t.addEventListener("updatefound",()=>{t.installing&&t.installing.addEventListener("statechange",()=>{t.waiting&&(navigator.serviceWorker.controller?this.update(t):n.log("Service worker initialized for the first time"))})});let e=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{e||(window.location.reload(),e=!0)})}).catch(t=>{n.error(`Service worker failed with ${t}`)}):n.log("Service workers not available!")}deregister(){navigator.serviceWorker.getRegistrations().then(t=>{t.forEach(e=>{e.unregister().then(i=>{n.log("Unregistered Service Worker",i)})})})}},Lt=yt;var xt=class{constructor(){window.onload=()=>{this.player=new Z,this.gameworker=new Lt(this.player),this.player.load().then(()=>{this.gameworker.register()})}}},Pt=new xt;window.app2dk=Pt;var Ki=Pt;})();
